# ウィンドウ管理機能 詳細設計書

**作成日**: 2025-12-26
**対象タスク**: 1.5.3 ウィンドウ間独立性確保（簡易実装版）
**目的**: 最小限の実装で最大限の価値を提供する

---

## 背景

タスク1.5.3の設計書 ([docs/design/1.5.3_window_independence.md](../design/1.5.3_window_independence.md)) は非常に包括的な内容ですが、現在の要件には過剰な部分が含まれています。

本設計書では、以下の方針で簡易版を定義します:

- **80/20の原則**: 20%の実装で80%の価値を提供
- **段階的実装**: 必要最小限から始め、必要に応じて拡張
- **既存資産の活用**: 1.5.2で実装済みのwindowAPIを最大限活用

---

## 実装方針

### UXパターン

**採用パターン**: 別ウィンドウ表示

```
ランチャー (常駐)
    ↓ 接続ボタンクリック
クエリビルダー (新規ウィンドウ) ← 複数同時起動可能
```

**理由:**
- 複数の接続を同時に扱える（開発環境と本番環境の比較など）
- ランチャーが接続管理のハブとして常に利用可能
- デスクトップアプリの強みを活かせる
- 既存の類似ツール（DBeaver、TablePlus等）と一貫性

### アーキテクチャ方針

1. **既存実装との共存**
   - 現在の `useWindowStore`（永続化用）はそのまま維持
   - 新しいコンテキスト管理機能を追加で実装

2. **段階的実装**
   - Phase 1: 基本的なコンテキスト管理（本設計書の対象）
   - Phase 2: ウィンドウイベント管理（必要になったら）
   - Phase 3: 詳細なウィンドウ状態管理（必要になったら）

3. **シンプルさ優先**
   - 複雑なイベントリスナーは省略
   - ウィンドウリストの常時監視は省略
   - 必要な時だけAPIを呼び出す

---

## 実装範囲

### 実装する機能（優先度順）

#### 優先度: 高 🔴
1. **WindowContext型定義とストア拡張** ([01_WindowContext型定義とストア拡張.md](./01_WindowContext型定義とストア拡張.md))
   - 各ウィンドウが接続情報を把握
   - 環境別テーマ適用の基盤

#### 優先度: 中 🟡
2. **useWindowコンポーザブル** ([02_useWindowコンポーザブル.md](./02_useWindowコンポーザブル.md))
   - ウィンドウ操作の一元化
   - 再利用性とテスタビリティ向上

#### 優先度: 低 🟢
3. **初期化ロジック** ([03_初期化ロジック.md](./03_初期化ロジック.md))
   - アプリ起動時の自動判定
   - なくても動作するが、あると便利

### 実装しない機能（将来の拡張候補）

以下は現時点で実装せず、必要になったら追加:

- ❌ `WindowEvent` 型定義とイベント管理
- ❌ `openWindows` リストの常時管理
- ❌ ウィンドウフォーカス/ブラーイベントリスナー
- ❌ `otherQueryBuilders` などの詳細getter
- ❌ ウィンドウ間通信機能

---

## ファイル構成

```
docs/20251226-window管理/
├── 00_概要.md                              # 本ファイル
├── 01_WindowContext型定義とストア拡張.md    # 優先度: 高
├── 02_useWindowコンポーザブル.md            # 優先度: 中
└── 03_初期化ロジック.md                     # 優先度: 低
```

---

## 実装スケジュール（目安）

| 項目 | 工数 | 依存関係 |
|------|------|----------|
| WindowContext型定義とストア拡張 | 1-2時間 | なし |
| useWindowコンポーザブル | 1-2時間 | WindowContext完了後 |
| 初期化ロジック | 0.5-1時間 | ストア拡張完了後 |
| **合計** | **2.5-5時間** | |

---

## 成功基準

以下が実現できれば成功:

1. ✅ ランチャーから接続ボタンで新しいウィンドウが開く
2. ✅ 同じ接続を再度開こうとすると、既存ウィンドウにフォーカス
3. ✅ 複数の接続を同時に開ける
4. ✅ 各クエリビルダーウィンドウが自分の接続情報を把握している
5. ✅ 環境別のテーマが各ウィンドウに適用される
6. ✅ ブラウザモード（`npm run dev`）でもエラーが出ない

---

## 参考資料

- [タスク1.5.3 元設計書](../design/1.5.3_window_independence.md)
- [タスク1.5.2 ウィンドウ起動コマンド実装](../design/1.5.2_window_launch_commands.md)
- [既存実装: app/api/window.ts](../../app/api/window.ts)
- [既存実装: app/stores/window.ts](../../app/stores/window.ts)
- [既存実装: app/types/index.ts](../../app/types/index.ts)

---

## 次のステップ

1. [01_WindowContext型定義とストア拡張.md](./01_WindowContext型定義とストア拡張.md) を確認
2. 実装を開始
3. 各機能のテストを実施
4. 必要に応じて追加機能を検討
