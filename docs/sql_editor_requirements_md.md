# GUIベースSQLエディタ

**要件定義書・概要設計書**

- バージョン: 1.0
- 作成日: 2025年10月5日

---

# 第1部: 要件定義書

## 1. プロジェクト概要

### 1.1 目的

GUIベースでSQLクエリを構築できる直感的なSQLエディタを開発する。技術者が複数のデータベース環境（開発・テスト・ステージング・本番）を安全に操作できることを目指す。

### 1.2 主要な特徴

- ドラッグ&ドロップによる視覚的なクエリ構築
- 環境別のウィンドウ分離と色分け表示
- リアルタイムSQLプレビュー機能
- 本番環境での誤操作防止機能

### 1.3 対象ユーザー

- データベースエンジニア
- バックエンド開発者
- データアナリスト
- SQLの知識が浅い初心者エンジニア

---

## 2. 機能要件

### 2.1 接続管理機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F001 | 接続設定 | データベース接続情報の登録・編集・削除 |
| F002 | 環境分類 | 開発/テスト/ステージング/本番の環境タイプ設定 |
| F003 | 環境色設定 | 環境ごとのテーマカラー設定 |
| F004 | 複数接続起動 | 複数の接続を同時に別ウィンドウで起動 |

### 2.2 GUIクエリビルダー機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F101 | テーブル選択 | ドラッグ&ドロップでテーブルを選択 |
| F102 | テーブル結合 | INNER/LEFT/RIGHT/FULL OUTER JOINの視覚的設定 |
| F103 | カラム選択 | チェックボックスでSELECT項目を選択 |
| F104 | WHERE条件設定 | AND/OR条件の組み合わせ設定 |
| F105 | GROUP BY設定 | グループ化とHAVING条件の設定 |
| F106 | ORDER BY設定 | 並び順の設定（ASC/DESC） |
| F107 | 集計関数設定 | COUNT/SUM/AVG/MIN/MAX等の設定 |
| F108 | SQLプレビュー | リアルタイムでSQLクエリを生成・表示 |

### 2.3 クエリ実行・管理機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F201 | クエリ実行 | 構築したSQLクエリの実行 |
| F202 | 結果表示 | クエリ実行結果の表形式表示 |
| F203 | クエリ保存 | 作成したクエリの保存・読み込み |
| F204 | クエリ履歴 | 実行済みクエリの履歴管理 |
| F205 | 結果エクスポート | CSV/Excel形式でのエクスポート |

### 2.4 安全機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F301 | 本番環境警告 | 本番環境での操作時に警告バナー表示 |
| F302 | 2段階確認 | UPDATE/DELETE実行時の確認ダイアログ |
| F303 | 操作ログ記録 | 全てのクエリ実行ログの記録 |

---

## 3. 非機能要件

### 3.1 性能要件

- アプリケーション起動時間: 3秒以内
- クエリ実行レスポンス: データベース応答時間 + 1秒以内
- GUIでの操作反映: 0.5秒以内
- 10万件までの結果セットを表示可能

### 3.2 ユーザビリティ要件

- SQLの知識が浅いユーザーでも基本的なクエリを構築可能
- 環境の誤認を防ぐ明確な視覚的識別
- キーボードショートカットによる操作効率化

### 3.3 互換性要件

- 対応OS: Windows 10以降、macOS 11以降、Ubuntu 20.04以降
- 対応データベース: PostgreSQL、MySQL、SQLiteを優先サポート

### 3.4 セキュリティ要件

- 接続情報の暗号化保存
- パスワードの平文保存禁止
- 操作ログの改ざん防止

### 3.5 セキュリティプロバイダー要件

DBeaverの設計を参考に、3つのセキュリティプロバイダーから選択可能とする。

| プロバイダー | 説明 | セキュリティレベル | 推奨用途 |
|------------|------|------------------|---------|
| Simple (デフォルト) | アプリ固定のキーでAES-256暗号化 | 低（カジュアル保護） | 個人開発、ローカル環境 |
| Master Password | ユーザー設定のパスワードで暗号化、起動時に1回入力 | 高 | チーム共有PC、高セキュリティ |
| OS Keychain (オプション) | macOS Keychain / Windows Credential Manager使用 | 最高 | 企業環境、最高セキュリティ |

#### 3.5.1 Simple プロバイダー

- **暗号化方式**: AES-256-GCM
- **キー管理**: アプリケーション内蔵の固定キー + ランダムソルト
- **利点**: パスワード入力不要、即座にアプリ起動可能
- **欠点**: ソースコードにアクセスできれば理論上は復号可能
- **対策**: 難読化、環境固有のソルト生成

#### 3.5.2 Master Password プロバイダー

- **暗号化方式**: AES-256-GCM + PBKDF2 (600,000回反復)
- **キー管理**: ユーザー設定のマスターパスワードから暗号化キーを導出
- **フロー**:
  1. 初回起動時にマスターパスワードを設定
  2. 以降の起動時にマスターパスワードを入力
  3. セッション中はメモリにキーをキャッシュ
- **利点**: ユーザーのみが復号可能、高セキュリティ
- **欠点**: 起動時に毎回パスワード入力が必要

#### 3.5.3 OS Keychain プロバイダー

- **暗号化方式**: OS提供のセキュアストレージを使用
- **対応OS**:
  - macOS: Keychain Access
  - Windows: Credential Manager
  - Linux: Secret Service API (GNOME Keyring等)
- **利点**: OSレベルのセキュリティ、生体認証対応
- **欠点**: OSの認証プロンプトが表示される場合がある

#### 3.5.4 データ保存構造

```
~/.sql-query-build/
├── connections.json          # 接続情報（パスワード以外）- 平文
├── credentials.json          # パスワード等の機密情報 - 暗号化
└── security-config.json      # セキュリティ設定
```

**security-config.json 例:**
```json
{
  "version": 1,
  "provider": "master_password",
  "master_password_hash": "...",
  "salt": "..."
}
```

#### 3.5.5 プロバイダー変更時の挙動

- プロバイダー変更時は既存の認証情報を新しい方式で再暗号化
- 変更前に現在のプロバイダーでの認証が必要
- データ移行中のエラー時はロールバック可能

---

## 4. 画面要件

### 4.1 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| S001 | 起動画面（ランチャー） | 保存済み接続一覧と新規接続作成 |
| S002 | 接続設定画面 | データベース接続情報の設定 |
| S003 | クエリビルダー画面 | GUIでのクエリ構築（メイン画面） |
| S004 | テーブル結合設定画面 | テーブル間の結合設定 |
| S005 | カラム選択画面 | SELECT項目と集計関数の設定 |
| S006 | 条件設定画面 | WHERE句の条件設定 |
| S007 | グループ化設定画面 | GROUP BY/HAVING句の設定 |
| S008 | データベース構造画面 | テーブル・カラム情報の表示 |
| S009 | クエリ履歴・管理画面 | クエリの保存・読み込み・履歴 |
| S010 | 設定画面 | アプリケーション設定 |

---

## 5. 画面遷移

```
アプリケーション起動
  ↓
起動画面（ランチャー）[S001]
  ├─ 接続選択 → ウィンドウA起動（環境A）
  ├─ 接続選択 → ウィンドウB起動（環境B）
  └─ 新規接続 → 接続設定画面 [S002]

各ウィンドウ内（独立）:
  クエリビルダー（メイン）[S003]
    ├─ テーブル結合設定 [S004]
    ├─ カラム選択 [S005]
    ├─ 条件設定 [S006]
    ├─ グループ化設定 [S007]
    └─ SQLプレビュー → 実行 → 結果表示

  クエリビルダー ⇄ データベース構造 [S008]
  クエリビルダー ⇄ クエリ履歴・管理 [S009]
  クエリビルダー ⇄ 設定 [S010]
```

---

# 第2部: 概要設計書

## 1. システムアーキテクチャ

### 1.1 技術スタック

| レイヤー | 技術 | バージョン |
|----------|------|------------|
| デスクトップフレームワーク | Tauri | 2.x |
| フロントエンドフレームワーク | Nuxt.js | 3.x |
| UIフレームワーク | Vuetify | 3.x |
| 状態管理 | Pinia | 2.x |
| バックエンド言語 | Rust | 1.70+ |

### 1.2 システム構成図

```
┌─────────────────────────────────┐
│     ユーザーインターフェース      │
│  (Nuxt.js + Vuetify)           │
└──────────┬──────────────────────┘
           │ Tauri IPC
┌──────────┴──────────────────────┐
│     Tauriバックエンド (Rust)     │
│  - ウィンドウ管理                │
│  - 接続情報管理                  │
│  - ファイルシステムアクセス        │
└──────────┬──────────────────────┘
           │
┌──────────┴──────────────────────┐
│   データベースドライバ層          │
│  - PostgreSQL Driver            │
│  - MySQL Driver                 │
│  - SQLite Driver                │
└──────────┬──────────────────────┘
           │
┌──────────┴──────────────────────┐
│      データベースサーバー         │
└─────────────────────────────────┘
```

---

## 2. データ設計

### 2.1 接続情報データ構造

```json
{
  "connections": [
    {
      "id": "uuid",
      "name": "開発DB",
      "environment": "development",
      "theme_color": "development",
      "host": "localhost",
      "port": 5432,
      "database": "dev_db",
      "username": "dev_user",
      "password": "encrypted_password",
      "db_type": "postgresql",
      "ssl": false,
      "created_at": "2025-10-05T10:00:00Z",
      "updated_at": "2025-10-05T10:00:00Z"
    }
  ]
}
```

### 2.2 クエリ保存データ構造

```json
{
  "saved_queries": [
    {
      "id": "uuid",
      "name": "ユーザー一覧取得",
      "description": "アクティブユーザーの一覧",
      "connection_id": "uuid",
      "query_json": {
        "tables": [
          {
            "name": "users",
            "alias": "u"
          }
        ],
        "joins": [],
        "columns": ["id", "name", "email"],
        "where": [],
        "groupBy": [],
        "orderBy": [{"column": "created_at", "order": "DESC"}]
      },
      "generated_sql": "SELECT id, name, email FROM users ORDER BY created_at DESC",
      "folder": "ユーザー管理",
      "tags": ["users", "active"],
      "created_at": "2025-10-05T10:00:00Z"
    }
  ]
}
```

### 2.3 クエリ履歴データ構造

```json
{
  "query_history": [
    {
      "id": "uuid",
      "connection_id": "uuid",
      "sql": "SELECT * FROM users LIMIT 10",
      "execution_time_ms": 45,
      "rows_affected": 10,
      "status": "success",
      "error_message": null,
      "executed_at": "2025-10-05T12:30:00Z"
    }
  ]
}
```

---

## 3. 画面設計

### 3.1 起動画面（ランチャー）レイアウト

**ヘッダー部**
- アプリケーションロゴ・タイトル
- 新規接続ボタン
- 設定ボタン

**メイン部**
- 接続カード一覧（グリッド表示）
- 各カードには接続名、環境タイプ、環境色、最終接続時刻を表示
- 検索・フィルター機能
- グループ分けタブ

### 3.2 クエリビルダー画面レイアウト

```
┌─────────────────────────────────────────────────┐
│ 環境識別ヘッダー（環境色・接続名・警告バナー）   │
├─────────────────────────────────────────────────┤
│ ツールバー（実行・保存・新規作成・履歴等）       │
├───────────┬─────────────────────┬───────────────┤
│ 左パネル  │   中央パネル        │  右パネル     │
│           │                     │               │
│ - DB構造  │ - テーブル関係図    │ - SQLプレビュー│
│   ツリー  │   （上部）          │ - クエリ情報  │
│ - テーブル│ - 条件設定タブ      │               │
│   一覧    │   （下部）          │               │
│ - カラム  │   SELECT/WHERE/     │               │
│   情報    │   GROUP BY/ORDER BY │               │
│           │                     │               │
├───────────┴─────────────────────┴───────────────┤
│ 実行結果表示エリア（テーブル形式）              │
└─────────────────────────────────────────────────┘
```

---

## 4. 環境別テーマ設計

### 4.1 Vuetifyテーマ定義

| 環境 | Primary色 | Background色 | 特徴 |
|------|-----------|--------------|------|
| 開発環境 | #4CAF50（緑） | #F1F8E9 | 安全な作業環境を示す緑 |
| テスト環境 | #2196F3（青） | #E3F2FD | 検証環境を示す青 |
| ステージング | #FF9800（オレンジ） | #FFF3E0 | 注意が必要な環境を示すオレンジ |
| 本番環境 | #F44336（赤） | #FFEBEE | 危険を示す赤・太枠・警告バナー |

### 4.2 環境別の安全機能

| 機能 | 開発 | テスト | ステージング | 本番 |
|------|------|--------|--------------|------|
| 警告バナー表示 | - | - | △ | ○ |
| UPDATE/DELETE確認 | - | ○ | ○ | ◎ |
| 実行ボタン遅延 | - | - | - | ○ |
| 操作ログ記録 | ○ | ○ | ○ | ◎ |

**凡例:** ◎: 必須・強化、○: 有効、△: オプション、-: 無効

---

## 5. モジュール構成

### 5.1 フロントエンドモジュール構成

```
src/
├── components/
│   ├── connection/
│   │   ├── ConnectionCard.vue
│   │   ├── ConnectionForm.vue
│   │   └── ConnectionList.vue
│   ├── query-builder/
│   │   ├── TableSelector.vue
│   │   ├── JoinEditor.vue
│   │   ├── ColumnSelector.vue
│   │   ├── WhereEditor.vue
│   │   ├── GroupByEditor.vue
│   │   └── OrderByEditor.vue
│   ├── result/
│   │   ├── ResultTable.vue
│   │   └── ResultExporter.vue
│   └── common/
│       ├── AppBar.vue
│       ├── Toolbar.vue
│       └── EnvironmentBanner.vue
├── pages/
│   ├── launcher.vue
│   ├── query-builder.vue
│   └── settings.vue
├── stores/
│   ├── connection.ts
│   ├── query.ts
│   ├── theme.ts
│   └── history.ts
└── plugins/
    └── vuetify.ts
```

### 5.2 バックエンドモジュール構成

```
src-tauri/src/
├── main.rs
├── commands/
│   ├── connection.rs
│   ├── query.rs
│   └── window.rs
├── database/
│   ├── postgresql.rs
│   ├── mysql.rs
│   └── sqlite.rs
├── storage/
│   ├── connection_storage.rs
│   ├── query_storage.rs
│   └── history_storage.rs
└── utils/
    ├── encryption.rs
    └── logger.rs
```

---

## 開発フェーズ計画

### フェーズ1 (1-2ヶ月): 基本機能実装
- 接続管理機能
- 基本的なクエリビルダー（SELECT, WHERE）
- 環境別テーマ適用

### フェーズ2 (2-3ヶ月): 高度な機能実装
- JOIN、GROUP BY、ORDER BY対応
- クエリ保存・履歴機能
- 結果エクスポート機能

### フェーズ3 (1ヶ月): 安全機能・最適化
- 本番環境安全機能実装
- 性能最適化
- ユーザビリティ改善