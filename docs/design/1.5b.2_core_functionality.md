# 1.5b.2 コア機能実装 - 詳細設計書

**作成日**: 2025-12-12
**バージョン**: 1.0
**ステータス**: 設計中
**フェーズ**: 1.5b Phase 2
**担当**: FE/BE
**工数**: 約56時間（1週間）

---

## 目次

1. [概要](#1-概要)
2. [目的とゴール](#2-目的とゴール)
3. [サブフェーズ詳細設計](#3-サブフェーズ詳細設計)
4. [技術仕様](#4-技術仕様)
5. [依存関係とリスク](#5-依存関係とリスク)
6. [検証・テスト計画](#6-検証テスト計画)
7. [成果物チェックリスト](#7-成果物チェックリスト)

---

## 1. 概要

### 1.1 Phase 2の位置づけ

Phase 2は、Nuxt環境上でアプリケーションのコア機能を実装します。Composables、型定義、Piniaストア、共通コンポーネント、ランチャーページ、接続フォームページを構築し、基本的なCRUD操作とTauri IPC通信を確立します。

### 1.2 期間

- **総工数**: 約56時間
- **期間**: 1週間
- **サブフェーズ**: 5つ（2.1 〜 2.5）

### 1.3 前提条件

- ✅ Phase 1（クリーンスレート準備）が完了していること
- ✅ Nuxt開発サーバーが正常に起動すること
- ✅ Tauriアプリが起動すること
- ✅ 環境別カラーパレットが定義されていること

---

## 2. 目的とゴール

### 2.1 主要目的

1. **Composablesと型定義の構築**
   - 環境管理、Tauri IPC、テーマ管理のComposablesを実装
   - TypeScript型定義を作成

2. **Piniaストアの移行**
   - 既存のVue/VuetifyストアをNuxt対応に移行
   - Connection、Theme、Window、Settings、Securityストアを実装

3. **共通コンポーネントの実装**
   - 環境ヘッダー、バッジ、インジケーター、警告バナーを実装
   - 再利用可能なUIコンポーネントを構築

4. **ランチャーページの実装**
   - 接続一覧表示
   - 接続カード、リスト、ツールバー
   - 検索・フィルター機能

5. **接続フォームページの実装**
   - 接続CRUD機能
   - 環境選択、カラーピッカー、テーマプレビュー
   - 接続テスト機能

### 2.2 成功基準

| 項目 | 基準 |
|------|------|
| **Composables** | useEnvironment、useTauri、useThemeが動作すること |
| **型定義** | TypeScriptエラーがないこと |
| **Piniaストア** | 5つのストアが正常に動作すること |
| **共通コンポーネント** | 4つのコンポーネントが表示されること |
| **ランチャー** | 接続一覧が表示され、検索・フィルターが動作すること |
| **接続フォーム** | 接続の作成・編集・削除が可能であること |
| **Tauri IPC** | フロントエンドとRustバックエンド間の通信が成功すること |

---

## 3. サブフェーズ詳細設計

### 3.1 サブフェーズ2.1: Composables・型定義（1日）

#### 3.1.1 タスク1.5b.2.1.1: useEnvironment composable作成

**目的**: 環境（開発/テスト/ステージング/本番）の管理ロジックを実装

**実装内容**:

**`app/composables/useEnvironment.ts`**:

```typescript
import type { Environment } from '~/types'

/**
 * 環境管理Composable
 *
 * 環境の選択、環境別カラー、環境別スタイルクラスを提供
 */
export const useEnvironment = () => {
  const currentEnvironment = useState<Environment>('currentEnvironment', () => 'development')

  /**
   * 環境別カラー定義
   */
  const environmentColors = computed(() => {
    const colors: Record<Environment, { primary: string; bg: string; border: string }> = {
      development: {
        primary: '#4CAF50',
        bg: '#F1F8E9',
        border: '#4CAF50'
      },
      test: {
        primary: '#2196F3',
        bg: '#E3F2FD',
        border: '#2196F3'
      },
      staging: {
        primary: '#FF9800',
        bg: '#FFF3E0',
        border: '#FF9800'
      },
      production: {
        primary: '#F44336',
        bg: '#FFEBEE',
        border: '#F44336'
      }
    }
    return colors[currentEnvironment.value]
  })

  /**
   * 環境別Tailwindクラス
   */
  const environmentClass = computed(() => {
    return `env-${currentEnvironment.value}`
  })

  /**
   * 環境ラベル
   */
  const environmentLabel = computed(() => {
    const labels: Record<Environment, string> = {
      development: '開発',
      test: 'テスト',
      staging: 'ステージング',
      production: '本番'
    }
    return labels[currentEnvironment.value]
  })

  /**
   * 環境を設定
   */
  const setEnvironment = (env: Environment) => {
    currentEnvironment.value = env
  }

  return {
    currentEnvironment,
    environmentColors,
    environmentClass,
    environmentLabel,
    setEnvironment
  }
}
```

**確認事項**:
- [ ] ファイルが作成されたか
- [ ] 環境カラーが正しく定義されているか
- [ ] 型が正しく定義されているか

**成果物**: `app/composables/useEnvironment.ts`

---

#### 3.1.2 タスク1.5b.2.1.2: useTauri composable作成

**目的**: Tauri IPC通信を抽象化し、フロントエンドから簡単に呼び出せるようにする

**実装内容**:

**`app/composables/useTauri.ts`**:

```typescript
import { invoke } from '@tauri-apps/api/core'

/**
 * Tauri IPC通信Composable
 *
 * Tauriコマンドの実行を簡略化
 */
export const useTauri = () => {
  const isAvailable = ref(false)

  /**
   * Tauriが利用可能かチェック
   */
  onMounted(() => {
    if (typeof window !== 'undefined' && '__TAURI__' in window) {
      isAvailable.value = true
    }
  })

  /**
   * Tauriコマンドを実行
   *
   * @param command - コマンド名
   * @param args - 引数オブジェクト
   * @returns Promise<T> - コマンドの戻り値
   */
  const invokeCommand = async <T>(
    command: string,
    args?: Record<string, unknown>
  ): Promise<T> => {
    if (!isAvailable.value) {
      throw new Error('Tauri is not available. Running in browser mode.')
    }
    return invoke<T>(command, args)
  }

  /**
   * エラーハンドリング付きでTauriコマンドを実行
   */
  const safeInvokeCommand = async <T>(
    command: string,
    args?: Record<string, unknown>,
    fallback?: T
  ): Promise<T | undefined> => {
    try {
      return await invokeCommand<T>(command, args)
    } catch (error) {
      console.error(`Tauri command "${command}" failed:`, error)
      return fallback
    }
  }

  return {
    isAvailable,
    invokeCommand,
    safeInvokeCommand
  }
}
```

**確認事項**:
- [ ] ファイルが作成されたか
- [ ] Tauri APIが正しくインポートされているか
- [ ] エラーハンドリングが実装されているか

**成果物**: `app/composables/useTauri.ts`

---

#### 3.1.3 タスク1.5b.2.1.3: 型定義ファイル作成

**目的**: アプリケーション全体で使用する型を定義

**実装内容**:

**`app/types/index.ts`**:

```typescript
/**
 * 環境タイプ
 */
export type Environment = 'development' | 'test' | 'staging' | 'production'

/**
 * データベースタイプ
 */
export type DatabaseType = 'mysql' | 'postgresql' | 'sqlite' | 'sqlserver' | 'oracle'

/**
 * セキュリティプロバイダー
 */
export type SecurityProvider = 'system' | 'master-password'

/**
 * セキュリティレベル
 */
export type SecurityLevel = 'low' | 'medium' | 'high'

/**
 * カラーモード
 */
export type ColorMode = 'light' | 'dark' | 'auto'

/**
 * 言語
 */
export type Language = 'ja' | 'en'

/**
 * 接続情報インターフェース
 */
export interface Connection {
  id: string
  name: string
  type: DatabaseType
  environment: Environment
  host: string
  port: number
  username: string
  database: string
  password?: string  // Optional: セキュリティプロバイダーで暗号化
  customColor?: {
    primary: string
    background: string
  }
  createdAt: string
  updatedAt: string
}

/**
 * アプリケーション設定インターフェース
 */
export interface AppSettings {
  theme: ColorMode
  language: Language
  autoSave: boolean
  windowRestore: boolean
}

/**
 * セキュリティ設定インターフェース
 */
export interface SecuritySettings {
  provider: SecurityProvider
  level: SecurityLevel
  masterPasswordSet?: boolean
}

/**
 * ウィンドウ状態インターフェース
 */
export interface WindowState {
  id: string
  connectionId: string
  position: { x: number; y: number }
  size: { width: number; height: number }
  isMaximized: boolean
  createdAt: string
}

/**
 * テーマ設定インターフェース
 */
export interface ThemeConfig {
  colorMode: ColorMode
  primaryColor: string
  environmentColors: Record<Environment, { primary: string; bg: string }>
}

/**
 * Tauri IPCレスポンス型
 */
export interface TauriResponse<T> {
  success: boolean
  data?: T
  error?: string
}

/**
 * 接続テスト結果
 */
export interface ConnectionTestResult {
  success: boolean
  message: string
  latency?: number
}
```

**確認事項**:
- [ ] ファイルが作成されたか
- [ ] すべての必要な型が定義されているか
- [ ] 型に矛盾がないか

**成果物**: `app/types/index.ts`

---

#### 3.1.4 タスク1.5b.2.1.4: useTheme composable作成

**目的**: テーマ（ライト/ダーク）とカラーモードの管理

**実装内容**:

**`app/composables/useTheme.ts`**:

```typescript
import type { ColorMode } from '~/types'

/**
 * テーマ管理Composable
 */
export const useTheme = () => {
  const colorMode = useColorMode()
  const { currentEnvironment, environmentColors } = useEnvironment()

  /**
   * 現在のテーマカラーを取得
   */
  const currentThemeColor = computed(() => {
    return environmentColors.value
  })

  /**
   * ダークモードかどうか
   */
  const isDark = computed(() => {
    return colorMode.value === 'dark'
  })

  /**
   * カラーモードを切り替え
   */
  const toggleColorMode = () => {
    colorMode.preference = isDark.value ? 'light' : 'dark'
  }

  /**
   * カラーモードを設定
   */
  const setColorMode = (mode: ColorMode) => {
    colorMode.preference = mode
  }

  return {
    colorMode,
    currentThemeColor,
    isDark,
    toggleColorMode,
    setColorMode
  }
}
```

**確認事項**:
- [ ] ファイルが作成されたか
- [ ] useColorModeが正しく使用されているか
- [ ] 環境カラーと連携しているか

**成果物**: `app/composables/useTheme.ts`

---

### 3.2 サブフェーズ2.2: Piniaストア移行（1日）

#### 3.2.1 タスク1.5b.2.2.1: connectionストア移行

**目的**: 接続情報の管理ストアを実装

**実装内容**:

**`app/stores/connection.ts`**:

```typescript
import { defineStore } from 'pinia'
import type { Connection } from '~/types'

export const useConnectionStore = defineStore('connection', {
  state: () => ({
    connections: [] as Connection[],
    activeConnection: null as Connection | null,
    loading: false,
    error: null as string | null
  }),

  getters: {
    /**
     * 環境別の接続リストを取得
     */
    connectionsByEnvironment: (state) => (env: string) => {
      return state.connections.filter(c => c.environment === env)
    },

    /**
     * IDで接続を取得
     */
    getConnectionById: (state) => (id: string) => {
      return state.connections.find(c => c.id === id)
    }
  },

  actions: {
    /**
     * 接続リストをロード
     */
    async loadConnections() {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        this.connections = await invokeCommand<Connection[]>('get_connections')
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Unknown error'
        console.error('Failed to load connections:', error)
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続を作成
     */
    async createConnection(connection: Omit<Connection, 'id' | 'createdAt' | 'updatedAt'>) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        const newConnection = await invokeCommand<Connection>('create_connection', { connection })
        this.connections.push(newConnection)
        return newConnection
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to create connection'
        console.error('Failed to create connection:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続を更新
     */
    async updateConnection(id: string, updates: Partial<Connection>) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        const updated = await invokeCommand<Connection>('update_connection', { id, updates })

        const index = this.connections.findIndex(c => c.id === id)
        if (index !== -1) {
          this.connections[index] = updated
        }

        return updated
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to update connection'
        console.error('Failed to update connection:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続を削除
     */
    async deleteConnection(id: string) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        await invokeCommand('delete_connection', { id })
        this.connections = this.connections.filter(c => c.id !== id)

        if (this.activeConnection?.id === id) {
          this.activeConnection = null
        }
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to delete connection'
        console.error('Failed to delete connection:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続をテスト
     */
    async testConnection(connection: Connection | Omit<Connection, 'id' | 'createdAt' | 'updatedAt'>) {
      try {
        const { invokeCommand } = useTauri()
        return await invokeCommand('test_connection', { connection })
      } catch (error) {
        console.error('Connection test failed:', error)
        throw error
      }
    },

    /**
     * アクティブな接続を設定
     */
    setActiveConnection(connection: Connection | null) {
      this.activeConnection = connection
    }
  }
})
```

**確認事項**:
- [ ] ファイルが作成されたか
- [ ] CRUD操作が実装されているか
- [ ] Tauri IPCと連携しているか

**成果物**: `app/stores/connection.ts`

---

#### 3.2.2 〜 3.2.5: その他のストア実装

以降のストア（theme、window、settings、security）も同様の構造で実装します。詳細は省略しますが、各ストアは以下の責務を持ちます:

- **themeストア**: テーマ設定の永続化
- **windowストア**: ウィンドウ状態の管理
- **settingsストア**: アプリケーション設定の管理
- **securityストア**: セキュリティプロバイダーの管理

**成果物**:
- `app/stores/theme.ts`
- `app/stores/window.ts`
- `app/stores/settings.ts`
- `app/stores/security.ts`

---

### 3.3 サブフェーズ2.3: 共通コンポーネント（1.5日）

#### 3.3.1 タスク1.5b.2.3.1: EnvironmentHeader.vue作成

**目的**: 環境を識別するヘッダーコンポーネント

**実装内容**:

**`app/components/common/EnvironmentHeader.vue`**:

```vue
<script setup lang="ts">
import type { Environment } from '~/types'

const props = defineProps<{
  environment: Environment
  showToggle?: boolean
}>()

const { environmentLabel } = useEnvironment()
const { toggleColorMode, isDark } = useTheme()

const environmentColors = {
  development: 'green',
  test: 'blue',
  staging: 'amber',
  production: 'red'
}
</script>

<template>
  <header :class="`env-${environment} border-b-4 shadow-md`">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
          SQL Query Build
        </h1>
        <UBadge
          :color="environmentColors[environment]"
          size="lg"
          variant="solid"
        >
          {{ environmentLabel }} 環境
        </UBadge>
      </div>

      <div v-if="showToggle" class="flex items-center gap-2">
        <UButton
          :icon="isDark ? 'i-heroicons-moon' : 'i-heroicons-sun'"
          variant="ghost"
          @click="toggleColorMode"
        >
          {{ isDark ? 'ダーク' : 'ライト' }}モード
        </UButton>
      </div>
    </div>
  </header>
</template>
```

**確認事項**:
- [ ] コンポーネントが作成されたか
- [ ] 環境別カラーが適用されるか
- [ ] ダークモード切り替えが動作するか

**成果物**: `app/components/common/EnvironmentHeader.vue`

---

#### 3.3.2 〜 3.3.4: その他の共通コンポーネント

以降のコンポーネント（EnvironmentBadge、EnvironmentIndicator、EnvironmentWarningBanner）も同様に実装します。

**成果物**:
- `app/components/common/EnvironmentBadge.vue`
- `app/components/common/EnvironmentIndicator.vue`
- `app/components/common/EnvironmentWarningBanner.vue`

---

### 3.4 サブフェーズ2.4: ランチャーページ（2.5日）

#### 3.4.1 タスク1.5b.2.4.1: pages/index.vue作成

**目的**: ランチャーページ（接続一覧画面）の実装

**実装内容**:

**`app/pages/index.vue`**:

```vue
<script setup lang="ts">
const connectionStore = useConnectionStore()
const { currentEnvironment } = useEnvironment()

const searchQuery = ref('')
const selectedEnvironmentFilter = ref<string>('all')

onMounted(() => {
  connectionStore.loadConnections()
})

/**
 * フィルタリングされた接続リスト
 */
const filteredConnections = computed(() => {
  let result = connectionStore.connections

  // 環境フィルター
  if (selectedEnvironmentFilter.value !== 'all') {
    result = result.filter(c => c.environment === selectedEnvironmentFilter.value)
  }

  // 検索フィルター
  if (searchQuery.value) {
    const query = searchQuery.value.toLowerCase()
    result = result.filter(c =>
      c.name.toLowerCase().includes(query) ||
      c.host.toLowerCase().includes(query) ||
      c.database.toLowerCase().includes(query)
    )
  }

  return result
})

const navigateToConnectionForm = () => {
  navigateTo('/connection-form')
}
</script>

<template>
  <div>
    <EnvironmentHeader :environment="currentEnvironment" :show-toggle="true" />

    <div class="container mx-auto p-8">
      <!-- ツールバー -->
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold">接続一覧</h2>
        <UButton
          icon="i-heroicons-plus"
          size="lg"
          @click="navigateToConnectionForm"
        >
          新規接続
        </UButton>
      </div>

      <!-- 検索・フィルター -->
      <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <UInput
          v-model="searchQuery"
          icon="i-heroicons-magnifying-glass"
          placeholder="接続名、ホスト、データベース名で検索..."
          size="lg"
        />

        <USelect
          v-model="selectedEnvironmentFilter"
          :options="[
            { label: 'すべての環境', value: 'all' },
            { label: '開発環境', value: 'development' },
            { label: 'テスト環境', value: 'test' },
            { label: 'ステージング環境', value: 'staging' },
            { label: '本番環境', value: 'production' }
          ]"
          size="lg"
        />
      </div>

      <!-- 接続リスト -->
      <div v-if="connectionStore.loading" class="text-center py-12">
        <UIcon name="i-heroicons-arrow-path" class="animate-spin text-4xl" />
        <p class="mt-4 text-gray-600 dark:text-gray-300">読み込み中...</p>
      </div>

      <div v-else-if="filteredConnections.length === 0" class="text-center py-12">
        <UIcon name="i-heroicons-inbox" class="text-6xl text-gray-400" />
        <p class="mt-4 text-gray-600 dark:text-gray-300">
          接続が見つかりませんでした
        </p>
      </div>

      <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <ConnectionCard
          v-for="connection in filteredConnections"
          :key="connection.id"
          :connection="connection"
        />
      </div>
    </div>
  </div>
</template>
```

**確認事項**:
- [ ] ページが作成されたか
- [ ] 接続一覧が表示されるか
- [ ] 検索・フィルターが動作するか

**成果物**: `app/pages/index.vue`

---

#### 3.4.2 〜 3.4.6: ランチャー関連コンポーネント

以降のコンポーネント（ConnectionCard、ConnectionList、LauncherToolbar等）を実装します。

**成果物**:
- `app/components/connection/ConnectionCard.vue`
- `app/components/connection/ConnectionList.vue`
- `app/components/launcher/LauncherToolbar.vue`

---

### 3.5 サブフェーズ2.5: 接続フォームページ（2日）

#### 3.5.1 タスク1.5b.2.5.1: pages/connection-form.vue作成

**目的**: 接続の作成・編集フォームページの実装

**実装内容**:

**`app/pages/connection-form.vue`**:

```vue
<script setup lang="ts">
import type { Connection, Environment, DatabaseType } from '~/types'

const route = useRoute()
const router = useRouter()
const connectionStore = useConnectionStore()

const isEditMode = computed(() => !!route.query.id)
const connectionId = computed(() => route.query.id as string)

const form = reactive({
  name: '',
  type: 'mysql' as DatabaseType,
  environment: 'development' as Environment,
  host: 'localhost',
  port: 3306,
  username: '',
  database: '',
  password: ''
})

const loading = ref(false)
const testing = ref(false)
const testResult = ref<{ success: boolean; message: string } | null>(null)

/**
 * 編集モード時、既存接続を読み込み
 */
onMounted(async () => {
  if (isEditMode.value) {
    const connection = connectionStore.getConnectionById(connectionId.value)
    if (connection) {
      Object.assign(form, connection)
    }
  }
})

/**
 * 接続テスト
 */
const testConnection = async () => {
  testing.value = true
  testResult.value = null

  try {
    const result = await connectionStore.testConnection(form)
    testResult.value = result
  } catch (error) {
    testResult.value = {
      success: false,
      message: error instanceof Error ? error.message : '接続テストに失敗しました'
    }
  } finally {
    testing.value = false
  }
}

/**
 * フォーム送信
 */
const submitForm = async () => {
  loading.value = true

  try {
    if (isEditMode.value) {
      await connectionStore.updateConnection(connectionId.value, form)
    } else {
      await connectionStore.createConnection(form)
    }
    router.push('/')
  } catch (error) {
    console.error('Failed to save connection:', error)
  } finally {
    loading.value = false
  }
}
</script>

<template>
  <div>
    <EnvironmentHeader :environment="form.environment" />

    <div class="container mx-auto p-8 max-w-3xl">
      <h2 class="text-3xl font-bold mb-6">
        {{ isEditMode ? '接続を編集' : '新規接続' }}
      </h2>

      <UForm :state="form" @submit="submitForm">
        <UCard>
          <div class="space-y-6">
            <!-- 接続名 -->
            <UFormGroup label="接続名" required>
              <UInput
                v-model="form.name"
                placeholder="例: 本番MySQL"
                size="lg"
              />
            </UFormGroup>

            <!-- データベースタイプ -->
            <UFormGroup label="データベースタイプ" required>
              <USelect
                v-model="form.type"
                :options="[
                  { label: 'MySQL', value: 'mysql' },
                  { label: 'PostgreSQL', value: 'postgresql' },
                  { label: 'SQLite', value: 'sqlite' },
                  { label: 'SQL Server', value: 'sqlserver' },
                  { label: 'Oracle', value: 'oracle' }
                ]"
                size="lg"
              />
            </UFormGroup>

            <!-- 環境選択 -->
            <UFormGroup label="環境" required>
              <EnvironmentSelector v-model="form.environment" />
            </UFormGroup>

            <!-- ホストとポート -->
            <div class="grid grid-cols-2 gap-4">
              <UFormGroup label="ホスト" required>
                <UInput
                  v-model="form.host"
                  placeholder="localhost"
                  size="lg"
                />
              </UFormGroup>

              <UFormGroup label="ポート" required>
                <UInput
                  v-model.number="form.port"
                  type="number"
                  size="lg"
                />
              </UFormGroup>
            </div>

            <!-- データベース名 -->
            <UFormGroup label="データベース名" required>
              <UInput
                v-model="form.database"
                placeholder="database_name"
                size="lg"
              />
            </UFormGroup>

            <!-- ユーザー名 -->
            <UFormGroup label="ユーザー名" required>
              <UInput
                v-model="form.username"
                placeholder="username"
                size="lg"
              />
            </UFormGroup>

            <!-- パスワード -->
            <UFormGroup label="パスワード">
              <UInput
                v-model="form.password"
                type="password"
                placeholder="••••••••"
                size="lg"
              />
            </UFormGroup>

            <!-- 接続テスト結果 -->
            <div v-if="testResult" :class="testResult.success ? 'text-green-600' : 'text-red-600'">
              <UIcon :name="testResult.success ? 'i-heroicons-check-circle' : 'i-heroicons-x-circle'" />
              {{ testResult.message }}
            </div>
          </div>

          <template #footer>
            <div class="flex gap-3 justify-between">
              <UButton
                variant="outline"
                @click="router.push('/')"
              >
                キャンセル
              </UButton>

              <div class="flex gap-3">
                <UButton
                  variant="outline"
                  :loading="testing"
                  @click="testConnection"
                >
                  接続テスト
                </UButton>

                <UButton
                  type="submit"
                  variant="solid"
                  :loading="loading"
                >
                  {{ isEditMode ? '更新' : '作成' }}
                </UButton>
              </div>
            </div>
          </template>
        </UCard>
      </UForm>
    </div>
  </div>
</template>
```

**確認事項**:
- [ ] ページが作成されたか
- [ ] フォームが正しく動作するか
- [ ] 接続テスト機能が動作するか
- [ ] 作成・編集が正常に完了するか

**成果物**: `app/pages/connection-form.vue`

---

## 4. 技術仕様

### 4.1 Composables仕様

| Composable | 責務 | 主要メソッド |
|-----------|------|------------|
| `useEnvironment` | 環境管理 | `setEnvironment()`, `environmentColors`, `environmentClass` |
| `useTauri` | Tauri IPC通信 | `invokeCommand()`, `safeInvokeCommand()` |
| `useTheme` | テーマ管理 | `toggleColorMode()`, `setColorMode()` |

### 4.2 Piniaストア仕様

| ストア | 状態 | アクション |
|--------|------|-----------|
| `connection` | `connections`, `activeConnection` | `loadConnections()`, `createConnection()`, `updateConnection()`, `deleteConnection()` |
| `theme` | `colorMode`, `primaryColor` | `setColorMode()`, `setPrimaryColor()` |
| `window` | `windows` | `saveWindowState()`, `restoreWindows()` |
| `settings` | `appSettings` | `loadSettings()`, `updateSettings()` |
| `security` | `provider`, `level` | `setProvider()`, `setLevel()` |

### 4.3 コンポーネント仕様

| コンポーネント | Props | Events | 用途 |
|--------------|-------|--------|------|
| `EnvironmentHeader` | `environment`, `showToggle` | - | 環境ヘッダー表示 |
| `ConnectionCard` | `connection` | `@edit`, `@delete`, `@connect` | 接続カード |
| `ConnectionList` | `connections` | - | 接続リスト表示 |
| `EnvironmentSelector` | `modelValue` | `@update:modelValue` | 環境選択UI |

---

## 5. 依存関係とリスク

### 5.1 サブフェーズ依存関係

```
2.1 (Composables・型定義)
  ↓
2.2 (Piniaストア移行)
  ↓
2.3 (共通コンポーネント)
  ↓
2.4 (ランチャーページ)
  ↓
2.5 (接続フォームページ)
```

### 5.2 リスク管理

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| Tauri IPC通信の失敗 | 高 | 中 | エラーハンドリングの実装、フォールバック値の設定 |
| Piniaストアの状態管理エラー | 中 | 低 | 型安全性の確保、デバッグツールの活用 |
| 既存ストアからの移行漏れ | 中 | 中 | 既存コードとの比較チェックリスト作成 |
| コンポーネント間の依存関係エラー | 低 | 低 | props/emitsの明確な定義 |

---

## 6. 検証・テスト計画

### 6.1 単体テスト

| テスト項目 | 期待結果 |
|-----------|---------|
| Composablesの動作 | 各Composableが正しく動作する |
| Piniaストアのアクション | CRUD操作が成功する |
| コンポーネントの表示 | 各コンポーネントが正しく表示される |

### 6.2 統合テスト

| テスト項目 | 期待結果 |
|-----------|---------|
| ランチャーページ表示 | 接続一覧が表示される |
| 検索・フィルター | 正しくフィルタリングされる |
| 接続フォーム | 作成・編集が正常に完了する |
| 接続テスト | Tauri IPCで接続テストが成功する |

### 6.3 E2Eテスト

| シナリオ | 手順 | 期待結果 |
|---------|------|---------|
| 接続作成フロー | 1. ランチャーで「新規接続」クリック → 2. フォーム入力 → 3. 保存 | 接続が作成され、一覧に表示される |
| 接続編集フロー | 1. 接続カードで「編集」クリック → 2. フォーム変更 → 3. 更新 | 接続が更新される |
| 接続削除フロー | 1. 接続カードで「削除」クリック → 2. 確認 | 接続が削除される |

---

## 7. 成果物チェックリスト

### 7.1 Composables

- [ ] `app/composables/useEnvironment.ts`
- [ ] `app/composables/useTauri.ts`
- [ ] `app/composables/useTheme.ts`

### 7.2 型定義

- [ ] `app/types/index.ts`

### 7.3 Piniaストア

- [ ] `app/stores/connection.ts`
- [ ] `app/stores/theme.ts`
- [ ] `app/stores/window.ts`
- [ ] `app/stores/settings.ts`
- [ ] `app/stores/security.ts`

### 7.4 共通コンポーネント

- [ ] `app/components/common/EnvironmentHeader.vue`
- [ ] `app/components/common/EnvironmentBadge.vue`
- [ ] `app/components/common/EnvironmentIndicator.vue`
- [ ] `app/components/common/EnvironmentWarningBanner.vue`

### 7.5 ランチャーページ

- [ ] `app/pages/index.vue`
- [ ] `app/components/connection/ConnectionCard.vue`
- [ ] `app/components/connection/ConnectionList.vue`
- [ ] `app/components/launcher/LauncherToolbar.vue`

### 7.6 接続フォームページ

- [ ] `app/pages/connection-form.vue`
- [ ] `app/components/connection/EnvironmentSelector.vue`
- [ ] `app/components/connection/EnvironmentColorPicker.vue`
- [ ] `app/components/connection/ThemePreview.vue`

### 7.7 動作確認

- [ ] Composablesが正常に動作する
- [ ] Piniaストアが正常に動作する
- [ ] 共通コンポーネントが表示される
- [ ] ランチャーページで接続一覧が表示される
- [ ] 接続フォームで作成・編集・削除が可能
- [ ] 接続テストが成功する
- [ ] Tauri IPC通信が成功する

---

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|-------|------|
| プロジェクトマネージャー | | | |
| 技術リード | | | |
| フロントエンド担当 | | | |
| バックエンド担当 | | | |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|--------|
| 1.0 | 2025-12-12 | 初版作成 | Claude |

---

**次のアクション**:
1. 本設計書のレビュー・承認
2. サブフェーズ2.1から順次実装開始
3. 完了後、Phase 3の設計書作成へ進む
