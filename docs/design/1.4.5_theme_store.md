# タスク1.4.5: テーマStore実装 設計書

## 概要

**タスクID**: 1.4.5
**タスク名**: テーマStore実装
**工数**: 0.5日
**依存関係**: 1.4.2 (テーマ切り替え機能実装)
**完了条件**: テーマ状態が管理される

---

## 目的

Piniaを使用してテーマの状態管理を実装する。現在のテーマ、テーマ設定、ユーザー設定を一元管理し、アプリケーション全体で共有できるようにする。

---

## 機能要件

### 主要機能

1. **テーマ状態の管理**
   - 現在のテーマ
   - テーマ設定のキャッシュ

2. **テーマ設定の永続化**
   - localStorageへの保存
   - アプリケーション起動時の復元

3. **テーマ切り替えAPI**
   - プログラムからのテーマ変更
   - テーマ情報の取得

4. **ウィンドウ別テーマ管理**
   - 各ウィンドウのテーマを独立管理
   - ウィンドウIDとテーマの紐付け

---

## アーキテクチャ

### ストア構成

```
src/stores/
├── connection.ts     # 接続管理ストア (既存)
├── theme.ts         # テーマ管理ストア (新規)
└── types.ts         # 共通型定義
```

---

## 型定義

### types.ts への追加

**ファイル**: `src/stores/types.ts`

```typescript
import type { ThemeType } from '@/types/theme';

/**
 * テーマストアの状態
 */
export interface ThemeStoreState {
  currentTheme: ThemeType;
  defaultTheme: ThemeType;
  windowThemes: Record<string, ThemeType>;  // ウィンドウID -> テーマのマップ
  preferences: ThemePreferences;
}

/**
 * テーマ設定
 */
export interface ThemePreferences {
  enableAnimations: boolean;          // アニメーション有効/無効
  showWarningBanner: boolean;         // 警告バナー表示
  autoSwitchTheme: boolean;           // 自動テーマ切り替え
  customColors?: Record<ThemeType, CustomThemeColors>;  // カスタムカラー (将来拡張)
}

/**
 * カスタムテーマカラー (将来拡張用)
 */
export interface CustomThemeColors {
  primary?: string;
  secondary?: string;
  background?: string;
}
```

---

## テーマストア実装

### theme.ts

**ファイル**: `src/stores/theme.ts`

```typescript
import { defineStore } from 'pinia';
import { useTheme as useVuetifyTheme } from 'vuetify';
import type { ThemeType } from '@/types/theme';
import type { ThemeStoreState, ThemePreferences } from './types';
import { THEME_COLORS } from '@/types/theme';

const STORAGE_KEY_THEME = 'app-theme-preferences';

export const useThemeStore = defineStore('theme', {
  state: (): ThemeStoreState => ({
    currentTheme: 'development',
    defaultTheme: 'development',
    windowThemes: {},
    preferences: {
      enableAnimations: true,
      showWarningBanner: true,
      autoSwitchTheme: true,
    },
  }),

  getters: {
    /**
     * 現在のテーマ情報
     */
    currentThemeInfo(state) {
      return THEME_COLORS[state.currentTheme];
    },

    /**
     * 現在のテーマがプロダクションかどうか
     */
    isProductionTheme(state): boolean {
      return state.currentTheme === 'production';
    },

    /**
     * 現在のテーマがステージングかどうか
     */
    isStagingTheme(state): boolean {
      return state.currentTheme === 'staging';
    },

    /**
     * 警告が必要な環境かどうか
     */
    needsWarning(state): boolean {
      return state.currentTheme === 'production' || state.currentTheme === 'staging';
    },

    /**
     * 警告バナーを表示するかどうか
     */
    shouldShowWarning(state): boolean {
      return state.preferences.showWarningBanner && this.needsWarning;
    },

    /**
     * アニメーションが有効かどうか
     */
    animationsEnabled(state): boolean {
      return state.preferences.enableAnimations;
    },

    /**
     * 指定されたウィンドウのテーマを取得
     */
    getWindowTheme: (state) => (windowId: string): ThemeType => {
      return state.windowThemes[windowId] || state.defaultTheme;
    },
  },

  actions: {
    /**
     * テーマを設定
     */
    setTheme(theme: ThemeType) {
      if (!this.isValidTheme(theme)) {
        console.warn(`Invalid theme: ${theme}, falling back to default`);
        this.currentTheme = this.defaultTheme;
        return;
      }

      this.currentTheme = theme;

      // Vuetifyのテーマを更新
      const vuetifyTheme = useVuetifyTheme();
      vuetifyTheme.global.name.value = theme;
    },

    /**
     * ウィンドウ別にテーマを設定
     */
    setWindowTheme(windowId: string, theme: ThemeType) {
      if (!this.isValidTheme(theme)) {
        console.warn(`Invalid theme for window ${windowId}: ${theme}`);
        return;
      }

      this.windowThemes[windowId] = theme;
      this.setTheme(theme);
    },

    /**
     * デフォルトテーマを設定
     */
    setDefaultTheme(theme: ThemeType) {
      if (!this.isValidTheme(theme)) {
        console.warn(`Invalid default theme: ${theme}`);
        return;
      }

      this.defaultTheme = theme;
      this.savePreferences();
    },

    /**
     * テーマをリセット
     */
    resetTheme() {
      this.setTheme(this.defaultTheme);
    },

    /**
     * ウィンドウテーマをクリア
     */
    clearWindowTheme(windowId: string) {
      delete this.windowThemes[windowId];
    },

    /**
     * すべてのウィンドウテーマをクリア
     */
    clearAllWindowThemes() {
      this.windowThemes = {};
    },

    /**
     * 設定を更新
     */
    updatePreferences(preferences: Partial<ThemePreferences>) {
      this.preferences = {
        ...this.preferences,
        ...preferences,
      };
      this.savePreferences();
    },

    /**
     * 警告バナー表示を切り替え
     */
    toggleWarningBanner() {
      this.preferences.showWarningBanner = !this.preferences.showWarningBanner;
      this.savePreferences();
    },

    /**
     * アニメーション有効/無効を切り替え
     */
    toggleAnimations() {
      this.preferences.enableAnimations = !this.preferences.enableAnimations;
      this.savePreferences();
    },

    /**
     * 設定をlocalStorageに保存
     */
    savePreferences() {
      try {
        const data = {
          defaultTheme: this.defaultTheme,
          preferences: this.preferences,
        };
        localStorage.setItem(STORAGE_KEY_THEME, JSON.stringify(data));
      } catch (error) {
        console.error('Failed to save theme preferences:', error);
      }
    },

    /**
     * 設定をlocalStorageから読み込み
     */
    loadPreferences() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY_THEME);
        if (!saved) return;

        const data = JSON.parse(saved);

        if (data.defaultTheme && this.isValidTheme(data.defaultTheme)) {
          this.defaultTheme = data.defaultTheme;
        }

        if (data.preferences) {
          this.preferences = {
            ...this.preferences,
            ...data.preferences,
          };
        }
      } catch (error) {
        console.error('Failed to load theme preferences:', error);
      }
    },

    /**
     * テーマが有効かどうかをチェック
     */
    isValidTheme(theme: string): theme is ThemeType {
      return ['development', 'test', 'staging', 'production'].includes(theme);
    },

    /**
     * 初期化
     */
    initialize() {
      this.loadPreferences();
      this.setTheme(this.defaultTheme);
    },
  },
});
```

---

## Composableの作成

### useTheme.ts の拡張

**ファイル**: `src/composables/useTheme.ts` (更新)

Piniaストアを使用するように更新:

```typescript
import { computed } from 'vue';
import { useThemeStore } from '@/stores/theme';
import type { ThemeType } from '@/types/theme';
import { THEME_COLORS } from '@/types/theme';

/**
 * テーマ管理コンポーザブル
 */
export function useTheme() {
  const store = useThemeStore();

  /**
   * 現在のテーマ
   */
  const currentTheme = computed({
    get: () => store.currentTheme,
    set: (value: ThemeType) => store.setTheme(value),
  });

  /**
   * 現在のテーマ情報
   */
  const currentThemeInfo = computed(() => store.currentThemeInfo);

  /**
   * プライマリーカラー
   */
  const primaryColor = computed(() => currentThemeInfo.value.primary);

  /**
   * バックグラウンドカラー
   */
  const backgroundColor = computed(() => currentThemeInfo.value.background);

  /**
   * 環境に応じてテーマを設定
   */
  const setThemeByEnvironment = (environment: ThemeType) => {
    if (store.preferences.autoSwitchTheme) {
      store.setTheme(environment);
    }
  };

  /**
   * ウィンドウ別にテーマを設定
   */
  const setWindowTheme = (windowId: string, theme: ThemeType) => {
    store.setWindowTheme(windowId, theme);
  };

  /**
   * テーマをリセット
   */
  const resetTheme = () => {
    store.resetTheme();
  };

  /**
   * テーマ情報を取得
   */
  const getThemeInfo = (themeName: ThemeType) => {
    return THEME_COLORS[themeName];
  };

  return {
    // 状態
    currentTheme,
    currentThemeInfo,
    primaryColor,
    backgroundColor,

    // ゲッター
    isProductionTheme: computed(() => store.isProductionTheme),
    isStagingTheme: computed(() => store.isStagingTheme),
    needsWarning: computed(() => store.needsWarning),
    shouldShowWarning: computed(() => store.shouldShowWarning),
    animationsEnabled: computed(() => store.animationsEnabled),

    // アクション
    setThemeByEnvironment,
    setWindowTheme,
    resetTheme,
    getThemeInfo,

    // 設定
    updatePreferences: store.updatePreferences,
    toggleWarningBanner: store.toggleWarningBanner,
    toggleAnimations: store.toggleAnimations,

    // ストアの参照
    store,
  };
}
```

---

## アプリケーション初期化

### app.vue または main.ts での初期化

**ファイル**: `src/App.vue`

```vue
<script setup lang="ts">
import { onMounted } from 'vue';
import { useThemeStore } from '@/stores/theme';

const themeStore = useThemeStore();

// アプリケーション起動時にテーマストアを初期化
onMounted(() => {
  themeStore.initialize();
});
</script>

<template>
  <router-view />
</template>
```

---

## 使用例

### クエリビルダー画面での使用

```vue
<script setup lang="ts">
import { onMounted, computed } from 'vue';
import { useRoute } from 'vue-router';
import { useTheme } from '@/composables/useTheme';
import { useConnectionStore } from '@/stores/connection';

const route = useRoute();
const { setWindowTheme } = useTheme();
const connectionStore = useConnectionStore();

const connectionId = computed(() => route.query.connectionId as string);
const connection = computed(() =>
  connectionStore.getConnectionById(connectionId.value)
);

onMounted(() => {
  if (connection.value) {
    // ウィンドウIDとテーマを紐付け
    const windowId = `window-${connectionId.value}`;
    setWindowTheme(windowId, connection.value.environment);
  }
});
</script>
```

### 設定画面での使用

```vue
<script setup lang="ts">
import { useTheme } from '@/composables/useTheme';

const {
  shouldShowWarning,
  animationsEnabled,
  toggleWarningBanner,
  toggleAnimations,
  updatePreferences,
} = useTheme();

const handleSavePreferences = () => {
  updatePreferences({
    enableAnimations: true,
    showWarningBanner: true,
  });
};
</script>

<template>
  <v-container>
    <v-switch
      :model-value="shouldShowWarning"
      @update:model-value="toggleWarningBanner"
      label="警告バナーを表示"
    ></v-switch>

    <v-switch
      :model-value="animationsEnabled"
      @update:model-value="toggleAnimations"
      label="アニメーションを有効化"
    ></v-switch>
  </v-container>
</template>
```

---

## テスト設計

### ユニットテスト

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { setActivePinia, createPinia } from 'pinia';
import { useThemeStore } from '@/stores/theme';

describe('ThemeStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
    localStorage.clear();
  });

  it('should initialize with default theme', () => {
    const store = useThemeStore();
    expect(store.currentTheme).toBe('development');
  });

  it('should set theme', () => {
    const store = useThemeStore();
    store.setTheme('production');
    expect(store.currentTheme).toBe('production');
    expect(store.isProductionTheme).toBe(true);
  });

  it('should detect warning environments', () => {
    const store = useThemeStore();

    store.setTheme('production');
    expect(store.needsWarning).toBe(true);

    store.setTheme('staging');
    expect(store.needsWarning).toBe(true);

    store.setTheme('development');
    expect(store.needsWarning).toBe(false);
  });

  it('should save and load preferences', () => {
    const store = useThemeStore();

    store.updatePreferences({
      enableAnimations: false,
      showWarningBanner: false,
    });

    // 新しいストアインスタンスを作成
    setActivePinia(createPinia());
    const newStore = useThemeStore();
    newStore.loadPreferences();

    expect(newStore.preferences.enableAnimations).toBe(false);
    expect(newStore.preferences.showWarningBanner).toBe(false);
  });

  it('should manage window themes', () => {
    const store = useThemeStore();

    store.setWindowTheme('window-1', 'production');
    store.setWindowTheme('window-2', 'development');

    expect(store.getWindowTheme('window-1')).toBe('production');
    expect(store.getWindowTheme('window-2')).toBe('development');

    store.clearWindowTheme('window-1');
    expect(store.getWindowTheme('window-1')).toBe(store.defaultTheme);
  });

  it('should toggle preferences', () => {
    const store = useThemeStore();

    const initialWarning = store.preferences.showWarningBanner;
    store.toggleWarningBanner();
    expect(store.preferences.showWarningBanner).toBe(!initialWarning);

    const initialAnimation = store.preferences.enableAnimations;
    store.toggleAnimations();
    expect(store.preferences.enableAnimations).toBe(!initialAnimation);
  });
});
```

---

## パフォーマンス最適化

### メモ化

- `computed` プロパティで自動メモ化
- 不要な再計算を防ぐ

### localStorageの最適化

```typescript
// デバウンスを使用して保存頻度を制限
import { debounce } from 'lodash-es';

const debouncedSave = debounce(() => {
  this.savePreferences();
}, 500);

// 設定更新時
updatePreferences(preferences: Partial<ThemePreferences>) {
  this.preferences = { ...this.preferences, ...preferences };
  debouncedSave();
}
```

---

## エラーハンドリング

### localStorageエラー

```typescript
savePreferences() {
  try {
    const data = {
      defaultTheme: this.defaultTheme,
      preferences: this.preferences,
    };
    localStorage.setItem(STORAGE_KEY_THEME, JSON.stringify(data));
  } catch (error) {
    // QuotaExceededErrorなどをハンドリング
    if (error instanceof DOMException && error.name === 'QuotaExceededError') {
      console.error('LocalStorage quota exceeded');
      // 古いデータを削除するなどの対応
    } else {
      console.error('Failed to save theme preferences:', error);
    }
  }
}
```

---

## 実装チェックリスト

- [ ] `src/stores/theme.ts` の作成
- [ ] `src/stores/types.ts` への型定義追加
- [ ] `src/composables/useTheme.ts` の更新
- [ ] アプリケーション初期化処理の実装
- [ ] localStorage永続化の実装
- [ ] ユニットテストの作成
- [ ] エラーハンドリングの実装

---

## 参考資料

- [Pinia Store](https://pinia.vuejs.org/core-concepts/)
- [Vuetify Theme](https://vuetifyjs.com/en/features/theme/)
- [Web Storage API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API)
