# タスク1.4.3: 環境色設定UI実装 設計書

## 概要

**タスクID**: 1.4.3
**タスク名**: 環境色設定UI実装
**工数**: 1日
**依存関係**: 1.3.3 (接続設定フォームUI実装)
**完了条件**: 接続設定で色選択可能

---

## 目的

接続設定フォームに環境タイプと環境色を選択するUIを追加する。ユーザーが直感的に環境を設定でき、各環境に対応するテーマカラーを視覚的に確認できるようにする。

---

## 機能要件

### 主要機能

1. **環境タイプ選択**
   - 4つの環境（開発・テスト・ステージング・本番）から選択
   - ラジオボタンまたはセレクトボックスで選択

2. **環境色プレビュー**
   - 選択した環境のテーマカラーをリアルタイムプレビュー
   - プライマリーカラー、バックグラウンドカラーを表示

3. **カスタムカラー設定（将来拡張）**
   - デフォルトのテーマカラーをカスタマイズ可能
   - カラーピッカーでの色選択

---

## 画面設計

### 接続設定フォームへの追加項目

```
┌─────────────────────────────────────────┐
│ 接続設定                                 │
├─────────────────────────────────────────┤
│ 接続名: [________________]              │
│                                         │
│ 環境タイプ: ◉ 開発環境                   │
│            ○ テスト環境                  │
│            ○ ステージング環境             │
│            ○ 本番環境                    │
│                                         │
│ 環境色プレビュー:                        │
│ ┌─────────────────────────────────┐    │
│ │  プライマリーカラー:  ■ #4CAF50   │    │
│ │  バックグラウンド:    ■ #F1F8E9   │    │
│ └─────────────────────────────────┘    │
│                                         │
│ ホスト: [________________]              │
│ ポート: [____]                          │
│ ...                                     │
│                                         │
│       [キャンセル]  [保存]              │
└─────────────────────────────────────────┘
```

---

## コンポーネント設計

### 1. EnvironmentSelector.vue

**配置場所**: `src/components/connection/EnvironmentSelector.vue`

#### 責務
- 環境タイプの選択UI
- 環境ごとのアイコンと説明表示
- 選択した環境の色プレビュー

#### Props
```typescript
interface EnvironmentSelectorProps {
  modelValue: Environment;     // 選択中の環境
  disabled?: boolean;          // 無効化フラグ
}
```

#### Emits
```typescript
interface EnvironmentSelectorEmits {
  (e: 'update:modelValue', value: Environment): void;
}
```

#### コンポーネント実装

```vue
<script setup lang="ts">
import { computed } from 'vue';
import type { Environment } from '@/stores/types';
import { THEME_COLORS } from '@/types/theme';

const props = withDefaults(
  defineProps<EnvironmentSelectorProps>(),
  {
    disabled: false,
  }
);

const emit = defineEmits<EnvironmentSelectorEmits>();

// 環境選択肢
const environmentOptions = [
  {
    value: 'development' as Environment,
    title: '開発環境',
    icon: 'mdi-code-tags',
    description: '開発・デバッグ用の環境',
  },
  {
    value: 'test' as Environment,
    title: 'テスト環境',
    icon: 'mdi-test-tube',
    description: '機能テスト・品質検証用の環境',
  },
  {
    value: 'staging' as Environment,
    title: 'ステージング環境',
    icon: 'mdi-server-network',
    description: '本番前の最終確認用環境',
  },
  {
    value: 'production' as Environment,
    title: '本番環境',
    icon: 'mdi-database-alert',
    description: '実運用環境 - 慎重な操作が必要',
  },
];

// 選択中の環境情報
const selectedEnvironmentInfo = computed(() => {
  return THEME_COLORS[props.modelValue];
});

// 環境変更ハンドラー
const handleChange = (value: Environment) => {
  emit('update:modelValue', value);
};
</script>

<template>
  <div class="environment-selector">
    <!-- タイトル -->
    <v-label class="mb-2">
      環境タイプ
      <span class="text-error">*</span>
    </v-label>

    <!-- 環境選択ラジオボタン -->
    <v-radio-group
      :model-value="modelValue"
      @update:model-value="handleChange"
      :disabled="disabled"
      class="mb-4"
    >
      <v-radio
        v-for="option in environmentOptions"
        :key="option.value"
        :value="option.value"
        :color="THEME_COLORS[option.value].primary"
      >
        <template #label>
          <div class="d-flex align-center">
            <v-icon
              :color="THEME_COLORS[option.value].primary"
              class="mr-2"
            >
              {{ option.icon }}
            </v-icon>
            <div>
              <div class="font-weight-medium">{{ option.title }}</div>
              <div class="text-caption text-grey-darken-1">
                {{ option.description }}
              </div>
            </div>
          </div>
        </template>
      </v-radio>
    </v-radio-group>

    <!-- 環境色プレビュー -->
    <EnvironmentColorPreview :environment="modelValue" />
  </div>
</template>

<style scoped>
.environment-selector {
  /* スタイル定義 */
}

.v-radio :deep(.v-label) {
  opacity: 1 !important;
}
</style>
```

---

### 2. EnvironmentColorPreview.vue

**配置場所**: `src/components/connection/EnvironmentColorPreview.vue`

#### 責務
- 選択された環境のテーマカラープレビュー
- プライマリー、セカンダリー、バックグラウンドカラーの表示

#### Props
```typescript
interface EnvironmentColorPreviewProps {
  environment: Environment;
}
```

#### コンポーネント実装

```vue
<script setup lang="ts">
import { computed } from 'vue';
import type { Environment } from '@/stores/types';
import { THEME_COLORS } from '@/types/theme';

const props = defineProps<EnvironmentColorPreviewProps>();

// 環境カラー情報
const colorInfo = computed(() => {
  return THEME_COLORS[props.environment];
});
</script>

<template>
  <v-card
    variant="outlined"
    class="environment-color-preview"
  >
    <v-card-title class="text-subtitle-2">
      <v-icon size="small" class="mr-2">mdi-palette</v-icon>
      環境色プレビュー
    </v-card-title>

    <v-card-text>
      <v-row dense>
        <!-- プライマリーカラー -->
        <v-col cols="12">
          <div class="color-item">
            <div class="color-label text-caption">プライマリーカラー</div>
            <div class="d-flex align-center">
              <div
                class="color-swatch"
                :style="{ backgroundColor: colorInfo.primary }"
              ></div>
              <v-chip
                size="small"
                variant="outlined"
                class="ml-2"
              >
                {{ colorInfo.primary }}
              </v-chip>
            </div>
          </div>
        </v-col>

        <!-- セカンダリーカラー -->
        <v-col cols="12">
          <div class="color-item">
            <div class="color-label text-caption">セカンダリーカラー</div>
            <div class="d-flex align-center">
              <div
                class="color-swatch"
                :style="{ backgroundColor: colorInfo.secondary }"
              ></div>
              <v-chip
                size="small"
                variant="outlined"
                class="ml-2"
              >
                {{ colorInfo.secondary }}
              </v-chip>
            </div>
          </div>
        </v-col>

        <!-- バックグラウンドカラー -->
        <v-col cols="12">
          <div class="color-item">
            <div class="color-label text-caption">バックグラウンドカラー</div>
            <div class="d-flex align-center">
              <div
                class="color-swatch"
                :style="{ backgroundColor: colorInfo.background }"
              ></div>
              <v-chip
                size="small"
                variant="outlined"
                class="ml-2"
              >
                {{ colorInfo.background }}
              </v-chip>
            </div>
          </div>
        </v-col>
      </v-row>

      <!-- プレビューサンプル -->
      <v-divider class="my-3"></v-divider>

      <div class="preview-sample">
        <div class="text-caption mb-2">表示イメージ</div>
        <v-sheet
          :color="colorInfo.background"
          rounded
          class="pa-3"
        >
          <v-btn
            :color="colorInfo.primary"
            size="small"
            variant="elevated"
          >
            サンプルボタン
          </v-btn>
        </v-sheet>
      </div>
    </v-card-text>
  </v-card>
</template>

<style scoped>
.environment-color-preview {
  max-width: 400px;
}

.color-item {
  margin-bottom: 12px;
}

.color-label {
  margin-bottom: 4px;
  color: rgba(0, 0, 0, 0.6);
}

.color-swatch {
  width: 40px;
  height: 40px;
  border-radius: 4px;
  border: 1px solid rgba(0, 0, 0, 0.12);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.preview-sample {
  margin-top: 8px;
}
</style>
```

---

### 3. ConnectionForm.vueへの統合

**ファイル**: `src/components/connection/ConnectionForm.vue`

既存の接続設定フォームに環境選択UIを追加:

```vue
<script setup lang="ts">
import { ref, computed } from 'vue';
import type { Connection, Environment } from '@/stores/types';
import EnvironmentSelector from './EnvironmentSelector.vue';

const props = defineProps<{
  mode: 'create' | 'edit';
  connection?: Connection;
}>();

const emit = defineEmits<{
  (e: 'save', connection: Connection): void;
  (e: 'cancel'): void;
}>();

// フォームデータ
const formData = ref<Partial<Connection>>({
  name: props.connection?.name || '',
  environment: props.connection?.environment || 'development',
  host: props.connection?.host || 'localhost',
  port: props.connection?.port || 5432,
  database: props.connection?.database || '',
  username: props.connection?.username || '',
  password: '',
  dbType: props.connection?.dbType || 'postgresql',
  ssl: props.connection?.ssl || false,
});

// バリデーション
const isValid = computed(() => {
  return !!(
    formData.value.name &&
    formData.value.environment &&
    formData.value.host &&
    formData.value.port &&
    formData.value.database &&
    formData.value.username
  );
});

// 保存ハンドラー
const handleSave = () => {
  if (isValid.value) {
    emit('save', formData.value as Connection);
  }
};
</script>

<template>
  <v-form @submit.prevent="handleSave">
    <v-container>
      <!-- 基本情報 -->
      <v-row>
        <v-col cols="12">
          <v-text-field
            v-model="formData.name"
            label="接続名"
            required
            variant="outlined"
            prepend-inner-icon="mdi-label"
          ></v-text-field>
        </v-col>
      </v-row>

      <!-- 環境タイプ選択 -->
      <v-row>
        <v-col cols="12">
          <EnvironmentSelector
            v-model="formData.environment"
          />
        </v-col>
      </v-row>

      <v-divider class="my-4"></v-divider>

      <!-- データベース接続情報 -->
      <v-row>
        <v-col cols="12" md="8">
          <v-text-field
            v-model="formData.host"
            label="ホスト"
            required
            variant="outlined"
            prepend-inner-icon="mdi-server"
          ></v-text-field>
        </v-col>

        <v-col cols="12" md="4">
          <v-text-field
            v-model.number="formData.port"
            label="ポート"
            type="number"
            required
            variant="outlined"
          ></v-text-field>
        </v-col>
      </v-row>

      <!-- ... その他のフィールド ... -->

      <!-- アクションボタン -->
      <v-row class="mt-4">
        <v-col>
          <v-btn
            variant="text"
            @click="$emit('cancel')"
          >
            キャンセル
          </v-btn>
          <v-btn
            type="submit"
            color="primary"
            :disabled="!isValid"
            class="ml-2"
          >
            {{ mode === 'create' ? '作成' : '更新' }}
          </v-btn>
        </v-col>
      </v-row>
    </v-container>
  </v-form>
</template>
```

---

## データモデル

### 接続データへの環境情報追加

```typescript
// src/stores/types.ts (既存の拡張)

export interface Connection {
  id: string;
  name: string;
  environment: Environment;      // 環境タイプ (必須)
  themeColor: string;            // テーマカラー (自動設定)
  // ... その他のフィールド
}

export type Environment = 'development' | 'test' | 'staging' | 'production';
```

---

## バリデーション

### 環境タイプのバリデーション

```typescript
// src/utils/validation.ts

export function validateEnvironment(environment: string): environment is Environment {
  const validEnvironments: Environment[] = ['development', 'test', 'staging', 'production'];
  return validEnvironments.includes(environment as Environment);
}

export function validateConnection(connection: Partial<Connection>): string[] {
  const errors: string[] = [];

  if (!connection.name || connection.name.trim() === '') {
    errors.push('接続名は必須です');
  }

  if (!connection.environment || !validateEnvironment(connection.environment)) {
    errors.push('有効な環境タイプを選択してください');
  }

  if (!connection.host || connection.host.trim() === '') {
    errors.push('ホストは必須です');
  }

  if (!connection.port || connection.port <= 0 || connection.port > 65535) {
    errors.push('有効なポート番号を入力してください');
  }

  if (!connection.database || connection.database.trim() === '') {
    errors.push('データベース名は必須です');
  }

  if (!connection.username || connection.username.trim() === '') {
    errors.push('ユーザー名は必須です');
  }

  return errors;
}
```

---

## 将来拡張: カスタムカラー設定

### CustomColorPicker.vue (Phase 2で実装予定)

```vue
<script setup lang="ts">
import { ref } from 'vue';

const props = defineProps<{
  modelValue: string;
  label: string;
}>();

const emit = defineEmits<{
  (e: 'update:modelValue', value: string): void;
}>();

const showPicker = ref(false);
</script>

<template>
  <div class="custom-color-picker">
    <v-label>{{ label }}</v-label>
    <div class="d-flex align-center mt-2">
      <div
        class="color-preview"
        :style="{ backgroundColor: modelValue }"
        @click="showPicker = true"
      ></div>
      <v-text-field
        :model-value="modelValue"
        @update:model-value="$emit('update:modelValue', $event)"
        variant="outlined"
        density="compact"
        class="ml-2"
        hide-details
      ></v-text-field>
    </div>

    <!-- カラーピッカーダイアログ -->
    <v-dialog v-model="showPicker" max-width="400">
      <v-card>
        <v-card-title>カラー選択</v-card-title>
        <v-card-text>
          <v-color-picker
            :model-value="modelValue"
            @update:model-value="$emit('update:modelValue', $event)"
            mode="hex"
          ></v-color-picker>
        </v-card-text>
        <v-card-actions>
          <v-btn @click="showPicker = false">閉じる</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<style scoped>
.color-preview {
  width: 40px;
  height: 40px;
  border-radius: 4px;
  border: 1px solid rgba(0, 0, 0, 0.12);
  cursor: pointer;
}
</style>
```

---

## テスト設計

### ユニットテスト

```typescript
import { describe, it, expect } from 'vitest';
import { mount } from '@vue/test-utils';
import EnvironmentSelector from '@/components/connection/EnvironmentSelector.vue';
import { createVuetify } from 'vuetify';

describe('EnvironmentSelector', () => {
  const vuetify = createVuetify();

  it('should render all environment options', () => {
    const wrapper = mount(EnvironmentSelector, {
      global: {
        plugins: [vuetify],
      },
      props: {
        modelValue: 'development',
      },
    });

    const radios = wrapper.findAll('.v-radio');
    expect(radios).toHaveLength(4);
  });

  it('should emit update:modelValue when selection changes', async () => {
    const wrapper = mount(EnvironmentSelector, {
      global: {
        plugins: [vuetify],
      },
      props: {
        modelValue: 'development',
      },
    });

    // プロダクション環境を選択
    const productionRadio = wrapper.findAll('.v-radio')[3];
    await productionRadio.trigger('click');

    expect(wrapper.emitted('update:modelValue')).toBeTruthy();
    expect(wrapper.emitted('update:modelValue')?.[0]).toEqual(['production']);
  });
});
```

### E2Eテスト

```typescript
import { test, expect } from '@playwright/test';

test.describe('Environment Color Settings UI', () => {
  test('should display environment selector in connection form', async ({ page }) => {
    await page.goto('/connections/new');

    // 環境選択ラジオボタンが表示されているか
    const environmentRadios = page.locator('.v-radio');
    await expect(environmentRadios).toHaveCount(4);
  });

  test('should update color preview when environment changes', async ({ page }) => {
    await page.goto('/connections/new');

    // 本番環境を選択
    await page.click('text=本番環境');

    // プレビューが赤色に変わるか
    const preview = page.locator('.environment-color-preview');
    const primaryColor = await preview.locator('.color-swatch').first().evaluate((el) =>
      window.getComputedStyle(el).backgroundColor
    );

    expect(primaryColor).toContain('244, 67, 54'); // #F44336のRGB値
  });
});
```

---

## アクセシビリティ

### キーボード操作

- **Tab**: ラジオボタン間の移動
- **矢印キー**: ラジオボタン選択
- **Space**: 選択の確定

### ARIA属性

```vue
<v-radio-group
  role="radiogroup"
  aria-label="環境タイプ選択"
>
  <v-radio
    v-for="option in environmentOptions"
    :key="option.value"
    :aria-label="option.title"
    :aria-describedby="`${option.value}-description`"
  >
  </v-radio>
</v-radio-group>
```

---

## 実装チェックリスト

- [ ] `EnvironmentSelector.vue` の作成
- [ ] `EnvironmentColorPreview.vue` の作成
- [ ] `ConnectionForm.vue` への統合
- [ ] バリデーションロジックの実装
- [ ] ユニットテストの作成
- [ ] E2Eテストの作成
- [ ] アクセシビリティのテスト
- [ ] レスポンシブデザインの確認

---

## パフォーマンス考慮事項

### リアルタイムプレビューの最適化

- `computed` プロパティでメモ化
- 不要な再レンダリングを防ぐ

---

## 参考資料

- [Vuetify Radio Buttons](https://vuetifyjs.com/en/components/radio-buttons/)
- [Vuetify Color Picker](https://vuetifyjs.com/en/components/color-pickers/)
- [Material Design Color System](https://m3.material.io/styles/color/overview)
