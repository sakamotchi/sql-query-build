# タスク1.6.7: クエリオブジェクトモデル定義 設計書

## 概要

**タスクID**: 1.6.7
**タスク名**: クエリオブジェクトモデル定義
**工数**: 1日
**依存関係**: なし
**完了条件**: JSON形式でクエリ表現

---

## 目的

GUIで構築されたクエリをJSON形式のオブジェクトモデルとして表現する。このモデルは以下の用途に使用される：

1. フロントエンドでの状態管理
2. バックエンドへのクエリ情報送信
3. クエリの保存・読み込み
4. SQL生成エンジンへの入力

---

## クエリオブジェクトモデル

### 完全なクエリモデル

```typescript
/**
 * クエリモデル（完全版）
 */
export interface QueryModel {
  /** クエリID（保存時に使用） */
  id?: string;
  /** クエリ名（保存時に使用） */
  name?: string;
  /** クエリの説明（保存時に使用） */
  description?: string;
  /** 接続ID */
  connectionId: string;
  /** SELECT句 */
  select: SelectClause;
  /** FROM句 */
  from: FromClause;
  /** JOIN句 */
  joins: JoinClause[];
  /** WHERE句 */
  where: WhereClause | null;
  /** GROUP BY句 */
  groupBy: GroupByClause | null;
  /** HAVING句 */
  having: HavingClause | null;
  /** ORDER BY句 */
  orderBy: OrderByClause | null;
  /** LIMIT/OFFSET */
  limit: LimitClause | null;
  /** 作成日時 */
  createdAt?: string;
  /** 更新日時 */
  updatedAt?: string;
}
```

---

### SELECT句

```typescript
/**
 * SELECT句
 */
export interface SelectClause {
  /** DISTINCT */
  distinct: boolean;
  /** 選択カラム */
  columns: SelectColumn[];
}

/**
 * 選択カラム
 */
export interface SelectColumn {
  /** カラムタイプ */
  type: 'column' | 'expression' | 'aggregate' | 'all';
  /** テーブルエイリアス（type: 'column' | 'all' の場合） */
  tableAlias?: string;
  /** カラム名（type: 'column' の場合） */
  columnName?: string;
  /** 式（type: 'expression' の場合） */
  expression?: string;
  /** 集計関数（type: 'aggregate' の場合） */
  aggregate?: AggregateFunction;
  /** 出力エイリアス（AS句） */
  alias?: string | null;
}

/**
 * 集計関数
 */
export interface AggregateFunction {
  /** 関数名 */
  function: 'COUNT' | 'SUM' | 'AVG' | 'MIN' | 'MAX' | 'COUNT_DISTINCT';
  /** 対象カラム */
  column: {
    tableAlias: string;
    columnName: string;
  } | '*';
}
```

---

### FROM句

```typescript
/**
 * FROM句
 */
export interface FromClause {
  /** メインテーブル */
  table: TableReference;
}

/**
 * テーブル参照
 */
export interface TableReference {
  /** スキーマ名 */
  schema: string;
  /** テーブル名 */
  name: string;
  /** エイリアス */
  alias: string;
}
```

---

### JOIN句

```typescript
/**
 * JOIN句
 */
export interface JoinClause {
  /** JOIN ID */
  id: string;
  /** JOIN種別 */
  type: 'INNER' | 'LEFT' | 'RIGHT' | 'FULL' | 'CROSS';
  /** 結合テーブル */
  table: TableReference;
  /** 結合条件 */
  conditions: JoinCondition[];
  /** 条件の結合方法 */
  conditionLogic: 'AND' | 'OR';
}

/**
 * JOIN条件
 */
export interface JoinCondition {
  /** 左側（元テーブル） */
  left: {
    tableAlias: string;
    columnName: string;
  };
  /** 演算子 */
  operator: '=' | '!=' | '>' | '>=' | '<' | '<=';
  /** 右側（結合テーブル） */
  right: {
    tableAlias: string;
    columnName: string;
  };
}
```

---

### WHERE句

```typescript
/**
 * WHERE句
 */
export interface WhereClause {
  /** 条件の結合方法 */
  logic: 'AND' | 'OR';
  /** 条件リスト */
  conditions: WhereConditionItem[];
}

/**
 * WHERE条件アイテム（条件またはグループ）
 */
export type WhereConditionItem = WhereCondition | WhereConditionGroup;

/**
 * WHERE条件
 */
export interface WhereCondition {
  /** タイプ */
  type: 'condition';
  /** 条件ID */
  id: string;
  /** カラム */
  column: {
    tableAlias: string;
    columnName: string;
  };
  /** 演算子 */
  operator: WhereOperator;
  /** 値 */
  value: WhereValue;
}

/**
 * WHERE演算子
 */
export type WhereOperator =
  | '='
  | '!='
  | '<>'
  | '>'
  | '>='
  | '<'
  | '<='
  | 'LIKE'
  | 'NOT LIKE'
  | 'ILIKE'
  | 'NOT ILIKE'
  | 'IN'
  | 'NOT IN'
  | 'BETWEEN'
  | 'NOT BETWEEN'
  | 'IS NULL'
  | 'IS NOT NULL';

/**
 * WHERE値
 */
export type WhereValue =
  | { type: 'literal'; value: string | number | boolean | null }
  | { type: 'list'; values: Array<string | number> }
  | { type: 'range'; from: string | number; to: string | number }
  | { type: 'column'; tableAlias: string; columnName: string }
  | { type: 'subquery'; query: QueryModel };

/**
 * 条件グループ
 */
export interface WhereConditionGroup {
  /** タイプ */
  type: 'group';
  /** グループID */
  id: string;
  /** グループ内の結合方法 */
  logic: 'AND' | 'OR';
  /** 条件リスト */
  conditions: WhereConditionItem[];
}
```

---

### GROUP BY句

```typescript
/**
 * GROUP BY句
 */
export interface GroupByClause {
  /** グループ化カラム */
  columns: GroupByColumn[];
}

/**
 * グループ化カラム
 */
export interface GroupByColumn {
  /** テーブルエイリアス */
  tableAlias: string;
  /** カラム名 */
  columnName: string;
}
```

---

### HAVING句

```typescript
/**
 * HAVING句
 */
export interface HavingClause {
  /** 条件の結合方法 */
  logic: 'AND' | 'OR';
  /** 条件リスト */
  conditions: HavingCondition[];
}

/**
 * HAVING条件
 */
export interface HavingCondition {
  /** 条件ID */
  id: string;
  /** 集計関数 */
  aggregate: AggregateFunction;
  /** 演算子 */
  operator: WhereOperator;
  /** 値 */
  value: string | number;
}
```

---

### ORDER BY句

```typescript
/**
 * ORDER BY句
 */
export interface OrderByClause {
  /** ソート項目 */
  items: OrderByItem[];
}

/**
 * ソート項目
 */
export interface OrderByItem {
  /** テーブルエイリアス */
  tableAlias: string;
  /** カラム名 */
  columnName: string;
  /** ソート順 */
  direction: 'ASC' | 'DESC';
  /** NULL値の位置（PostgreSQL） */
  nulls?: 'FIRST' | 'LAST';
}
```

---

### LIMIT/OFFSET句

```typescript
/**
 * LIMIT/OFFSET句
 */
export interface LimitClause {
  /** 取得件数 */
  limit: number;
  /** オフセット */
  offset?: number;
}
```

---

## フロントエンド用簡易モデル

フロントエンドの状態管理では、より操作しやすい形式を使用する：

```typescript
/**
 * フロントエンド用クエリ状態
 */
export interface QueryBuilderState {
  /** 選択されたテーブル */
  selectedTables: SelectedTable[];
  /** 選択されたカラム */
  selectedColumns: SelectedColumn[];
  /** WHERE条件 */
  whereConditions: Array<WhereCondition | WhereConditionGroup>;
  /** WHERE条件の結合方法 */
  whereLogic: 'AND' | 'OR';
  /** GROUP BY カラム（フェーズ2） */
  groupByColumns: GroupByColumn[];
  /** HAVING条件（フェーズ2） */
  havingConditions: HavingCondition[];
  /** ORDER BY項目（フェーズ2） */
  orderByItems: OrderByItem[];
  /** LIMIT（フェーズ2） */
  limit: number | null;
  /** OFFSET（フェーズ2） */
  offset: number | null;
  /** DISTINCT */
  distinct: boolean;
  /** JOIN設定（フェーズ2） */
  joins: JoinClause[];
}

/**
 * 選択されたテーブル
 */
export interface SelectedTable {
  /** 一意識別子 */
  id: string;
  /** スキーマ名 */
  schema: string;
  /** テーブル名 */
  name: string;
  /** エイリアス */
  alias: string;
  /** カラム情報 */
  columns: Column[];
}

/**
 * 選択されたカラム
 */
export interface SelectedColumn {
  /** テーブルID */
  tableId: string;
  /** テーブルエイリアス */
  tableAlias: string;
  /** カラム名 */
  columnName: string;
  /** カラムエイリアス（AS句） */
  columnAlias: string | null;
  /** データ型 */
  dataType: string;
}
```

---

## 変換関数

### フロントエンド状態からクエリモデルへの変換

```typescript
/**
 * フロントエンド状態からクエリモデルに変換
 */
export function convertToQueryModel(
  state: QueryBuilderState,
  connectionId: string
): QueryModel {
  // メインテーブル（最初のテーブル）
  const mainTable = state.selectedTables[0];
  if (!mainTable) {
    throw new Error('No table selected');
  }

  return {
    connectionId,
    select: {
      distinct: state.distinct,
      columns: convertSelectedColumns(state.selectedColumns),
    },
    from: {
      table: {
        schema: mainTable.schema,
        name: mainTable.name,
        alias: mainTable.alias,
      },
    },
    joins: state.joins,
    where: convertWhereConditions(state.whereConditions, state.whereLogic),
    groupBy: state.groupByColumns.length > 0
      ? { columns: state.groupByColumns }
      : null,
    having: state.havingConditions.length > 0
      ? { logic: 'AND', conditions: state.havingConditions }
      : null,
    orderBy: state.orderByItems.length > 0
      ? { items: state.orderByItems }
      : null,
    limit: state.limit
      ? { limit: state.limit, offset: state.offset || undefined }
      : null,
  };
}

/**
 * 選択カラムを変換
 */
function convertSelectedColumns(columns: SelectedColumn[]): SelectColumn[] {
  return columns.map((col) => ({
    type: 'column' as const,
    tableAlias: col.tableAlias,
    columnName: col.columnName,
    alias: col.columnAlias,
  }));
}

/**
 * WHERE条件を変換
 */
function convertWhereConditions(
  conditions: Array<WhereCondition | WhereConditionGroup>,
  logic: 'AND' | 'OR'
): WhereClause | null {
  // 有効な条件のみフィルタ
  const validConditions = conditions.filter((c) => {
    if (c.type === 'condition') {
      return c.column !== null;
    }
    return c.conditions.length > 0;
  });

  if (validConditions.length === 0) {
    return null;
  }

  return {
    logic,
    conditions: validConditions.map(convertWhereConditionItem),
  };
}

/**
 * WHERE条件アイテムを変換
 */
function convertWhereConditionItem(
  item: WhereCondition | WhereConditionGroup
): WhereConditionItem {
  if (item.type === 'group') {
    return {
      type: 'group',
      id: item.id,
      logic: item.logic,
      conditions: item.conditions.map(convertWhereConditionItem),
    };
  }

  return {
    type: 'condition',
    id: item.id,
    column: item.column!,
    operator: item.operator,
    value: convertWhereValue(item.value, item.operator),
  };
}

/**
 * WHERE値を変換
 */
function convertWhereValue(
  value: string | string[] | { from: string; to: string },
  operator: WhereOperator
): WhereValue {
  if (operator === 'IS NULL' || operator === 'IS NOT NULL') {
    return { type: 'literal', value: null };
  }

  if (operator === 'IN' || operator === 'NOT IN') {
    return {
      type: 'list',
      values: (value as string[]).map(parseValue),
    };
  }

  if (operator === 'BETWEEN' || operator === 'NOT BETWEEN') {
    const range = value as { from: string; to: string };
    return {
      type: 'range',
      from: parseValue(range.from),
      to: parseValue(range.to),
    };
  }

  return { type: 'literal', value: parseValue(value as string) };
}

/**
 * 値をパース（数値判定）
 */
function parseValue(value: string): string | number {
  const num = Number(value);
  return isNaN(num) ? value : num;
}
```

---

## JSONスキーマ

クエリモデルのJSONスキーマ（バリデーション用）:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "QueryModel",
  "type": "object",
  "required": ["connectionId", "select", "from"],
  "properties": {
    "id": { "type": "string" },
    "name": { "type": "string" },
    "connectionId": { "type": "string" },
    "select": {
      "type": "object",
      "required": ["distinct", "columns"],
      "properties": {
        "distinct": { "type": "boolean" },
        "columns": {
          "type": "array",
          "items": { "$ref": "#/definitions/SelectColumn" }
        }
      }
    },
    "from": {
      "type": "object",
      "required": ["table"],
      "properties": {
        "table": { "$ref": "#/definitions/TableReference" }
      }
    },
    "joins": {
      "type": "array",
      "items": { "$ref": "#/definitions/JoinClause" }
    },
    "where": {
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/definitions/WhereClause" }
      ]
    },
    "groupBy": {
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/definitions/GroupByClause" }
      ]
    },
    "orderBy": {
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/definitions/OrderByClause" }
      ]
    },
    "limit": {
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/definitions/LimitClause" }
      ]
    }
  },
  "definitions": {
    "TableReference": {
      "type": "object",
      "required": ["schema", "name", "alias"],
      "properties": {
        "schema": { "type": "string" },
        "name": { "type": "string" },
        "alias": { "type": "string" }
      }
    },
    "SelectColumn": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "enum": ["column", "expression", "aggregate", "all"] },
        "tableAlias": { "type": "string" },
        "columnName": { "type": "string" },
        "expression": { "type": "string" },
        "alias": { "type": ["string", "null"] }
      }
    },
    "WhereClause": {
      "type": "object",
      "required": ["logic", "conditions"],
      "properties": {
        "logic": { "enum": ["AND", "OR"] },
        "conditions": { "type": "array" }
      }
    },
    "GroupByClause": {
      "type": "object",
      "required": ["columns"],
      "properties": {
        "columns": { "type": "array" }
      }
    },
    "OrderByClause": {
      "type": "object",
      "required": ["items"],
      "properties": {
        "items": { "type": "array" }
      }
    },
    "LimitClause": {
      "type": "object",
      "required": ["limit"],
      "properties": {
        "limit": { "type": "integer", "minimum": 0 },
        "offset": { "type": "integer", "minimum": 0 }
      }
    },
    "JoinClause": {
      "type": "object",
      "required": ["id", "type", "table", "conditions"],
      "properties": {
        "id": { "type": "string" },
        "type": { "enum": ["INNER", "LEFT", "RIGHT", "FULL", "CROSS"] },
        "table": { "$ref": "#/definitions/TableReference" },
        "conditions": { "type": "array" }
      }
    }
  }
}
```

---

## サンプルJSON

### 基本的なSELECT

```json
{
  "connectionId": "conn-123",
  "select": {
    "distinct": false,
    "columns": [
      {
        "type": "column",
        "tableAlias": "u",
        "columnName": "id",
        "alias": null
      },
      {
        "type": "column",
        "tableAlias": "u",
        "columnName": "name",
        "alias": null
      },
      {
        "type": "column",
        "tableAlias": "u",
        "columnName": "email",
        "alias": null
      }
    ]
  },
  "from": {
    "table": {
      "schema": "public",
      "name": "users",
      "alias": "u"
    }
  },
  "joins": [],
  "where": null,
  "groupBy": null,
  "having": null,
  "orderBy": null,
  "limit": null
}
```

生成されるSQL:
```sql
SELECT u.id, u.name, u.email
FROM public.users u
```

---

### WHERE条件付き

```json
{
  "connectionId": "conn-123",
  "select": {
    "distinct": false,
    "columns": [
      {
        "type": "column",
        "tableAlias": "u",
        "columnName": "id",
        "alias": null
      },
      {
        "type": "column",
        "tableAlias": "u",
        "columnName": "name",
        "alias": null
      }
    ]
  },
  "from": {
    "table": {
      "schema": "public",
      "name": "users",
      "alias": "u"
    }
  },
  "joins": [],
  "where": {
    "logic": "AND",
    "conditions": [
      {
        "type": "condition",
        "id": "cond-1",
        "column": {
          "tableAlias": "u",
          "columnName": "status"
        },
        "operator": "=",
        "value": {
          "type": "literal",
          "value": "active"
        }
      },
      {
        "type": "condition",
        "id": "cond-2",
        "column": {
          "tableAlias": "u",
          "columnName": "age"
        },
        "operator": ">=",
        "value": {
          "type": "literal",
          "value": 18
        }
      }
    ]
  },
  "groupBy": null,
  "having": null,
  "orderBy": null,
  "limit": null
}
```

生成されるSQL:
```sql
SELECT u.id, u.name
FROM public.users u
WHERE u.status = 'active'
  AND u.age >= 18
```

---

### ネストされたWHERE条件

```json
{
  "connectionId": "conn-123",
  "select": {
    "distinct": false,
    "columns": [
      { "type": "all", "tableAlias": "u" }
    ]
  },
  "from": {
    "table": {
      "schema": "public",
      "name": "users",
      "alias": "u"
    }
  },
  "joins": [],
  "where": {
    "logic": "AND",
    "conditions": [
      {
        "type": "condition",
        "id": "cond-1",
        "column": {
          "tableAlias": "u",
          "columnName": "status"
        },
        "operator": "=",
        "value": { "type": "literal", "value": "active" }
      },
      {
        "type": "group",
        "id": "group-1",
        "logic": "OR",
        "conditions": [
          {
            "type": "condition",
            "id": "cond-2",
            "column": {
              "tableAlias": "u",
              "columnName": "role"
            },
            "operator": "=",
            "value": { "type": "literal", "value": "admin" }
          },
          {
            "type": "condition",
            "id": "cond-3",
            "column": {
              "tableAlias": "u",
              "columnName": "role"
            },
            "operator": "=",
            "value": { "type": "literal", "value": "manager" }
          }
        ]
      }
    ]
  },
  "groupBy": null,
  "having": null,
  "orderBy": null,
  "limit": null
}
```

生成されるSQL:
```sql
SELECT u.*
FROM public.users u
WHERE u.status = 'active'
  AND (u.role = 'admin' OR u.role = 'manager')
```

---

## Rust側の型定義

```rust
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryModel {
    pub connection_id: String,
    pub select: SelectClause,
    pub from: FromClause,
    pub joins: Vec<JoinClause>,
    pub where_clause: Option<WhereClause>,
    pub group_by: Option<GroupByClause>,
    pub having: Option<HavingClause>,
    pub order_by: Option<OrderByClause>,
    pub limit: Option<LimitClause>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SelectClause {
    pub distinct: bool,
    pub columns: Vec<SelectColumn>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(tag = "type")]
pub enum SelectColumn {
    #[serde(rename = "column")]
    Column {
        table_alias: String,
        column_name: String,
        alias: Option<String>,
    },
    #[serde(rename = "all")]
    All {
        table_alias: String,
    },
    #[serde(rename = "aggregate")]
    Aggregate {
        aggregate: AggregateFunction,
        alias: Option<String>,
    },
    #[serde(rename = "expression")]
    Expression {
        expression: String,
        alias: Option<String>,
    },
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct FromClause {
    pub table: TableReference,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TableReference {
    pub schema: String,
    pub name: String,
    pub alias: String,
}

// ... 他の型定義
```

---

## テスト設計

### ユニットテスト

```typescript
describe('QueryModel', () => {
  describe('convertToQueryModel', () => {
    it('should convert basic select', () => {
      // 基本的なSELECTの変換
    });

    it('should convert with WHERE conditions', () => {
      // WHERE条件付きの変換
    });

    it('should convert nested WHERE groups', () => {
      // ネストされたWHEREグループの変換
    });

    it('should handle empty state', () => {
      // 空状態のハンドリング
    });
  });

  describe('JSON Schema validation', () => {
    it('should validate correct model', () => {
      // 正しいモデルのバリデーション
    });

    it('should reject invalid model', () => {
      // 不正なモデルの拒否
    });
  });
});
```

---

## 実装チェックリスト

- [ ] `src/types/query.ts` の作成・更新
  - [ ] QueryModel型定義
  - [ ] SelectClause型定義
  - [ ] FromClause型定義
  - [ ] JoinClause型定義
  - [ ] WhereClause型定義
  - [ ] GroupByClause型定義
  - [ ] OrderByClause型定義
  - [ ] LimitClause型定義
- [ ] `src/utils/query-converter.ts` の作成
  - [ ] convertToQueryModel関数
  - [ ] 各句の変換関数
- [ ] `src-tauri/src/models/query.rs` の作成
  - [ ] Rust側の型定義
  - [ ] シリアライズ/デシリアライズ
- [ ] JSONスキーマの作成
- [ ] ユニットテストの作成

---

## 参考資料

- [JSON Schema](https://json-schema.org/)
- [TypeScript Utility Types](https://www.typescriptlang.org/docs/handbook/utility-types.html)
- [Serde (Rust)](https://serde.rs/)
