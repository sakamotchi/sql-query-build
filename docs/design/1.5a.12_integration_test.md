# 1.5a.12 セキュリティ機能統合テスト

## 概要

| 項目 | 内容 |
|------|------|
| タスクID | 1.5a.12 |
| タスク名 | セキュリティ機能統合テスト |
| 担当 | BE/FE |
| 工数 | 2日 |
| 依存関係 | 1.5a.11 |
| 完了条件 | 全テストパス |

## 目的

セキュリティプロバイダー機能全体の統合テストを実施し、各コンポーネントが正しく連携することを確認する。

## テスト対象

```
src-tauri/src/crypto/
├── security_provider.rs         # SecurityProviderトレイト
├── simple_provider.rs           # SimpleProvider
├── master_password_provider.rs  # MasterPasswordProvider
├── keychain_provider.rs         # KeychainProvider
├── credential_storage.rs        # CredentialStorage
├── security_config.rs           # SecurityConfigStorage
├── provider_switch.rs           # ProviderSwitcher
└── migration.rs                 # MigrationManager

src/
├── components/security/         # セキュリティUI
├── stores/security.ts           # セキュリティストア
└── api/security.ts              # セキュリティAPI
```

## テスト設計

### 統合テストモジュール

```rust
// src-tauri/tests/security_integration_tests.rs

use sql_query_build::crypto::*;
use tempfile::TempDir;
use std::sync::Arc;

/// テスト用のセットアップヘルパー
struct TestEnvironment {
    temp_dir: TempDir,
    file_storage: Arc<FileStorage>,
    provider_manager: Arc<RwLock<SecurityProviderManager>>,
    credential_storage: Arc<CredentialStorage>,
    config_storage: Arc<SecurityConfigStorage>,
}

impl TestEnvironment {
    async fn new() -> Self {
        let temp_dir = TempDir::new().unwrap();
        let file_storage = Arc::new(
            FileStorage::new(temp_dir.path().to_path_buf()).unwrap()
        );

        let config_storage = Arc::new(SecurityConfigStorage::new(file_storage.clone()));

        let provider_manager = Arc::new(RwLock::new(
            SecurityProviderManager::new(file_storage.clone()).await.unwrap()
        ));

        let credential_storage = Arc::new(
            CredentialStorage::new(file_storage.clone(), provider_manager.clone())
        );

        Self {
            temp_dir,
            file_storage,
            provider_manager,
            credential_storage,
            config_storage,
        }
    }

    async fn with_provider(provider_type: SecurityProviderType) -> Self {
        let env = Self::new().await;

        {
            let mut manager = env.provider_manager.write().await;
            manager.change_provider(provider_type).await.unwrap();
        }

        env
    }
}
```

### SimpleProvider統合テスト

```rust
mod simple_provider_tests {
    use super::*;

    #[tokio::test]
    async fn test_simple_provider_full_workflow() {
        let env = TestEnvironment::with_provider(SecurityProviderType::Simple).await;

        // 1. プロバイダーが自動初期化されていることを確認
        {
            let manager = env.provider_manager.read().await;
            assert_eq!(manager.provider_state(), ProviderState::Ready);
        }

        // 2. クレデンシャルを保存
        let connection_id = "conn_001";
        let password = "test_password_123";

        env.credential_storage.store(connection_id, password).await.unwrap();

        // 3. クレデンシャルを取得して一致を確認
        let retrieved = env.credential_storage.retrieve(connection_id).await.unwrap();
        assert_eq!(retrieved.as_deref(), Some(password));

        // 4. 設定が永続化されていることを確認
        let config = env.config_storage.load().await.unwrap();
        assert_eq!(config.provider_type, SecurityProviderType::Simple);
    }

    #[tokio::test]
    async fn test_simple_provider_persistence_across_restart() {
        let temp_dir = TempDir::new().unwrap();
        let connection_id = "conn_001";
        let password = "persistent_password";

        // セッション1: 保存
        {
            let file_storage = Arc::new(
                FileStorage::new(temp_dir.path().to_path_buf()).unwrap()
            );
            let provider_manager = Arc::new(RwLock::new(
                SecurityProviderManager::new(file_storage.clone()).await.unwrap()
            ));
            let credential_storage = Arc::new(
                CredentialStorage::new(file_storage.clone(), provider_manager.clone())
            );

            credential_storage.store(connection_id, password).await.unwrap();
        }

        // セッション2: 取得
        {
            let file_storage = Arc::new(
                FileStorage::new(temp_dir.path().to_path_buf()).unwrap()
            );
            let provider_manager = Arc::new(RwLock::new(
                SecurityProviderManager::new(file_storage.clone()).await.unwrap()
            ));
            let credential_storage = Arc::new(
                CredentialStorage::new(file_storage.clone(), provider_manager.clone())
            );

            let retrieved = credential_storage.retrieve(connection_id).await.unwrap();
            assert_eq!(retrieved.as_deref(), Some(password));
        }
    }
}
```

### MasterPasswordProvider統合テスト

```rust
mod master_password_provider_tests {
    use super::*;

    #[tokio::test]
    async fn test_master_password_full_workflow() {
        let env = TestEnvironment::new().await;
        let master_password = "SecurePassword123!";

        // 1. マスターパスワードプロバイダーに変更
        {
            let mut manager = env.provider_manager.write().await;
            manager.change_provider(SecurityProviderType::MasterPassword).await.unwrap();
        }

        // 2. 初期状態はロック状態
        {
            let manager = env.provider_manager.read().await;
            assert_eq!(manager.provider_state(), ProviderState::Locked);
        }

        // 3. マスターパスワードを設定
        {
            let mut manager = env.provider_manager.write().await;
            manager.setup_master_password(master_password).await.unwrap();
        }

        // 4. アンロック後はReady状態
        {
            let manager = env.provider_manager.read().await;
            assert_eq!(manager.provider_state(), ProviderState::Ready);
        }

        // 5. クレデンシャルを保存・取得
        let connection_id = "conn_001";
        let password = "db_password";

        env.credential_storage.store(connection_id, password).await.unwrap();
        let retrieved = env.credential_storage.retrieve(connection_id).await.unwrap();
        assert_eq!(retrieved.as_deref(), Some(password));
    }

    #[tokio::test]
    async fn test_master_password_lock_unlock_cycle() {
        let env = TestEnvironment::new().await;
        let master_password = "SecurePassword123!";
        let connection_id = "conn_001";
        let password = "db_password";

        // セットアップ
        {
            let mut manager = env.provider_manager.write().await;
            manager.change_provider(SecurityProviderType::MasterPassword).await.unwrap();
            manager.setup_master_password(master_password).await.unwrap();
        }

        // クレデンシャル保存
        env.credential_storage.store(connection_id, password).await.unwrap();

        // ロック
        {
            let mut manager = env.provider_manager.write().await;
            manager.lock().await.unwrap();
            assert_eq!(manager.provider_state(), ProviderState::Locked);
        }

        // ロック中はアクセス不可
        let result = env.credential_storage.retrieve(connection_id).await;
        assert!(result.is_err());

        // アンロック
        {
            let mut manager = env.provider_manager.write().await;
            manager.unlock_with_master_password(master_password).await.unwrap();
            assert_eq!(manager.provider_state(), ProviderState::Ready);
        }

        // アンロック後はアクセス可能
        let retrieved = env.credential_storage.retrieve(connection_id).await.unwrap();
        assert_eq!(retrieved.as_deref(), Some(password));
    }

    #[tokio::test]
    async fn test_master_password_wrong_password() {
        let env = TestEnvironment::new().await;
        let master_password = "CorrectPassword123!";
        let wrong_password = "WrongPassword123!";

        // セットアップ
        {
            let mut manager = env.provider_manager.write().await;
            manager.change_provider(SecurityProviderType::MasterPassword).await.unwrap();
            manager.setup_master_password(master_password).await.unwrap();
            manager.lock().await.unwrap();
        }

        // 間違ったパスワードでアンロック試行
        {
            let mut manager = env.provider_manager.write().await;
            let result = manager.unlock_with_master_password(wrong_password).await;
            assert!(result.is_err());
            assert_eq!(manager.provider_state(), ProviderState::Locked);
        }
    }

    #[tokio::test]
    async fn test_master_password_change() {
        let env = TestEnvironment::new().await;
        let old_password = "OldPassword123!";
        let new_password = "NewPassword456!";
        let connection_id = "conn_001";
        let db_password = "db_password";

        // セットアップとクレデンシャル保存
        {
            let mut manager = env.provider_manager.write().await;
            manager.change_provider(SecurityProviderType::MasterPassword).await.unwrap();
            manager.setup_master_password(old_password).await.unwrap();
        }
        env.credential_storage.store(connection_id, db_password).await.unwrap();

        // パスワード変更
        {
            let mut manager = env.provider_manager.write().await;
            manager.change_master_password(old_password, new_password).await.unwrap();
        }

        // 新しいパスワードでアンロック可能
        {
            let mut manager = env.provider_manager.write().await;
            manager.lock().await.unwrap();
            manager.unlock_with_master_password(new_password).await.unwrap();
        }

        // クレデンシャルが引き続きアクセス可能
        let retrieved = env.credential_storage.retrieve(connection_id).await.unwrap();
        assert_eq!(retrieved.as_deref(), Some(db_password));
    }
}
```

### プロバイダー切り替え統合テスト

```rust
mod provider_switch_tests {
    use super::*;

    #[tokio::test]
    async fn test_switch_simple_to_master_password() {
        let env = TestEnvironment::with_provider(SecurityProviderType::Simple).await;
        let connection_id = "conn_001";
        let password = "db_password";
        let master_password = "MasterPassword123!";

        // Simpleプロバイダーでクレデンシャル保存
        env.credential_storage.store(connection_id, password).await.unwrap();

        // MasterPasswordプロバイダーに切り替え
        let switcher = ProviderSwitcher::new(
            env.provider_manager.clone(),
            env.credential_storage.clone(),
            env.config_storage.clone(),
        );

        switcher.switch_to(
            SecurityProviderType::MasterPassword,
            Some(master_password.to_string()),
        ).await.unwrap();

        // クレデンシャルが引き続きアクセス可能
        let retrieved = env.credential_storage.retrieve(connection_id).await.unwrap();
        assert_eq!(retrieved.as_deref(), Some(password));

        // 設定が更新されていることを確認
        let config = env.config_storage.load().await.unwrap();
        assert_eq!(config.provider_type, SecurityProviderType::MasterPassword);
    }

    #[tokio::test]
    async fn test_switch_master_password_to_simple() {
        let env = TestEnvironment::new().await;
        let connection_id = "conn_001";
        let password = "db_password";
        let master_password = "MasterPassword123!";

        // MasterPasswordプロバイダーでセットアップ
        {
            let mut manager = env.provider_manager.write().await;
            manager.change_provider(SecurityProviderType::MasterPassword).await.unwrap();
            manager.setup_master_password(master_password).await.unwrap();
        }
        env.credential_storage.store(connection_id, password).await.unwrap();

        // Simpleプロバイダーに切り替え
        let switcher = ProviderSwitcher::new(
            env.provider_manager.clone(),
            env.credential_storage.clone(),
            env.config_storage.clone(),
        );

        switcher.switch_to(SecurityProviderType::Simple, None).await.unwrap();

        // クレデンシャルが引き続きアクセス可能
        let retrieved = env.credential_storage.retrieve(connection_id).await.unwrap();
        assert_eq!(retrieved.as_deref(), Some(password));
    }

    #[tokio::test]
    async fn test_switch_with_multiple_credentials() {
        let env = TestEnvironment::with_provider(SecurityProviderType::Simple).await;
        let master_password = "MasterPassword123!";

        // 複数のクレデンシャルを保存
        let credentials = vec![
            ("conn_001", "password1"),
            ("conn_002", "password2"),
            ("conn_003", "password3"),
        ];

        for (id, pwd) in &credentials {
            env.credential_storage.store(id, pwd).await.unwrap();
        }

        // プロバイダー切り替え
        let switcher = ProviderSwitcher::new(
            env.provider_manager.clone(),
            env.credential_storage.clone(),
            env.config_storage.clone(),
        );

        switcher.switch_to(
            SecurityProviderType::MasterPassword,
            Some(master_password.to_string()),
        ).await.unwrap();

        // 全てのクレデンシャルがアクセス可能
        for (id, pwd) in &credentials {
            let retrieved = env.credential_storage.retrieve(id).await.unwrap();
            assert_eq!(retrieved.as_deref(), Some(*pwd));
        }
    }

    #[tokio::test]
    async fn test_switch_rollback_on_failure() {
        // 切り替え失敗時のロールバック確認
        // TODO: エラーを注入してロールバックをテスト
    }
}
```

### マイグレーション統合テスト

```rust
mod migration_tests {
    use super::*;

    #[tokio::test]
    async fn test_full_migration_workflow() {
        let temp_dir = TempDir::new().unwrap();

        // 旧形式のデータを作成
        let legacy_connections = create_legacy_test_data(&temp_dir);

        // マイグレーション実行
        let file_storage = Arc::new(
            FileStorage::new(temp_dir.path().to_path_buf()).unwrap()
        );

        // MigrationManagerをセットアップ
        // ...

        let result = migration_manager.migrate().await.unwrap();

        if let MigrationResult::Success { migrated_count, errors, .. } = result {
            assert_eq!(migrated_count, legacy_connections.len() as u32);
            assert!(errors.is_empty());
        }

        // 移行後のデータが正しいことを確認
        // ...
    }

    #[tokio::test]
    async fn test_migration_idempotent() {
        // マイグレーションを2回実行しても問題ないことを確認
        let temp_dir = TempDir::new().unwrap();
        create_legacy_test_data(&temp_dir);

        // 1回目
        // ...
        let result1 = migration_manager.migrate().await.unwrap();
        assert!(matches!(result1, MigrationResult::Success { .. }));

        // 2回目
        let result2 = migration_manager.migrate().await.unwrap();
        assert!(matches!(result2, MigrationResult::AlreadyUpToDate));
    }

    fn create_legacy_test_data(temp_dir: &TempDir) -> Vec<LegacyConnectionInfo> {
        // テスト用の旧形式データを作成
        vec![]
    }
}
```

### E2Eテスト（フロントエンド）

```typescript
// tests/e2e/security.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Security Provider', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
  });

  test('should use Simple provider by default', async ({ page }) => {
    await page.click('[data-testid="settings-button"]');
    await page.click('[data-testid="security-tab"]');

    const activeProvider = page.locator('[data-testid="active-provider"]');
    await expect(activeProvider).toHaveText('Simple');
  });

  test('should switch to Master Password provider', async ({ page }) => {
    await page.click('[data-testid="settings-button"]');
    await page.click('[data-testid="security-tab"]');

    // Master Passwordを選択
    await page.click('[data-testid="provider-master-password"]');

    // パスワード設定ダイアログ
    await page.fill('[data-testid="new-password"]', 'SecurePassword123!');
    await page.fill('[data-testid="confirm-password"]', 'SecurePassword123!');
    await page.click('[data-testid="setup-button"]');

    // 切り替え完了確認
    const activeProvider = page.locator('[data-testid="active-provider"]');
    await expect(activeProvider).toHaveText('Master Password');
  });

  test('should require unlock after restart with Master Password', async ({ page }) => {
    // Master Passwordを設定済みの状態でアプリを再起動
    // アンロックダイアログが表示されることを確認

    const unlockDialog = page.locator('[data-testid="unlock-dialog"]');
    await expect(unlockDialog).toBeVisible();

    await page.fill('[data-testid="master-password-input"]', 'SecurePassword123!');
    await page.click('[data-testid="unlock-button"]');

    await expect(unlockDialog).not.toBeVisible();
  });

  test('should save and retrieve connection password', async ({ page }) => {
    // 接続を作成
    await page.click('[data-testid="new-connection"]');
    await page.fill('[data-testid="connection-name"]', 'Test DB');
    await page.fill('[data-testid="host"]', 'localhost');
    await page.fill('[data-testid="username"]', 'testuser');
    await page.fill('[data-testid="password"]', 'testpass');
    await page.click('[data-testid="save-connection"]');

    // 接続を編集して、パスワードが保持されていることを確認
    await page.click('[data-testid="connection-Test DB"]');
    await page.click('[data-testid="edit-connection"]');

    const passwordField = page.locator('[data-testid="password"]');
    // パスワードは「••••••••」のように表示される
    await expect(passwordField).toHaveAttribute('type', 'password');
  });
});
```

### パフォーマンステスト

```rust
mod performance_tests {
    use super::*;
    use std::time::Instant;

    #[tokio::test]
    async fn test_encryption_performance() {
        let env = TestEnvironment::with_provider(SecurityProviderType::Simple).await;

        let password = "test_password_for_performance";
        let iterations = 1000;

        let start = Instant::now();

        for i in 0..iterations {
            let id = format!("conn_{:04}", i);
            env.credential_storage.store(&id, password).await.unwrap();
        }

        let duration = start.elapsed();
        let per_operation = duration / iterations;

        println!("Total: {:?}, Per operation: {:?}", duration, per_operation);

        // 1操作あたり10ms以下であることを確認
        assert!(per_operation.as_millis() < 10);
    }

    #[tokio::test]
    async fn test_provider_switch_performance() {
        let env = TestEnvironment::with_provider(SecurityProviderType::Simple).await;

        // 100件のクレデンシャルを保存
        for i in 0..100 {
            let id = format!("conn_{:03}", i);
            env.credential_storage.store(&id, "password").await.unwrap();
        }

        let switcher = ProviderSwitcher::new(
            env.provider_manager.clone(),
            env.credential_storage.clone(),
            env.config_storage.clone(),
        );

        let start = Instant::now();

        switcher.switch_to(
            SecurityProviderType::MasterPassword,
            Some("MasterPassword123!".to_string()),
        ).await.unwrap();

        let duration = start.elapsed();

        println!("Provider switch with 100 credentials: {:?}", duration);

        // 5秒以下で完了することを確認
        assert!(duration.as_secs() < 5);
    }
}
```

### セキュリティテスト

```rust
mod security_tests {
    use super::*;

    #[tokio::test]
    async fn test_encrypted_data_format() {
        let env = TestEnvironment::with_provider(SecurityProviderType::Simple).await;

        let connection_id = "conn_001";
        let password = "sensitive_password";

        env.credential_storage.store(connection_id, password).await.unwrap();

        // ファイルから直接読み込んで、平文が含まれていないことを確認
        let file_content = std::fs::read_to_string(
            env.temp_dir.path().join("credentials.json")
        ).unwrap();

        assert!(!file_content.contains(password));
        assert!(file_content.contains("ciphertext"));
        assert!(file_content.contains("nonce"));
    }

    #[tokio::test]
    async fn test_memory_zeroization() {
        // パスワードがメモリからクリアされることを確認
        // 注: 実際のテストは困難なため、APIレベルでのテストに留める
    }

    #[tokio::test]
    async fn test_locked_provider_access_denied() {
        let env = TestEnvironment::new().await;
        let master_password = "MasterPassword123!";

        // セットアップ
        {
            let mut manager = env.provider_manager.write().await;
            manager.change_provider(SecurityProviderType::MasterPassword).await.unwrap();
            manager.setup_master_password(master_password).await.unwrap();
            manager.lock().await.unwrap();
        }

        // ロック中はすべての操作が失敗する
        let store_result = env.credential_storage.store("id", "password").await;
        assert!(store_result.is_err());

        let retrieve_result = env.credential_storage.retrieve("id").await;
        assert!(retrieve_result.is_err());

        let delete_result = env.credential_storage.delete("id").await;
        assert!(delete_result.is_err());
    }
}
```

## テスト実行

```bash
# すべての統合テストを実行
cargo test --test security_integration_tests

# 特定のモジュールのみ実行
cargo test --test security_integration_tests simple_provider_tests

# パフォーマンステストを実行（リリースビルドで）
cargo test --test security_integration_tests performance_tests --release

# E2Eテストを実行
npm run test:e2e -- --grep "Security Provider"
```

## 実装チェックリスト

- [ ] TestEnvironment セットアップ実装
- [ ] SimpleProvider統合テスト実装
- [ ] MasterPasswordProvider統合テスト実装
- [ ] プロバイダー切り替えテスト実装
- [ ] マイグレーションテスト実装
- [ ] E2Eテスト実装
- [ ] パフォーマンステスト実装
- [ ] セキュリティテスト実装
- [ ] CI/CDパイプラインへの統合

---

**作成日**: 2025-11-24
**作成者**: Claude Code
