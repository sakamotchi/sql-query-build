# タスク1.6.7: GROUP BY設定UI実装 設計書

## 概要

**タスクID**: 1.6.7
**タスク名**: GROUP BY設定UI実装
**工数**: 1日
**依存関係**: 1.6.5 (カラム選択UI実装)
**完了条件**: グループ化カラムの追加・並べ替え・削除が可能
**UIフレームワーク**: Nuxt UI v4（Tailwind CSS 4ベース）

---

## 目的

SELECT文のGROUP BY句を構築するUIを実装する。複数のカラムをリストに追加し、グループ化の順序を制御できるインターフェースを提供する。

---

## UI設計

### GROUP BYタブ

```
┌─────────────────────────────────────────────────────────────┐
│ [SELECT] [WHERE] [GROUP BY] [ORDER BY] [LIMIT]              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  GROUP BY条件                                 [+ カラム追加] │
│  ─────────────────────────────────────────────────────────  │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ::  u.role                                  [×]    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ::  u.status                                [×]    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  （ドラッグ＆ドロップで並べ替え可能）                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## コンポーネント設計

### ファイル構成

```
src/components/query-builder/
├── group-by/
│   ├── GroupByTab.vue            # GROUP BYタブ
│   └── GroupByRow.vue            # グループ化カラム行
└── ConditionTabs.vue             # タブコンテナ（更新）
```

---

### group-by/GroupByTab.vue

```vue
<script setup lang="ts">
import { computed } from 'vue'
import { useQueryBuilderStore } from '@/stores/query-builder'
import GroupByRow from './GroupByRow.vue'
import draggable from 'vuedraggable' // ドラッグ＆ドロップ用（要インストール検討）

const queryBuilderStore = useQueryBuilderStore()

// 選択されたテーブルがない場合
const isEmpty = computed(() => queryBuilderStore.selectedTables.length === 0)

// GROUP BYカラム
const groupByColumns = computed({
  get: () => queryBuilderStore.groupByColumns,
  set: (val) => queryBuilderStore.updateGroupByColumns(val)
})

// 利用可能な全カラム（WHEREタブと同様に生成）
const availableColumns = computed(() => {
  // ... (SelectedTablesから生成)
})

const addGroupByColumn = () => {
    queryBuilderStore.addGroupByColumn({
        id: crypto.randomUUID(),
        column: null
    })
}

const removeGroupByColumn = (id: string) => {
    queryBuilderStore.removeGroupByColumn(id)
}
</script>

<template>
  <div class="h-full flex flex-col">
    <div v-if="isEmpty" class="flex flex-col items-center justify-center h-full text-gray-500">
       <UIcon name="i-heroicons-table-cells" class="text-4xl mb-2" />
       <p>テーブルを選択してください</p>
    </div>

    <template v-else>
      <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800">
        <span class="text-sm font-medium">GROUP BY条件</span>
        <UButton
          label="カラム追加"
          icon="i-heroicons-plus"
          size="sm"
          variant="soft"
          @click="addGroupByColumn"
        />
      </div>

      <div class="p-4 overflow-y-auto flex-1">
        <!-- Draggableリスト -->
        <draggable 
           v-model="groupByColumns" 
           item-key="id"
           handle=".drag-handle"
           class="flex flex-col gap-2"
        >
          <template #item="{ element }">
             <GroupByRow 
                :item="element" 
                :available-columns="availableColumns"
                @remove="removeGroupByColumn(element.id)"
             />
          </template>
        </draggable>
      </div>
    </template>
  </div>
</template>
```

### group-by/GroupByRow.vue

```vue
<script setup lang="ts">
// Props: item (GroupByColumn), availableColumns
// Emits: update, remove
</script>

<template>
  <div class="flex items-center gap-2 p-2 border rounded bg-white dark:bg-gray-800">
     <!-- ドラッグハンドル -->
     <UIcon name="i-heroicons-bars-2" class="drag-handle cursor-move text-gray-400" />
     
     <!-- カラム選択 -->
     <div class="flex-1">
       <ColumnSelect 
         v-model="item.column" 
         :columns="availableColumns" 
       />
     </div>

     <!-- 削除ボタン -->
     <UButton icon="i-heroicons-x-mark" color="red" variant="ghost" size="sm" @click="$emit('remove')" />
  </div>
</template>
```
