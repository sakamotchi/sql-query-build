# 1.5a.9 マスターパスワード設定ダイアログ

## 概要

| 項目 | 内容 |
|------|------|
| タスクID | 1.5a.9 |
| タスク名 | マスターパスワード設定ダイアログ |
| 担当 | FE |
| 工数 | 1日 |
| 依存関係 | 1.5a.3 |
| 完了条件 | パスワード設定UI完成 |

## 目的

マスターパスワードプロバイダーを選択した際に、パスワードを設定するためのダイアログを実装する。

## コンポーネント

```
src/components/security/
├── MasterPasswordSetupDialog.vue  # パスワード設定ダイアログ
├── PasswordStrengthMeter.vue      # パスワード強度メーター
└── PasswordRequirements.vue       # パスワード要件表示
```

## 画面設計

### MasterPasswordSetupDialog.vue

```vue
<template>
  <v-dialog
    v-model="isOpen"
    max-width="500"
    persistent
  >
    <v-card>
      <v-card-title class="d-flex align-center">
        <v-icon start color="primary">mdi-key-plus</v-icon>
        マスターパスワードの設定
      </v-card-title>

      <v-card-text>
        <v-alert
          type="info"
          variant="tonal"
          class="mb-4"
        >
          <p class="mb-0">
            マスターパスワードは、データベース接続のパスワードを暗号化するために使用されます。
            <strong>このパスワードは絶対に忘れないでください。</strong>
            パスワードを忘れると、保存された接続情報にアクセスできなくなります。
          </p>
        </v-alert>

        <v-form ref="form" v-model="isFormValid">
          <!-- パスワード入力 -->
          <v-text-field
            v-model="password"
            :type="showPassword ? 'text' : 'password'"
            label="マスターパスワード"
            :rules="passwordRules"
            :append-inner-icon="showPassword ? 'mdi-eye-off' : 'mdi-eye'"
            @click:append-inner="showPassword = !showPassword"
            @input="onPasswordChange"
            autocomplete="new-password"
            class="mb-2"
          />

          <!-- パスワード強度メーター -->
          <PasswordStrengthMeter
            :password="password"
            :strength="passwordStrength"
            class="mb-4"
          />

          <!-- パスワード確認入力 -->
          <v-text-field
            v-model="passwordConfirm"
            :type="showPasswordConfirm ? 'text' : 'password'"
            label="パスワードの確認"
            :rules="confirmRules"
            :append-inner-icon="showPasswordConfirm ? 'mdi-eye-off' : 'mdi-eye'"
            @click:append-inner="showPasswordConfirm = !showPasswordConfirm"
            autocomplete="new-password"
            class="mb-4"
          />

          <!-- パスワード要件 -->
          <PasswordRequirements
            :password="password"
            class="mb-4"
          />
        </v-form>

        <v-alert
          v-if="error"
          type="error"
          variant="tonal"
          class="mb-0"
        >
          {{ error }}
        </v-alert>
      </v-card-text>

      <v-card-actions>
        <v-spacer />
        <v-btn
          variant="text"
          @click="onCancel"
          :disabled="isLoading"
        >
          キャンセル
        </v-btn>
        <v-btn
          color="primary"
          :loading="isLoading"
          :disabled="!isFormValid"
          @click="onSubmit"
        >
          設定する
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { securityApi } from '@/api/security';
import type { PasswordStrength, PasswordValidationResult } from '@/types/security';

const props = defineProps<{
  modelValue: boolean;
}>();

const emit = defineEmits<{
  'update:modelValue': [value: boolean];
  'success': [];
  'cancel': [];
}>();

const isOpen = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value),
});

const form = ref<HTMLFormElement | null>(null);
const password = ref('');
const passwordConfirm = ref('');
const showPassword = ref(false);
const showPasswordConfirm = ref(false);
const isFormValid = ref(false);
const isLoading = ref(false);
const error = ref<string | null>(null);
const passwordStrength = ref<PasswordStrength>('very_weak');

const passwordRules = [
  (v: string) => !!v || 'パスワードを入力してください',
  (v: string) => v.length >= 8 || '8文字以上で入力してください',
  (v: string) => v.length <= 128 || '128文字以下で入力してください',
];

const confirmRules = [
  (v: string) => !!v || 'パスワードを再入力してください',
  (v: string) => v === password.value || 'パスワードが一致しません',
];

const onPasswordChange = async () => {
  if (password.value.length > 0) {
    try {
      const result = await securityApi.checkPasswordStrength(password.value);
      passwordStrength.value = result.strength;
    } catch {
      // エラーは無視
    }
  } else {
    passwordStrength.value = 'very_weak';
  }
};

const onSubmit = async () => {
  if (!form.value?.validate()) return;

  isLoading.value = true;
  error.value = null;

  try {
    await securityApi.initializeMasterPassword(password.value, passwordConfirm.value);
    emit('success');
    isOpen.value = false;
  } catch (e) {
    error.value = e instanceof Error ? e.message : '設定に失敗しました';
  } finally {
    isLoading.value = false;
  }
};

const onCancel = () => {
  password.value = '';
  passwordConfirm.value = '';
  error.value = null;
  emit('cancel');
  isOpen.value = false;
};

// ダイアログを閉じる際にフォームをリセット
watch(isOpen, (value) => {
  if (!value) {
    password.value = '';
    passwordConfirm.value = '';
    error.value = null;
  }
});
</script>
```

### PasswordStrengthMeter.vue

```vue
<template>
  <div class="password-strength-meter">
    <div class="strength-bars d-flex mb-1">
      <div
        v-for="i in 5"
        :key="i"
        :class="['strength-bar', { active: i <= strengthLevel }]"
        :style="{ backgroundColor: i <= strengthLevel ? color : undefined }"
      />
    </div>
    <div class="d-flex justify-space-between">
      <span :class="['text-caption', `text-${textColor}`]">
        {{ strengthText }}
      </span>
      <span class="text-caption text-grey">
        {{ password.length }} 文字
      </span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import type { PasswordStrength } from '@/types/security';

const props = defineProps<{
  password: string;
  strength: PasswordStrength;
}>();

const strengthLevel = computed(() => {
  switch (props.strength) {
    case 'very_weak': return 1;
    case 'weak': return 2;
    case 'fair': return 3;
    case 'strong': return 4;
    case 'very_strong': return 5;
    default: return 0;
  }
});

const strengthText = computed(() => {
  switch (props.strength) {
    case 'very_weak': return 'とても弱い';
    case 'weak': return '弱い';
    case 'fair': return '普通';
    case 'strong': return '強い';
    case 'very_strong': return 'とても強い';
    default: return '';
  }
});

const color = computed(() => {
  switch (props.strength) {
    case 'very_weak': return '#f44336';
    case 'weak': return '#ff9800';
    case 'fair': return '#ffeb3b';
    case 'strong': return '#8bc34a';
    case 'very_strong': return '#4caf50';
    default: return '#e0e0e0';
  }
});

const textColor = computed(() => {
  switch (props.strength) {
    case 'very_weak': return 'error';
    case 'weak': return 'warning';
    case 'fair': return 'warning';
    case 'strong': return 'success';
    case 'very_strong': return 'success';
    default: return 'grey';
  }
});
</script>

<style scoped>
.strength-bars {
  gap: 4px;
}

.strength-bar {
  flex: 1;
  height: 4px;
  border-radius: 2px;
  background-color: #e0e0e0;
  transition: background-color 0.3s ease;
}
</style>
```

### PasswordRequirements.vue

```vue
<template>
  <div class="password-requirements">
    <div class="text-caption text-grey mb-2">パスワードの要件</div>
    <div
      v-for="req in requirements"
      :key="req.text"
      class="requirement-item d-flex align-center mb-1"
    >
      <v-icon
        :icon="req.met ? 'mdi-check-circle' : 'mdi-circle-outline'"
        :color="req.met ? 'success' : 'grey'"
        size="small"
        class="mr-2"
      />
      <span :class="['text-caption', req.met ? 'text-success' : 'text-grey']">
        {{ req.text }}
      </span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';

const props = defineProps<{
  password: string;
}>();

const requirements = computed(() => [
  {
    text: '8文字以上',
    met: props.password.length >= 8,
  },
  {
    text: '大文字を含む（推奨）',
    met: /[A-Z]/.test(props.password),
  },
  {
    text: '小文字を含む（推奨）',
    met: /[a-z]/.test(props.password),
  },
  {
    text: '数字を含む（推奨）',
    met: /[0-9]/.test(props.password),
  },
  {
    text: '記号を含む（推奨）',
    met: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(props.password),
  },
]);
</script>

<style scoped>
.requirement-item {
  transition: color 0.2s ease;
}
</style>
```

## テスト

```typescript
describe('MasterPasswordSetupDialog', () => {
  it('validates password length', async () => {
    const wrapper = mount(MasterPasswordSetupDialog, {
      props: { modelValue: true },
    });

    await wrapper.find('input').setValue('short');
    expect(wrapper.text()).toContain('8文字以上');
  });

  it('validates password match', async () => {
    const wrapper = mount(MasterPasswordSetupDialog, {
      props: { modelValue: true },
    });

    const inputs = wrapper.findAll('input');
    await inputs[0].setValue('password123');
    await inputs[1].setValue('different');

    expect(wrapper.text()).toContain('パスワードが一致しません');
  });

  it('shows password strength', async () => {
    const wrapper = mount(MasterPasswordSetupDialog, {
      props: { modelValue: true },
    });

    await wrapper.find('input').setValue('StrongP@ss123!');
    // 強度メーターが表示されることを確認
  });
});
```

## 実装チェックリスト

- [ ] `MasterPasswordSetupDialog.vue` 実装
- [ ] `PasswordStrengthMeter.vue` 実装
- [ ] `PasswordRequirements.vue` 実装
- [ ] パスワードバリデーション実装
- [ ] 強度チェックAPI連携
- [ ] エラーハンドリング
- [ ] コンポーネントテスト作成

---

**作成日**: 2025-11-24
**作成者**: Claude Code
