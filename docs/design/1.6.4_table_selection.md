# ã‚¿ã‚¹ã‚¯1.6.4: ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠæ©Ÿèƒ½å®Ÿè£… è¨­è¨ˆæ›¸

## æ¦‚è¦

**ã‚¿ã‚¹ã‚¯ID**: 1.6.4
**ã‚¿ã‚¹ã‚¯å**: ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠæ©Ÿèƒ½å®Ÿè£…
**å·¥æ•°**: 1æ—¥
**ä¾å­˜é–¢ä¿‚**: 1.6.3 (å·¦ãƒ‘ãƒãƒ« DBæ§‹é€ ãƒ„ãƒªãƒ¼å®Ÿè£…)
**å®Œäº†æ¡ä»¶**: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ
**UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Nuxt UI v4ï¼ˆTailwind CSS 4ãƒ™ãƒ¼ã‚¹ï¼‰

---

## ç›®çš„

DBæ§‹é€ ãƒ„ãƒªãƒ¼ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä¸­å¤®ãƒ‘ãƒãƒ«ã®ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚å›³ã‚¨ãƒªã‚¢ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã€ã‚¯ã‚¨ãƒªã§ä½¿ç”¨ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¯Nuxt UI v4ã®`<UCard>`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§è¡¨ç¤ºã•ã‚Œã€è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã®é¸æŠã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

---

## UIè¨­è¨ˆ

### ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚å›³ã‚¨ãƒªã‚¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚å›³                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚ ğŸ“‹ users      â”‚        â”‚ ğŸ“‹ departmentsâ”‚               â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚   â”‚ ğŸ”‘ id         â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ğŸ”‘ id         â”‚               â”‚
â”‚   â”‚ ğŸ“ name       â”‚        â”‚ ğŸ“ name       â”‚               â”‚
â”‚   â”‚ ğŸ“ email      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚   â”‚ ğŸ”— dept_id    â”‚                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                              â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                  â”‚ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—       â”‚                â”‚
â”‚                  â”‚ ã¾ãŸã¯ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯     â”‚                â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ users           [Ã—]  â”‚  â† ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«åã€å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Alias: u                â”‚  â† ã‚¨ã‚¤ãƒªã‚¢ã‚¹å…¥åŠ›
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”‘ id (integer)        â”‚  â† ã‚«ãƒ©ãƒ ãƒªã‚¹ãƒˆ
â”‚ ğŸ“ name (varchar)      â”‚
â”‚ ğŸ“ email (varchar)     â”‚
â”‚ ğŸ”— dept_id (integer)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/components/query-builder/
â”œâ”€â”€ TableRelationArea.vue     # ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚å›³ã‚¨ãƒªã‚¢
â”œâ”€â”€ table/
â”‚   â”œâ”€â”€ TableCard.vue         # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ TableCardHeader.vue   # ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼
â”‚   â”œâ”€â”€ TableCardColumn.vue   # ã‚«ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ è¡Œ
â”‚   â””â”€â”€ DropZone.vue          # ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
â””â”€â”€ CenterPanel.vue           # ä¸­å¤®ãƒ‘ãƒãƒ«ï¼ˆæ›´æ–°ï¼‰
```

---

### TableRelationArea.vue

```vue
<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { useQueryBuilderStore } from '@/stores/query-builder';
import TableCard from './table/TableCard.vue';
import DropZone from './table/DropZone.vue';
import type { Table } from '@/types/database-structure';
import type { SelectedTable } from '@/types/query';

const queryBuilderStore = useQueryBuilderStore();

// é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
const selectedTables = computed(() => queryBuilderStore.selectedTables);

// ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹
const isDragOver = ref(false);

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ï¼ˆè‡ªç”±é…ç½®ç”¨ï¼‰
const tablePositions = ref<Record<string, { x: number; y: number }>>({});

/**
 * ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
 */
const handleDragOver = (e: DragEvent) => {
  e.preventDefault();
  isDragOver.value = true;
};

/**
 * ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–å‡¦ç†
 */
const handleDragLeave = () => {
  isDragOver.value = false;
};

/**
 * ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
 */
const handleDrop = (e: DragEvent) => {
  e.preventDefault();
  isDragOver.value = false;

  const data = e.dataTransfer?.getData('application/json');
  if (!data) return;

  try {
    const parsed = JSON.parse(data);
    if (parsed.type === 'table') {
      addTable(parsed.data, e.offsetX, e.offsetY);
    }
  } catch (error) {
    console.error('Failed to parse drop data:', error);
  }
};

/**
 * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
 */
const addTable = (table: Table, x: number = 50, y: number = 50) => {
  // æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (selectedTables.value.some((t) => t.id === `${table.schema}.${table.name}`)) {
    return;
  }

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ç”Ÿæˆ
  const alias = generateAlias(table.name);

  const selectedTable: SelectedTable = {
    id: `${table.schema}.${table.name}`,
    schema: table.schema,
    name: table.name,
    alias,
    columns: table.columns,
  };

  queryBuilderStore.addTable(selectedTable);

  // ä½ç½®ã‚’è¨­å®š
  tablePositions.value[selectedTable.id] = { x, y };
};

/**
 * ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ç”Ÿæˆ
 */
const generateAlias = (tableName: string): string => {
  // æ—¢å­˜ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
  const existingAliases = new Set(
    selectedTables.value.map((t) => t.alias)
  );

  // ãƒ†ãƒ¼ãƒ–ãƒ«åã®å…ˆé ­æ–‡å­—ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
  let baseAlias = tableName.charAt(0).toLowerCase();

  // ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ã®å ´åˆã¯å„å˜èªã®å…ˆé ­æ–‡å­—ã‚’ä½¿ç”¨
  if (tableName.includes('_')) {
    baseAlias = tableName
      .split('_')
      .map((word) => word.charAt(0))
      .join('')
      .toLowerCase();
  }

  // é‡è¤‡ãŒãªã‘ã‚Œã°ãã®ã¾ã¾ä½¿ç”¨
  if (!existingAliases.has(baseAlias)) {
    return baseAlias;
  }

  // æ•°å­—ã‚’ä»˜ã‘ã¦é‡è¤‡ã‚’å›é¿
  let counter = 1;
  while (existingAliases.has(`${baseAlias}${counter}`)) {
    counter++;
  }
  return `${baseAlias}${counter}`;
};

/**
 * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
 */
const removeTable = (tableId: string) => {
  queryBuilderStore.removeTable(tableId);
  delete tablePositions.value[tableId];
};

/**
 * ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æ›´æ–°
 */
const updateAlias = (tableId: string, alias: string) => {
  queryBuilderStore.updateTableAlias(tableId, alias);
};

/**
 * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•
 */
const handleTableMove = (tableId: string, x: number, y: number) => {
  tablePositions.value[tableId] = { x, y };
};

/**
 * ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆDBæ§‹é€ ãƒ„ãƒªãƒ¼ã‹ã‚‰ï¼‰
 */
const handleTableDoubleClick = (table: Table) => {
  addTable(table);
};

// å¤–éƒ¨ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
defineExpose({
  addTable,
  handleTableDoubleClick,
});
</script>

<template>
  <div
    class="table-relation-area"
    :class="{ 'is-drag-over': isDragOver }"
    @dragover="handleDragOver"
    @dragleave="handleDragLeave"
    @drop="handleDrop"
  >
    <!-- ç©ºçŠ¶æ…‹ -->
    <DropZone v-if="selectedTables.length === 0" />

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ -->
    <template v-else>
      <TableCard
        v-for="table in selectedTables"
        :key="table.id"
        :table="table"
        :position="tablePositions[table.id]"
        @remove="removeTable"
        @update-alias="updateAlias"
        @move="handleTableMove"
      />
    </template>

    <!-- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ’ãƒ³ãƒˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹å ´åˆã‚‚è¡¨ç¤ºï¼‰ -->
    <div v-if="selectedTables.length > 0" class="drop-hint">
      <v-icon size="small" class="mr-1">mdi-plus</v-icon>
      ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦è¿½åŠ 
    </div>
  </div>
</template>

<style scoped>
.table-relation-area {
  position: relative;
  height: 100%;
  background: rgb(var(--v-theme-surface));
  overflow: auto;
  transition: background-color 0.2s;
}

.table-relation-area.is-drag-over {
  background: rgba(var(--v-theme-primary), 0.05);
}

.table-relation-area.is-drag-over::after {
  content: '';
  position: absolute;
  inset: 8px;
  border: 2px dashed rgb(var(--v-theme-primary));
  border-radius: 8px;
  pointer-events: none;
}

.drop-hint {
  position: absolute;
  bottom: 8px;
  right: 8px;
  display: flex;
  align-items: center;
  padding: 4px 8px;
  font-size: 0.75rem;
  color: rgb(var(--v-theme-on-surface-variant));
  background: rgb(var(--v-theme-surface));
  border-radius: 4px;
  opacity: 0.7;
}
</style>
```

---

### table/TableCard.vue

```vue
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import TableCardHeader from './TableCardHeader.vue';
import TableCardColumn from './TableCardColumn.vue';
import type { SelectedTable } from '@/types/query';
import type { Column } from '@/types/database-structure';

const props = defineProps<{
  table: SelectedTable;
  position?: { x: number; y: number };
}>();

const emit = defineEmits<{
  (e: 'remove', tableId: string): void;
  (e: 'update-alias', tableId: string, alias: string): void;
  (e: 'move', tableId: string, x: number, y: number): void;
  (e: 'select-column', column: Column): void;
}>();

const cardRef = ref<HTMLElement | null>(null);
const isDragging = ref(false);
const dragOffset = ref({ x: 0, y: 0 });

// ã‚«ãƒ¼ãƒ‰ä½ç½®
const cardStyle = computed(() => {
  if (!props.position) return {};
  return {
    left: `${props.position.x}px`,
    top: `${props.position.y}px`,
  };
});

// å±•é–‹çŠ¶æ…‹
const isExpanded = ref(true);

// è¡¨ç¤ºã™ã‚‹ã‚«ãƒ©ãƒ æ•°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿æ™‚ï¼‰
const maxCollapsedColumns = 5;

// è¡¨ç¤ºã™ã‚‹ã‚«ãƒ©ãƒ 
const displayedColumns = computed(() => {
  if (isExpanded.value) {
    return props.table.columns;
  }
  return props.table.columns.slice(0, maxCollapsedColumns);
});

// æ®‹ã‚Šã®ã‚«ãƒ©ãƒ æ•°
const remainingColumnCount = computed(() => {
  if (isExpanded.value) return 0;
  return Math.max(0, props.table.columns.length - maxCollapsedColumns);
});

/**
 * ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
 */
const handleMouseDown = (e: MouseEvent) => {
  if ((e.target as HTMLElement).closest('.no-drag')) return;

  isDragging.value = true;

  if (cardRef.value) {
    const rect = cardRef.value.getBoundingClientRect();
    dragOffset.value = {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top,
    };
  }

  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);
};

/**
 * ãƒ‰ãƒ©ãƒƒã‚°ä¸­
 */
const handleMouseMove = (e: MouseEvent) => {
  if (!isDragging.value || !cardRef.value) return;

  const parent = cardRef.value.parentElement;
  if (!parent) return;

  const parentRect = parent.getBoundingClientRect();
  const x = e.clientX - parentRect.left - dragOffset.value.x;
  const y = e.clientY - parentRect.top - dragOffset.value.y;

  // ç¯„å›²åˆ¶é™
  const maxX = parent.clientWidth - cardRef.value.offsetWidth;
  const maxY = parent.clientHeight - cardRef.value.offsetHeight;

  emit(
    'move',
    props.table.id,
    Math.max(0, Math.min(maxX, x)),
    Math.max(0, Math.min(maxY, y))
  );
};

/**
 * ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
 */
const handleMouseUp = () => {
  isDragging.value = false;
  document.removeEventListener('mousemove', handleMouseMove);
  document.removeEventListener('mouseup', handleMouseUp);
};

/**
 * å‰Šé™¤
 */
const handleRemove = () => {
  emit('remove', props.table.id);
};

/**
 * ã‚¨ã‚¤ãƒªã‚¢ã‚¹æ›´æ–°
 */
const handleAliasUpdate = (alias: string) => {
  emit('update-alias', props.table.id, alias);
};

/**
 * å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
 */
const toggleExpand = () => {
  isExpanded.value = !isExpanded.value;
};

/**
 * ã‚«ãƒ©ãƒ é¸æŠ
 */
const handleColumnClick = (column: Column) => {
  emit('select-column', column);
};
</script>

<template>
  <div
    ref="cardRef"
    class="table-card"
    :class="{ 'is-dragging': isDragging }"
    :style="cardStyle"
    @mousedown="handleMouseDown"
  >
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <TableCardHeader
      :table-name="table.name"
      :alias="table.alias"
      :is-expanded="isExpanded"
      class="no-drag"
      @remove="handleRemove"
      @update-alias="handleAliasUpdate"
      @toggle-expand="toggleExpand"
    />

    <!-- ã‚«ãƒ©ãƒ ãƒªã‚¹ãƒˆ -->
    <div v-if="isExpanded || displayedColumns.length > 0" class="column-list">
      <TableCardColumn
        v-for="column in displayedColumns"
        :key="column.name"
        :column="column"
        class="no-drag"
        @click="handleColumnClick(column)"
      />

      <!-- æ®‹ã‚Šã®ã‚«ãƒ©ãƒ æ•°è¡¨ç¤º -->
      <div
        v-if="remainingColumnCount > 0"
        class="remaining-count no-drag"
        @click="toggleExpand"
      >
        +{{ remainingColumnCount }} more columns
      </div>
    </div>
  </div>
</template>

<style scoped>
.table-card {
  position: absolute;
  min-width: 180px;
  max-width: 280px;
  background: rgb(var(--v-theme-surface));
  border: 1px solid rgba(var(--v-border-color), var(--v-border-opacity));
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  cursor: move;
  user-select: none;
  z-index: 1;
}

.table-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.table-card.is-dragging {
  opacity: 0.8;
  z-index: 100;
  cursor: grabbing;
}

.column-list {
  max-height: 300px;
  overflow-y: auto;
  border-top: 1px solid rgba(var(--v-border-color), var(--v-border-opacity));
}

.remaining-count {
  padding: 6px 12px;
  font-size: 0.75rem;
  color: rgb(var(--v-theme-primary));
  text-align: center;
  cursor: pointer;
}

.remaining-count:hover {
  background: rgba(var(--v-theme-primary), 0.08);
}
</style>
```

---

### table/TableCardHeader.vue

```vue
<script setup lang="ts">
import { ref, watch } from 'vue';

const props = defineProps<{
  tableName: string;
  alias: string;
  isExpanded: boolean;
}>();

const emit = defineEmits<{
  (e: 'remove'): void;
  (e: 'update-alias', alias: string): void;
  (e: 'toggle-expand'): void;
}>();

const isEditingAlias = ref(false);
const editingAlias = ref(props.alias);

watch(
  () => props.alias,
  (newAlias) => {
    editingAlias.value = newAlias;
  }
);

/**
 * ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç·¨é›†é–‹å§‹
 */
const startEditAlias = () => {
  isEditingAlias.value = true;
  editingAlias.value = props.alias;
};

/**
 * ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç·¨é›†ç¢ºå®š
 */
const confirmAlias = () => {
  isEditingAlias.value = false;
  if (editingAlias.value.trim() && editingAlias.value !== props.alias) {
    emit('update-alias', editingAlias.value.trim());
  }
};

/**
 * ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
 */
const cancelAlias = () => {
  isEditingAlias.value = false;
  editingAlias.value = props.alias;
};

/**
 * ã‚­ãƒ¼å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©
 */
const handleKeyDown = (e: KeyboardEvent) => {
  if (e.key === 'Enter') {
    confirmAlias();
  } else if (e.key === 'Escape') {
    cancelAlias();
  }
};
</script>

<template>
  <div class="table-card-header">
    <!-- å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ -->
    <v-btn
      icon
      variant="text"
      size="x-small"
      @click="emit('toggle-expand')"
    >
      <v-icon size="small">
        {{ isExpanded ? 'mdi-chevron-down' : 'mdi-chevron-right' }}
      </v-icon>
    </v-btn>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã¨åå‰ -->
    <v-icon size="small" color="primary" class="mr-1">mdi-table</v-icon>
    <span class="table-name">{{ tableName }}</span>

    <v-spacer />

    <!-- ã‚¨ã‚¤ãƒªã‚¢ã‚¹ -->
    <div class="alias-section">
      <template v-if="isEditingAlias">
        <input
          v-model="editingAlias"
          class="alias-input"
          type="text"
          maxlength="20"
          @blur="confirmAlias"
          @keydown="handleKeyDown"
          autofocus
        />
      </template>
      <template v-else>
        <span
          class="alias-display"
          title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ç·¨é›†"
          @click="startEditAlias"
        >
          {{ alias }}
        </span>
      </template>
    </div>

    <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
    <v-btn
      icon
      variant="text"
      size="x-small"
      color="error"
      @click="emit('remove')"
    >
      <v-icon size="small">mdi-close</v-icon>
    </v-btn>
  </div>
</template>

<style scoped>
.table-card-header {
  display: flex;
  align-items: center;
  padding: 8px;
  gap: 4px;
}

.table-name {
  font-size: 0.875rem;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.alias-section {
  margin-left: 8px;
}

.alias-display {
  font-size: 0.75rem;
  color: rgb(var(--v-theme-primary));
  background: rgba(var(--v-theme-primary), 0.1);
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
}

.alias-display:hover {
  background: rgba(var(--v-theme-primary), 0.2);
}

.alias-input {
  width: 60px;
  font-size: 0.75rem;
  padding: 2px 6px;
  border: 1px solid rgb(var(--v-theme-primary));
  border-radius: 4px;
  outline: none;
}
</style>
```

---

### table/TableCardColumn.vue

```vue
<script setup lang="ts">
import { computed } from 'vue';
import type { Column } from '@/types/database-structure';

const props = defineProps<{
  column: Column;
}>();

const emit = defineEmits<{
  (e: 'click', column: Column): void;
}>();

// ã‚¢ã‚¤ã‚³ãƒ³ã¨è‰²
const iconConfig = computed(() => {
  if (props.column.isPrimaryKey) {
    return { icon: 'mdi-key', color: 'amber-darken-2' };
  }
  if (props.column.isForeignKey) {
    return { icon: 'mdi-link', color: 'blue' };
  }
  if (props.column.isUnique) {
    return { icon: 'mdi-star', color: 'purple' };
  }
  return { icon: 'mdi-format-text', color: 'grey' };
});

const handleClick = () => {
  emit('click', props.column);
};
</script>

<template>
  <div class="table-card-column" @click="handleClick">
    <v-icon :icon="iconConfig.icon" :color="iconConfig.color" size="x-small" />
    <span class="column-name">{{ column.name }}</span>
    <span class="column-type">{{ column.displayType }}</span>
    <span v-if="!column.nullable" class="not-null">*</span>
  </div>
</template>

<style scoped>
.table-card-column {
  display: flex;
  align-items: center;
  padding: 4px 12px;
  gap: 4px;
  cursor: pointer;
}

.table-card-column:hover {
  background: rgba(var(--v-theme-primary), 0.08);
}

.column-name {
  flex: 1;
  font-size: 0.8125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.column-type {
  font-size: 0.75rem;
  color: rgb(var(--v-theme-on-surface-variant));
}

.not-null {
  color: rgb(var(--v-theme-error));
  font-weight: bold;
}
</style>
```

---

### table/DropZone.vue

```vue
<script setup lang="ts">
</script>

<template>
  <div class="drop-zone">
    <div class="drop-zone-content">
      <v-icon size="48" color="grey-lighten-1">mdi-table-plus</v-icon>
      <h3 class="text-h6 text-grey mt-2">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ </h3>
      <p class="text-caption text-grey">
        å·¦ãƒ‘ãƒãƒ«ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br />
        ã¾ãŸã¯ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ã§ãã¾ã™
      </p>
    </div>
  </div>
</template>

<style scoped>
.drop-zone {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 24px;
}

.drop-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}
</style>
```

---

## çŠ¶æ…‹ç®¡ç†

### query-builder.tsï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠé–¢é€£ã®è¿½åŠ ï¼‰

```typescript
import { defineStore } from 'pinia';
import type { SelectedTable } from '@/types/query';

interface QueryBuilderState {
  /** é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ */
  selectedTables: SelectedTable[];
  // ... ä»–ã®çŠ¶æ…‹
}

export const useQueryBuilderStore = defineStore('query-builder', {
  state: (): QueryBuilderState => ({
    selectedTables: [],
    // ...
  }),

  actions: {
    /**
     * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
     */
    addTable(table: SelectedTable) {
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (this.selectedTables.some((t) => t.id === table.id)) {
        return;
      }
      this.selectedTables.push(table);
      this.regenerateSql();
    },

    /**
     * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
     */
    removeTable(tableId: string) {
      const index = this.selectedTables.findIndex((t) => t.id === tableId);
      if (index !== -1) {
        this.selectedTables.splice(index, 1);
        // é–¢é€£ã™ã‚‹JOINã‚„ã‚«ãƒ©ãƒ é¸æŠã‚‚å‰Šé™¤
        this.removeRelatedJoins(tableId);
        this.removeRelatedColumns(tableId);
        this.regenerateSql();
      }
    },

    /**
     * ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æ›´æ–°
     */
    updateTableAlias(tableId: string, alias: string) {
      const table = this.selectedTables.find((t) => t.id === tableId);
      if (table) {
        table.alias = alias;
        this.regenerateSql();
      }
    },

    /**
     * é–¢é€£ã™ã‚‹JOINã‚’å‰Šé™¤
     */
    removeRelatedJoins(tableId: string) {
      // TODO: JOINæ©Ÿèƒ½å®Ÿè£…æ™‚ã«è©³ç´°åŒ–
    },

    /**
     * é–¢é€£ã™ã‚‹ã‚«ãƒ©ãƒ é¸æŠã‚’å‰Šé™¤
     */
    removeRelatedColumns(tableId: string) {
      // TODO: ã‚«ãƒ©ãƒ é¸æŠæ©Ÿèƒ½å®Ÿè£…æ™‚ã«è©³ç´°åŒ–
    },

    /**
     * SQLã‚’å†ç”Ÿæˆ
     */
    regenerateSql() {
      // TODO: SQLç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…æ™‚ã«è©³ç´°åŒ–
    },
  },
});
```

---

## å‹å®šç¾©

### src/types/query.tsï¼ˆè¿½åŠ ï¼‰

```typescript
import type { Column } from './database-structure';

/**
 * é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«
 */
export interface SelectedTable {
  /** ä¸€æ„è­˜åˆ¥å­ï¼ˆschema.table_nameï¼‰ */
  id: string;
  /** ã‚¹ã‚­ãƒ¼ãƒå */
  schema: string;
  /** ãƒ†ãƒ¼ãƒ–ãƒ«å */
  name: string;
  /** ã‚¨ã‚¤ãƒªã‚¢ã‚¹ */
  alias: string;
  /** ã‚«ãƒ©ãƒ ä¸€è¦§ */
  columns: Column[];
}
```

---

## ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```typescript
describe('TableRelationArea', () => {
  it('should show drop zone when no tables selected', () => {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒãªã„å ´åˆã¯ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  });

  it('should add table on drop', () => {
    // ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¿½åŠ ã•ã‚Œã‚‹
  });

  it('should not add duplicate tables', () => {
    // åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¯é‡è¤‡ã—ã¦è¿½åŠ ã•ã‚Œãªã„
  });
});

describe('TableCard', () => {
  it('should display table name and alias', () => {
    // ãƒ†ãƒ¼ãƒ–ãƒ«åã¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  });

  it('should allow alias editing', () => {
    // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒç·¨é›†ã§ãã‚‹
  });

  it('should be draggable within area', () => {
    // ã‚¨ãƒªã‚¢å†…ã§ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã§ãã‚‹
  });
});
```

### E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

```
ã‚·ãƒŠãƒªã‚ª1: ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
1. DBæ§‹é€ ãƒ„ãƒªãƒ¼ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°
2. ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚å›³ã‚¨ãƒªã‚¢ã«ãƒ‰ãƒ­ãƒƒãƒ—
3. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ã‚·ãƒŠãƒªã‚ª2: ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç·¨é›†
1. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯
2. æ–°ã—ã„ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’å…¥åŠ›
3. Enterã§ç¢ºå®š
4. ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ã‚·ãƒŠãƒªã‚ª3: ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
1. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `src/components/query-builder/TableRelationArea.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/table/TableCard.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/table/TableCardHeader.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/table/TableCardColumn.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/table/DropZone.vue` ã®ä½œæˆ
- [ ] `src/types/query.ts` ã®æ›´æ–°
- [ ] `src/stores/query-builder.ts` ã®æ›´æ–°
- [ ] ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®å®Ÿè£…
- [ ] ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç·¨é›†æ©Ÿèƒ½ã®å®Ÿè£…
- [ ] ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ç§»å‹•æ©Ÿèƒ½ã®å®Ÿè£…
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆã®ä½œæˆ

---

## å‚è€ƒè³‡æ–™

- [Nuxt UI v4 Documentation](https://ui.nuxt.com/)
- [Nuxt UI Card Component](https://ui.nuxt.com/components/card)
- [Tailwind CSS v4](https://tailwindcss.com/)
- [HTML Drag and Drop API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API)
- [Vue Draggable](https://github.com/SortableJS/Vue.Draggable)
