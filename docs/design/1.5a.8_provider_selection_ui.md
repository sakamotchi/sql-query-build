# 1.5a.8 セキュリティプロバイダー選択UI

## 概要

| 項目 | 内容 |
|------|------|
| タスクID | 1.5a.8 |
| タスク名 | セキュリティプロバイダー選択UI |
| 担当 | FE |
| 工数 | 1.5日 |
| 依存関係 | 1.5a.6 |
| 完了条件 | 設定画面でプロバイダー選択可能 |

## 目的

設定画面でセキュリティプロバイダーを選択・変更できるUIを実装する。

## コンポーネント構成

```
src/pages/
└── settings.vue                   # 設定ページ（ルーティング対象）

src/components/settings/
├── SecuritySettings.vue           # セキュリティ設定セクション
├── SecurityProviderCard.vue       # プロバイダー選択カード
├── ProviderChangeDialog.vue       # プロバイダー変更確認ダイアログ
└── SecurityLevelIndicator.vue     # セキュリティレベルインジケーター
```

## ルーティング設定

### App.vue の変更

設定画面をルーティングに追加する必要があります。

```vue
<!-- src/App.vue -->
<script setup lang="ts">
import { computed } from 'vue';
// ... 既存のimport

import SettingsPage from './pages/settings.vue';

// ルート判定
const isSettings = computed(() => {
  const pathname = window.location.pathname.replace(/^\/+/, '');
  return pathname.startsWith('settings');
});

const isQueryBuilder = computed(() => {
  const pathname = window.location.pathname.replace(/^\/+/, '');
  return pathname.startsWith('query-builder');
});
</script>

<template>
  <SettingsPage v-if="isSettings" />
  <QueryBuilderPage v-else-if="isQueryBuilder" />
  <LauncherPage v-else />

  <!-- 既存のダイアログ等 -->
</template>
```

### 設定ページ（settings.vue）

```vue
<!-- src/pages/settings.vue -->
<template>
  <v-app>
    <v-app-bar color="surface" elevation="1">
      <v-btn icon="mdi-arrow-left" @click="handleBack" />
      <v-app-bar-title>設定</v-app-bar-title>
    </v-app-bar>

    <v-main>
      <v-container class="py-6">
        <v-tabs v-model="activeTab" color="primary">
          <v-tab value="security">
            <v-icon start>mdi-shield-lock</v-icon>
            セキュリティ
          </v-tab>
          <v-tab value="general">
            <v-icon start>mdi-cog</v-icon>
            一般
          </v-tab>
          <v-tab value="about">
            <v-icon start>mdi-information</v-icon>
            このアプリについて
          </v-tab>
        </v-tabs>

        <v-tabs-window v-model="activeTab" class="mt-6">
          <v-tabs-window-item value="security">
            <SecuritySettings />
          </v-tabs-window-item>

          <v-tabs-window-item value="general">
            <GeneralSettings />
          </v-tabs-window-item>

          <v-tabs-window-item value="about">
            <AboutSection />
          </v-tabs-window-item>
        </v-tabs-window>
      </v-container>
    </v-main>
  </v-app>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { getCurrentWindow } from '@tauri-apps/api/window';
import SecuritySettings from '@/components/settings/SecuritySettings.vue';
import GeneralSettings from '@/components/settings/GeneralSettings.vue';
import AboutSection from '@/components/settings/AboutSection.vue';

const activeTab = ref('security');

const handleBack = async () => {
  try {
    const currentWindow = getCurrentWindow();
    await currentWindow.close();
  } catch (error) {
    console.error('Failed to close window:', error);
    window.history.back();
  }
};
</script>
```

### GeneralSettings.vue

```vue
<!-- src/components/settings/GeneralSettings.vue -->
<template>
  <v-card>
    <v-card-title>
      <v-icon start>mdi-cog</v-icon>
      一般設定
    </v-card-title>
    <v-card-text>
      <v-switch
        v-model="restoreWindows"
        label="起動時に前回のウィンドウを復元する"
        color="primary"
        class="mb-2"
      />
      <v-switch
        v-model="rememberPositions"
        label="ウィンドウ位置を記憶する"
        color="primary"
        class="mb-2"
      />
      <v-switch
        v-model="confirmClose"
        label="終了前に確認する"
        color="primary"
        class="mb-2"
      />
      <v-switch
        v-model="rememberLastOpened"
        label="最後に開いたウィンドウを記憶する"
        color="primary"
      />
    </v-card-text>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { storeToRefs } from 'pinia';
import { useSettingsStore } from '@/stores/settings';

const settingsStore = useSettingsStore();
const {
  restoreWindowsOnStartup,
  rememberWindowPositions,
  confirmBeforeClose,
  rememberLastOpenedWindows,
} = storeToRefs(settingsStore);

const restoreWindows = computed({
  get: () => restoreWindowsOnStartup.value,
  set: value => settingsStore.updateSettings({ restoreWindowsOnStartup: value }),
});

const rememberPositions = computed({
  get: () => rememberWindowPositions.value,
  set: value => settingsStore.updateSettings({ rememberWindowPositions: value }),
});

const confirmClose = computed({
  get: () => confirmBeforeClose.value,
  set: value => settingsStore.updateSettings({ confirmBeforeClose: value }),
});

const rememberLastOpened = computed({
  get: () => rememberLastOpenedWindows.value,
  set: value => settingsStore.updateSettings({ rememberLastOpenedWindows: value }),
});
</script>
```

### AboutSection.vue（プレースホルダー）

```vue
<!-- src/components/settings/AboutSection.vue -->
<template>
  <v-card>
    <v-card-title>
      <v-icon start>mdi-information</v-icon>
      SQL Query Builder
    </v-card-title>
    <v-card-text>
      <p>バージョン: 1.0.0</p>
      <p class="text-grey">データベース接続とクエリ作成のためのツール</p>
    </v-card-text>
  </v-card>
</template>
```

## 画面設計

### SecuritySettings.vue

```vue
<template>
  <v-card class="security-settings">
    <v-card-title>
      <v-icon start>mdi-shield-lock</v-icon>
      セキュリティ設定
    </v-card-title>

    <v-card-text>
      <!-- 現在のプロバイダー表示 -->
      <div class="current-provider mb-6">
        <div class="text-subtitle-2 text-grey mb-2">現在のセキュリティ方式</div>
        <v-chip
          :color="currentProviderColor"
          variant="elevated"
          size="large"
        >
          <v-icon start>{{ currentProviderIcon }}</v-icon>
          {{ currentProviderName }}
        </v-chip>
        <SecurityLevelIndicator :level="currentSecurityLevel" class="mt-2" />
      </div>

      <v-divider class="mb-6" />

      <!-- プロバイダー選択 -->
      <div class="text-subtitle-1 mb-4">セキュリティ方式を選択</div>

      <v-row>
        <v-col
          v-for="provider in availableProviders"
          :key="provider.type"
          cols="12"
          md="4"
        >
          <SecurityProviderCard
            :provider="provider"
            :is-current="provider.type === currentProvider"
            @select="onProviderSelect"
          />
        </v-col>
      </v-row>
    </v-card-text>

    <!-- プロバイダー変更ダイアログ -->
    <ProviderChangeDialog
      v-model="showChangeDialog"
      :from-provider="currentProvider"
      :to-provider="selectedProvider"
      @confirm="onProviderChange"
      @cancel="showChangeDialog = false"
    />
  </v-card>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useSecurityStore } from '@/stores/security';
import type { SecurityProviderType, SecurityProviderInfo } from '@/types/security';

const securityStore = useSecurityStore();

const showChangeDialog = ref(false);
const selectedProvider = ref<SecurityProviderType | null>(null);

const currentProvider = computed(() => securityStore.currentProvider);
const currentSecurityLevel = computed(() => securityStore.currentSecurityLevel);
const availableProviders = computed(() => securityStore.availableProviders);

const currentProviderName = computed(() => {
  const provider = availableProviders.value.find(p => p.type === currentProvider.value);
  return provider?.displayName ?? '';
});

const currentProviderIcon = computed(() => {
  switch (currentProvider.value) {
    case 'simple': return 'mdi-lock-open-outline';
    case 'master_password': return 'mdi-key';
    case 'keychain': return 'mdi-shield-check';
    default: return 'mdi-lock';
  }
});

const currentProviderColor = computed(() => {
  switch (currentProvider.value) {
    case 'simple': return 'grey';
    case 'master_password': return 'primary';
    case 'keychain': return 'success';
    default: return 'grey';
  }
});

const onProviderSelect = (providerType: SecurityProviderType) => {
  if (providerType !== currentProvider.value) {
    selectedProvider.value = providerType;
    showChangeDialog.value = true;
  }
};

const onProviderChange = async (params: ProviderChangeParams) => {
  try {
    await securityStore.changeProvider(params);
    showChangeDialog.value = false;
  } catch (error) {
    // エラーハンドリング
  }
};

onMounted(() => {
  securityStore.loadConfig();
});
</script>
```

### SecurityProviderCard.vue

```vue
<template>
  <v-card
    :class="['provider-card', { 'is-current': isCurrent }]"
    :color="isCurrent ? 'primary' : undefined"
    :variant="isCurrent ? 'elevated' : 'outlined'"
    @click="$emit('select', provider.type)"
  >
    <v-card-item>
      <template #prepend>
        <v-avatar :color="iconColor" size="48">
          <v-icon :icon="icon" size="24" />
        </v-avatar>
      </template>

      <v-card-title>{{ provider.displayName }}</v-card-title>
      <v-card-subtitle>{{ securityLevelText }}</v-card-subtitle>
    </v-card-item>

    <v-card-text>
      <p class="text-body-2 mb-3">{{ provider.description }}</p>

      <div class="features">
        <div
          v-for="(feature, index) in features"
          :key="index"
          class="feature-item d-flex align-center mb-1"
        >
          <v-icon
            :icon="feature.available ? 'mdi-check-circle' : 'mdi-close-circle'"
            :color="feature.available ? 'success' : 'grey'"
            size="small"
            class="mr-2"
          />
          <span class="text-body-2">{{ feature.text }}</span>
        </div>
      </div>
    </v-card-text>

    <v-card-actions v-if="!isCurrent">
      <v-btn
        color="primary"
        variant="tonal"
        block
        @click.stop="$emit('select', provider.type)"
      >
        この方式に変更
      </v-btn>
    </v-card-actions>

    <v-card-actions v-else>
      <v-chip color="white" variant="flat" block>
        <v-icon start>mdi-check</v-icon>
        現在使用中
      </v-chip>
    </v-card-actions>
  </v-card>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import type { SecurityProviderInfo, SecurityProviderType } from '@/types/security';

const props = defineProps<{
  provider: SecurityProviderInfo;
  isCurrent: boolean;
}>();

const emit = defineEmits<{
  select: [type: SecurityProviderType];
}>();

const icon = computed(() => {
  switch (props.provider.type) {
    case 'simple': return 'mdi-lock-open-outline';
    case 'master_password': return 'mdi-key';
    case 'keychain': return 'mdi-shield-check';
    default: return 'mdi-lock';
  }
});

const iconColor = computed(() => {
  if (props.isCurrent) return 'white';
  switch (props.provider.type) {
    case 'simple': return 'grey-lighten-2';
    case 'master_password': return 'primary-lighten-4';
    case 'keychain': return 'success-lighten-4';
    default: return 'grey-lighten-2';
  }
});

const securityLevelText = computed(() => {
  switch (props.provider.securityLevel) {
    case 1: return 'セキュリティレベル: 低';
    case 2: return 'セキュリティレベル: 高';
    case 3: return 'セキュリティレベル: 最高';
    default: return '';
  }
});

const features = computed(() => {
  switch (props.provider.type) {
    case 'simple':
      return [
        { text: 'パスワード入力不要', available: true },
        { text: '即座に起動可能', available: true },
        { text: '高度な暗号化', available: false },
        { text: '生体認証', available: false },
      ];
    case 'master_password':
      return [
        { text: 'パスワード入力不要', available: false },
        { text: '高度な暗号化', available: true },
        { text: 'ユーザーのみ復号可能', available: true },
        { text: '生体認証', available: false },
      ];
    case 'keychain':
      return [
        { text: 'パスワード入力不要', available: true },
        { text: 'OSレベルのセキュリティ', available: true },
        { text: '高度な暗号化', available: true },
        { text: '生体認証対応', available: true },
      ];
    default:
      return [];
  }
});
</script>

<style scoped>
.provider-card {
  cursor: pointer;
  transition: all 0.2s ease;
  height: 100%;
}

.provider-card:hover:not(.is-current) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.is-current {
  cursor: default;
}

.feature-item {
  font-size: 0.875rem;
}
</style>
```

### SecurityLevelIndicator.vue

```vue
<template>
  <div class="security-level-indicator d-flex align-center">
    <span class="text-caption text-grey mr-2">セキュリティレベル:</span>
    <div class="level-bars d-flex">
      <div
        v-for="i in 3"
        :key="i"
        :class="['level-bar', { active: i <= level }]"
        :style="{ backgroundColor: i <= level ? color : undefined }"
      />
    </div>
    <span :class="['text-caption ml-2', `text-${textColor}`]">
      {{ levelText }}
    </span>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';

const props = defineProps<{
  level: number;
}>();

const levelText = computed(() => {
  switch (props.level) {
    case 1: return '低';
    case 2: return '高';
    case 3: return '最高';
    default: return '';
  }
});

const color = computed(() => {
  switch (props.level) {
    case 1: return '#9e9e9e';
    case 2: return '#1976d2';
    case 3: return '#4caf50';
    default: return '#9e9e9e';
  }
});

const textColor = computed(() => {
  switch (props.level) {
    case 1: return 'grey';
    case 2: return 'primary';
    case 3: return 'success';
    default: return 'grey';
  }
});
</script>

<style scoped>
.level-bars {
  gap: 4px;
}

.level-bar {
  width: 20px;
  height: 8px;
  border-radius: 2px;
  background-color: #e0e0e0;
  transition: background-color 0.3s ease;
}
</style>
```

## Piniaストア

```typescript
// src/stores/security.ts
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';
import { securityApi } from '@/api/security';
import type {
  SecurityProviderType,
  SecurityProviderInfo,
  SecurityConfig,
} from '@/types/security';

export const useSecurityStore = defineStore('security', () => {
  const config = ref<SecurityConfig | null>(null);
  const availableProviders = ref<SecurityProviderInfo[]>([]);
  const isLoading = ref(false);
  const error = ref<string | null>(null);

  const currentProvider = computed(() => config.value?.providerType ?? 'simple');
  const currentSecurityLevel = computed(() => {
    const provider = availableProviders.value.find(
      p => p.type === currentProvider.value
    );
    return provider?.securityLevel ?? 1;
  });

  const loadConfig = async () => {
    isLoading.value = true;
    error.value = null;
    try {
      config.value = await securityApi.getConfig();
      availableProviders.value = await securityApi.getAvailableProviders();
    } catch (e) {
      error.value = e instanceof Error ? e.message : 'Unknown error';
    } finally {
      isLoading.value = false;
    }
  };

  const changeProvider = async (params: ProviderChangeParams) => {
    isLoading.value = true;
    error.value = null;
    try {
      await securityApi.switchProvider(params);
      await loadConfig();
    } catch (e) {
      error.value = e instanceof Error ? e.message : 'Unknown error';
      throw e;
    } finally {
      isLoading.value = false;
    }
  };

  return {
    config,
    availableProviders,
    isLoading,
    error,
    currentProvider,
    currentSecurityLevel,
    loadConfig,
    changeProvider,
  };
});
```

## テスト

```typescript
// src/components/settings/__tests__/SecuritySettings.spec.ts
import { describe, it, expect, vi } from 'vitest';
import { mount } from '@vue/test-utils';
import { createPinia, setActivePinia } from 'pinia';
import SecuritySettings from '../SecuritySettings.vue';
import { useSecurityStore } from '@/stores/security';

// Vuetify/子コンポーネントはスタブ化
const providerCardStub = {
  props: ['provider'],
  template:
    '<div class=\"provider-card\" @click=\"$emit(\\'select\\', provider.type)\">{{ provider.displayName }}</div>',
};
const providerChangeDialogStub = {
  props: ['modelValue', 'toProvider'],
  emits: ['update:modelValue', 'confirm', 'cancel'],
  template:
    '<div v-if=\"modelValue\" class=\"provider-change-dialog\"><button class=\"confirm\" @click=\"$emit(\\'confirm\\', { targetProvider: toProvider })\"></button></div>',
};

describe('SecuritySettings', () => {
  it('現在のプロバイダーを表示する', () => {
    const pinia = createPinia();
    setActivePinia(pinia);
    const store = useSecurityStore();

    store.config = { providerType: 'simple', providerConfig: { providerConfigType: 'Simple' } };
    store.availableProviders = [{ type: 'simple', displayName: 'Simple', description: '', securityLevel: 1 }];
    store.changeProvider = vi.fn();
    store.loadConfig = vi.fn();

    const wrapper = mount(SecuritySettings, {
      global: {
        plugins: [pinia],
        stubs: { SecurityProviderCard: providerCardStub, ProviderChangeDialog: providerChangeDialogStub },
      },
    });

    expect(wrapper.text()).toContain('Simple');
  });

  it('別プロバイダー選択時に changeProvider を呼び出す', async () => {
    const pinia = createPinia();
    setActivePinia(pinia);
    const store = useSecurityStore();

    store.config = { providerType: 'simple', providerConfig: { providerConfigType: 'Simple' } };
    store.availableProviders = [
      { type: 'simple', displayName: 'Simple', description: '', securityLevel: 1 },
      { type: 'master_password', displayName: 'Master Password', description: '', securityLevel: 2 },
    ];
    store.changeProvider = vi.fn();
    store.loadConfig = vi.fn();

    const wrapper = mount(SecuritySettings, {
      global: {
        plugins: [pinia],
        stubs: { SecurityProviderCard: providerCardStub, ProviderChangeDialog: providerChangeDialogStub },
      },
    });

    await wrapper.findAll('.provider-card')[1].trigger('click');
    await wrapper.find('.confirm').trigger('click');

    expect(store.changeProvider).toHaveBeenCalledWith({ targetProvider: 'master_password' });
  });
});
```

## 実装チェックリスト

- [x] `App.vue` にルーティング追加（`isSettings` 判定）
- [x] `src/pages/settings.vue` 実装
- [x] `SecuritySettings.vue` 実装
- [x] `SecurityProviderCard.vue` 実装
- [x] `ProviderChangeDialog.vue` 実装
- [x] `SecurityLevelIndicator.vue` 実装
- [x] `GeneralSettings.vue` 実装
- [x] `AboutSection.vue` 実装
- [x] `useSecurityStore` 実装
- [x] セキュリティAPI統合
- [x] スタイリング
- [x] コンポーネントテスト作成

### 備考
- バックエンドが `provider_config` をネストせず `provider_config_type` をフラットに返すケースに備え、フロントの `securityApi.getConfig` で両方の形式を正規化する。

---

**作成日**: 2025-11-24
**作成者**: Claude Code
