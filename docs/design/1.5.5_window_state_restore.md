# タスク1.5.5: ウィンドウ状態復元機能 設計書

## 概要

**タスクID**: 1.5.5
**タスク名**: ウィンドウ状態復元機能
**工数**: 1日
**依存関係**: 1.5.1 (Tauriウィンドウ管理モジュール実装)
**完了条件**: 起動時に前回状態を復元

---

## 目的

アプリケーション終了時にウィンドウの状態（位置、サイズ、開いていた接続）を保存し、次回起動時に復元する。これにより、ユーザーは前回の作業状態から継続して作業を開始できる。

---

## 機能要件

### 主要機能

1. **ウィンドウ状態の保存**
   - ウィンドウ位置（X, Y座標）
   - ウィンドウサイズ（幅、高さ）
   - 最大化/最小化状態
   - 開いていた接続ID

2. **ウィンドウ状態の復元**
   - 前回終了時のウィンドウを復元
   - 位置・サイズの復元
   - 接続の再確立

3. **設定オプション**
   - 復元機能の有効/無効
   - ウィンドウ位置の記憶の有効/無効
   - 終了時確認ダイアログ

---

## データ設計

### ウィンドウ状態データ構造

```json
{
  "window_states": [
    {
      "id": "query-builder-uuid-123",
      "window_type": "query_builder",
      "connection_id": "conn-uuid-456",
      "x": 100,
      "y": 100,
      "width": 1400,
      "height": 900,
      "maximized": false,
      "minimized": false,
      "fullscreen": false,
      "created_at": "2025-11-23T10:00:00Z",
      "updated_at": "2025-11-23T12:30:00Z"
    }
  ],
  "settings": {
    "restore_windows_on_startup": true,
    "remember_window_positions": true,
    "confirm_before_close": true
  }
}
```

### 保存場所

```
{app_data_dir}/sql-query-builder/
├── window_states.json    # ウィンドウ状態
└── settings.json         # アプリケーション設定
```

---

## アーキテクチャ

### 状態保存・復元フロー

```
┌────────────────────────────────────────────────────────────────┐
│                    Application Lifecycle                        │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  起動時:                                                        │
│  ┌─────────┐    ┌──────────────┐    ┌────────────────┐        │
│  │ App     │───▶│ Load States  │───▶│ Restore        │        │
│  │ Start   │    │ from Storage │    │ Windows        │        │
│  └─────────┘    └──────────────┘    └────────────────┘        │
│                                                                 │
│  操作中:                                                        │
│  ┌─────────┐    ┌──────────────┐    ┌────────────────┐        │
│  │ Window  │───▶│ Debounce     │───▶│ Save State     │        │
│  │ Move/   │    │ (500ms)      │    │ to Storage     │        │
│  │ Resize  │    │              │    │                │        │
│  └─────────┘    └──────────────┘    └────────────────┘        │
│                                                                 │
│  終了時:                                                        │
│  ┌─────────┐    ┌──────────────┐    ┌────────────────┐        │
│  │ App     │───▶│ Save All     │───▶│ Close          │        │
│  │ Close   │    │ States       │    │ Application    │        │
│  └─────────┘    └──────────────┘    └────────────────┘        │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## 設定ストア

**ファイル**: `src/stores/settings.ts`

```typescript
import { defineStore } from 'pinia';
import { invoke } from '@tauri-apps/api/core';

/**
 * アプリケーション設定の状態
 */
interface SettingsState {
  /** 起動時にウィンドウを復元するか */
  restoreWindowsOnStartup: boolean;
  /** ウィンドウ位置を記憶するか */
  rememberWindowPositions: boolean;
  /** 終了前に確認ダイアログを表示するか */
  confirmBeforeClose: boolean;
  /** 最後に開いたウィンドウを記憶するか */
  rememberLastOpenedWindows: boolean;
  /** 読み込み完了フラグ */
  loaded: boolean;
}

const STORAGE_KEY = 'app-settings';

export const useSettingsStore = defineStore('settings', {
  state: (): SettingsState => ({
    restoreWindowsOnStartup: true,
    rememberWindowPositions: true,
    confirmBeforeClose: true,
    rememberLastOpenedWindows: true,
    loaded: false,
  }),

  getters: {
    /**
     * ウィンドウ復元が有効かどうか
     */
    shouldRestoreWindows(state): boolean {
      return state.restoreWindowsOnStartup && state.rememberLastOpenedWindows;
    },

    /**
     * 位置の記憶が有効かどうか
     */
    shouldRememberPositions(state): boolean {
      return state.rememberWindowPositions;
    },
  },

  actions: {
    /**
     * 設定を読み込み
     */
    async loadSettings() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          this.restoreWindowsOnStartup = data.restoreWindowsOnStartup ?? true;
          this.rememberWindowPositions = data.rememberWindowPositions ?? true;
          this.confirmBeforeClose = data.confirmBeforeClose ?? true;
          this.rememberLastOpenedWindows = data.rememberLastOpenedWindows ?? true;
        }
        this.loaded = true;
      } catch (error) {
        console.error('Failed to load settings:', error);
        this.loaded = true;
      }
    },

    /**
     * 設定を保存
     */
    saveSettings() {
      try {
        const data = {
          restoreWindowsOnStartup: this.restoreWindowsOnStartup,
          rememberWindowPositions: this.rememberWindowPositions,
          confirmBeforeClose: this.confirmBeforeClose,
          rememberLastOpenedWindows: this.rememberLastOpenedWindows,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (error) {
        console.error('Failed to save settings:', error);
      }
    },

    /**
     * 設定を更新
     */
    updateSettings(settings: Partial<SettingsState>) {
      if (settings.restoreWindowsOnStartup !== undefined) {
        this.restoreWindowsOnStartup = settings.restoreWindowsOnStartup;
      }
      if (settings.rememberWindowPositions !== undefined) {
        this.rememberWindowPositions = settings.rememberWindowPositions;
      }
      if (settings.confirmBeforeClose !== undefined) {
        this.confirmBeforeClose = settings.confirmBeforeClose;
      }
      if (settings.rememberLastOpenedWindows !== undefined) {
        this.rememberLastOpenedWindows = settings.rememberLastOpenedWindows;
      }
      this.saveSettings();
    },

    /**
     * デフォルト設定にリセット
     */
    resetToDefaults() {
      this.restoreWindowsOnStartup = true;
      this.rememberWindowPositions = true;
      this.confirmBeforeClose = true;
      this.rememberLastOpenedWindows = true;
      this.saveSettings();
    },
  },
});
```

---

## アプリケーション初期化

**ファイル**: `src/App.vue`

```vue
<script setup lang="ts">
import { onMounted, onUnmounted, ref } from 'vue';
import { useThemeStore } from '@/stores/theme';
import { useWindowStore } from '@/stores/window';
import { useSettingsStore } from '@/stores/settings';
import { windowApi } from '@/api/window';
import { listen } from '@tauri-apps/api/event';
import { getCurrentWindow } from '@tauri-apps/api/window';

import RestoreWindowsDialog from '@/components/dialogs/RestoreWindowsDialog.vue';

const themeStore = useThemeStore();
const windowStore = useWindowStore();
const settingsStore = useSettingsStore();

const showRestoreDialog = ref(false);
const savedWindowCount = ref(0);

let unlistenCloseRequested: (() => void) | null = null;
let unlistenBeforeClose: (() => void) | null = null;

/**
 * アプリケーション初期化
 */
const initializeApp = async () => {
  // 設定を読み込み
  await settingsStore.loadSettings();

  // テーマストアを初期化
  themeStore.initialize();

  // ウィンドウストアを初期化
  await windowStore.initialize();

  // ランチャーウィンドウの場合、復元を確認
  if (windowStore.isLauncher && settingsStore.shouldRestoreWindows) {
    await checkAndRestoreWindows();
  }

  // イベントリスナーを設定
  await setupEventListeners();
};

/**
 * 前回のウィンドウ状態を復元するか確認
 */
const checkAndRestoreWindows = async () => {
  try {
    // 保存されたウィンドウ状態を確認
    const savedStates = await windowApi.getSavedWindowStates();

    if (savedStates && savedStates.length > 0) {
      savedWindowCount.value = savedStates.length;
      showRestoreDialog.value = true;
    }
  } catch (error) {
    console.error('Failed to check saved windows:', error);
  }
};

/**
 * ウィンドウを復元
 */
const restoreWindows = async () => {
  try {
    const restored = await windowApi.restoreWindows();
    console.log(`Restored ${restored.length} window(s)`);
  } catch (error) {
    console.error('Failed to restore windows:', error);
  } finally {
    showRestoreDialog.value = false;
  }
};

/**
 * 復元をスキップ
 */
const skipRestore = () => {
  showRestoreDialog.value = false;
};

/**
 * イベントリスナーを設定
 */
const setupEventListeners = async () => {
  try {
    // ウィンドウクローズ要求をリッスン
    unlistenCloseRequested = await listen('tauri://close-requested', async (event) => {
      if (settingsStore.confirmBeforeClose) {
        // 確認ダイアログを表示（必要に応じて）
      }

      // ウィンドウ状態を保存
      await windowApi.saveAllWindowStates();
    });

    // アプリケーション終了前の処理
    unlistenBeforeClose = await listen('before-exit', async () => {
      await windowApi.saveAllWindowStates();
    });
  } catch (error) {
    console.error('Failed to setup event listeners:', error);
  }
};

/**
 * クリーンアップ
 */
const cleanup = () => {
  if (unlistenCloseRequested) {
    unlistenCloseRequested();
    unlistenCloseRequested = null;
  }
  if (unlistenBeforeClose) {
    unlistenBeforeClose();
    unlistenBeforeClose = null;
  }
};

onMounted(() => {
  initializeApp();
});

onUnmounted(() => {
  cleanup();
});
</script>

<template>
  <router-view />

  <!-- ウィンドウ復元ダイアログ -->
  <RestoreWindowsDialog
    v-model="showRestoreDialog"
    :window-count="savedWindowCount"
    @restore="restoreWindows"
    @skip="skipRestore"
  />
</template>
```

---

## 復元確認ダイアログ

**ファイル**: `src/components/dialogs/RestoreWindowsDialog.vue`

```vue
<script setup lang="ts">
import { computed } from 'vue';

const props = defineProps<{
  modelValue: boolean;
  windowCount: number;
}>();

const emit = defineEmits<{
  (e: 'update:modelValue', value: boolean): void;
  (e: 'restore'): void;
  (e: 'skip'): void;
}>();

const show = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value),
});

const handleRestore = () => {
  emit('restore');
};

const handleSkip = () => {
  emit('skip');
};
</script>

<template>
  <v-dialog v-model="show" max-width="400" persistent>
    <v-card>
      <v-card-title class="text-h6">
        前回のセッションを復元
      </v-card-title>

      <v-card-text>
        前回のセッションで {{ windowCount }} 個のウィンドウが開かれていました。
        復元しますか？
      </v-card-text>

      <v-card-actions>
        <v-spacer />
        <v-btn
          variant="text"
          @click="handleSkip"
        >
          スキップ
        </v-btn>
        <v-btn
          color="primary"
          variant="flat"
          @click="handleRestore"
        >
          復元する
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>
```

---

## 設定画面UI

**ファイル**: `src/components/settings/WindowRestoreSettings.vue`

```vue
<script setup lang="ts">
import { computed } from 'vue';
import { useSettingsStore } from '@/stores/settings';

const settingsStore = useSettingsStore();

const restoreWindowsOnStartup = computed({
  get: () => settingsStore.restoreWindowsOnStartup,
  set: (value) => settingsStore.updateSettings({ restoreWindowsOnStartup: value }),
});

const rememberWindowPositions = computed({
  get: () => settingsStore.rememberWindowPositions,
  set: (value) => settingsStore.updateSettings({ rememberWindowPositions: value }),
});

const confirmBeforeClose = computed({
  get: () => settingsStore.confirmBeforeClose,
  set: (value) => settingsStore.updateSettings({ confirmBeforeClose: value }),
});

const rememberLastOpenedWindows = computed({
  get: () => settingsStore.rememberLastOpenedWindows,
  set: (value) => settingsStore.updateSettings({ rememberLastOpenedWindows: value }),
});
</script>

<template>
  <v-card>
    <v-card-title>ウィンドウ設定</v-card-title>

    <v-card-text>
      <v-switch
        v-model="restoreWindowsOnStartup"
        label="起動時に前回のウィンドウを復元する"
        color="primary"
        hide-details
        class="mb-4"
      />

      <v-switch
        v-model="rememberLastOpenedWindows"
        label="最後に開いたウィンドウを記憶する"
        color="primary"
        hide-details
        :disabled="!restoreWindowsOnStartup"
        class="mb-4"
      />

      <v-switch
        v-model="rememberWindowPositions"
        label="ウィンドウの位置とサイズを記憶する"
        color="primary"
        hide-details
        class="mb-4"
      />

      <v-switch
        v-model="confirmBeforeClose"
        label="アプリケーション終了前に確認する"
        color="primary"
        hide-details
      />
    </v-card-text>
  </v-card>
</template>
```

---

## Rust側の状態保存拡張

**ファイル**: `src-tauri/src/commands/window.rs` (追加)

```rust
/// 保存されたウィンドウ状態を取得
#[command]
pub async fn get_saved_window_states(
    window_manager: State<'_, WindowManager>,
) -> Result<Vec<WindowState>, String> {
    window_manager.get_saved_states()
}

/// ウィンドウ状態をクリア
#[command]
pub async fn clear_window_states(
    window_manager: State<'_, WindowManager>,
) -> Result<(), String> {
    window_manager.clear_saved_states()
}
```

**ファイル**: `src-tauri/src/services/window_manager.rs` (追加)

```rust
impl WindowManager {
    /// 保存された状態を取得
    pub fn get_saved_states(&self) -> Result<Vec<WindowState>, String> {
        self.storage.load_all_states()
    }

    /// 保存された状態をクリア
    pub fn clear_saved_states(&self) -> Result<(), String> {
        self.storage.clear_all_states()
    }
}
```

**ファイル**: `src-tauri/src/storage/window_state.rs` (追加)

```rust
impl WindowStateStorage {
    /// すべての状態をクリア
    pub fn clear_all_states(&self) -> Result<(), String> {
        if self.storage_path.exists() {
            fs::remove_file(&self.storage_path)
                .map_err(|e| format!("Failed to delete window states: {}", e))?;
        }
        Ok(())
    }
}
```

---

## フロントエンドAPIクライアント拡張

**ファイル**: `src/api/window.ts` (追加)

```typescript
import type { WindowState } from '@/types/window';

export const windowApi = {
  // ... 既存のメソッド

  /**
   * 保存されたウィンドウ状態を取得
   */
  async getSavedWindowStates(): Promise<WindowState[]> {
    return invoke('get_saved_window_states');
  },

  /**
   * ウィンドウ状態をクリア
   */
  async clearWindowStates(): Promise<void> {
    return invoke('clear_window_states');
  },
};
```

---

## テスト設計

### ユニットテスト

**ファイル**: `src/stores/__tests__/settings.spec.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { setActivePinia, createPinia } from 'pinia';
import { useSettingsStore } from '@/stores/settings';

describe('SettingsStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
    localStorage.clear();
  });

  it('should have default values', () => {
    const store = useSettingsStore();

    expect(store.restoreWindowsOnStartup).toBe(true);
    expect(store.rememberWindowPositions).toBe(true);
    expect(store.confirmBeforeClose).toBe(true);
    expect(store.rememberLastOpenedWindows).toBe(true);
  });

  it('should load settings from localStorage', async () => {
    localStorage.setItem('app-settings', JSON.stringify({
      restoreWindowsOnStartup: false,
      rememberWindowPositions: false,
    }));

    const store = useSettingsStore();
    await store.loadSettings();

    expect(store.restoreWindowsOnStartup).toBe(false);
    expect(store.rememberWindowPositions).toBe(false);
    expect(store.loaded).toBe(true);
  });

  it('should save settings to localStorage', () => {
    const store = useSettingsStore();
    store.updateSettings({
      restoreWindowsOnStartup: false,
    });

    const saved = JSON.parse(localStorage.getItem('app-settings') || '{}');
    expect(saved.restoreWindowsOnStartup).toBe(false);
  });

  it('should compute shouldRestoreWindows correctly', () => {
    const store = useSettingsStore();

    expect(store.shouldRestoreWindows).toBe(true);

    store.restoreWindowsOnStartup = false;
    expect(store.shouldRestoreWindows).toBe(false);

    store.restoreWindowsOnStartup = true;
    store.rememberLastOpenedWindows = false;
    expect(store.shouldRestoreWindows).toBe(false);
  });

  it('should reset to defaults', () => {
    const store = useSettingsStore();
    store.updateSettings({
      restoreWindowsOnStartup: false,
      confirmBeforeClose: false,
    });

    store.resetToDefaults();

    expect(store.restoreWindowsOnStartup).toBe(true);
    expect(store.confirmBeforeClose).toBe(true);
  });
});
```

### E2Eテストシナリオ

```
シナリオ1: ウィンドウ状態の保存と復元
1. アプリケーションを起動
2. 接続Aのクエリビルダーを開く
3. ウィンドウを移動・リサイズ
4. アプリケーションを終了
5. アプリケーションを再起動
6. 復元ダイアログが表示されることを確認
7. 「復元する」をクリック
8. ウィンドウが前回の位置・サイズで復元されることを確認

シナリオ2: 復元のスキップ
1. シナリオ1の1-5を実行
2. 「スキップ」をクリック
3. ランチャー画面のみが表示されることを確認

シナリオ3: 設定の無効化
1. 設定画面を開く
2. 「起動時に前回のウィンドウを復元する」をオフにする
3. クエリビルダーを開いてアプリを終了
4. アプリケーションを再起動
5. 復元ダイアログが表示されないことを確認
```

---

## 実装チェックリスト

- [ ] `src/stores/settings.ts` の作成
  - [ ] 設定状態の定義
  - [ ] loadSettings アクション
  - [ ] saveSettings アクション
  - [ ] updateSettings アクション
- [ ] `src/App.vue` の更新
  - [ ] 設定ストアの初期化
  - [ ] ウィンドウ復元チェック
  - [ ] イベントリスナー設定
- [ ] `src/components/dialogs/RestoreWindowsDialog.vue` の作成
- [ ] `src/components/settings/WindowRestoreSettings.vue` の作成
- [ ] Rustコマンドの追加
  - [ ] get_saved_window_states
  - [ ] clear_window_states
- [ ] フロントエンドAPIクライアントの拡張
- [ ] ユニットテストの作成
- [ ] E2Eテストの作成

---

## 参考資料

- [Tauri Events](https://tauri.app/v2/guide/events/)
- [Pinia Store](https://pinia.vuejs.org/core-concepts/)
- [Vuetify Dialog](https://vuetifyjs.com/en/components/dialogs/)
- [Web Storage API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API)
