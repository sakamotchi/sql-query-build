# ã‚¿ã‚¹ã‚¯1.6.3: å·¦ãƒ‘ãƒãƒ«ï¼ˆDBæ§‹é€ ãƒ„ãƒªãƒ¼ï¼‰å®Ÿè£… è¨­è¨ˆæ›¸

## æ¦‚è¦

**ã‚¿ã‚¹ã‚¯ID**: 1.6.3
**ã‚¿ã‚¹ã‚¯å**: å·¦ãƒ‘ãƒãƒ«ï¼ˆDBæ§‹é€ ãƒ„ãƒªãƒ¼ï¼‰å®Ÿè£…
**å·¥æ•°**: 2æ—¥
**ä¾å­˜é–¢ä¿‚**: 1.6.2 (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ å–å¾—APIå®Ÿè£…)
**å®Œäº†æ¡ä»¶**: ãƒ„ãƒªãƒ¼è¡¨ç¤ºãŒå‹•ä½œ
**UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Nuxt UI v4ï¼ˆTailwind CSS 4ãƒ™ãƒ¼ã‚¹ï¼‰

---

## ç›®çš„

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚«ãƒ©ãƒ æƒ…å ±ã‚’éšå±¤çš„ãªãƒ„ãƒªãƒ¼æ§‹é€ ã§è¡¨ç¤ºã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ãƒ„ãƒªãƒ¼ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ã‚«ãƒ©ãƒ ã‚’é¸æŠã—ã¦ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã§ä½¿ç”¨ã§ãã‚‹ã€‚

Nuxt UI v4ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨Tailwind CSSã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ„ãƒªãƒ¼UIã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

## UIè¨­è¨ˆ

### ãƒ„ãƒªãƒ¼æ§‹é€ 

```
ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
â”œâ”€â”€ ğŸ“ public (ã‚¹ã‚­ãƒ¼ãƒ)
â”‚   â”œâ”€â”€ ğŸ“‹ users (ãƒ†ãƒ¼ãƒ–ãƒ«)
â”‚   â”‚   â”œâ”€â”€ ğŸ”‘ id (integer, PK)
â”‚   â”‚   â”œâ”€â”€ ğŸ“ name (varchar(100))
â”‚   â”‚   â”œâ”€â”€ ğŸ“ email (varchar(255))
â”‚   â”‚   â””â”€â”€ ğŸ”— department_id (integer, FK)
â”‚   â”œâ”€â”€ ğŸ“‹ departments (ãƒ†ãƒ¼ãƒ–ãƒ«)
â”‚   â”‚   â”œâ”€â”€ ğŸ”‘ id (integer, PK)
â”‚   â”‚   â””â”€â”€ ğŸ“ name (varchar(100))
â”‚   â””â”€â”€ ğŸ‘ user_summary (ãƒ“ãƒ¥ãƒ¼)
â”‚       â”œâ”€â”€ ğŸ“ user_name
â”‚       â””â”€â”€ ğŸ“ department_name
â””â”€â”€ ğŸ“ pg_catalog (ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ¼ãƒ) [æŠ˜ã‚ŠãŸãŸã¿]
```

### ã‚¢ã‚¤ã‚³ãƒ³ä½“ç³»

| ã‚¢ã‚¤ãƒ†ãƒ  | ã‚¢ã‚¤ã‚³ãƒ³ | è‰² |
|---------|---------|-----|
| ã‚¹ã‚­ãƒ¼ãƒ | `mdi-folder` | ç’°å¢ƒãƒ†ãƒ¼ãƒè‰² |
| ãƒ†ãƒ¼ãƒ–ãƒ« | `mdi-table` | ç’°å¢ƒãƒ†ãƒ¼ãƒè‰² |
| ãƒ“ãƒ¥ãƒ¼ | `mdi-eye` | ã‚°ãƒ¬ãƒ¼ |
| ã‚«ãƒ©ãƒ ï¼ˆé€šå¸¸ï¼‰ | `mdi-format-text` | ã‚°ãƒ¬ãƒ¼ |
| ã‚«ãƒ©ãƒ ï¼ˆPKï¼‰ | `mdi-key` | ã‚´ãƒ¼ãƒ«ãƒ‰ |
| ã‚«ãƒ©ãƒ ï¼ˆFKï¼‰ | `mdi-link` | ãƒ–ãƒ«ãƒ¼ |
| ã‚«ãƒ©ãƒ ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ | `mdi-star` | ãƒ‘ãƒ¼ãƒ—ãƒ« |

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/components/query-builder/
â”œâ”€â”€ DatabaseTree.vue           # ãƒ¡ã‚¤ãƒ³ãƒ„ãƒªãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ tree/
â”‚   â”œâ”€â”€ TreeNode.vue           # æ±ç”¨ãƒ„ãƒªãƒ¼ãƒãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ SchemaNode.vue         # ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ TableNode.vue          # ãƒ†ãƒ¼ãƒ–ãƒ«ãƒãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ ViewNode.vue           # ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ ColumnNode.vue         # ã‚«ãƒ©ãƒ ãƒãƒ¼ãƒ‰
â”‚   â””â”€â”€ TreeNodeIcon.vue       # ãƒãƒ¼ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³
â””â”€â”€ LeftPanel.vue              # å·¦ãƒ‘ãƒãƒ«ï¼ˆæ›´æ–°ï¼‰
```

---

### DatabaseTree.vue

```vue
<script setup lang="ts">
import { ref, computed, watch, onMounted } from 'vue';
import { useDatabaseStructureStore } from '@/stores/database-structure';
import { useWindowStore } from '@/stores/window';
import SchemaNode from './tree/SchemaNode.vue';
import type { Schema, Table, Column } from '@/types/database-structure';

const props = defineProps<{
  /** æ¤œç´¢ã‚¯ã‚¨ãƒª */
  searchQuery?: string;
}>();

const emit = defineEmits<{
  (e: 'select-table', table: Table): void;
  (e: 'select-column', column: Column, table: Table): void;
  (e: 'drag-start-table', table: Table): void;
  (e: 'drag-start-column', column: Column, table: Table): void;
}>();

const databaseStructureStore = useDatabaseStructureStore();
const windowStore = useWindowStore();

// çŠ¶æ…‹
const isLoading = ref(false);
const error = ref<string | null>(null);
const expandedNodes = ref<Set<string>>(new Set());
const selectedNode = ref<string | null>(null);

// æ¥ç¶šID
const connectionId = computed(() => windowStore.connectionId);

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 
const databaseStructure = computed(() => {
  if (!connectionId.value) return null;
  return databaseStructureStore.getStructure(connectionId.value);
});

// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒ
const filteredSchemas = computed(() => {
  if (!databaseStructure.value) return [];

  const schemas = databaseStructure.value.schemas;

  // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ¼ãƒã‚’éè¡¨ç¤ºã«ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  const hideSystemSchemas = true; // TODO: è¨­å®šã‹ã‚‰å–å¾—

  let filtered = hideSystemSchemas
    ? schemas.filter((s) => !s.isSystem)
    : schemas;

  // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  if (props.searchQuery) {
    const query = props.searchQuery.toLowerCase();
    filtered = filtered
      .map((schema) => ({
        ...schema,
        tables: schema.tables.filter(
          (table) =>
            table.name.toLowerCase().includes(query) ||
            table.columns.some((col) =>
              col.name.toLowerCase().includes(query)
            )
        ),
        views: schema.views.filter(
          (view) =>
            view.name.toLowerCase().includes(query) ||
            view.columns.some((col) =>
              col.name.toLowerCase().includes(query)
            )
        ),
      }))
      .filter((schema) => schema.tables.length > 0 || schema.views.length > 0);
  }

  return filtered;
});

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã‚’èª­ã¿è¾¼ã¿
 */
const loadStructure = async () => {
  if (!connectionId.value) return;

  isLoading.value = true;
  error.value = null;

  try {
    await databaseStructureStore.fetchDatabaseStructure(connectionId.value);
  } catch (e) {
    error.value = e instanceof Error ? e.message : 'Unknown error';
  } finally {
    isLoading.value = false;
  }
};

/**
 * æ§‹é€ ã‚’å†èª­ã¿è¾¼ã¿
 */
const refreshStructure = async () => {
  if (!connectionId.value) return;

  isLoading.value = true;
  error.value = null;

  try {
    await databaseStructureStore.refreshDatabaseStructure(connectionId.value);
  } catch (e) {
    error.value = e instanceof Error ? e.message : 'Unknown error';
  } finally {
    isLoading.value = false;
  }
};

/**
 * ãƒãƒ¼ãƒ‰ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
 */
const toggleNode = (nodeId: string) => {
  if (expandedNodes.value.has(nodeId)) {
    expandedNodes.value.delete(nodeId);
  } else {
    expandedNodes.value.add(nodeId);
  }
};

/**
 * ãƒãƒ¼ãƒ‰é¸æŠ
 */
const selectNode = (nodeId: string) => {
  selectedNode.value = nodeId;
};

/**
 * ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ
 */
const handleTableSelect = (table: Table) => {
  emit('select-table', table);
};

/**
 * ã‚«ãƒ©ãƒ é¸æŠ
 */
const handleColumnSelect = (column: Column, table: Table) => {
  emit('select-column', column, table);
};

/**
 * ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
 */
const handleTableDragStart = (table: Table) => {
  emit('drag-start-table', table);
};

/**
 * ã‚«ãƒ©ãƒ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
 */
const handleColumnDragStart = (column: Column, table: Table) => {
  emit('drag-start-column', column, table);
};

// æ¥ç¶šIDãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰æ§‹é€ ã‚’èª­ã¿è¾¼ã¿
watch(connectionId, () => {
  loadStructure();
});

onMounted(() => {
  if (connectionId.value && !databaseStructure.value) {
    loadStructure();
  }
});

defineExpose({
  refresh: refreshStructure,
});
</script>

<template>
  <div class="database-tree">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div v-if="isLoading" class="tree-loading">
      <v-progress-circular indeterminate size="24" />
      <span class="ml-2">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ -->
    <div v-else-if="error" class="tree-error">
      <v-icon color="error" class="mb-2">mdi-alert-circle</v-icon>
      <p class="text-error text-caption">{{ error }}</p>
      <v-btn
        variant="text"
        size="small"
        color="primary"
        @click="refreshStructure"
      >
        å†è©¦è¡Œ
      </v-btn>
    </div>

    <!-- ç©ºçŠ¶æ…‹ -->
    <div v-else-if="!databaseStructure" class="tree-empty">
      <v-icon color="grey-lighten-1">mdi-database-off</v-icon>
      <p class="text-grey text-caption">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¦ãã ã•ã„</p>
    </div>

    <!-- æ¤œç´¢çµæœãªã— -->
    <div
      v-else-if="searchQuery && filteredSchemas.length === 0"
      class="tree-empty"
    >
      <v-icon color="grey-lighten-1">mdi-magnify</v-icon>
      <p class="text-grey text-caption">
        "{{ searchQuery }}" ã«ä¸€è‡´ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“
      </p>
    </div>

    <!-- ãƒ„ãƒªãƒ¼è¡¨ç¤º -->
    <div v-else class="tree-content">
      <SchemaNode
        v-for="schema in filteredSchemas"
        :key="schema.name"
        :schema="schema"
        :expanded-nodes="expandedNodes"
        :selected-node="selectedNode"
        :search-query="searchQuery"
        @toggle="toggleNode"
        @select="selectNode"
        @select-table="handleTableSelect"
        @select-column="handleColumnSelect"
        @drag-start-table="handleTableDragStart"
        @drag-start-column="handleColumnDragStart"
      />
    </div>
  </div>
</template>

<style scoped>
.database-tree {
  height: 100%;
  overflow: auto;
}

.tree-loading,
.tree-error,
.tree-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  height: 100%;
  text-align: center;
}

.tree-content {
  padding: 4px 0;
}
</style>
```

---

### tree/SchemaNode.vue

```vue
<script setup lang="ts">
import { computed } from 'vue';
import TableNode from './TableNode.vue';
import ViewNode from './ViewNode.vue';
import TreeNodeIcon from './TreeNodeIcon.vue';
import type { Schema, Table, Column } from '@/types/database-structure';

const props = defineProps<{
  schema: Schema;
  expandedNodes: Set<string>;
  selectedNode: string | null;
  searchQuery?: string;
}>();

const emit = defineEmits<{
  (e: 'toggle', nodeId: string): void;
  (e: 'select', nodeId: string): void;
  (e: 'select-table', table: Table): void;
  (e: 'select-column', column: Column, table: Table): void;
  (e: 'drag-start-table', table: Table): void;
  (e: 'drag-start-column', column: Column, table: Table): void;
}>();

const nodeId = computed(() => `schema:${props.schema.name}`);
const isExpanded = computed(() => props.expandedNodes.has(nodeId.value));
const isSelected = computed(() => props.selectedNode === nodeId.value);

const tableCount = computed(() => props.schema.tables.length);
const viewCount = computed(() => props.schema.views.length);

const handleClick = () => {
  emit('toggle', nodeId.value);
  emit('select', nodeId.value);
};
</script>

<template>
  <div class="schema-node">
    <!-- ã‚¹ã‚­ãƒ¼ãƒãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div
      class="node-header"
      :class="{ 'is-selected': isSelected }"
      @click="handleClick"
    >
      <v-icon
        size="small"
        class="expand-icon"
        :class="{ 'is-expanded': isExpanded }"
      >
        mdi-chevron-right
      </v-icon>

      <TreeNodeIcon type="schema" :is-system="schema.isSystem" />

      <span class="node-label">{{ schema.name }}</span>

      <span class="node-badge">
        {{ tableCount + viewCount }}
      </span>
    </div>

    <!-- å­è¦ç´  -->
    <div v-if="isExpanded" class="node-children">
      <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <TableNode
        v-for="table in schema.tables"
        :key="`table:${table.name}`"
        :table="table"
        :expanded-nodes="expandedNodes"
        :selected-node="selectedNode"
        :search-query="searchQuery"
        @toggle="emit('toggle', $event)"
        @select="emit('select', $event)"
        @select-table="emit('select-table', $event)"
        @select-column="(col, tbl) => emit('select-column', col, tbl)"
        @drag-start-table="emit('drag-start-table', $event)"
        @drag-start-column="(col, tbl) => emit('drag-start-column', col, tbl)"
      />

      <!-- ãƒ“ãƒ¥ãƒ¼ -->
      <ViewNode
        v-for="view in schema.views"
        :key="`view:${view.name}`"
        :view="view"
        :expanded-nodes="expandedNodes"
        :selected-node="selectedNode"
        :search-query="searchQuery"
        @toggle="emit('toggle', $event)"
        @select="emit('select', $event)"
      />
    </div>
  </div>
</template>

<style scoped>
.schema-node {
  user-select: none;
}

.node-header {
  display: flex;
  align-items: center;
  padding: 4px 8px;
  cursor: pointer;
  border-radius: 4px;
  gap: 4px;
}

.node-header:hover {
  background: rgba(var(--v-theme-primary), 0.08);
}

.node-header.is-selected {
  background: rgba(var(--v-theme-primary), 0.12);
}

.expand-icon {
  transition: transform 0.2s;
}

.expand-icon.is-expanded {
  transform: rotate(90deg);
}

.node-label {
  flex: 1;
  font-size: 0.875rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.node-badge {
  font-size: 0.75rem;
  color: rgb(var(--v-theme-on-surface-variant));
  background: rgba(var(--v-border-color), 0.2);
  padding: 0 6px;
  border-radius: 10px;
}

.node-children {
  margin-left: 16px;
}
</style>
```

---

### tree/TableNode.vue

```vue
<script setup lang="ts">
import { computed } from 'vue';
import ColumnNode from './ColumnNode.vue';
import TreeNodeIcon from './TreeNodeIcon.vue';
import type { Table, Column } from '@/types/database-structure';

const props = defineProps<{
  table: Table;
  expandedNodes: Set<string>;
  selectedNode: string | null;
  searchQuery?: string;
}>();

const emit = defineEmits<{
  (e: 'toggle', nodeId: string): void;
  (e: 'select', nodeId: string): void;
  (e: 'select-table', table: Table): void;
  (e: 'select-column', column: Column, table: Table): void;
  (e: 'drag-start-table', table: Table): void;
  (e: 'drag-start-column', column: Column, table: Table): void;
}>();

const nodeId = computed(() => `table:${props.table.schema}.${props.table.name}`);
const isExpanded = computed(() => props.expandedNodes.has(nodeId.value));
const isSelected = computed(() => props.selectedNode === nodeId.value);

const columnCount = computed(() => props.table.columns.length);

// æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ
const matchesSearch = computed(() => {
  if (!props.searchQuery) return false;
  return props.table.name.toLowerCase().includes(props.searchQuery.toLowerCase());
});

const handleClick = () => {
  emit('toggle', nodeId.value);
  emit('select', nodeId.value);
};

const handleDoubleClick = () => {
  emit('select-table', props.table);
};

const handleDragStart = (e: DragEvent) => {
  e.dataTransfer?.setData('application/json', JSON.stringify({
    type: 'table',
    data: props.table,
  }));
  emit('drag-start-table', props.table);
};

const handleColumnSelect = (column: Column) => {
  emit('select-column', column, props.table);
};

const handleColumnDragStart = (column: Column) => {
  emit('drag-start-column', column, props.table);
};
</script>

<template>
  <div class="table-node">
    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div
      class="node-header"
      :class="{
        'is-selected': isSelected,
        'is-highlighted': matchesSearch,
      }"
      draggable="true"
      @click="handleClick"
      @dblclick="handleDoubleClick"
      @dragstart="handleDragStart"
    >
      <v-icon
        size="small"
        class="expand-icon"
        :class="{ 'is-expanded': isExpanded }"
      >
        mdi-chevron-right
      </v-icon>

      <TreeNodeIcon type="table" />

      <span class="node-label">{{ table.name }}</span>

      <span class="node-badge">{{ columnCount }}</span>

      <!-- è¡Œæ•°ï¼ˆã‚ã‚Œã°ï¼‰ -->
      <span v-if="table.estimatedRowCount" class="node-row-count">
        ~{{ table.estimatedRowCount.toLocaleString() }}è¡Œ
      </span>
    </div>

    <!-- ã‚«ãƒ©ãƒ ä¸€è¦§ -->
    <div v-if="isExpanded" class="node-children">
      <ColumnNode
        v-for="column in table.columns"
        :key="column.name"
        :column="column"
        :table="table"
        :selected-node="selectedNode"
        :search-query="searchQuery"
        @select="emit('select', $event)"
        @select-column="handleColumnSelect"
        @drag-start="handleColumnDragStart"
      />
    </div>
  </div>
</template>

<style scoped>
.table-node {
  user-select: none;
}

.node-header {
  display: flex;
  align-items: center;
  padding: 4px 8px;
  cursor: pointer;
  border-radius: 4px;
  gap: 4px;
}

.node-header:hover {
  background: rgba(var(--v-theme-primary), 0.08);
}

.node-header.is-selected {
  background: rgba(var(--v-theme-primary), 0.12);
}

.node-header.is-highlighted {
  background: rgba(var(--v-theme-warning), 0.15);
}

.node-header[draggable='true'] {
  cursor: grab;
}

.node-header[draggable='true']:active {
  cursor: grabbing;
}

.expand-icon {
  transition: transform 0.2s;
}

.expand-icon.is-expanded {
  transform: rotate(90deg);
}

.node-label {
  flex: 1;
  font-size: 0.875rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.node-badge {
  font-size: 0.75rem;
  color: rgb(var(--v-theme-on-surface-variant));
  background: rgba(var(--v-border-color), 0.2);
  padding: 0 6px;
  border-radius: 10px;
}

.node-row-count {
  font-size: 0.7rem;
  color: rgb(var(--v-theme-on-surface-variant));
}

.node-children {
  margin-left: 16px;
}
</style>
```

---

### tree/ColumnNode.vue

```vue
<script setup lang="ts">
import { computed } from 'vue';
import TreeNodeIcon from './TreeNodeIcon.vue';
import type { Column, Table } from '@/types/database-structure';

const props = defineProps<{
  column: Column;
  table: Table;
  selectedNode: string | null;
  searchQuery?: string;
}>();

const emit = defineEmits<{
  (e: 'select', nodeId: string): void;
  (e: 'select-column', column: Column): void;
  (e: 'drag-start', column: Column): void;
}>();

const nodeId = computed(
  () => `column:${props.table.schema}.${props.table.name}.${props.column.name}`
);
const isSelected = computed(() => props.selectedNode === nodeId.value);

// ã‚«ãƒ©ãƒ ã‚¿ã‚¤ãƒ—
const columnType = computed(() => {
  if (props.column.isPrimaryKey) return 'primary-key';
  if (props.column.isForeignKey) return 'foreign-key';
  if (props.column.isUnique) return 'unique';
  return 'column';
});

// æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ
const matchesSearch = computed(() => {
  if (!props.searchQuery) return false;
  return props.column.name.toLowerCase().includes(props.searchQuery.toLowerCase());
});

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å†…å®¹
const tooltipContent = computed(() => {
  const lines = [
    `${props.column.name} (${props.column.displayType})`,
  ];

  if (props.column.isPrimaryKey) lines.push('PRIMARY KEY');
  if (props.column.isForeignKey) lines.push('FOREIGN KEY');
  if (props.column.isUnique) lines.push('UNIQUE');
  if (!props.column.nullable) lines.push('NOT NULL');
  if (props.column.defaultValue) lines.push(`DEFAULT: ${props.column.defaultValue}`);
  if (props.column.comment) lines.push(`ã‚³ãƒ¡ãƒ³ãƒˆ: ${props.column.comment}`);

  return lines.join('\n');
});

const handleClick = () => {
  emit('select', nodeId.value);
};

const handleDoubleClick = () => {
  emit('select-column', props.column);
};

const handleDragStart = (e: DragEvent) => {
  e.dataTransfer?.setData('application/json', JSON.stringify({
    type: 'column',
    data: {
      column: props.column,
      table: props.table,
    },
  }));
  emit('drag-start', props.column);
};
</script>

<template>
  <div
    class="column-node"
    :class="{
      'is-selected': isSelected,
      'is-highlighted': matchesSearch,
    }"
    draggable="true"
    :title="tooltipContent"
    @click="handleClick"
    @dblclick="handleDoubleClick"
    @dragstart="handleDragStart"
  >
    <TreeNodeIcon :type="columnType" />

    <span class="column-name">{{ column.name }}</span>

    <span class="column-type">{{ column.displayType }}</span>

    <!-- NULLè¨±å¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <span v-if="!column.nullable" class="not-null-indicator" title="NOT NULL">
      *
    </span>
  </div>
</template>

<style scoped>
.column-node {
  display: flex;
  align-items: center;
  padding: 3px 8px;
  cursor: pointer;
  border-radius: 4px;
  gap: 4px;
  user-select: none;
}

.column-node:hover {
  background: rgba(var(--v-theme-primary), 0.08);
}

.column-node.is-selected {
  background: rgba(var(--v-theme-primary), 0.12);
}

.column-node.is-highlighted {
  background: rgba(var(--v-theme-warning), 0.15);
}

.column-node[draggable='true'] {
  cursor: grab;
}

.column-node[draggable='true']:active {
  cursor: grabbing;
}

.column-name {
  font-size: 0.8125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.column-type {
  font-size: 0.75rem;
  color: rgb(var(--v-theme-on-surface-variant));
  margin-left: auto;
}

.not-null-indicator {
  color: rgb(var(--v-theme-error));
  font-weight: bold;
}
</style>
```

---

### tree/TreeNodeIcon.vue

```vue
<script setup lang="ts">
import { computed } from 'vue';

const props = defineProps<{
  type: 'schema' | 'table' | 'view' | 'column' | 'primary-key' | 'foreign-key' | 'unique';
  isSystem?: boolean;
}>();

const iconConfig = computed(() => {
  const configs: Record<string, { icon: string; color: string }> = {
    schema: {
      icon: 'mdi-folder',
      color: props.isSystem ? 'grey' : 'primary',
    },
    table: {
      icon: 'mdi-table',
      color: 'primary',
    },
    view: {
      icon: 'mdi-eye',
      color: 'grey',
    },
    column: {
      icon: 'mdi-format-text',
      color: 'grey',
    },
    'primary-key': {
      icon: 'mdi-key',
      color: 'amber-darken-2',
    },
    'foreign-key': {
      icon: 'mdi-link',
      color: 'blue',
    },
    unique: {
      icon: 'mdi-star',
      color: 'purple',
    },
  };

  return configs[props.type] || configs.column;
});
</script>

<template>
  <v-icon :icon="iconConfig.icon" :color="iconConfig.color" size="small" />
</template>
```

---

### LeftPanel.vueï¼ˆæ›´æ–°ç‰ˆï¼‰

```vue
<script setup lang="ts">
import { ref } from 'vue';
import DatabaseTree from './DatabaseTree.vue';
import type { Table, Column } from '@/types/database-structure';

const emit = defineEmits<{
  (e: 'select-table', table: Table): void;
  (e: 'select-column', column: Column, table: Table): void;
  (e: 'drag-start-table', table: Table): void;
  (e: 'drag-start-column', column: Column, table: Table): void;
}>();

// æ¤œç´¢ã‚¯ã‚¨ãƒª
const searchQuery = ref('');
const databaseTreeRef = ref<InstanceType<typeof DatabaseTree> | null>(null);

/**
 * ãƒ„ãƒªãƒ¼ã‚’æ›´æ–°
 */
const refreshTree = () => {
  databaseTreeRef.value?.refresh();
};

/**
 * ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ
 */
const handleTableSelect = (table: Table) => {
  emit('select-table', table);
};

/**
 * ã‚«ãƒ©ãƒ é¸æŠ
 */
const handleColumnSelect = (column: Column, table: Table) => {
  emit('select-column', column, table);
};

/**
 * ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
 */
const handleTableDragStart = (table: Table) => {
  emit('drag-start-table', table);
};

/**
 * ã‚«ãƒ©ãƒ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
 */
const handleColumnDragStart = (column: Column, table: Table) => {
  emit('drag-start-column', column, table);
};
</script>

<template>
  <div class="left-panel">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="panel-header">
      <span class="panel-title">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ </span>
      <v-btn
        icon
        variant="text"
        size="x-small"
        title="æ›´æ–°"
        @click="refreshTree"
      >
        <v-icon size="small">mdi-refresh</v-icon>
      </v-btn>
    </div>

    <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
    <div class="search-box">
      <v-text-field
        v-model="searchQuery"
        density="compact"
        variant="outlined"
        placeholder="ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚«ãƒ©ãƒ ã‚’æ¤œç´¢..."
        prepend-inner-icon="mdi-magnify"
        hide-details
        clearable
      />
    </div>

    <!-- DBæ§‹é€ ãƒ„ãƒªãƒ¼ -->
    <div class="tree-container">
      <DatabaseTree
        ref="databaseTreeRef"
        :search-query="searchQuery"
        @select-table="handleTableSelect"
        @select-column="handleColumnSelect"
        @drag-start-table="handleTableDragStart"
        @drag-start-column="handleColumnDragStart"
      />
    </div>
  </div>
</template>

<style scoped>
.left-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: rgb(var(--v-theme-surface));
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border-bottom: 1px solid rgba(var(--v-border-color), var(--v-border-opacity));
}

.panel-title {
  font-size: 0.875rem;
  font-weight: 500;
}

.search-box {
  padding: 8px;
  border-bottom: 1px solid rgba(var(--v-border-color), var(--v-border-opacity));
}

.tree-container {
  flex: 1;
  overflow: hidden;
}
</style>
```

---

## ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—è¨­è¨ˆ

### ãƒ‡ãƒ¼ã‚¿è»¢é€å½¢å¼

```typescript
// ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‰ãƒ©ãƒƒã‚°æ™‚
interface TableDragData {
  type: 'table';
  data: Table;
}

// ã‚«ãƒ©ãƒ ãƒ‰ãƒ©ãƒƒã‚°æ™‚
interface ColumnDragData {
  type: 'column';
  data: {
    column: Column;
    table: Table;
  };
}
```

### ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

| ãƒ‰ãƒ­ãƒƒãƒ—å…ˆ | ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚«ãƒ©ãƒ  |
|-----------|---------|--------|
| ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚å›³ | ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ  | - |
| ã‚«ãƒ©ãƒ é¸æŠã‚¨ãƒªã‚¢ | å…¨ã‚«ãƒ©ãƒ é¸æŠ | ã‚«ãƒ©ãƒ è¿½åŠ  |
| WHEREæ¡ä»¶ã‚¨ãƒªã‚¢ | - | æ¡ä»¶è¿½åŠ  |

---

## ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£

### ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

| ã‚­ãƒ¼ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|------|-----------|
| `â†‘` / `â†“` | å‰å¾Œã®ãƒãƒ¼ãƒ‰ã¸ç§»å‹• |
| `â†` | ãƒãƒ¼ãƒ‰ã‚’æŠ˜ã‚ŠãŸãŸã‚€ / è¦ªã¸ç§»å‹• |
| `â†’` | ãƒãƒ¼ãƒ‰ã‚’å±•é–‹ |
| `Enter` | ãƒãƒ¼ãƒ‰ã‚’é¸æŠ / ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚«ãƒ©ãƒ ã‚’è¿½åŠ  |
| `Space` | ãƒãƒ¼ãƒ‰ã‚’å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ |

### ARIAãƒ©ãƒ™ãƒ«

```html
<div role="tree" aria-label="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ">
  <div role="treeitem" aria-expanded="true" aria-level="1">
    ã‚¹ã‚­ãƒ¼ãƒå
    <div role="group">
      <div role="treeitem" aria-level="2">ãƒ†ãƒ¼ãƒ–ãƒ«å</div>
    </div>
  </div>
</div>
```

---

## ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```typescript
describe('DatabaseTree', () => {
  it('should render schema tree', () => {
    // ã‚¹ã‚­ãƒ¼ãƒãƒ„ãƒªãƒ¼ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
  });

  it('should expand/collapse nodes', () => {
    // ãƒãƒ¼ãƒ‰ã®å±•é–‹ãƒ»æŠ˜ã‚ŠãŸãŸã¿ãŒå‹•ä½œã™ã‚‹ã“ã¨
  });

  it('should filter by search query', () => {
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒå‹•ä½œã™ã‚‹ã“ã¨
  });

  it('should emit drag events', () => {
    // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹ã“ã¨
  });
});
```

### E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

```
ã‚·ãƒŠãƒªã‚ª1: ãƒ„ãƒªãƒ¼è¡¨ç¤º
1. ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã‚’é–‹ã
2. å·¦ãƒ‘ãƒãƒ«ã«DBæ§‹é€ ãƒ„ãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. ã‚¹ã‚­ãƒ¼ãƒã‚’å±•é–‹ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’ç¢ºèª
4. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å±•é–‹ã—ã¦ã‚«ãƒ©ãƒ ä¸€è¦§ã‚’ç¢ºèª

ã‚·ãƒŠãƒªã‚ª2: æ¤œç´¢æ©Ÿèƒ½
1. æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›
2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ„ãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ã‚¯ãƒªã‚¢ã—ã¦å…¨ä½“ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `src/components/query-builder/DatabaseTree.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/tree/TreeNode.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/tree/SchemaNode.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/tree/TableNode.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/tree/ViewNode.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/tree/ColumnNode.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/tree/TreeNodeIcon.vue` ã®ä½œæˆ
- [ ] `src/components/query-builder/LeftPanel.vue` ã®æ›´æ–°
- [ ] æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…
- [ ] ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®å®Ÿè£…
- [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ä½œæˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆã®ä½œæˆ

---

## å‚è€ƒè³‡æ–™

- [Nuxt UI v4 Documentation](https://ui.nuxt.com/)
- [Nuxt UI Components](https://ui.nuxt.com/components)
- [Tailwind CSS v4](https://tailwindcss.com/)
- [HTML Drag and Drop API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API)
- [WAI-ARIA Tree View](https://www.w3.org/WAI/ARIA/apg/patterns/treeview/)
