# 1.5b.2 Nuxt UI移行 Phase 2: Nuxt 3への移行

## 概要

| 項目 | 内容 |
|------|------|
| タスクID | 1.5b.2 |
| タスク名 | Nuxt UI移行Phase 2: Nuxt 3導入 |
| 担当 | FE/BE |
| 工数 | 56時間 (1週間) |
| 依存関係 | 1.5b.1 (Phase 1: 環境構築) |
| 完了条件 | 全ページアクセス可能、IPC動作 |

## 目的

Phase 1で構築した環境を基に、Vue 3 + ViteからNuxt 3への本格的な移行を実施する。

この段階で以下を達成する:
- ファイルベースルーティングの実装
- レイアウトシステムの構築
- Piniaの統合
- Tauri IPCの動作確認
- 全ページへのアクセス確認

---

## タスク詳細

### 2.1 ルーティング移行 (16時間)

#### 2.1.1 ファイルベースルーティング設定

**Nuxt 3のファイルベースルーティング**:

```
app/pages/
├── index.vue                 → /
├── query-builder.vue         → /query-builder
├── settings.vue              → /settings
└── connection-form.vue       → /connection-form
```

**`nuxt.config.ts`でルーティング設定**:

```typescript
export default defineNuxtConfig({
  // ...

  // ルーティング設定
  router: {
    options: {
      // 厳密なトレーリングスラッシュ
      strict: false
    }
  }
})
```

**完了条件**: Nuxtのファイルベースルーティングが機能する

---

#### 2.1.2 ランチャーページ移行

**`app/pages/index.vue`の作成**:

```vue
<script setup lang="ts">
// メタデータ設定
definePageMeta({
  layout: 'launcher',
  title: 'SQLエディタ ランチャー'
})

// Piniaストア
const connectionStore = useConnectionStore()
const { connections, loading } = storeToRefs(connectionStore)

// 接続を読み込み
onMounted(async () => {
  await connectionStore.loadConnections()
})

// 接続選択ハンドラー
const handleSelectConnection = async (connection: Connection) => {
  // Tauriコマンドで新しいウィンドウを起動
  await invoke('launch_window', {
    connectionId: connection.id,
    route: '/query-builder'
  })
}
</script>

<template>
  <div class="launcher-page">
    <LauncherToolbar
      v-model:search="searchQuery"
      v-model:filter="environmentFilter"
      v-model:sort="sortOption"
    />

    <ConnectionList
      :connections="filteredConnections"
      :loading="loading"
      @select-connection="handleSelectConnection"
      @edit-connection="handleEditConnection"
      @delete-connection="handleDeleteConnection"
    />
  </div>
</template>

<style scoped>
.launcher-page {
  @apply p-6 space-y-6;
}
</style>
```

**完了条件**: ランチャーページにアクセス可能

---

#### 2.1.3 クエリビルダーページ移行

**`app/pages/query-builder.vue`の作成**:

```vue
<script setup lang="ts">
definePageMeta({
  layout: 'query-builder',
  title: 'クエリビルダー'
})

// URLからconnectionIdを取得
const route = useRoute()
const connectionId = computed(() => route.query.connectionId as string)

// 接続情報を取得
const connectionStore = useConnectionStore()
const connection = computed(() =>
  connectionStore.getConnectionById(connectionId.value)
)

// ウィンドウタイトルを設定
useHead({
  title: computed(() =>
    connection.value ? `${connection.value.name} - クエリビルダー` : 'クエリビルダー'
  )
})

// クエリビルダーストア
const queryStore = useQueryStore()

onMounted(async () => {
  if (connectionId.value) {
    await connectionStore.loadConnection(connectionId.value)
    await queryStore.initialize(connectionId.value)
  }
})
</script>

<template>
  <div class="query-builder-page">
    <template v-if="connection">
      <QueryBuilderLayout :connection="connection" />
    </template>
    <template v-else>
      <div class="flex items-center justify-center h-screen">
        <UIcon name="i-heroicons-circle-notch" class="animate-spin text-4xl" />
      </div>
    </template>
  </div>
</template>
```

**完了条件**: クエリビルダーページにアクセス可能

---

#### 2.1.4 設定ページ移行

**`app/pages/settings.vue`の作成**:

```vue
<script setup lang="ts">
definePageMeta({
  layout: 'default',
  title: '設定'
})

const settingsStore = useSettingsStore()
const { settings, loading } = storeToRefs(settingsStore)

onMounted(async () => {
  await settingsStore.loadSettings()
})
</script>

<template>
  <div class="settings-page p-8">
    <h1 class="text-3xl font-bold mb-6">設定</h1>

    <UTabs :items="tabs">
      <template #general>
        <GeneralSettings v-model="settings.general" />
      </template>

      <template #security>
        <SecuritySettings v-model="settings.security" />
      </template>

      <template #about>
        <AboutSection />
      </template>
    </UTabs>
  </div>
</template>
```

**完了条件**: 設定ページにアクセス可能

---

#### 2.1.5 接続フォームページ移行

**`app/pages/connection-form.vue`の作成**:

```vue
<script setup lang="ts">
definePageMeta({
  layout: 'default',
  title: '接続設定'
})

const route = useRoute()
const router = useRouter()
const connectionStore = useConnectionStore()

// 編集モードの判定
const connectionId = computed(() => route.query.id as string | undefined)
const isEditMode = computed(() => !!connectionId.value)

// フォームデータ
const formData = ref<ConnectionFormData>({
  name: '',
  environment: 'development',
  host: '',
  port: 5432,
  database: '',
  username: '',
  password: '',
  dbType: 'postgresql',
  ssl: false
})

// 保存ハンドラー
const handleSave = async () => {
  try {
    if (isEditMode.value) {
      await connectionStore.updateConnection(connectionId.value!, formData.value)
    } else {
      await connectionStore.createConnection(formData.value)
    }

    await router.push('/')
  } catch (error) {
    console.error('Failed to save connection:', error)
  }
}
</script>

<template>
  <div class="connection-form-page p-8">
    <h1 class="text-3xl font-bold mb-6">
      {{ isEditMode ? '接続の編集' : '新規接続' }}
    </h1>

    <ConnectionForm
      v-model="formData"
      :is-edit-mode="isEditMode"
      @save="handleSave"
      @cancel="router.push('/')"
    />
  </div>
</template>
```

**完了条件**: 接続フォームページにアクセス可能

---

#### 2.1.6 ナビゲーション機能実装

**`navigateTo`の使用**:

```typescript
// ページ遷移
const goToSettings = () => {
  navigateTo('/settings')
}

// クエリパラメータ付き遷移
const goToConnectionForm = (connectionId?: string) => {
  navigateTo({
    path: '/connection-form',
    query: connectionId ? { id: connectionId } : {}
  })
}

// 外部リンク
const openExternal = (url: string) => {
  navigateTo(url, { external: true })
}
```

**完了条件**: ページ遷移が正しく動作する

---

#### 2.1.7 Tauriウィンドウ別URL対応

**ウィンドウ起動時のURL指定**:

```rust
// src-tauri/src/commands/window.rs

#[tauri::command]
pub async fn launch_window(
    app: AppHandle,
    connection_id: String,
    route: String
) -> Result<(), String> {
    let window_label = format!("query-builder-{}", connection_id);

    // ウィンドウが既に存在する場合はフォーカス
    if let Some(window) = app.get_window(&window_label) {
        window.set_focus().map_err(|e| e.to_string())?;
        return Ok(());
    }

    // 新しいウィンドウを作成
    let url = format!("http://localhost:1420{}?connectionId={}", route, connection_id);

    tauri::WindowBuilder::new(
        &app,
        window_label,
        tauri::WindowUrl::External(url.parse().unwrap())
    )
    .title("クエリビルダー")
    .build()
    .map_err(|e| e.to_string())?;

    Ok(())
}
```

**完了条件**: マルチウィンドウで異なるURLが開く

---

#### 2.1.8 ルーティングテスト

**テストケース**:

```typescript
// tests/e2e/routing.spec.ts

import { test, expect } from '@playwright/test'

test.describe('Nuxt Routing', () => {
  test('should navigate to launcher page', async ({ page }) => {
    await page.goto('http://localhost:1420')
    await expect(page).toHaveURL('/')
    await expect(page.locator('h1')).toContainText('ランチャー')
  })

  test('should navigate to settings page', async ({ page }) => {
    await page.goto('http://localhost:1420/settings')
    await expect(page).toHaveURL('/settings')
    await expect(page.locator('h1')).toContainText('設定')
  })

  test('should navigate with query parameters', async ({ page }) => {
    const connectionId = 'test-connection-id'
    await page.goto(`http://localhost:1420/query-builder?connectionId=${connectionId}`)
    await expect(page).toHaveURL(/connectionId=test-connection-id/)
  })
})
```

**完了条件**: 全ルーティングテストが通過する

---

### 2.2 レイアウトシステム構築 (16時間)

#### 2.2.1 `default.vue`レイアウト作成

**`app/layouts/default.vue`の作成**:

```vue
<script setup lang="ts">
// グローバルヘッダーの設定など
</script>

<template>
  <div class="default-layout">
    <header class="layout-header">
      <UContainer>
        <div class="flex items-center justify-between py-4">
          <NuxtLink to="/" class="flex items-center gap-2">
            <UIcon name="i-heroicons-circle-stack" class="text-2xl" />
            <span class="text-xl font-bold">SQLエディタ</span>
          </NuxtLink>

          <nav class="flex gap-4">
            <UButton to="/settings" variant="ghost">
              設定
            </UButton>
          </nav>
        </div>
      </UContainer>
    </header>

    <main class="layout-main">
      <slot />
    </main>
  </div>
</template>

<style scoped>
.default-layout {
  @apply min-h-screen flex flex-col;
}

.layout-header {
  @apply border-b border-gray-200 dark:border-gray-800;
}

.layout-main {
  @apply flex-1;
}
</style>
```

**完了条件**: デフォルトレイアウトが表示される

---

#### 2.2.2 `launcher.vue`レイアウト作成

**`app/layouts/launcher.vue`の作成**:

```vue
<script setup lang="ts">
const router = useRouter()

const handleNewConnection = () => {
  router.push('/connection-form')
}

const handleOpenSettings = () => {
  router.push('/settings')
}
</script>

<template>
  <div class="launcher-layout">
    <header class="launcher-header bg-primary text-white">
      <UContainer>
        <div class="flex items-center justify-between py-4">
          <div class="flex items-center gap-3">
            <UIcon name="i-heroicons-circle-stack" class="text-3xl" />
            <h1 class="text-2xl font-bold">SQLエディタ ランチャー</h1>
          </div>

          <div class="flex gap-3">
            <UButton
              icon="i-heroicons-plus-circle"
              color="white"
              variant="solid"
              @click="handleNewConnection"
            >
              新規接続
            </UButton>

            <UButton
              icon="i-heroicons-cog-6-tooth"
              color="white"
              variant="ghost"
              @click="handleOpenSettings"
            />
          </div>
        </div>
      </UContainer>
    </header>

    <main class="launcher-main">
      <UContainer>
        <slot />
      </UContainer>
    </main>
  </div>
</template>

<style scoped>
.launcher-layout {
  @apply min-h-screen flex flex-col bg-gray-50 dark:bg-gray-900;
}

.launcher-header {
  @apply shadow-md;
}

.launcher-main {
  @apply flex-1 py-6;
}
</style>
```

**完了条件**: ランチャーレイアウトが表示される

---

#### 2.2.3 `query-builder.vue`レイアウト作成

**`app/layouts/query-builder.vue`の作成**:

```vue
<script setup lang="ts">
const route = useRoute()
const connectionStore = useConnectionStore()

// 接続情報を取得
const connectionId = computed(() => route.query.connectionId as string)
const connection = computed(() =>
  connectionStore.getConnectionById(connectionId.value)
)

// 環境別クラス
const environmentClass = computed(() => {
  if (!connection.value) return ''
  return `env-${connection.value.environment}`
})
</script>

<template>
  <div class="query-builder-layout" :class="environmentClass">
    <!-- 環境識別ヘッダー -->
    <EnvironmentHeader
      v-if="connection"
      :environment="connection.environment"
      :connection-name="connection.name"
    />

    <!-- ツールバー -->
    <QueryBuilderToolbar />

    <!-- 3カラムレイアウト -->
    <div class="grid grid-cols-12 gap-4 h-[calc(100vh-120px)] p-4">
      <!-- 左パネル: データベース構造 -->
      <aside class="col-span-2 overflow-y-auto">
        <slot name="left-panel" />
      </aside>

      <!-- 中央パネル: クエリビルダー -->
      <main class="col-span-7 overflow-y-auto">
        <slot />
      </main>

      <!-- 右パネル: SQLプレビュー -->
      <aside class="col-span-3 overflow-y-auto">
        <slot name="right-panel" />
      </aside>
    </div>
  </div>
</template>

<style scoped>
.query-builder-layout {
  @apply min-h-screen flex flex-col;
}
</style>
```

**完了条件**: クエリビルダーレイアウトが表示される

---

#### 2.2.4 環境識別ヘッダー統合

**`app/components/common/EnvironmentHeader.vue`の作成**:

```vue
<script setup lang="ts">
interface Props {
  environment: 'development' | 'test' | 'staging' | 'production'
  connectionName: string
}

const props = defineProps<Props>()

const environmentConfig = {
  development: {
    label: '開発環境',
    icon: 'i-heroicons-code-bracket',
    color: 'development'
  },
  test: {
    label: 'テスト環境',
    icon: 'i-heroicons-beaker',
    color: 'test'
  },
  staging: {
    label: 'ステージング環境',
    icon: 'i-heroicons-adjustments-horizontal',
    color: 'staging'
  },
  production: {
    label: '本番環境',
    icon: 'i-heroicons-exclamation-triangle',
    color: 'production'
  }
}

const config = computed(() => environmentConfig[props.environment])
</script>

<template>
  <header :class="`env-${environment} border-b-4`">
    <UContainer>
      <div class="flex items-center justify-between py-3">
        <div class="flex items-center gap-3">
          <UIcon :name="config.icon" class="text-2xl" />
          <div>
            <div class="text-sm font-semibold text-gray-600 dark:text-gray-400">
              {{ config.label }}
            </div>
            <div class="text-lg font-bold">
              {{ connectionName }}
            </div>
          </div>
        </div>

        <!-- 本番環境警告 -->
        <UAlert
          v-if="environment === 'production'"
          color="red"
          icon="i-heroicons-exclamation-triangle"
          title="本番環境"
          description="操作には十分注意してください"
        />
      </div>
    </UContainer>
  </header>
</template>
```

**完了条件**: 環境別ヘッダーが正しく表示される

---

### 2.3 Pinia統合 (8時間)

#### 2.3.1 `@pinia/nuxt`インストール

```bash
npm install @pinia/nuxt@^0.7.0
```

**`nuxt.config.ts`にモジュール追加** (Phase 1で実施済み)

---

#### 2.3.2-2.3.7 既存ストア動作確認

**各ストアをNuxt 3で動作確認**:

1. `app/stores/theme.ts`
2. `app/stores/connection.ts`
3. `app/stores/window.ts`
4. `app/stores/settings.ts`
5. `app/stores/security.ts`

**Nuxt 3での自動インポート例**:

```vue
<script setup lang="ts">
// import不要（自動インポート）
const connectionStore = useConnectionStore()
const { connections } = storeToRefs(connectionStore)
</script>
```

**完了条件**: 全ストアが自動インポートで動作する

---

#### 2.3.8 自動インポート確認

**`tsconfig.json`で型定義確認**:

```json
{
  "extends": "./.nuxt/tsconfig.json"
}
```

**完了条件**: IDEで自動補完が効く

---

### 2.4 Tauri IPC統合 (16時間)

#### 2.4.1-2.4.4 Tauri設定

**`nuxt.config.ts`のTauri設定** (Phase 1で実施済み)

**完了条件**: Tauri環境変数がアクセス可能

---

#### 2.4.5-2.4.7 IPC通信テスト

**各機能のIPCコマンドをテスト**:

```typescript
// 接続管理
await invoke('get_connections')
await invoke('create_connection', { connection })
await invoke('update_connection', { id, connection })
await invoke('delete_connection', { id })

// ウィンドウ管理
await invoke('launch_window', { connectionId, route })
await invoke('close_window', { windowLabel })

// セキュリティ
await invoke('get_security_provider_info')
await invoke('unlock_provider', { params })
```

**完了条件**: 全IPCコマンドが動作する

---

#### 2.4.8 マルチウィンドウ動作確認

**テストシナリオ**:

1. ランチャーから複数の接続を開く
2. 各ウィンドウが独立して動作することを確認
3. ウィンドウ間でデータが干渉しないことを確認

**完了条件**: マルチウィンドウが正しく動作する

---

#### 2.4.9 Tauriビルドテスト

```bash
npm run tauri build
```

**完了条件**: ビルドが成功し、アプリが起動する

---

#### 2.4.10 統合動作確認

**E2Eテストの実行**:

```bash
npm run test:e2e
```

**完了条件**: 全テストが通過する

---

## 成果物

### レイアウト
- [ ] `app/layouts/default.vue`
- [ ] `app/layouts/launcher.vue`
- [ ] `app/layouts/query-builder.vue`

### ページ
- [ ] `app/pages/index.vue`
- [ ] `app/pages/query-builder.vue`
- [ ] `app/pages/settings.vue`
- [ ] `app/pages/connection-form.vue`

### コンポーネント
- [ ] `app/components/common/EnvironmentHeader.vue`

### ストア
- [ ] `app/stores/theme.ts` (動作確認)
- [ ] `app/stores/connection.ts` (動作確認)
- [ ] `app/stores/window.ts` (動作確認)
- [ ] `app/stores/settings.ts` (動作確認)
- [ ] `app/stores/security.ts` (動作確認)

---

## テスト観点

### ルーティング
- [ ] 全ページにアクセス可能
- [ ] ページ遷移が正しく動作する
- [ ] クエリパラメータが正しく渡される

### レイアウト
- [ ] 各レイアウトが正しく表示される
- [ ] 環境別ヘッダーが正しく表示される
- [ ] 3カラムレイアウトが正しく動作する

### Pinia
- [ ] 全ストアが自動インポートで動作する
- [ ] ストア間の連携が正しく動作する

### Tauri IPC
- [ ] 全IPCコマンドが動作する
- [ ] マルチウィンドウが正しく動作する

---

## 実装チェックリスト

### 2.1 ルーティング移行
- [ ] 2.1.1 ファイルベースルーティング設定
- [ ] 2.1.2 ランチャーページ移行
- [ ] 2.1.3 クエリビルダーページ移行
- [ ] 2.1.4 設定ページ移行
- [ ] 2.1.5 接続フォームページ移行
- [ ] 2.1.6 ナビゲーション機能実装
- [ ] 2.1.7 Tauriウィンドウ別URL対応
- [ ] 2.1.8 ルーティングテスト

### 2.2 レイアウトシステム構築
- [ ] 2.2.1 `default.vue`レイアウト作成
- [ ] 2.2.2 `launcher.vue`レイアウト作成
- [ ] 2.2.3 `query-builder.vue`レイアウト作成
- [ ] 2.2.4 環境識別ヘッダー統合

### 2.3 Pinia統合
- [ ] 2.3.1 `@pinia/nuxt`インストール
- [ ] 2.3.2-2.3.7 既存ストア動作確認
- [ ] 2.3.8 自動インポート確認

### 2.4 Tauri IPC統合
- [ ] 2.4.1-2.4.4 Tauri設定
- [ ] 2.4.5-2.4.7 IPC通信テスト
- [ ] 2.4.8 マルチウィンドウ動作確認
- [ ] 2.4.9 Tauriビルドテスト
- [ ] 2.4.10 統合動作確認

---

## 次のステップ

**1.5b.3 Phase 3: UIコンポーネント移行** に進みます。

- 全42コンポーネントのNuxt UI v4への移行
- Vuetify → Nuxt UIコンポーネントマッピング
- アイコンのIconify移行

---

**作成日**: 2025-12-06
**作成者**: Claude Code
