# タスク1.5.2: ウィンドウ起動コマンド実装 設計書

## 概要

**タスクID**: 1.5.2
**タスク名**: ウィンドウ起動コマンド実装
**工数**: 1日
**依存関係**: 1.5.1 (Tauriウィンドウ管理モジュール実装)
**完了条件**: 接続選択でウィンドウ起動

---

## 目的

フロントエンドからウィンドウを操作するためのTauriコマンドを実装する。ランチャー画面から接続を選択した際に、新しいクエリビルダーウィンドウを起動できるようにする。

---

## 機能要件

### 主要機能

1. **クエリビルダーウィンドウ起動**
   - 接続情報を指定してウィンドウを開く
   - 接続名・環境をタイトルに反映

2. **設定ウィンドウ起動**
   - 設定画面用のウィンドウを開く

3. **ウィンドウ操作**
   - ウィンドウのクローズ
   - ウィンドウへのフォーカス
   - ウィンドウタイトルの更新

4. **ウィンドウ情報取得**
   - 開いているウィンドウの一覧取得
   - 接続IDによるウィンドウ検索

---

## Tauriコマンド一覧

| コマンド名 | 説明 | パラメータ |
|-----------|------|-----------|
| `open_query_builder_window` | クエリビルダーウィンドウを開く | connection_id, connection_name, environment |
| `open_settings_window` | 設定ウィンドウを開く | なし |
| `close_window` | ウィンドウを閉じる | label |
| `focus_window` | ウィンドウにフォーカス | label |
| `list_windows` | 全ウィンドウを取得 | なし |
| `find_window_by_connection` | 接続IDでウィンドウ検索 | connection_id |
| `set_window_title` | ウィンドウタイトルを更新 | label, title |
| `get_current_window_info` | 現在のウィンドウ情報取得 | label |
| `restore_windows` | ウィンドウ状態を復元 | なし |
| `save_all_window_states` | 全ウィンドウ状態を保存 | なし |

---

## 実装詳細

### Tauriコマンド

**ファイル**: `src-tauri/src/commands/window.rs`

```rust
use tauri::{command, AppHandle, State};

use crate::models::window::{WindowCreateOptions, WindowInfo, WindowType};
use crate::services::window_manager::WindowManager;

/// クエリビルダーウィンドウを開く
#[command]
pub async fn open_query_builder_window(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
    connection_id: String,
    connection_name: String,
    environment: String,
) -> Result<WindowInfo, String> {
    let title = format!("{} [{}] - SQL Query Builder", connection_name, get_environment_label(&environment));

    let options = WindowCreateOptions {
        title,
        window_type: WindowType::QueryBuilder,
        connection_id: Some(connection_id),
        width: Some(1400),
        height: Some(900),
        center: true,
        restore_state: true,
    };

    window_manager.create_window(&app_handle, options)
}

/// 設定ウィンドウを開く
#[command]
pub async fn open_settings_window(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
) -> Result<WindowInfo, String> {
    let options = WindowCreateOptions {
        title: "設定 - SQL Query Builder".to_string(),
        window_type: WindowType::Settings,
        connection_id: None,
        width: Some(800),
        height: Some(600),
        center: true,
        restore_state: false,
    };

    window_manager.create_window(&app_handle, options)
}

/// ウィンドウを閉じる
#[command]
pub async fn close_window(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
    label: String,
) -> Result<(), String> {
    window_manager.close_window(&app_handle, &label)
}

/// ウィンドウにフォーカス
#[command]
pub async fn focus_window(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
    label: String,
) -> Result<(), String> {
    window_manager.focus_window(&app_handle, &label)
}

/// すべてのウィンドウを取得
#[command]
pub async fn list_windows(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
) -> Result<Vec<WindowInfo>, String> {
    Ok(window_manager.list_windows(&app_handle))
}

/// 接続IDでウィンドウを検索
#[command]
pub async fn find_window_by_connection(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
    connection_id: String,
) -> Result<Option<WindowInfo>, String> {
    Ok(window_manager.find_window_by_connection(&app_handle, &connection_id))
}

/// ウィンドウタイトルを更新
#[command]
pub async fn set_window_title(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
    label: String,
    title: String,
) -> Result<(), String> {
    window_manager.set_window_title(&app_handle, &label, &title)
}

/// 現在のウィンドウ情報を取得
#[command]
pub async fn get_current_window_info(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
    label: String,
) -> Result<Option<WindowInfo>, String> {
    let windows = window_manager.list_windows(&app_handle);
    Ok(windows.into_iter().find(|w| w.label == label))
}

/// ウィンドウ状態を復元
#[command]
pub async fn restore_windows(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
) -> Result<Vec<WindowInfo>, String> {
    window_manager.restore_windows(&app_handle)
}

/// すべてのウィンドウ状態を保存
#[command]
pub async fn save_all_window_states(
    app_handle: AppHandle,
    window_manager: State<'_, WindowManager>,
) -> Result<(), String> {
    window_manager.save_all_window_states(&app_handle)
}

/// 環境ラベルを取得
fn get_environment_label(environment: &str) -> &str {
    match environment {
        "development" => "開発環境",
        "test" => "テスト環境",
        "staging" => "ステージング",
        "production" => "本番環境",
        _ => environment,
    }
}
```

---

## main.rs への登録

**ファイル**: `src-tauri/src/main.rs` (更新)

```rust
mod commands;
mod models;
mod services;
mod storage;

use services::window_manager::WindowManager;

fn main() {
    tauri::Builder::default()
        .manage(WindowManager::new())
        .invoke_handler(tauri::generate_handler![
            // 既存のコマンド...

            // ウィンドウ管理コマンド
            commands::window::open_query_builder_window,
            commands::window::open_settings_window,
            commands::window::close_window,
            commands::window::focus_window,
            commands::window::list_windows,
            commands::window::find_window_by_connection,
            commands::window::set_window_title,
            commands::window::get_current_window_info,
            commands::window::restore_windows,
            commands::window::save_all_window_states,
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

---

## フロントエンドAPIクライアント

**ファイル**: `src/api/window.ts`

```typescript
import { invoke } from '@tauri-apps/api/core';
import type { WindowInfo } from '@/types/window';

/**
 * ウィンドウAPI
 */
export const windowApi = {
  /**
   * クエリビルダーウィンドウを開く
   */
  async openQueryBuilder(
    connectionId: string,
    connectionName: string,
    environment: string
  ): Promise<WindowInfo> {
    return invoke('open_query_builder_window', {
      connectionId,
      connectionName,
      environment,
    });
  },

  /**
   * 設定ウィンドウを開く
   */
  async openSettings(): Promise<WindowInfo> {
    return invoke('open_settings_window');
  },

  /**
   * ウィンドウを閉じる
   */
  async closeWindow(label: string): Promise<void> {
    return invoke('close_window', { label });
  },

  /**
   * ウィンドウにフォーカス
   */
  async focusWindow(label: string): Promise<void> {
    return invoke('focus_window', { label });
  },

  /**
   * すべてのウィンドウを取得
   */
  async listWindows(): Promise<WindowInfo[]> {
    return invoke('list_windows');
  },

  /**
   * 接続IDでウィンドウを検索
   */
  async findWindowByConnection(connectionId: string): Promise<WindowInfo | null> {
    return invoke('find_window_by_connection', { connectionId });
  },

  /**
   * ウィンドウタイトルを設定
   */
  async setWindowTitle(label: string, title: string): Promise<void> {
    return invoke('set_window_title', { label, title });
  },

  /**
   * 現在のウィンドウ情報を取得
   */
  async getCurrentWindowInfo(label: string): Promise<WindowInfo | null> {
    return invoke('get_current_window_info', { label });
  },

  /**
   * ウィンドウ状態を復元
   */
  async restoreWindows(): Promise<WindowInfo[]> {
    return invoke('restore_windows');
  },

  /**
   * すべてのウィンドウ状態を保存
   */
  async saveAllWindowStates(): Promise<void> {
    return invoke('save_all_window_states');
  },
};
```

---

## 使用例

### ランチャーからクエリビルダーを開く

**ファイル**: `src/components/connection/ConnectionCard.vue` (一部)

```vue
<script setup lang="ts">
import { windowApi } from '@/api/window';
import type { Connection } from '@/types/connection';

const props = defineProps<{
  connection: Connection;
}>();

const emit = defineEmits<{
  (e: 'open', connection: Connection): void;
}>();

/**
 * 接続をダブルクリックしてクエリビルダーを開く
 */
const handleDoubleClick = async () => {
  try {
    await windowApi.openQueryBuilder(
      props.connection.id,
      props.connection.name,
      props.connection.environment
    );
    emit('open', props.connection);
  } catch (error) {
    console.error('Failed to open query builder:', error);
  }
};
</script>

<template>
  <v-card
    class="connection-card"
    @dblclick="handleDoubleClick"
  >
    <!-- カードの内容 -->
  </v-card>
</template>
```

### 既存のウィンドウにフォーカスするか新規作成

```typescript
import { windowApi } from '@/api/window';

async function openOrFocusQueryBuilder(
  connectionId: string,
  connectionName: string,
  environment: string
) {
  // 既存のウィンドウを検索
  const existing = await windowApi.findWindowByConnection(connectionId);

  if (existing) {
    // 既存のウィンドウにフォーカス
    await windowApi.focusWindow(existing.label);
    return existing;
  }

  // 新しいウィンドウを開く
  return await windowApi.openQueryBuilder(connectionId, connectionName, environment);
}
```

---

## エラーハンドリング

### コマンドエラーの種類

| エラー | 説明 | 対処 |
|--------|------|------|
| `Window not found` | 指定されたウィンドウが存在しない | ウィンドウリストを更新 |
| `Failed to create window` | ウィンドウ作成に失敗 | エラーをユーザーに表示 |
| `Failed to focus window` | フォーカス設定に失敗 | 再試行 |

### フロントエンドでのエラー処理

```typescript
import { windowApi } from '@/api/window';

async function safeOpenQueryBuilder(
  connectionId: string,
  connectionName: string,
  environment: string
) {
  try {
    const windowInfo = await windowApi.openQueryBuilder(
      connectionId,
      connectionName,
      environment
    );
    return { success: true, data: windowInfo };
  } catch (error) {
    console.error('Failed to open query builder:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    };
  }
}
```

---

## テスト設計

### Rustコマンドテスト

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_get_environment_label() {
        assert_eq!(get_environment_label("development"), "開発環境");
        assert_eq!(get_environment_label("test"), "テスト環境");
        assert_eq!(get_environment_label("staging"), "ステージング");
        assert_eq!(get_environment_label("production"), "本番環境");
        assert_eq!(get_environment_label("unknown"), "unknown");
    }
}
```

### フロントエンドAPIテスト

```typescript
import { describe, it, expect, vi } from 'vitest';
import { windowApi } from '@/api/window';

vi.mock('@tauri-apps/api/core', () => ({
  invoke: vi.fn(),
}));

import { invoke } from '@tauri-apps/api/core';

describe('windowApi', () => {
  it('should call open_query_builder_window with correct params', async () => {
    (invoke as any).mockResolvedValue({
      label: 'query-builder-123',
      title: 'Test DB [開発環境] - SQL Query Builder',
      windowType: 'query_builder',
      connectionId: '123',
      focused: true,
      visible: true,
    });

    const result = await windowApi.openQueryBuilder('123', 'Test DB', 'development');

    expect(invoke).toHaveBeenCalledWith('open_query_builder_window', {
      connectionId: '123',
      connectionName: 'Test DB',
      environment: 'development',
    });
    expect(result.label).toBe('query-builder-123');
  });

  it('should call list_windows', async () => {
    (invoke as any).mockResolvedValue([]);

    await windowApi.listWindows();

    expect(invoke).toHaveBeenCalledWith('list_windows');
  });
});
```

---

## 実装チェックリスト

- [ ] `src-tauri/src/commands/window.rs` の作成
  - [ ] open_query_builder_window コマンド
  - [ ] open_settings_window コマンド
  - [ ] close_window コマンド
  - [ ] focus_window コマンド
  - [ ] list_windows コマンド
  - [ ] find_window_by_connection コマンド
  - [ ] set_window_title コマンド
  - [ ] get_current_window_info コマンド
  - [ ] restore_windows コマンド
  - [ ] save_all_window_states コマンド
- [ ] `src-tauri/src/main.rs` へのコマンド登録
- [ ] `src/api/window.ts` の作成
- [ ] ユニットテストの作成

---

## 参考資料

- [Tauri Commands](https://tauri.app/v2/guide/commands/)
- [Tauri State Management](https://tauri.app/v2/guide/state/)
- [@tauri-apps/api/core](https://tauri.app/v2/reference/js/core/)
