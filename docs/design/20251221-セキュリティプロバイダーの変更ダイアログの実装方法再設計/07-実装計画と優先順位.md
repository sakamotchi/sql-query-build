# 実装計画と優先順位

## 実装フェーズ

### Phase 1: 共通コンポーネントの作成
**目的:** 再利用可能な基盤を構築

#### タスク
1. **ProviderCard.vueの作成**
   - ファイル: `app/components/security/provider-change/ProviderCard.vue`
   - 所要工数: 小
   - 依存: なし
   - テスト: 各プロバイダーでの表示確認

2. **useProviderSwitch.tsの作成**
   - ファイル: `app/composables/useProviderSwitch.ts`
   - 所要工数: 中
   - 依存: なし
   - テスト:
     - Simpleからの切り替えロジック
     - Master Passwordからの切り替えロジック
     - バリデーション
     - エラーハンドリング

#### 成果物
- [ ] `ProviderCard.vue`
- [ ] `useProviderSwitch.ts`

#### 完了条件
- 両コンポーネント/Composableが単体で動作する
- プロバイダー情報が正しく表示される
- バックエンド通信ロジックが正しく動作する

---

### Phase 2: 新しいダイアログコンポーネントの作成
**目的:** フロー別の専用ダイアログを実装

#### タスク
1. **FromSimpleDialog.vueの作成**
   - ファイル: `app/components/security/provider-change/FromSimpleDialog.vue`
   - 所要工数: 大
   - 依存: Phase 1完了
   - テスト:
     - Simple → Master Password フロー
     - Simple → Keychain フロー
     - パスワードバリデーション
     - エラーハンドリング
     - キャンセル処理

2. **FromMasterPasswordDialog.vueの作成**
   - ファイル: `app/components/security/provider-change/FromMasterPasswordDialog.vue`
   - 所要工数: 大
   - 依存: Phase 1完了
   - テスト:
     - Master Password → Simple フロー
     - Master Password → Keychain フロー
     - パスワード認証
     - エラーハンドリング
     - キャンセル処理

#### 成果物
- [ ] `FromSimpleDialog.vue`
- [ ] `FromMasterPasswordDialog.vue`

#### 完了条件
- 各ダイアログが独立して動作する
- 全フローが正常に動作する
- エラーケースが適切にハンドリングされる

---

### Phase 3: 親コンポーネントでの統合
**目的:** 設定ページで新しいダイアログを使用可能にする

#### タスク
1. **useProviderChangeDialog.tsの作成**
   - ファイル: `app/composables/useProviderChangeDialog.ts`
   - 所要工数: 中
   - 依存: Phase 2完了
   - テスト:
     - 現在のプロバイダーに応じた適切なダイアログ選択
     - 開く/閉じる処理
     - 型安全性の確認

2. **設定ページの更新**
   - ファイル: 設定ページのセキュリティタブコンポーネント
   - 所要工数: 小
   - 依存: タスク1完了
   - 変更内容:
     - 旧`ProviderChangeDialog`の使用を新しいダイアログに置き換え
     - `useProviderChangeDialog` Composableの使用

#### 成果物
- [ ] `useProviderChangeDialog.ts`
- [ ] 設定ページのセキュリティタブ更新

#### 完了条件
- 設定ページから全フローが正常に動作する
- 旧実装と同等の機能を提供
- UIが適切に表示される

---

### Phase 4: 旧コンポーネントの削除とクリーンアップ
**目的:** 不要なコードを削除し、コードベースを整理

#### タスク
1. **旧コンポーネントの使用箇所検索**
   - 検索対象: `ProviderChangeDialog.vue`のimport文
   - ツール: Grep, IDE検索
   - 所要工数: 小

2. **全使用箇所の置き換え確認**
   - 所要工数: 小
   - 確認内容: 設定ページ以外の使用箇所がないか

3. **旧コンポーネントの削除**
   - ファイル: `app/components/security/ProviderChangeDialog.vue`
   - 所要工数: 小
   - 依存: 全使用箇所の置き換え完了

4. **ドキュメント更新**
   - この設計書のステータス更新
   - 必要に応じてREADME更新

#### 成果物
- [ ] 旧`ProviderChangeDialog.vue`削除
- [ ] ドキュメント更新

#### 完了条件
- 旧コンポーネントが完全に削除されている
- 全機能が新実装で動作している
- ドキュメントが最新状態

---

## 実装の優先順位

### 優先度: 高
- Phase 1: 共通コンポーネントの作成
- Phase 2: 新しいダイアログコンポーネントの作成

### 優先度: 中
- Phase 3: 親コンポーネントでの統合

### 優先度: 低
- Phase 4: 旧コンポーネントの削除とクリーンアップ

## テスト戦略

### 単体テスト
- [ ] `useProviderSwitch.ts` のロジックテスト
- [ ] `useProviderChangeDialog.ts` のロジックテスト
- [ ] `ProviderCard.vue` のレンダリングテスト

### 結合テスト
- [ ] `FromSimpleDialog.vue` の全フローテスト
- [ ] `FromMasterPasswordDialog.vue` の全フローテスト

### E2Eテスト
- [ ] 設定ページからの全フローテスト
  - Simple → Master Password
  - Simple → Keychain
  - Master Password → Simple
  - Master Password → Keychain

### 手動テスト
- [ ] UIの見た目確認
- [ ] エラーメッセージの確認
- [ ] バックエンドとの通信確認
- [ ] パスワード認証の確認

## リスクと対策

### リスク1: 既存機能の破壊
**対策:**
- Phase 3完了時に全フローの動作確認
- 旧コンポーネントは削除前にバックアップ
- Git ブランチで作業し、問題があればrevert可能に

### リスク2: 型エラー
**対策:**
- TypeScript strict mode有効
- 各Phaseで型チェック実行
- IDE の型エラー表示を常に確認

### リスク3: バックエンドとの互換性
**対策:**
- `useProviderSwitch.ts`で既存のバックエンドAPIを使用
- パラメータ形式を既存実装と同じに保つ
- Phase 1で通信ロジックの動作確認を徹底

### リスク4: 工数超過
**対策:**
- Phase単位で区切って実装
- 各Phaseの完了条件を明確に定義
- 問題があれば早めにエスカレーション

## マイルストーン

| Phase | 完了予定 | 成果物数 | 主要タスク |
|-------|---------|---------|-----------|
| Phase 1 | Day 1 | 2 | 共通コンポーネント作成 |
| Phase 2 | Day 2-3 | 2 | ダイアログコンポーネント作成 |
| Phase 3 | Day 4 | 2 | 親コンポーネント統合 |
| Phase 4 | Day 5 | 1 | クリーンアップ |

**総所要日数:** 5日(目安)

## チェックリスト

### Phase 1
- [ ] `ProviderCard.vue` 作成
- [ ] プロバイダー情報が正しく表示されることを確認
- [ ] `useProviderSwitch.ts` 作成
- [ ] バックエンド通信ロジックが動作することを確認
- [ ] バリデーションが正しく動作することを確認

### Phase 2
- [ ] `FromSimpleDialog.vue` 作成
- [ ] Simple → Master Password フロー動作確認
- [ ] Simple → Keychain フロー動作確認
- [ ] `FromMasterPasswordDialog.vue` 作成
- [ ] Master Password → Simple フロー動作確認
- [ ] Master Password → Keychain フロー動作確認
- [ ] 両ダイアログのエラーハンドリング確認

### Phase 3
- [ ] `useProviderChangeDialog.ts` 作成
- [ ] 適切なダイアログが選択されることを確認
- [ ] 設定ページの更新
- [ ] 設定ページから全フロー動作確認
- [ ] UI/UXが旧実装と同等以上であることを確認

### Phase 4
- [ ] 旧`ProviderChangeDialog.vue`の使用箇所を検索
- [ ] 全使用箇所が置き換えられたことを確認
- [ ] 旧コンポーネント削除
- [ ] 全機能が正常に動作することを最終確認
- [ ] ドキュメント更新

## 成功基準

- [ ] 全てのフローが正常に動作する
- [ ] コードの可読性が向上している
- [ ] テストカバレッジが維持または向上している
- [ ] パフォーマンスが低下していない
- [ ] 旧コンポーネントが完全に削除されている
- [ ] ドキュメントが最新の状態である

## ロールバック計画

万が一問題が発生した場合:

1. **Phase 3までで問題発生**
   - 該当Phaseのブランチをrevert
   - 旧実装を継続使用

2. **Phase 4で問題発生**
   - 旧コンポーネントを復元(Git履歴から)
   - 新実装の問題を修正後、再度削除

3. **本番環境で問題発生**
   - 即座に旧実装にロールバック
   - 問題の原因を調査・修正
   - 再度デプロイ
