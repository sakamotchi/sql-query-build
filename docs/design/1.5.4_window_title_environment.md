# タスク1.5.4: ウィンドウタイトル・環境色設定 設計書

## 概要

**タスクID**: 1.5.4
**タスク名**: ウィンドウタイトル・環境色設定
**工数**: 1日
**依存関係**: 1.4.5 (テーマStore実装), 1.5.2 (ウィンドウ起動コマンド実装)
**完了条件**: タイトルと色が環境別に表示

---

## 目的

各ウィンドウのタイトルと環境色を接続情報に基づいて設定し、ユーザーがどの環境で作業しているかを常に視覚的に認識できるようにする。特に本番環境での誤操作を防止するため、警告色とバナーを表示する。

---

## 機能要件

### 主要機能

1. **ウィンドウタイトル設定**
   - 接続名と環境を含むタイトル
   - 動的なタイトル更新

2. **環境色の適用**
   - 環境に応じたテーマカラー
   - ヘッダーの色分け

3. **本番環境の警告**
   - 警告バナーの表示
   - 視覚的な注意喚起

---

## ウィンドウタイトル形式

### タイトルフォーマット

```
{接続名} [{環境ラベル}] - SQL Query Builder
```

### 環境ラベル

| 環境 | ラベル | 例 |
|------|--------|-----|
| development | 開発環境 | 開発DB [開発環境] - SQL Query Builder |
| test | テスト環境 | テストDB [テスト環境] - SQL Query Builder |
| staging | ステージング | ステージングDB [ステージング] - SQL Query Builder |
| production | 本番環境 | 本番DB [本番環境] - SQL Query Builder |

---

## 環境色設定

### カラースキーム

| 環境 | Primary | Background | 説明 |
|------|---------|------------|------|
| development | #4CAF50 (緑) | #F1F8E9 | 安全な作業環境 |
| test | #2196F3 (青) | #E3F2FD | 検証環境 |
| staging | #FF9800 (オレンジ) | #FFF3E0 | 注意が必要 |
| production | #F44336 (赤) | #FFEBEE | 危険・要注意 |

---

## コンポーネント設計

### WindowEnvironmentProvider

ウィンドウの環境設定を管理するプロバイダーコンポーネント

**ファイル**: `src/components/common/WindowEnvironmentProvider.vue`

```vue
<script setup lang="ts">
import { onMounted, watch, computed } from 'vue';
import { useRoute } from 'vue-router';
import { useWindow } from '@/composables/useWindow';
import { useTheme } from '@/composables/useTheme';
import { useConnectionStore } from '@/stores/connection';
import { windowApi } from '@/api/window';
import { getCurrentWindow } from '@tauri-apps/api/window';
import type { ThemeType } from '@/types/theme';
import type { Connection } from '@/types/connection';

const route = useRoute();
const { setConnectionContext, isQueryBuilder, connectionId } = useWindow();
const { setThemeByEnvironment } = useTheme();
const connectionStore = useConnectionStore();

/**
 * 環境ラベルのマッピング
 */
const environmentLabels: Record<string, string> = {
  development: '開発環境',
  test: 'テスト環境',
  staging: 'ステージング',
  production: '本番環境',
};

/**
 * 環境ラベルを取得
 */
const getEnvironmentLabel = (environment: string): string => {
  return environmentLabels[environment] || environment;
};

/**
 * ウィンドウタイトルを生成
 */
const generateWindowTitle = (connection: Connection): string => {
  const envLabel = getEnvironmentLabel(connection.environment);
  return `${connection.name} [${envLabel}] - SQL Query Builder`;
};

/**
 * 接続情報を読み込んでウィンドウを設定
 */
const setupWindowForConnection = async (connId: string) => {
  // 接続情報を取得
  let connection = connectionStore.getConnectionById(connId);

  if (!connection) {
    await connectionStore.loadConnections();
    connection = connectionStore.getConnectionById(connId);
  }

  if (!connection) {
    console.error('Connection not found:', connId);
    return;
  }

  await applyConnectionSettings(connection);
};

/**
 * 接続設定を適用
 */
const applyConnectionSettings = async (connection: Connection) => {
  // コンテキストを設定
  setConnectionContext(connection.id, connection.environment);

  // テーマを適用
  setThemeByEnvironment(connection.environment as ThemeType);

  // ウィンドウタイトルを更新
  try {
    const window = getCurrentWindow();
    const title = generateWindowTitle(connection);
    await windowApi.setWindowTitle(window.label, title);
  } catch (error) {
    console.error('Failed to set window title:', error);
  }
};

// ルートパラメータの監視
watch(
  () => route.query.connectionId,
  async (newConnectionId) => {
    if (newConnectionId && isQueryBuilder.value) {
      await setupWindowForConnection(newConnectionId as string);
    }
  },
  { immediate: true }
);

// コンポーネントマウント時の処理
onMounted(async () => {
  const connId = route.query.connectionId as string;
  if (connId && isQueryBuilder.value) {
    await setupWindowForConnection(connId);
  }
});
</script>

<template>
  <slot />
</template>
```

---

### EnvironmentIndicator

環境を視覚的に示すインジケーターコンポーネント

**ファイル**: `src/components/common/EnvironmentIndicator.vue`

```vue
<script setup lang="ts">
import { computed } from 'vue';
import { useWindow } from '@/composables/useWindow';
import { useTheme } from '@/composables/useTheme';
import type { ThemeType } from '@/types/theme';

const { environment } = useWindow();
const { currentThemeInfo, isProductionTheme, isStagingTheme } = useTheme();

/**
 * 環境アイコン
 */
const environmentIcons: Record<string, string> = {
  development: 'mdi-code-braces',
  test: 'mdi-test-tube',
  staging: 'mdi-rocket-launch',
  production: 'mdi-database',
};

/**
 * 環境ラベル
 */
const environmentLabels: Record<string, string> = {
  development: '開発環境',
  test: 'テスト環境',
  staging: 'ステージング',
  production: '本番環境',
};

const icon = computed(() => {
  return environmentIcons[environment.value || 'development'] || 'mdi-database';
});

const label = computed(() => {
  return environmentLabels[environment.value || 'development'] || environment.value;
});

const color = computed(() => {
  return currentThemeInfo.value?.primary || '#4CAF50';
});

const showWarning = computed(() => {
  return isProductionTheme.value || isStagingTheme.value;
});
</script>

<template>
  <div class="environment-indicator">
    <v-chip
      :color="color"
      :variant="showWarning ? 'flat' : 'tonal'"
      size="small"
      class="environment-chip"
    >
      <v-icon :icon="icon" size="small" start />
      {{ label }}
      <v-icon
        v-if="showWarning"
        icon="mdi-alert"
        size="small"
        end
      />
    </v-chip>
  </div>
</template>

<style scoped>
.environment-indicator {
  display: inline-flex;
  align-items: center;
}

.environment-chip {
  font-weight: 500;
}
</style>
```

---

### EnvironmentWarningBanner

本番・ステージング環境での警告バナー

**ファイル**: `src/components/common/EnvironmentWarningBanner.vue`

```vue
<script setup lang="ts">
import { computed, ref } from 'vue';
import { useWindow } from '@/composables/useWindow';
import { useTheme } from '@/composables/useTheme';

const { environment } = useWindow();
const { isProductionTheme, isStagingTheme, shouldShowWarning } = useTheme();

const dismissed = ref(false);

/**
 * バナーを表示するかどうか
 */
const showBanner = computed(() => {
  return shouldShowWarning.value && !dismissed.value;
});

/**
 * 警告メッセージ
 */
const warningMessage = computed(() => {
  if (isProductionTheme.value) {
    return '本番環境に接続しています。操作には十分注意してください。';
  }
  if (isStagingTheme.value) {
    return 'ステージング環境に接続しています。';
  }
  return '';
});

/**
 * バナーの色
 */
const bannerColor = computed(() => {
  if (isProductionTheme.value) {
    return 'error';
  }
  if (isStagingTheme.value) {
    return 'warning';
  }
  return 'info';
});

/**
 * アイコン
 */
const bannerIcon = computed(() => {
  if (isProductionTheme.value) {
    return 'mdi-alert-circle';
  }
  return 'mdi-alert';
});

/**
 * バナーを閉じる
 */
const dismissBanner = () => {
  dismissed.value = true;
};
</script>

<template>
  <v-banner
    v-if="showBanner"
    :color="bannerColor"
    :icon="bannerIcon"
    class="environment-warning-banner"
    density="compact"
  >
    <template #text>
      {{ warningMessage }}
    </template>
    <template #actions>
      <v-btn
        variant="text"
        size="small"
        @click="dismissBanner"
      >
        閉じる
      </v-btn>
    </template>
  </v-banner>
</template>

<style scoped>
.environment-warning-banner {
  border-radius: 0;
}
</style>
```

---

## ページへの統合

### クエリビルダーページ

**ファイル**: `src/pages/query-builder.vue` (一部)

```vue
<script setup lang="ts">
import WindowEnvironmentProvider from '@/components/common/WindowEnvironmentProvider.vue';
import EnvironmentHeader from '@/components/common/EnvironmentHeader.vue';
import EnvironmentWarningBanner from '@/components/common/EnvironmentWarningBanner.vue';
import EnvironmentIndicator from '@/components/common/EnvironmentIndicator.vue';
// ... 他のインポート
</script>

<template>
  <WindowEnvironmentProvider>
    <v-app>
      <!-- 警告バナー -->
      <EnvironmentWarningBanner />

      <!-- 環境識別ヘッダー -->
      <EnvironmentHeader>
        <template #indicator>
          <EnvironmentIndicator />
        </template>
      </EnvironmentHeader>

      <!-- メインコンテンツ -->
      <v-main>
        <!-- クエリビルダーの内容 -->
      </v-main>
    </v-app>
  </WindowEnvironmentProvider>
</template>
```

---

## 動的タイトル更新

### タイトル更新ユーティリティ

**ファイル**: `src/utils/windowTitle.ts`

```typescript
import { windowApi } from '@/api/window';
import { getCurrentWindow } from '@tauri-apps/api/window';

/**
 * 環境ラベルを取得
 */
export const getEnvironmentLabel = (environment: string): string => {
  const labels: Record<string, string> = {
    development: '開発環境',
    test: 'テスト環境',
    staging: 'ステージング',
    production: '本番環境',
  };
  return labels[environment] || environment;
};

/**
 * ウィンドウタイトルを生成
 */
export const generateWindowTitle = (
  connectionName: string,
  environment: string,
  suffix?: string
): string => {
  const envLabel = getEnvironmentLabel(environment);
  let title = `${connectionName} [${envLabel}] - SQL Query Builder`;

  if (suffix) {
    title = `${suffix} - ${title}`;
  }

  return title;
};

/**
 * 現在のウィンドウタイトルを更新
 */
export const updateCurrentWindowTitle = async (
  connectionName: string,
  environment: string,
  suffix?: string
): Promise<void> => {
  try {
    const window = getCurrentWindow();
    const title = generateWindowTitle(connectionName, environment, suffix);
    await windowApi.setWindowTitle(window.label, title);
  } catch (error) {
    console.error('Failed to update window title:', error);
  }
};

/**
 * クエリ名を含むタイトルに更新
 */
export const updateTitleWithQueryName = async (
  connectionName: string,
  environment: string,
  queryName: string
): Promise<void> => {
  await updateCurrentWindowTitle(connectionName, environment, queryName);
};
```

### 使用例：クエリ保存時のタイトル更新

```typescript
import { updateTitleWithQueryName } from '@/utils/windowTitle';
import { useWindow } from '@/composables/useWindow';
import { useConnectionStore } from '@/stores/connection';

// クエリ保存後にタイトルを更新
const onQuerySaved = async (queryName: string) => {
  const { connectionId } = useWindow();
  const connectionStore = useConnectionStore();

  const connection = connectionStore.getConnectionById(connectionId.value);
  if (connection) {
    await updateTitleWithQueryName(
      connection.name,
      connection.environment,
      queryName
    );
  }
};
```

---

## テスト設計

### ユニットテスト

**ファイル**: `src/utils/__tests__/windowTitle.spec.ts`

```typescript
import { describe, it, expect } from 'vitest';
import { getEnvironmentLabel, generateWindowTitle } from '@/utils/windowTitle';

describe('windowTitle', () => {
  describe('getEnvironmentLabel', () => {
    it('should return correct label for development', () => {
      expect(getEnvironmentLabel('development')).toBe('開発環境');
    });

    it('should return correct label for test', () => {
      expect(getEnvironmentLabel('test')).toBe('テスト環境');
    });

    it('should return correct label for staging', () => {
      expect(getEnvironmentLabel('staging')).toBe('ステージング');
    });

    it('should return correct label for production', () => {
      expect(getEnvironmentLabel('production')).toBe('本番環境');
    });

    it('should return original value for unknown environment', () => {
      expect(getEnvironmentLabel('custom')).toBe('custom');
    });
  });

  describe('generateWindowTitle', () => {
    it('should generate title without suffix', () => {
      const title = generateWindowTitle('TestDB', 'development');
      expect(title).toBe('TestDB [開発環境] - SQL Query Builder');
    });

    it('should generate title with suffix', () => {
      const title = generateWindowTitle('TestDB', 'production', 'My Query');
      expect(title).toBe('My Query - TestDB [本番環境] - SQL Query Builder');
    });
  });
});
```

### コンポーネントテスト

**ファイル**: `src/components/common/__tests__/EnvironmentIndicator.spec.ts`

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { mount } from '@vue/test-utils';
import { createPinia, setActivePinia } from 'pinia';
import { createVuetify } from 'vuetify';
import EnvironmentIndicator from '../EnvironmentIndicator.vue';

// モック
vi.mock('@/composables/useWindow', () => ({
  useWindow: () => ({
    environment: { value: 'production' },
  }),
}));

vi.mock('@/composables/useTheme', () => ({
  useTheme: () => ({
    currentThemeInfo: { value: { primary: '#F44336' } },
    isProductionTheme: { value: true },
    isStagingTheme: { value: false },
  }),
}));

describe('EnvironmentIndicator', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
  });

  it('should display production environment', () => {
    const vuetify = createVuetify();
    const wrapper = mount(EnvironmentIndicator, {
      global: {
        plugins: [vuetify],
      },
    });

    expect(wrapper.text()).toContain('本番環境');
  });
});
```

---

## 実装チェックリスト

- [ ] `src/components/common/WindowEnvironmentProvider.vue` の作成
  - [ ] 接続情報の読み込み
  - [ ] テーマ適用
  - [ ] タイトル設定
- [ ] `src/components/common/EnvironmentIndicator.vue` の作成
  - [ ] アイコン表示
  - [ ] 環境ラベル表示
  - [ ] 警告アイコン
- [ ] `src/components/common/EnvironmentWarningBanner.vue` の作成
  - [ ] 警告メッセージ
  - [ ] 閉じるボタン
- [ ] `src/utils/windowTitle.ts` の作成
  - [ ] getEnvironmentLabel関数
  - [ ] generateWindowTitle関数
  - [ ] updateCurrentWindowTitle関数
- [ ] クエリビルダーページへの統合
- [ ] ユニットテストの作成

---

## 参考資料

- [Vuetify Banner](https://vuetifyjs.com/en/components/banners/)
- [Vuetify Chip](https://vuetifyjs.com/en/components/chips/)
- [Tauri Window API](https://tauri.app/v2/reference/js/window/)
- タスク1.4.4: 環境識別ヘッダーコンポーネント設計書
