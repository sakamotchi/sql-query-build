# テスト手順書 - SQLエディタウィンドウ基盤構築

## 概要

このドキュメントでは、SQLエディタウィンドウ基盤構築（Phase 1）のテスト手順を記載します。
可能な限り手動操作で確認し、操作で確認できない項目のみ自動テストを記載します。

## 前提条件

- `npm run tauri:dev` でアプリが起動していること
- 1つ以上の接続情報が登録されていること（開発環境・本番環境の両方があれば理想）
- TypeScriptコンパイルエラーがないこと（`npm run typecheck`）
- Rustビルドエラーがないこと

## 手動テスト

### ケース 1: 接続カードに「エディタ」ボタンが表示される

**目的**: 接続カードに新規「エディタ」ボタンが追加されていることを確認

**手順:**

1. `npm run tauri:dev` でアプリを起動する
2. ランチャー画面で接続カードを確認する

**期待結果:**

- 各接続カードに「クエリビルダー」「ミューテーション」「エディタ」の3つのボタンが表示される
- 「エディタ」ボタンのアイコンは `</>` (コードブラケット)である
- ボタンのデザインは既存ボタンと統一されている

**確認結果:**

- [ ] OK / NG

---

### ケース 2: SQLエディタウィンドウが開く

**目的**: 「エディタ」ボタンをクリックしてSQLエディタウィンドウが開くことを確認

**手順:**

1. ランチャー画面で任意の接続カードの「エディタ」ボタンをクリックする

**期待結果:**

- 新しいウィンドウが開く
- ウィンドウタイトルが `[環境名] 接続名 - SQLエディタ` の形式である（例: `[開発] PostgreSQL開発 - SQLエディタ`）
- ウィンドウサイズは `1280x900` 程度である
- ウィンドウ内に環境ヘッダーが表示される
- 環境ヘッダーの背景色が環境に応じた色である（開発=緑、テスト=青、ステージング=オレンジ、本番=赤）
- ウィンドウ内に「SQLエディタ（準備中）」等のプレースホルダーテキストが表示される

**確認結果:**

- [ ] OK / NG

---

### ケース 3: 本番環境で警告記号が表示される

**目的**: 本番環境の接続でSQLエディタを開いた際、警告記号が表示されることを確認

**前提**: 本番環境の接続が登録されていること

**手順:**

1. ランチャー画面で本番環境の接続カードの「エディタ」ボタンをクリックする

**期待結果:**

- ウィンドウタイトルが `[本番] 接続名 - SQLエディタ ⚠️` の形式である
- 環境ヘッダーの背景色が赤色である
- 環境バッジに「本番」と表示される

**確認結果:**

- [ ] OK / NG（本番接続がない場合はスキップ）

---

### ケース 4: 重複ウィンドウが開かない（既存にフォーカス）

**目的**: 同一接続で「エディタ」ボタンを再クリックした際、新規ウィンドウではなく既存ウィンドウにフォーカスすることを確認

**手順:**

1. ランチャー画面で接続Aの「エディタ」ボタンをクリックする
2. SQLエディタウィンドウが開くことを確認する
3. ランチャー画面に戻る
4. 再度、接続Aの「エディタ」ボタンをクリックする

**期待結果:**

- 新しいウィンドウは開かない
- 既存のSQLエディタウィンドウにフォーカスが移る（ウィンドウが最前面に表示される）

**確認結果:**

- [ ] OK / NG

---

### ケース 5: 異なる接続で別ウィンドウが開く

**目的**: 異なる接続で「エディタ」ボタンをクリックした際、別のウィンドウが開くことを確認

**前提**: 2つ以上の接続が登録されていること

**手順:**

1. ランチャー画面で接続Aの「エディタ」ボタンをクリックする
2. SQLエディタウィンドウAが開くことを確認する
3. ランチャー画面に戻る
4. 接続Bの「エディタ」ボタンをクリックする

**期待結果:**

- 新しいSQLエディタウィンドウBが開く
- ウィンドウAとウィンドウBが両方開いている状態になる
- 各ウィンドウのタイトルが異なる接続名を表示している

**確認結果:**

- [ ] OK / NG

---

### ケース 6: ウィンドウコンテキストが正しく取得される

**目的**: SQLエディタページがウィンドウコンテキスト（接続ID、環境情報）を正しく取得していることを確認

**手順:**

1. ランチャー画面で任意の接続カードの「エディタ」ボタンをクリックする
2. SQLエディタウィンドウが開く
3. ブラウザの開発者ツール（DevTools）を開く（Tauriウィンドウで右クリック → 検証）
4. Consoleタブで `window.__TAURI__` が存在することを確認

**期待結果:**

- 環境ヘッダーに正しい接続名が表示される
- 環境ヘッダーの背景色が正しい（環境に応じた色）
- DevToolsのConsoleで `window.__TAURI__` が `undefined` でない

**確認結果:**

- [ ] OK / NG

---

### ケース 7: ウィンドウサイズの変更・最小化が正常に動作する

**目的**: ウィンドウのリサイズや最小化が正常に動作することを確認

**手順:**

1. SQLエディタウィンドウを開く
2. ウィンドウを最大化する
3. ウィンドウを元のサイズに戻す
4. ウィンドウをドラッグしてリサイズする
5. ウィンドウを最小サイズ（1024x768）よりも小さくしようとする
6. ウィンドウを閉じる

**期待結果:**

- ウィンドウの最大化・元に戻す操作が正常に動作する
- ウィンドウのリサイズが正常に動作する
- 最小サイズ（1024x768）以下にはリサイズできない
- ウィンドウを閉じると正常に終了する

**確認結果:**

- [ ] OK / NG

---

## 自動テスト

### ユニットテスト（フロントエンド）

**テスト対象**: `app/api/window.ts` の `openSqlEditor` 関数

**テストファイル**: `app/api/window.test.ts`

**実行コマンド**:

```bash
npm run test:run
```

**テストケース**:

1. `openSqlEditor` が正しい引数で `open_sql_editor_window` コマンドを呼び出すこと
2. `openSqlEditor` がエラーをハンドリングすること

**確認結果:**

- [ ] テストが作成されている
- [ ] すべてのテストがパスする

---

### 型チェック

**実行コマンド**:

```bash
npm run typecheck
```

**期待結果:**

- TypeScriptコンパイルエラーが0件である
- `WindowType` 型に `'sql_editor'` が追加されている
- `windowApi.openSqlEditor` の型定義が正しい

**確認結果:**

- [ ] OK / NG

---

### Rustテスト

**テスト対象**: `src-tauri/src/services/window_manager.rs`

**実行コマンド**:

```bash
cd src-tauri && cargo test
```

**テストケース**:

1. ウィンドウラベル形式が `sql_editor_{connection_id}` であること
2. ウィンドウタイトル形式が正しいこと（開発環境）
3. ウィンドウタイトル形式が正しいこと（本番環境、警告記号付き）

**確認結果:**

- [ ] テストが作成されている
- [ ] すべてのテストがパスする

---

### Rustビルド

**実行コマンド**:

```bash
cd src-tauri && cargo build
```

**期待結果:**

- Rustコンパイルエラーが0件である
- `WindowType::SqlEditor` バリアントが追加されている
- `open_sql_editor_window` 関数が実装されている

**確認結果:**

- [ ] OK / NG

---

## エッジケース

| ケース | 期待動作 | 確認結果 |
|--------|---------|---------|
| 接続が削除された後、SQLエディタウィンドウを開こうとする | エラーメッセージが表示される、またはウィンドウが開かない | [ ] OK / NG |
| 接続情報が0件の状態 | 接続カードが表示されないため、「エディタ」ボタンも表示されない | [ ] OK / NG |
| ウィンドウを複数開いた状態でアプリを終了 | 正常に終了する（クラッシュしない） | [ ] OK / NG |
| ウィンドウを開いた状態でランチャーを閉じる | SQLエディタウィンドウはそのまま開いている | [ ] OK / NG |
| 日本語・絵文字を含む接続名 | ウィンドウタイトルに正しく表示される | [ ] OK / NG |

---

## 回帰テスト

既存機能への影響がないことを確認します。

### クエリビルダーの動作確認

**手順:**

1. ランチャー画面で任意の接続カードの「クエリビルダー」ボタンをクリックする
2. クエリビルダーウィンドウが開くことを確認する
3. テーブルを選択してクエリを構築する
4. クエリを実行する

**確認結果:**

- [ ] クエリビルダーが正常に動作する

---

### ミューテーションビルダーの動作確認

**手順:**

1. ランチャー画面で任意の接続カードの「ミューテーション」ボタンをクリックする
2. ミューテーションビルダーウィンドウが開くことを確認する
3. テーブルを選択してINSERT/UPDATE/DELETE操作を試みる（実行はしない）

**確認結果:**

- [ ] ミューテーションビルダーが正常に動作する

---

### 設定画面の動作確認

**手順:**

1. ランチャー画面で設定ボタンをクリックする
2. 設定ウィンドウが開くことを確認する
3. 設定項目を確認する

**確認結果:**

- [ ] 設定画面が正常に動作する

---

### 接続管理の動作確認

**手順:**

1. ランチャー画面で「新規接続」ボタンをクリックする
2. 接続情報を入力して保存する
3. 保存した接続が一覧に表示されることを確認する
4. 接続を編集・削除する

**確認結果:**

- [ ] 接続管理が正常に動作する

---

## テスト実施記録

| 実施日 | 実施者 | 結果 | 備考 |
|--------|--------|------|------|
| YYYY-MM-DD | | OK / NG | |

---

## 不具合報告

テスト中に発見した不具合を記録します。

| 不具合ID | 発見日 | 内容 | 優先度 | ステータス | 備考 |
|---------|--------|------|--------|-----------|------|
| - | - | - | - | - | - |

---

## テスト完了条件

以下の条件をすべて満たした時点でPhase 1のテストが完了とする：

- [ ] すべての手動テストケースが「OK」である
- [ ] すべての自動テストがパスしている
- [ ] TypeScript型チェックが通っている
- [ ] Rustビルドが通っている
- [ ] エッジケースがすべて「OK」である
- [ ] 回帰テストがすべて「OK」である
- [ ] クリティカルな不具合が0件である

---

## 次のステップ

Phase 1のテスト完了後、以下の作業に進む：

1. **Phase 2: エディタUI基本構築**のテスト計画作成
2. **永続化ドキュメント更新**
   - `docs/steering/features/sql-editor.md` の作成
   - `docs/steering/features/window.md` の更新
