# テスト手順書: クエリ履歴機能

**作成日**: 2025年12月30日
**WBS参照**: Phase 4.3 履歴機能

---

## 1. テスト環境

### 1.1 前提条件
- Phase 4.1-4.2（クエリ保存機能）が実装済み
- Phase 2（クエリ実行機能）が実装済み
- データベース接続が設定済み（PostgreSQL/MySQL/SQLiteのいずれか）

### 1.2 テストデータ
- 接続情報: 1つ以上のデータベース接続
- テーブル: usersテーブル（または任意のテーブル）

---

## 2. 手動テスト手順

### 2.1 履歴の自動記録

#### テストケース 2.1.1: クエリ実行成功時の履歴記録

**目的**: クエリ実行成功時に履歴が自動記録されることを確認

**手順**:
1. アプリを起動（`npm run tauri:dev`）
2. データベース接続を選択
3. クエリビルダーでSELECTクエリを作成
   - 例: `SELECT * FROM users LIMIT 10`
4. 「実行」ボタンをクリック
5. クエリが成功することを確認
6. ツールバーの「履歴」ボタンをクリック
7. 履歴Slideoverが開く
8. 履歴一覧の最上部に今実行したクエリが表示されることを確認

**期待される結果**:
- ✅ 履歴一覧の最上部に新しい履歴が追加される
- ✅ SQL文が表示される（`SELECT * FROM users LIMIT 10`）
- ✅ 成功アイコン（緑のチェックマーク）が表示される
- ✅ 実行日時が表示される
- ✅ 結果件数が表示される（例: 10件）
- ✅ 実行時間が表示される（例: 150ms）

---

#### テストケース 2.1.2: クエリ実行失敗時の履歴記録

**目的**: クエリ実行失敗時にも履歴が記録されることを確認

**手順**:
1. クエリビルダーで意図的に誤ったクエリを作成
   - 例: `SELECT * FROM non_existent_table`
2. 「実行」ボタンをクリック
3. エラーダイアログが表示されることを確認
4. ツールバーの「履歴」ボタンをクリック
5. 履歴Slideoverが開く
6. 履歴一覧に失敗したクエリが表示されることを確認

**期待される結果**:
- ✅ 履歴一覧に新しい履歴が追加される
- ✅ SQL文が表示される
- ✅ 失敗アイコン（赤のXマーク）が表示される
- ✅ 実行日時が表示される
- ✅ 結果件数は表示されない
- ✅ 実行時間が表示される

---

### 2.2 履歴一覧表示

#### テストケース 2.2.1: 履歴一覧の表示

**目的**: 履歴一覧が時系列で正しく表示されることを確認

**前提条件**: 少なくとも3件の履歴が存在する

**手順**:
1. ツールバーの「履歴」ボタンをクリック
2. 履歴Slideoverが開く
3. 履歴一覧を確認

**期待される結果**:
- ✅ 最新の履歴が最上部に表示される
- ✅ 各履歴項目に以下が表示される:
  - 成功/失敗アイコン
  - 実行日時
  - SQL文のプレビュー（最大3行）
  - 結果件数（成功時）
  - 実行時間
- ✅ SQL文が長い場合、3行で切り詰められて「...」が表示される

---

#### テストケース 2.2.2: 空状態の表示

**目的**: 履歴がない場合の表示を確認

**前提条件**: 履歴が0件（またはすべて削除した状態）

**手順**:
1. ツールバーの「履歴」ボタンをクリック
2. 履歴Slideoverが開く

**期待される結果**:
- ✅ 「履歴はありません」というメッセージが表示される
- ✅ 時計アイコンが表示される

---

### 2.3 履歴検索・フィルタ

#### テストケース 2.3.1: キーワード検索

**目的**: キーワード検索が正しく動作することを確認

**前提条件**: 複数の異なるSQL文の履歴が存在する

**手順**:
1. 履歴Slideoverを開く
2. 検索ボックスに「users」と入力
3. リアルタイムで結果がフィルタされることを確認

**期待される結果**:
- ✅ 「users」を含むSQL文の履歴のみ表示される
- ✅ 「users」を含まない履歴は非表示になる
- ✅ 検索ボックスをクリアすると全履歴が再表示される

---

#### テストケース 2.3.2: 成功のみフィルタ

**目的**: 成功したクエリのみをフィルタできることを確認

**前提条件**: 成功と失敗の履歴が両方存在する

**手順**:
1. 履歴Slideoverを開く
2. 「成功したクエリのみ表示」チェックボックスをON
3. 結果を確認

**期待される結果**:
- ✅ 成功した履歴（緑のチェックマーク）のみ表示される
- ✅ 失敗した履歴（赤のXマーク）は非表示になる
- ✅ チェックボックスをOFFにすると全履歴が再表示される

---

### 2.4 履歴からの復元

#### テストケース 2.4.1: 履歴をクエリビルダーに復元

**目的**: 履歴からクエリビルダーに正しく復元されることを確認

**手順**:
1. 履歴Slideoverを開く
2. 任意の履歴項目をクリック
3. トースト通知が表示されることを確認
4. Slideoverが自動的に閉じることを確認
5. クエリビルダーの状態を確認

**期待される結果**:
- ✅ トースト通知「読み込み成功」が表示される
- ✅ Slideoverが閉じる
- ✅ クエリビルダーに履歴のクエリが復元される
  - 選択されたテーブル
  - 選択されたカラム
  - WHERE条件
  - その他の設定
- ✅ 生成されたSQL文が履歴と一致する

---

### 2.5 履歴の削除

#### テストケース 2.5.1: 個別削除

**目的**: 履歴を個別に削除できることを確認

**手順**:
1. 履歴Slideoverを開く
2. 任意の履歴項目にマウスホバー
3. 削除ボタン（ゴミ箱アイコン）が表示されることを確認
4. 削除ボタンをクリック
5. 確認ダイアログが表示される
6. 「削除」ボタンをクリック

**期待される結果**:
- ✅ 確認ダイアログが表示される
- ✅ 「この履歴を削除してもよろしいですか？」というメッセージが表示される
- ✅ 削除後、トースト通知「削除完了」が表示される
- ✅ 削除した履歴が一覧から消える
- ✅ 他の履歴は残っている

---

#### テストケース 2.5.2: 削除のキャンセル

**目的**: 削除をキャンセルできることを確認

**手順**:
1. 履歴Slideoverを開く
2. 任意の履歴項目の削除ボタンをクリック
3. 確認ダイアログが表示される
4. 「キャンセル」ボタンをクリック

**期待される結果**:
- ✅ 確認ダイアログが閉じる
- ✅ 履歴は削除されない
- ✅ 一覧に変化がない

---

### 2.6 最大件数管理

#### テストケース 2.6.1: 1000件を超える履歴の自動削除

**目的**: 1000件を超えると古い履歴が自動削除されることを確認

**前提条件**: このテストは時間がかかるため、単体テストで確認を推奨

**手順**:
1. Rustの単体テスト `test_max_history_limit` を実行
2. テストがパスすることを確認

**期待される結果**:
- ✅ 単体テストがパスする
- ✅ 1001件追加しても最大1000件までしか保存されない

---

## 3. 自動テスト

### 3.1 Rustユニットテスト

**実行コマンド**:
```bash
cd src-tauri
cargo test query_history
```

**期待される結果**:
```
running 8 tests
test services::query_history::tests::test_add_history ... ok
test services::query_history::tests::test_list_histories ... ok
test services::query_history::tests::test_max_history_limit ... ok
test services::query_history::tests::test_delete_history ... ok
test services::query_history::tests::test_search_by_keyword ... ok
test services::query_history::tests::test_search_by_connection_id ... ok
test services::query_history::tests::test_search_by_date_range ... ok
test services::query_history::tests::test_clear_old_histories ... ok

test result: ok. 8 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

---

### 3.2 フロントエンドユニットテスト

**実行コマンド**:
```bash
npm run test:run -- query-history
```

**期待される結果**:
```
✓ query-history store (5)
  ✓ fetchHistories should load histories
  ✓ addHistory should add history and refresh list
  ✓ deleteHistory should remove history and refresh list
  ✓ filteredHistories should filter by keyword
  ✓ filteredHistories should filter by successOnly

Test Files  1 passed (1)
     Tests  5 passed (5)
```

---

## 4. パフォーマンステスト

### 4.1 履歴読み込み時間

**目的**: 大量の履歴でもスムーズに読み込めることを確認

**手順**:
1. 履歴を100件程度作成（複数回クエリ実行）
2. 履歴Slideoverを開く
3. 読み込み時間を確認

**期待される結果**:
- ✅ 1秒以内に一覧が表示される
- ✅ スクロールがスムーズ
- ✅ UIがフリーズしない

---

## 5. エラーハンドリングテスト

### 5.1 ファイル読み込みエラー

**目的**: 履歴ファイルが破損している場合のエラーハンドリング

**手順**:
1. アプリを終了
2. 履歴ファイル（`{app_data}/history/query_history.json`）を手動で破損させる
   - 例: JSONの一部を削除
3. アプリを起動
4. 履歴Slideoverを開く

**期待される結果**:
- ✅ エラーが表示される、または空状態として扱われる
- ✅ アプリがクラッシュしない

---

## 6. 回帰テスト

### 6.1 既存機能への影響確認

**目的**: 履歴機能追加が既存機能に影響しないことを確認

**テスト項目**:
- [ ] クエリ保存機能が正常に動作する
- [ ] クエリ実行機能が正常に動作する
- [ ] クエリビルダーのUI操作が正常に動作する
- [ ] 接続切り替えが正常に動作する

---

## 7. テスト完了基準

### 7.1 必須項目
- [ ] 全ての手動テストがパスする
- [ ] Rustユニットテストが全てパスする
- [ ] フロントエンドユニットテストが全てパスする
- [ ] パフォーマンステストの基準を満たす
- [ ] エラーハンドリングが適切に動作する
- [ ] 回帰テストがパスする

### 7.2 推奨項目
- [ ] 1000件以上の履歴でパフォーマンステスト
- [ ] 複数の接続で履歴が正しく記録される
- [ ] 長時間稼働でメモリリークがない

---

## 8. 既知の問題・制限事項

### 8.1 既知の問題
（実装後に追記）

### 8.2 制限事項
- 履歴は最大1000件まで（仕様）
- 非常に長いSQL文（10000文字以上）は切り詰められる（仕様）
- 履歴のエクスポート機能はPhase 5で実装予定

---

## 9. テスト結果記録

| 日付 | テスター | テストケース | 結果 | 備考 |
|------|---------|------------|------|------|
| - | - | - | - | - |

---

**最終更新**: 2025年12月30日
