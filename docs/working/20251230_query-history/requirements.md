# 要件定義書: クエリ履歴機能

**作成日**: 2025年12月30日
**WBS参照**: Phase 4.3 履歴機能

---

## 1. 概要

クエリビルダーで実行したクエリの履歴を自動的に記録し、過去に実行したクエリを簡単に復元できる機能を提供します。

---

## 2. 目的

### 2.1 ビジネス目的
- クエリの再利用性を向上させ、作業効率を改善する
- 過去の作業履歴を追跡可能にし、監査証跡を提供する
- よく使うクエリをすぐに見つけられるようにする

### 2.2 技術目的
- クエリ実行時に自動的に履歴を保存する仕組みを構築
- 履歴データの効率的な保存・検索を実現
- クエリ保存機能（4.1-4.2）との整合性を保つ

---

## 3. 機能要件

### 3.1 自動履歴記録
- **FR-1**: クエリ実行時に自動的に履歴を記録する
  - 実行したSQL文
  - 実行日時
  - 実行結果のサマリー（成功/失敗、件数、実行時間）
  - 使用した接続情報

### 3.2 履歴一覧表示
- **FR-2**: 履歴を時系列で一覧表示する
  - 最新の履歴を上部に表示
  - 実行日時、SQL文のプレビュー、実行結果を表示
  - 無限スクロールまたはページネーション対応

### 3.3 履歴検索・フィルタ
- **FR-3**: 履歴を検索・フィルタできる
  - キーワード検索（SQL文の内容）
  - 接続別フィルタ
  - 日付範囲フィルタ
  - 成功/失敗でフィルタ

### 3.4 履歴からの復元
- **FR-4**: 履歴からクエリビルダーに復元できる
  - ワンクリックで過去のクエリをクエリビルダーに読み込む
  - 復元時に現在のクエリを上書きすることを確認

### 3.5 履歴の削除
- **FR-5**: 不要な履歴を削除できる
  - 個別削除
  - 一括削除（期間指定、全削除）
  - 削除前に確認ダイアログを表示

### 3.6 履歴の保存
- **FR-6**: 履歴から直接「保存済みクエリ」として保存できる
  - 履歴項目に「保存」ボタンを配置
  - SaveQueryDialogを開いて名前・説明を入力

---

## 4. 非機能要件

### 4.1 パフォーマンス
- **NFR-1**: 履歴の記録はクエリ実行を遅延させない（非同期処理）
- **NFR-2**: 履歴一覧の読み込みは1秒以内
- **NFR-3**: 1000件以上の履歴でもスムーズにスクロール可能

### 4.2 データ保存
- **NFR-4**: 履歴は最大1000件まで保存（古いものから自動削除）
- **NFR-5**: 履歴データはローカルファイルシステムに保存
- **NFR-6**: 履歴ファイルは1つのJSONファイルに集約（読み込み高速化）

### 4.3 ユーザビリティ
- **NFR-7**: 履歴パネルはSlideoverで表示
- **NFR-8**: 履歴項目はホバー時にアクションボタンを表示
- **NFR-9**: SQL文は最大3行でプレビュー表示（クリックで全文表示）

---

## 5. ユーザーストーリー

### US-1: 過去のクエリを再実行したい
**As a** データアナリスト
**I want to** 過去に実行したクエリをすぐに見つけて再実行できる
**So that** 同じクエリを何度も作り直す手間を省ける

**受け入れ基準**:
- 履歴パネルを開くと、過去に実行したクエリが時系列で表示される
- クエリをクリックすると、クエリビルダーに復元される
- 復元後すぐに「実行」ボタンを押せる

### US-2: 昨日実行したクエリを探したい
**As a** データベース管理者
**I want to** 日付範囲で履歴をフィルタできる
**So that** 特定期間の作業履歴を確認できる

**受け入れ基準**:
- 日付範囲でフィルタできる
- 「今日」「昨日」「過去7日間」などのプリセットがある
- フィルタ結果がリアルタイムで表示される

### US-3: よく使うクエリを保存したい
**As a** データアナリスト
**I want to** 履歴から直接クエリを「保存済み」にできる
**So that** 後で簡単に再利用できる

**受け入れ基準**:
- 履歴項目に「保存」ボタンがある
- クリックするとSaveQueryDialogが開く
- 保存後、「保存済みクエリ」一覧に表示される

---

## 6. 画面遷移

```
QueryBuilderLayout
  └─ QueryBuilderToolbar
       ├─ [保存]ボタン → SaveQueryDialog
       ├─ [開く]ボタン → SavedQuerySlideover
       └─ [履歴]ボタン → QueryHistorySlideover ← 新規
            ├─ 履歴項目クリック → クエリビルダーに復元
            ├─ [保存]ボタン → SaveQueryDialog
            └─ [削除]ボタン → 確認ダイアログ → 削除実行
```

---

## 7. データ構造（概要）

### QueryHistory
```typescript
{
  id: string                    // UUID
  connectionId: string          // 使用した接続ID
  query: SerializableQueryState // クエリビルダーの状態
  sql: string                   // 生成されたSQL文
  executedAt: string            // 実行日時（ISO 8601）
  success: boolean              // 実行成功/失敗
  resultCount?: number          // 結果件数（成功時）
  executionTimeMs?: number      // 実行時間（ミリ秒）
  errorMessage?: string         // エラーメッセージ（失敗時）
}
```

---

## 8. 制約事項

### 8.1 技術的制約
- 履歴は最大1000件まで（自動削除）
- 履歴ファイルサイズは最大10MBまで
- 非常に長いSQL文（10000文字以上）は切り詰めて保存

### 8.2 ビジネス制約
- 履歴は接続ごとにフィルタできるが、接続を跨いだ統合検索も可能
- 履歴の自動削除は設定で無効化できない（ディスク容量管理のため）

---

## 9. 除外事項

以下は本フェーズの対象外です：

- 履歴のエクスポート機能（CSV/JSON）→ Phase 5で検討
- 履歴の共有機能（他のユーザーと共有）→ 将来検討
- 履歴の統計情報表示（よく使うテーブル、実行回数など）→ Phase 7で検討
- 履歴の自動保存（定期的に保存済みクエリに昇格）→ 将来検討

---

## 10. 成功基準

### 定量的基準
- 履歴記録の成功率: 99%以上
- 履歴一覧の読み込み時間: 1秒以内
- 履歴からの復元時間: 0.5秒以内

### 定性的基準
- ユーザーが過去のクエリを3クリック以内で復元できる
- 履歴パネルの操作が直感的で、説明なしで使える
- クエリ保存機能と履歴機能の違いが明確に理解できる

---

## 11. 依存関係

### 前提条件
- Phase 4.1-4.2（クエリ保存・管理UI）が完了していること
- Phase 2（クエリ実行機能）が実装されていること

### 連携する機能
- クエリビルダー（query-builder.ts）: 履歴からの復元時に状態を更新
- クエリ実行機能: 実行時に履歴を記録
- クエリ保存機能: 履歴から保存済みクエリに昇格

---

## 12. 備考

### 履歴とクエリ保存の違い

| 観点 | 履歴（History） | 保存済みクエリ（Saved Query） |
|------|----------------|------------------------------|
| 作成方法 | 自動記録 | 手動で保存 |
| 目的 | 一時的な再利用、監査証跡 | 長期的な再利用 |
| 件数制限 | あり（最大1000件） | なし |
| メタデータ | 実行結果、実行時間 | 名前、説明、タグ |
| 検索性 | 日付、接続、成功/失敗 | 名前、タグ |

---

**承認者**: -
**承認日**: -
