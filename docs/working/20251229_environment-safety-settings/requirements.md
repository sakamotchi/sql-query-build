# 要件定義書: 環境別安全設定

**作成日**: 2025年12月29日
**WBS参照**: Phase 3.3 環境別安全設定

---

## 1. 概要

接続先の環境（development, test, staging, production）ごとに、クエリ実行時の安全設定を個別に構成できる機能を実装する。

## 2. 背景・目的

- 本番環境では厳格な確認ダイアログを要求し、開発環境では軽量な確認で済ませたい
- 環境ごとに誤操作リスクが異なるため、環境に応じた安全レベルの設定が必要
- ユーザーが自分のワークフローに合わせて安全設定をカスタマイズできるようにする

## 3. 機能要件

### 3.1 環境別安全設定の管理

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| REQ-3.3.1 | 各環境（development/test/staging/production）に対して個別の安全設定を持つ | 必須 |
| REQ-3.3.2 | 設定項目: 確認ダイアログの有効/無効 | 必須 |
| REQ-3.3.3 | 設定項目: 確認ダイアログを表示する危険度レベル（Warning以上/Danger以上） | 必須 |
| REQ-3.3.4 | 設定項目: カウントダウン秒数（0〜10秒） | 必須 |
| REQ-3.3.5 | 設定項目: DROPクエリの完全禁止 | 必須 |
| REQ-3.3.6 | 設定項目: TRUNCATEクエリの完全禁止 | 必須 |
| REQ-3.3.7 | デフォルト設定: 環境ごとに適切なデフォルト値を持つ | 必須 |
| REQ-3.3.8 | 設定はアプリケーション再起動後も保持される | 必須 |

### 3.2 デフォルト設定

| 環境 | 確認ダイアログ | 表示レベル | カウントダウン | DROP禁止 | TRUNCATE禁止 |
|------|--------------|-----------|---------------|---------|-------------|
| development | 有効 | Danger以上 | 0秒 | 無効 | 無効 |
| test | 有効 | Danger以上 | 0秒 | 無効 | 無効 |
| staging | 有効 | Warning以上 | 3秒 | 無効 | 無効 |
| production | 有効 | Warning以上 | 5秒 | 有効 | 有効 |

### 3.3 設定UI

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| REQ-3.3.9 | 設定画面から環境別安全設定を編集できる | 必須 |
| REQ-3.3.10 | 各環境の設定をカード形式で表示 | 必須 |
| REQ-3.3.11 | 本番環境の設定には警告を表示（安全設定を緩めることのリスク） | 必須 |
| REQ-3.3.12 | デフォルトにリセット機能 | 任意 |

### 3.4 クエリ実行時の統合

| 要件ID | 要件 | 優先度 |
|--------|------|--------|
| REQ-3.3.13 | クエリ実行時、現在の接続環境の安全設定を参照する | 必須 |
| REQ-3.3.14 | DROP/TRUNCATE禁止設定時、該当クエリを実行不可にする | 必須 |
| REQ-3.3.15 | 禁止されたクエリの場合、実行ボタンを無効化しエラーメッセージを表示 | 必須 |
| REQ-3.3.16 | 環境設定に基づきカウントダウン秒数を動的に適用 | 必須 |

## 4. 非機能要件

| 要件ID | 要件 | 備考 |
|--------|------|------|
| NFR-3.3.1 | 設定ファイルはJSON形式で保存 | 既存のsettings.jsonを拡張 |
| NFR-3.3.2 | 設定変更は即座に反映される | 再起動不要 |
| NFR-3.3.3 | 設定画面のレスポンスは100ms以内 | UX要件 |

## 5. 制約事項

- Phase 3.1（クエリ種別検出）とPhase 3.2（確認ダイアログ）が完了していることが前提
- 既存の`Environment`型（development/test/staging/production）を使用
- 設定の保存はRust側（Tauri）で行う

## 6. 用語定義

| 用語 | 定義 |
|------|------|
| 安全設定 (SafetySettings) | 環境ごとのクエリ実行時の安全確認に関する設定 |
| 危険度レベル (RiskLevel) | クエリの危険度（safe/warning/danger） |
| 確認ダイアログ | 危険なクエリ実行前に表示する確認UI |
| カウントダウン | 実行ボタン有効化までの待機時間 |

## 7. 関連ドキュメント

- [WBS v3.0](../../sql_editor_wbs_v3.md) - Phase 3.3
- [セキュリティ機能詳細仕様](../../features/security.md)
- [確認ダイアログ設計書](../20251229_confirmation-dialog/design.md)
- [クエリ種別検出設計書](../20251229_query-type-detection/design.md)
