# テスト手順書 - SQLエディタ Phase 5: クエリ履歴機能

## 概要

このドキュメントでは、SQLエディタ Phase 5（クエリ履歴機能）のテスト手順を記載します。
可能な限り手動操作で確認し、操作で確認できない項目のみ自動テストを記載します。

## 前提条件

### テスト環境

- `npm run tauri:dev` でアプリが起動していること
- テスト用のデータベース接続が登録されていること
  - PostgreSQL、MySQL、またはSQLiteの接続
  - テスト用のテーブル・データが準備されていること
- Phase 3（クエリ実行機能）が実装済みであること

### テストデータ準備

```sql
-- テスト用テーブル作成（例: PostgreSQL）
CREATE TABLE test_history_users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- テストデータ挿入
INSERT INTO test_history_users (name, email) VALUES
  ('Alice', 'alice@example.com'),
  ('Bob', 'bob@example.com'),
  ('Charlie', 'charlie@example.com');
```

## 手動テスト

### ケース 1: クエリ実行時の自動履歴保存（成功）

**手順:**

1. アプリを起動する
2. ランチャーでテスト用接続カードの「エディタ」ボタンをクリック
3. SQLエディタウィンドウが開くことを確認
4. エディタに以下のSQLを入力:
   ```sql
   SELECT * FROM test_history_users;
   ```
5. Ctrl+Enter（macOSではCmd+Enter）を押下してクエリを実行
6. 履歴パネルを開く（右側のパネル）

**期待結果:**

- 履歴パネルに新しい履歴が1件追加される
- 履歴には以下が表示される:
  - ✅ 成功バッジ（緑色）
  - 実行日時（相対時間: 「数秒前」）
  - SQL文: 「SELECT * FROM test_history_users;」
  - 実行時間（例: 「0.05秒」）
  - 結果行数（「3行」）

**確認結果:**

- [ ] OK / NG

---

### ケース 2: クエリ実行時の自動履歴保存（失敗）

**手順:**

1. SQLエディタを開く
2. エディタに以下の誤ったSQLを入力:
   ```sql
   SELECT * FROM non_existent_table;
   ```
3. Ctrl+Enter を押下してクエリを実行
4. エラーが表示されることを確認
5. 履歴パネルを確認

**期待結果:**

- 履歴パネルに新しい履歴が1件追加される
- 履歴には以下が表示される:
  - ❌ 失敗バッジ（赤色）
  - 実行日時（相対時間: 「数秒前」）
  - SQL文: 「SELECT * FROM non_existent_table;」
  - 実行時間（例: 「0.01秒」）
  - エラーメッセージ（例: 「テーブル 'non_existent_table' が存在しません」）

**確認結果:**

- [ ] OK / NG

---

### ケース 3: 履歴の時系列表示

**手順:**

1. SQLエディタを開く
2. 以下のクエリを順次実行する（各クエリの間に2-3秒待つ）:
   ```sql
   SELECT * FROM test_history_users WHERE id = 1;
   SELECT * FROM test_history_users WHERE id = 2;
   SELECT * FROM test_history_users WHERE id = 3;
   ```
3. 履歴パネルを確認

**期待結果:**

- 履歴パネルに3件の履歴が表示される
- 新しい順に並んでいる（id=3のクエリが最上部）
- 各履歴の実行日時が正しく表示される

**確認結果:**

- [ ] OK / NG

---

### ケース 4: 履歴の検索（キーワード）

**手順:**

1. SQLエディタを開く
2. 以下のクエリを順次実行する:
   ```sql
   SELECT * FROM test_history_users;
   INSERT INTO test_history_users (name, email) VALUES ('Test', 'test@example.com');
   UPDATE test_history_users SET name = 'Updated' WHERE id = 1;
   ```
3. 履歴パネルの検索ボックスに「INSERT」と入力

**期待結果:**

- INSERT文の履歴のみが表示される
- SELECT文とUPDATE文の履歴は表示されない
- 検索は大文字・小文字を区別しない

**確認結果:**

- [ ] OK / NG

---

### ケース 5: 履歴の検索（クリア）

**手順:**

1. ケース4の続き（「INSERT」で検索中）
2. 検索ボックスのクリアボタン（×）をクリック

**期待結果:**

- 検索ボックスが空になる
- すべての履歴（SELECT、INSERT、UPDATE）が表示される

**確認結果:**

- [ ] OK / NG

---

### ケース 6: 履歴のフィルタリング（成功のみ表示）

**手順:**

1. SQLエディタを開く
2. 以下のクエリを順次実行する:
   ```sql
   SELECT * FROM test_history_users;
   SELECT * FROM non_existent_table;
   ```
3. 履歴パネルの「成功のみ表示」チェックボックスをONにする

**期待結果:**

- 成功した履歴（SELECT * FROM test_history_users）のみが表示される
- 失敗した履歴（SELECT * FROM non_existent_table）は表示されない

**確認結果:**

- [ ] OK / NG

---

### ケース 7: 履歴からのエディタ読み込み

**手順:**

1. SQLエディタを開く（エディタは空の状態）
2. 履歴パネルから任意の履歴をクリック

**期待結果:**

- エディタに履歴のSQLが読み込まれる
- エディタの内容が履歴のSQL文に置き換わる
- トースト通知「履歴を読み込みました」が表示される

**確認結果:**

- [ ] OK / NG

---

### ケース 8: 履歴からのエディタ読み込み（未保存警告）

**手順:**

1. SQLエディタを開く
2. エディタに何かSQL文を入力する（保存しない）
3. 履歴パネルから任意の履歴をクリック

**期待結果:**

- 未保存の変更がある場合は警告ダイアログが表示される（簡易実装の場合はこのステップをスキップ可能）
- 確認後、エディタに履歴のSQLが読み込まれる

**確認結果:**

- [ ] OK / NG（簡易実装の場合は N/A）

---

### ケース 9: 履歴からの直接再実行

**手順:**

1. SQLエディタを開く
2. エディタに以下のSQLを入力:
   ```sql
   SELECT 'Original Query' AS message;
   ```
3. Ctrl+Enter で実行
4. エディタの内容はそのまま（「Original Query」）
5. 履歴パネルで過去の履歴にホバーし、「再実行」ボタン（▶アイコン）をクリック

**期待結果:**

- エディタの内容は変更されない（「Original Query」のまま）
- 結果パネルに再実行した履歴のクエリ結果が表示される
- 履歴パネルに再実行自体の履歴が新しく追加される

**確認結果:**

- [ ] OK / NG

---

### ケース 10: 履歴の削除

**手順:**

1. SQLエディタを開く
2. 履歴パネルで任意の履歴にホバー
3. 「削除」ボタン（ゴミ箱アイコン）をクリック
4. 確認ダイアログで「削除」を選択

**期待結果:**

- 確認ダイアログが表示される
- 確認後、履歴パネルから履歴が削除される
- トースト通知「履歴を削除しました」が表示される

**確認結果:**

- [ ] OK / NG

---

### ケース 11: 履歴の削除（キャンセル）

**手順:**

1. 履歴パネルで任意の履歴にホバー
2. 「削除」ボタンをクリック
3. 確認ダイアログで「キャンセル」を選択

**期待結果:**

- ダイアログが閉じる
- 履歴は削除されない（そのまま表示される）

**確認結果:**

- [ ] OK / NG

---

### ケース 12: 古い履歴の自動削除（1000件超）

**注意**: このテストは時間がかかるため、手動実行は推奨しません。自動テストまたはスクリプトで実施してください。

**手順:**

1. スクリプトで1001件の履歴を作成する（バックエンドから直接追加）
2. アプリを再起動
3. SQLエディタを開く
4. 履歴パネルを確認

**期待結果:**

- 履歴パネルに最大1000件の履歴が表示される
- 最古の1件は自動削除されている
- 最新の1000件が保持されている

**確認結果:**

- [ ] OK / NG（自動テストで確認）

---

### ケース 13: アプリ再起動後の履歴維持

**手順:**

1. SQLエディタを開く
2. 以下のクエリを実行:
   ```sql
   SELECT 'Persistent Test' AS test;
   ```
3. 履歴パネルで履歴が追加されたことを確認
4. アプリを完全に終了する
5. アプリを再起動する
6. ランチャーでエディタを開く
7. 履歴パネルを確認

**期待結果:**

- アプリ再起動後も履歴が維持されている
- 「SELECT 'Persistent Test' AS test;」の履歴が表示される

**確認結果:**

- [ ] OK / NG

---

### ケース 14: Query Builder用履歴との分離確認

**手順:**

1. ランチャーでテスト用接続カードの「クエリビルダー」ボタンをクリック
2. クエリビルダーでクエリを構築（例: SELECT * FROM test_history_users）
3. クエリを実行
4. クエリビルダーの履歴パネル（スライドオーバー）を開く
5. Query Builder用の履歴が表示されることを確認
6. クエリビルダーを閉じる
7. ランチャーで「エディタ」ボタンをクリック
8. SQLエディタの履歴パネルを確認

**期待結果:**

- Query Builderの履歴とSQLエディタの履歴が混在しない
- SQLエディタの履歴パネルにはSQLエディタで実行したクエリのみが表示される
- Query Builderの履歴スライドオーバーにはQuery Builderで実行したクエリのみが表示される

**確認結果:**

- [ ] OK / NG

---

## 自動テスト

### ユニットテスト（フロントエンド）

```bash
npm run test:run
```

**対象テスト**:
- `app/tests/stores/sql-editor.test.ts`
  - `should add history after successful query execution`
  - `should filter histories by search keyword`
  - `should filter histories by success status`

**期待結果**:
- すべてのテストがパスする

---

### ユニットテスト（バックエンド）

```bash
cd src-tauri && cargo test sql_editor_history
```

**対象テスト**:
- `src-tauri/src/services/sql_editor_history.rs`
  - `test_add_history` - 履歴追加が正しく動作する
  - `test_get_histories` - 履歴一覧取得が正しく動作する（新しい順）
  - `test_cleanup_if_needed` - 1000件超の自動削除が正しく動作する

**期待結果**:
- すべてのテストがパスする

---

### 型チェック

```bash
npm run typecheck
```

**期待結果**:
- TypeScriptコンパイルエラーがない
- 型定義が正しく適用されている

---

## パフォーマンステスト

### ケース P1: 1000件の履歴表示パフォーマンス

**手順:**

1. スクリプトで1000件の履歴を作成する
2. SQLエディタを開く
3. 履歴パネルを開く
4. 表示にかかる時間を計測

**期待結果:**

- 1000件の履歴が1秒以内に表示される
- スクロールがスムーズに動作する

**確認結果:**

- [ ] OK / NG

---

### ケース P2: 検索レスポンスタイム

**手順:**

1. 1000件の履歴がある状態で履歴パネルを開く
2. 検索ボックスに「SELECT」と入力
3. 絞り込み結果が表示されるまでの時間を計測

**期待結果:**

- 入力後200ms以内に絞り込み結果が表示される
- UIがフリーズしない

**確認結果:**

- [ ] OK / NG

---

### ケース P3: 履歴保存がクエリ実行を遅延させないことの確認

**手順:**

1. SQLエディタを開く
2. 以下のシンプルなクエリを実行:
   ```sql
   SELECT 1;
   ```
3. クエリ実行の完了（結果表示）までの時間を計測
4. 履歴保存処理がクエリ実行をブロックしていないことを確認

**期待結果:**

- クエリ実行の完了が履歴保存によって遅延しない（非同期処理）
- クエリ実行がスムーズに完了する

**確認結果:**

- [ ] OK / NG

---

## エッジケース

| ケース | 期待動作 | 確認結果 |
|--------|---------|---------|
| 履歴ファイルが存在しない場合 | 空の履歴として扱い、エラーが発生しない | [ ] OK / NG |
| 履歴ファイルが破損している場合 | エラーをコンソールログに出力し、空の履歴として扱う | [ ] OK / NG |
| 非常に長いSQL文（10,000文字超）の履歴保存 | 正常に保存され、一覧表示では省略表示される | [ ] OK / NG |
| 履歴保存に失敗した場合 | クエリ実行自体は成功し、エラーはコンソールログのみ | [ ] OK / NG |
| 同時に複数のクエリを実行した場合 | すべての履歴が正しく保存される | [ ] OK / NG |
| 接続IDが変更された場合 | 新しい接続IDの履歴ファイルが作成される | [ ] OK / NG |

---

## 回帰テスト

既存機能への影響がないことを確認します。

### Query Builder関連

- [ ] Query Builderでクエリを構築・実行できる
- [ ] Query Builderの履歴機能（QueryHistorySlideover）が正常に動作する
- [ ] Query Builderの履歴保存が正常に動作する
- [ ] Query Builderの履歴とSQLエディタの履歴が混在しない

### SQLエディタ関連（Phase 3, 4）

- [ ] クエリ実行機能が正常に動作する（Phase 3）
- [ ] 実行ボタン・停止ボタンが正常に動作する
- [ ] キーボードショートカット（Ctrl+Enter）が正常に動作する
- [ ] 選択範囲実行が正常に動作する
- [ ] 結果パネルが正常に表示される
- [ ] エラー表示が正常に動作する
- [ ] クエリ保存機能が正常に動作する（Phase 4）
- [ ] 保存クエリパネルが正常に表示される
- [ ] 保存クエリの読み込み・実行が正常に動作する

### その他

- [ ] 接続管理機能が正常に動作する
- [ ] ウィンドウ管理機能が正常に動作する
- [ ] 設定画面が正常に動作する

---

## テスト完了基準

- [ ] すべての手動テストケース（ケース1〜14）がパスする
- [ ] すべての自動テストがパスする
- [ ] パフォーマンステスト（P1〜P3）がパスする
- [ ] すべてのエッジケースがパスする
- [ ] すべての回帰テストがパスする
- [ ] WBSの完了条件をすべて満たす
  - [x] クエリ実行時に履歴が自動保存される
  - [x] 履歴パネルに実行履歴が時系列で表示される
  - [x] 履歴をクリックするとエディタに読み込まれる
  - [x] 履歴から直接再実行できる
  - [x] 履歴を検索できる
  - [x] 古い履歴を削除できる

---

## 備考

### 履歴ファイルの確認方法

履歴ファイルは以下の場所に保存されています:

- **macOS**: `~/Library/Application Support/com.example.sql-query-builder/sql_editor_histories/{connection_id}_history.jsonl`
- **Windows**: `%APPDATA%\com.example.sql-query-builder\sql_editor_histories\{connection_id}_history.jsonl`
- **Linux**: `~/.local/share/com.example.sql-query-builder/sql_editor_histories/{connection_id}_history.jsonl`

JSON Lines形式で保存されており、テキストエディタで直接確認できます。

### 1000件の履歴を作成するスクリプト例

```bash
# Rust側のテストコードまたはスクリプトで実装
cd src-tauri
cargo test create_1000_histories -- --ignored
```

または、フロントエンドから以下のスクリプトを実行:

```typescript
// ブラウザのコンソールで実行
for (let i = 1; i <= 1001; i++) {
  await store.executeQuery(`SELECT ${i} AS test;`)
}
```
