# 要件定義書: クエリ保存機能

**作成日**: 2025年12月29日
**WBS参照**: Phase 4.1 クエリ保存機能
**依存**: Phase 2 クエリ実行・結果表示（完了）

---

## 1. 背景・目的

クエリビルダーで作成したクエリを名前付きで保存し、後から再利用できるようにする。これにより、よく使うクエリを毎回作成し直す手間を省き、チーム内でのクエリ共有の基盤を構築する。

### 1.1 解決したい課題

- 毎回同じクエリを手動で作成し直す手間
- 複雑なクエリの構成を覚えておく必要がある
- クエリの再利用性がない

### 1.2 期待する効果

- よく使うクエリを素早く呼び出せる
- クエリに名前と説明を付けて整理できる
- タグで分類・検索できる

---

## 2. 機能要件

### 2.1 クエリ保存

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-01 | 現在のクエリ（QueryModel）を名前付きで保存できる | 必須 |
| REQ-02 | クエリに説明文を付与できる | 必須 |
| REQ-03 | クエリにタグを複数付与できる | 任意 |
| REQ-04 | 保存時に接続ID（どのDB接続用か）を記録する | 必須 |
| REQ-05 | 既存のクエリを上書き保存できる | 必須 |
| REQ-06 | 保存されたクエリには一意のIDが付与される | 必須 |

### 2.2 クエリ読み込み

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-07 | 保存済みクエリを一覧表示できる | 必須 |
| REQ-08 | クエリを選択してクエリビルダーに読み込める | 必須 |
| REQ-09 | 読み込み時に現在のクエリを置き換える | 必須 |

### 2.3 クエリ検索・フィルタリング

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-10 | クエリ名で検索できる | 必須 |
| REQ-11 | タグでフィルタリングできる | 任意 |
| REQ-12 | 接続IDでフィルタリングできる | 任意 |

### 2.4 クエリ削除

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-13 | 保存済みクエリを削除できる | 必須 |
| REQ-14 | 削除前に確認ダイアログを表示する | 必須 |

---

## 3. 非機能要件

### 3.1 データ永続化

- クエリデータはJSON形式でローカルファイルに保存
- 既存のFileStorageパターンを使用
- 保存先: `{app_data}/queries/` ディレクトリ

### 3.2 パフォーマンス

- 保存済みクエリが100件程度でもスムーズに表示
- 一覧表示時は軽量なメタデータのみ読み込み

### 3.3 データ整合性

- 保存時にバリデーションを実施
- 不正なデータは保存しない

---

## 4. 画面仕様

### 4.1 保存ダイアログ

```
┌─────────────────────────────────────────────────────┐
│ クエリを保存                                 [×]    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  クエリ名 *                                         │
│  ┌───────────────────────────────────────────────┐ │
│  │ ユーザー一覧取得                              │ │
│  └───────────────────────────────────────────────┘ │
│                                                     │
│  説明                                               │
│  ┌───────────────────────────────────────────────┐ │
│  │ アクティブなユーザーの一覧を取得するクエリ    │ │
│  │                                               │ │
│  └───────────────────────────────────────────────┘ │
│                                                     │
│  タグ（カンマ区切り）                               │
│  ┌───────────────────────────────────────────────┐ │
│  │ users, report, daily                          │ │
│  └───────────────────────────────────────────────┘ │
│                                                     │
├─────────────────────────────────────────────────────┤
│                      [キャンセル]  [保存]           │
└─────────────────────────────────────────────────────┘
```

### 4.2 保存済みクエリ一覧（Slideover）

```
┌────────────────────────────────────┐
│ 保存済みクエリ              [×]   │
├────────────────────────────────────┤
│ 🔍 検索...                         │
├────────────────────────────────────┤
│                                    │
│ ┌────────────────────────────────┐ │
│ │ ユーザー一覧取得               │ │
│ │ アクティブなユーザーの...      │ │
│ │ [users] [report]         [···]│ │
│ └────────────────────────────────┘ │
│                                    │
│ ┌────────────────────────────────┐ │
│ │ 売上サマリー                   │ │
│ │ 月別の売上を集計...            │ │
│ │ [sales] [summary]        [···]│ │
│ └────────────────────────────────┘ │
│                                    │
│ ┌────────────────────────────────┐ │
│ │ 在庫チェック                   │ │
│ │ 在庫が少ない商品...            │ │
│ │ [inventory]              [···]│ │
│ └────────────────────────────────┘ │
│                                    │
└────────────────────────────────────┘
```

### 4.3 ツールバー統合

既存のツールバー「保存」ボタンをクリック → 保存ダイアログを表示

---

## 5. データ構造

### 5.1 SavedQuery型

```typescript
interface SavedQuery {
  id: string;              // UUID
  name: string;            // クエリ名
  description: string;     // 説明
  tags: string[];          // タグ
  connectionId: string;    // 接続ID
  query: QueryModel;       // クエリモデル
  createdAt: string;       // 作成日時（ISO8601）
  updatedAt: string;       // 更新日時（ISO8601）
}
```

### 5.2 SavedQueryMetadata型（一覧表示用）

```typescript
interface SavedQueryMetadata {
  id: string;
  name: string;
  description: string;
  tags: string[];
  connectionId: string;
  createdAt: string;
  updatedAt: string;
}
```

---

## 6. 受け入れ条件

1. ツールバーの「保存」ボタンから保存ダイアログが開く
2. クエリ名を入力して保存できる
3. 保存済みクエリ一覧から選択してクエリを読み込める
4. クエリ名で検索できる
5. 保存済みクエリを削除できる
6. アプリを再起動しても保存済みクエリが残っている

---

## 7. 関連ドキュメント

- [WBS v3.0](../../sql_editor_wbs_v3.md) - Phase 4.1
- [QueryBuilderToolbar.vue](../../../app/components/query-builder/QueryBuilderToolbar.vue) - L136-139のTODO
- [FileStorage実装](../../../src-tauri/src/storage/file_storage.rs) - 既存のストレージパターン
