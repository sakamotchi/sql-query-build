# テスト手順書: クエリ保存機能

**作成日**: 2025年12月29日
**WBS参照**: Phase 4.1 クエリ保存機能

---

## 1. テスト環境

- **アプリ起動**: `npm run tauri:dev`
- **データベース接続**: PostgreSQL/MySQL/SQLite いずれかに接続済み
- **前提**: クエリビルダーでテーブル選択、カラム選択が可能な状態

---

## 2. 手動テスト手順

### 2.1 クエリ保存（新規）

**前提条件**: クエリビルダーで何らかのクエリを構築済み

**手順**:
1. ツールバーの「保存」ボタンをクリック
2. 保存ダイアログが表示される
3. クエリ名を入力（例: 「ユーザー一覧」）
4. 説明を入力（例: 「アクティブユーザーの一覧取得」）
5. タグを入力（例: 「users, report」）
6. 「保存」ボタンをクリック

**期待結果**:
- [ ] 保存ダイアログが正しく表示される
- [ ] クエリ名が必須項目としてバリデーションされる
- [ ] タグがバッジとしてプレビュー表示される
- [ ] 保存成功のトースト通知が表示される
- [ ] ダイアログが閉じる

---

### 2.2 クエリ保存（上書き）

**前提条件**: 既に保存済みのクエリがある

**手順**:
1. 保存済みクエリを読み込む
2. クエリを編集（カラム追加など）
3. ツールバーの「保存」ボタンをクリック
4. 同じ名前で保存

**期待結果**:
- [ ] 既存のクエリが更新される
- [ ] updatedAtが更新される
- [ ] IDは変わらない

---

### 2.3 保存済みクエリ一覧表示

**手順**:
1. ツールバーの「開く」ボタンをクリック

**期待結果**:
- [ ] Slideoverが右側から表示される
- [ ] 保存済みクエリが一覧表示される
- [ ] 各クエリの名前、説明、タグが表示される
- [ ] 更新日時が表示される
- [ ] 更新日時の降順でソートされている

---

### 2.4 クエリ検索

**前提条件**: 複数のクエリが保存済み

**手順**:
1. 「開く」ボタンでSlideoverを表示
2. 検索ボックスに検索キーワードを入力

**期待結果**:
- [ ] 入力に応じてリアルタイムでフィルタリングされる
- [ ] 名前または説明に含まれるクエリのみ表示される
- [ ] 検索キーワードをクリアすると全クエリが表示される

---

### 2.5 クエリ読み込み

**前提条件**: 保存済みクエリがある

**手順**:
1. 「開く」ボタンでSlideoverを表示
2. 任意のクエリカードをクリック

**期待結果**:
- [ ] クエリビルダーにクエリが読み込まれる
- [ ] 選択テーブルが復元される
- [ ] 選択カラムが復元される
- [ ] WHERE条件が復元される
- [ ] ORDER BY/LIMIT等が復元される
- [ ] SQLプレビューが更新される
- [ ] 読み込み成功のトースト通知が表示される
- [ ] Slideoverが閉じる

---

### 2.6 クエリ削除

**前提条件**: 保存済みクエリがある

**手順**:
1. 「開く」ボタンでSlideoverを表示
2. 任意のクエリカードにマウスオーバー
3. ゴミ箱アイコンをクリック
4. 確認ダイアログで「削除」をクリック

**期待結果**:
- [ ] 確認ダイアログが表示される
- [ ] 「キャンセル」で削除されない
- [ ] 「削除」でクエリが削除される
- [ ] 削除成功のトースト通知が表示される
- [ ] 一覧から削除される

---

### 2.7 空の状態表示

**前提条件**: 保存済みクエリが0件

**手順**:
1. 「開く」ボタンでSlideoverを表示

**期待結果**:
- [ ] 「保存されたクエリはありません」メッセージが表示される
- [ ] アイコンが表示される

---

### 2.8 アプリ再起動後の永続化確認

**手順**:
1. クエリを保存
2. アプリを終了（Cmd+Q または閉じるボタン）
3. アプリを再起動
4. 「開く」ボタンでSlideoverを表示

**期待結果**:
- [ ] 保存したクエリが残っている
- [ ] 全ての情報（名前、説明、タグ等）が保持されている

---

## 3. 自動テスト

### 3.1 Rustテスト実行コマンド

```bash
cd src-tauri && cargo test query_storage
```

### 3.2 フロントエンドテスト実行コマンド

```bash
npm run test:run -- app/stores/__tests__/saved-query.spec.ts
```

### 3.3 テストケース一覧

| テストID | テスト内容 | 期待結果 |
|---------|-----------|---------|
| T-01 | 新規クエリ保存 | IDが生成され、ファイルに保存される |
| T-02 | 既存クエリ更新 | 同一IDで内容が更新される |
| T-03 | クエリ読み込み | 保存した内容が正しく読み込まれる |
| T-04 | クエリ削除 | ファイルが削除される |
| T-05 | 一覧取得 | 全クエリが取得できる |
| T-06 | キーワード検索 | 名前/説明で絞り込まれる |
| T-07 | 存在しないID読み込み | エラーが返る |
| T-08 | ストア検索フィルタ | filteredQueriesが正しく動作 |

---

## 4. 境界条件テスト

### 4.1 長いクエリ名

**手順**:
1. 100文字以上のクエリ名を入力して保存

**期待結果**:
- [ ] 保存できる（または適切なバリデーションエラー）
- [ ] 一覧表示で適切に省略表示される

---

### 4.2 特殊文字を含むクエリ名

**手順**:
1. クエリ名に特殊文字（例: `<script>`, `'`, `"`）を入力して保存

**期待結果**:
- [ ] 保存できる
- [ ] XSSが発生しない
- [ ] 正しく読み込める

---

### 4.3 空のタグ

**手順**:
1. タグを入力せずに保存

**期待結果**:
- [ ] 保存できる
- [ ] タグは空配列として保存される

---

### 4.4 大量のクエリ

**手順**:
1. 100件のクエリを保存
2. 一覧を表示

**期待結果**:
- [ ] 一覧がスムーズに表示される
- [ ] 検索がスムーズに動作する

---

### 4.5 複雑なクエリ

**手順**:
1. 複数テーブル、複数JOIN、複数WHERE条件、ORDER BY、LIMITを含むクエリを構築
2. 保存
3. 読み込み

**期待結果**:
- [ ] 全ての条件が正しく保存される
- [ ] 全ての条件が正しく復元される

---

## 5. エラーケーステスト

### 5.1 ストレージアクセスエラー

**手順**:
1. （テスト環境で）データディレクトリの権限を削除
2. 保存を試みる

**期待結果**:
- [ ] エラートースト通知が表示される
- [ ] アプリがクラッシュしない

---

### 5.2 不正なJSONファイル

**手順**:
1. データディレクトリ内のJSONファイルを手動で破損
2. 一覧を表示

**期待結果**:
- [ ] 破損したファイルはスキップされる
- [ ] 他の正常なクエリは表示される

---

## 6. チェックリスト（最終確認）

| 項目 | 確認者 | 確認日 |
|------|--------|--------|
| クエリを名前付きで保存できる | | |
| 保存済みクエリを一覧表示できる | | |
| クエリ名で検索できる | | |
| クエリを読み込んでビルダーに反映できる | | |
| クエリを削除できる | | |
| アプリ再起動後もデータが保持されている | | |
| Rustテストが全てパス | | |
| フロントエンドテストが全てパス | | |

---

## 7. 備考

- テストデータは `{app_data}/queries/` ディレクトリに保存される
- macOSの場合: `~/Library/Application Support/com.sql-query-build.app/queries/`
- テスト後はテストデータを削除することを推奨
