# Phase 6B: JOIN設定UI拡張（ビジュアル表現） - タスクリスト

**作成日**: 2025-12-31
**フェーズ**: 6B
**更新日**: 2025-12-31 (TableRelationArea方式に変更)

---

## タスク概要

| タスクID | タスク名 | 依存関係 | 担当 | 状態 |
|---------|---------|---------|------|------|
| 6B.1 | RelationLine.vue コンポーネント作成 | Phase 6A | - | 📝 未着手 |
| 6B.2 | TableRelationArea.vue 拡張 | 6B.1 | - | 📝 未着手 |
| 6B.3 | JOINツールバーUI追加 | 6B.2 | - | 📝 未着手 |
| 6B.4 | 総合テスト | 6B.3 | - | 📝 未着手 |

---

## 6B.1 RelationLine.vue コンポーネント作成

**目的**: JOIN関係を視覚化するSVG線コンポーネントを作成する

### サブタスク

- [ ] 6B.1.1 - RelationLine.vue の基本構造作成
  - SVG `<line>` 要素でJOIN線を描画
  - JOIN種別に応じた線種（実線・破線・点線）
  - 線の中央にJOIN種別ラベルを表示
  - **成果物**: `app/components/query-builder/RelationLine.vue`
  - **完了条件**: JOIN線が正しく表示される

- [ ] 6B.1.2 - クリックイベント実装
  - 線クリックで`click`イベントを発火
  - ホバー時のスタイル変更
  - **成果物**: RelationLine.vue にクリックロジック追加
  - **完了条件**: 線をクリックするとイベントが発火する

- [ ] 6B.1.3 - 単体テスト実装
  - JOIN種別ごとの線種テスト
  - クリックイベントのテスト
  - **成果物**: `app/components/query-builder/RelationLine.test.ts`
  - **完了条件**: テストがすべてパスする

---

## 6B.2 TableRelationArea.vue 拡張

**目的**: 既存のTableRelationArea.vueにJOIN可視化機能を追加する

### サブタスク

- [ ] 6B.2.1 - コメントアウトコードの有効化
  - 8, 9, 18, 27-29, 118-135, 172-189行目のコメントアウトを解除
  - import文の有効化（RelationLine, JoinConfigDialog, JoinClause型）
  - **成果物**: TableRelationArea.vue の修正
  - **完了条件**: コメントアウトが解除され、コンパイルエラーがない

- [ ] 6B.2.2 - SVGレイヤー追加
  - `<svg>` 要素を追加（absolute配置、z-10）
  - `RelationLine` コンポーネントをv-forで描画
  - **成果物**: TableRelationArea.vue のテンプレート拡張
  - **完了条件**: JOIN線がSVG上に表示される

- [ ] 6B.2.3 - relationLines computed 実装
  - joins配列から線の座標を計算
  - テーブル位置からJOIN線のx1, y1, x2, y2を算出
  - **成果物**: TableRelationArea.vue に relationLines computed 追加
  - **完了条件**: JOIN設定に応じて線の座標が計算される

- [ ] 6B.2.4 - JOIN関連メソッド実装
  - `openJoinDialog(join?)` - ダイアログを開く
  - `handleSaveJoin(join)` - JOIN保存
  - 線クリック時にダイアログを開く連携
  - **成果物**: TableRelationArea.vue にメソッド追加
  - **完了条件**: 線クリックでJOIN編集ダイアログが開く

- [ ] 6B.2.5 - ズーム機能実装
  - `zoom`, `panX`, `panY` 状態追加
  - `handleZoomIn/Out/Reset` メソッド実装
  - `svgTransform` computed で transform 属性生成
  - **成果物**: TableRelationArea.vue にズームロジック追加
  - **完了条件**: ズーム操作で線が拡大縮小される

- [ ] 6B.2.6 - 単体テスト実装
  - relationLines computed のテスト
  - JOIN線クリックのテスト
  - ズーム操作のテスト
  - **成果物**: `app/components/query-builder/TableRelationArea.test.ts` 拡張
  - **完了条件**: テストがすべてパスする

---

## 6B.3 JOINツールバーUI追加

**目的**: JOIN追加・ズーム操作のツールバーを追加する

### サブタスク

- [ ] 6B.3.1 - JOINツールバー実装
  - [+ JOIN追加]ボタン（selectedTables.length >= 2 の時のみ表示）
  - ズームイン・アウトボタン
  - ズーム倍率表示・リセットボタン
  - **成果物**: TableRelationArea.vue のツールバー部分
  - **完了条件**: ツールバーが右上に浮遊表示される

- [ ] 6B.3.2 - ボタンアクション統合
  - JOIN追加ボタン → `openJoinDialog()`
  - ズームボタン → `handleZoomIn/Out/Reset()`
  - **成果物**: TableRelationArea.vue のイベントハンドラ接続
  - **完了条件**: すべてのボタンが正しく動作する

- [ ] 6B.3.3 - E2Eテスト実装
  - ツールバーボタンのクリックテスト
  - ズーム操作の統合テスト
  - **成果物**: E2Eテストファイル
  - **完了条件**: テストがすべてパスする

---

## 6B.4 総合テスト

**目的**: Phase 6B全体の動作を確認する

### サブタスク

- [ ] 6B.4.1 - JOIN線表示テスト
  - 2つ以上のテーブルを選択
  - Phase 6AでJOINを設定
  - JOIN線が正しく表示されることを確認
  - **完了条件**: JOIN種別に応じた線種で表示される

- [ ] 6B.4.2 - JOIN編集フロー統合テスト
  - 線をクリック → ダイアログが開く
  - JOIN設定を変更 → 線の表示が更新される
  - **完了条件**: エンドツーエンドのフローが動作する

- [ ] 6B.4.3 - ズーム操作テスト
  - ズームイン・アウト操作
  - テーブルと線が同時に拡大縮小されることを確認
  - **完了条件**: ズーム操作が滑らか（60fps）

- [ ] 6B.4.4 - テーブル位置保存・復元テスト
  - テーブルをドラッグして配置
  - クエリを保存
  - クエリを読み込み
  - **完了条件**: テーブル位置が正しく復元される

- [ ] 6B.4.5 - パフォーマンステスト
  - 10テーブル、20JOINを設定
  - Chrome DevToolsでFPSを計測
  - **完了条件**: 60fps以上を維持

---

## 完了条件チェックリスト

- [ ] JOIN関係が線で可視化される
- [ ] 線をクリックしてJOIN設定を編集できる
- [ ] ズーム操作が可能
- [ ] キャンバス上でテーブルをドラッグ配置できる（既存機能）
- [ ] テーブル位置が保存される（既存機能）
- [ ] 10テーブル、20JOINでもスムーズに動作する（60fps）

---

## 進捗管理

| タスクID | 開始日 | 終了日 | 備考 |
|---------|--------|--------|------|
| 6B.1.1 | - | - | - |
| 6B.1.2 | - | - | - |
| 6B.1.3 | - | - | - |
| 6B.2.1 | - | - | - |
| 6B.2.2 | - | - | - |
| 6B.2.3 | - | - | - |
| 6B.2.4 | - | - | - |
| 6B.2.5 | - | - | - |
| 6B.2.6 | - | - | - |
| 6B.3.1 | - | - | - |
| 6B.3.2 | - | - | - |
| 6B.3.3 | - | - | - |
| 6B.4.1 | - | - | - |
| 6B.4.2 | - | - | - |
| 6B.4.3 | - | - | - |
| 6B.4.4 | - | - | - |
| 6B.4.5 | - | - | - |

---

## リスク管理

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 | 状態 |
|---------|-----------|--------|---------|------|------|
| R1 | SVGパフォーマンスが低下 | 中 | 中 | 要素数制限（最大50JOIN） | 監視中 |
| R2 | ズーム操作がぎこちない | 高 | 低 | transform使用で軽量化 | - |
| R3 | 既存TableCard.vueとの統合問題 | 中 | 低 | 既存実装を変更しない | - |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-12-31 | 1.0 | 初版作成（タブ方式） |
| 2025-12-31 | 2.0 | **TableRelationArea方式に変更** |

### v2.0 主な変更点

1. **実装方針変更**: JOINタブ→TableRelationArea拡張方式
2. **タスク数削減**: 24タスク→17タスク（既存コンポーネント活用）
3. **コンポーネント構成変更**:
   - ❌ TableCanvas.vue（新規作成）→ 削除
   - ❌ TableCardOnCanvas.vue（新規作成）→ 削除
   - ✅ RelationLine.vue（新規作成）→ 採用
   - ✅ TableRelationArea.vue（拡張）→ 採用
4. **既存資産の活用**: TableCard.vue、tablePositions、JoinConfigDialogを再利用

---

## 次のアクション

1. 6B.1.1から順次実装を開始
2. 各タスク完了後に進捗を更新
3. 問題が発生した場合はリスク管理セクションを更新
