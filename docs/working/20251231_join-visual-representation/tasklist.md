# Phase 6B: JOIN設定UI拡張（ビジュアル表現） - タスクリスト

**作成日**: 2025-12-31
**フェーズ**: 6B

---

## タスク概要

| タスクID | タスク名 | 依存関係 | 担当 | 状態 |
|---------|---------|---------|------|------|
| 6B.1 | TableCanvas.vue - 基本構造実装 | Phase 6A | - | 📝 未着手 |
| 6B.2 | テーブル位置管理機能 | 6B.1 | - | 📝 未着手 |
| 6B.3 | リレーション線描画機能 | 6B.2 | - | 📝 未着手 |
| 6B.4 | キャンバス操作UI（ズーム・パン） | 6B.3 | - | 📝 未着手 |
| 6B.5 | JoinConfigDialogとの連携 | 6B.4 | - | 📝 未着手 |

---

## 6B.1 TableCanvas.vue - 基本構造実装

**目的**: キャンバスコンポーネントの基本構造を作成し、テーブルカードを表示する

### サブタスク

- [ ] 6B.1.1 - TableCardOnCanvas.vue コンポーネント作成
  - SVG `<g>` 要素でテーブルカードを表現
  - テーブル名、エイリアス、カラム一覧を表示
  - ドラッグ開始イベントを発火
  - **成果物**: `app/components/query-builder/TableCardOnCanvas.vue`
  - **完了条件**: テーブルカードがSVG上に表示される

- [ ] 6B.1.2 - TableCanvas.vue の基本レイアウト作成
  - SVGキャンバスの基本構造
  - グリッド背景の表示（オプション）
  - テーブルカードの配置（positions computed）
  - **成果物**: `app/components/query-builder/TableCanvas.vue`
  - **完了条件**: 複数のテーブルカードが表示される

- [ ] 6B.1.3 - ドラッグ&ドロップ機能実装
  - `handleDragStart` / `handleDragMove` / `handleDragEnd` 実装
  - `update:table-position` イベント発火
  - ドラッグ中の視覚的フィードバック（半透明化）
  - **成果物**: TableCanvas.vue にドラッグロジック追加
  - **完了条件**: テーブルカードをドラッグして移動できる

- [ ] 6B.1.4 - 単体テスト実装
  - TableCardOnCanvas.vue のテスト
  - TableCanvas.vue の基本表示テスト
  - ドラッグ操作のテスト
  - **成果物**: `*.test.ts` ファイル
  - **完了条件**: テストがすべてパスする

---

## 6B.2 テーブル位置管理機能

**目的**: テーブル位置の記憶・自動配置・永続化機能を実装する

### サブタスク

- [ ] 6B.2.1 - query-builder.ts にテーブル位置状態を追加
  - `tablePositions: { [alias]: { x, y } }` 状態追加
  - `updateTablePosition(alias, x, y)` アクション実装
  - `resetTablePositions()` アクション実装
  - **成果物**: `app/stores/query-builder.ts` 拡張
  - **完了条件**: テーブル位置が状態管理される

- [ ] 6B.2.2 - 自動配置アルゴリズム実装
  - 新規テーブル追加時の位置計算
  - 3列レイアウト（折り返し対応）
  - 既存テーブルとの重複回避
  - **成果物**: TableCanvas.vue の `positions` computed
  - **完了条件**: テーブルが自動配置される

- [ ] 6B.2.3 - QueryModel拡張（位置情報の保存）
  - QueryModel型に `tablePositions` プロパティ追加
  - `toQueryModel()` で位置情報を含める
  - `loadFromQueryModel()` で位置情報を復元
  - **成果物**: `app/types/query-model.ts` 拡張、`app/stores/query-builder.ts` 拡張
  - **完了条件**: クエリ保存時に位置情報が含まれる

- [ ] 6B.2.4 - テーブル削除時の位置情報削除
  - `removeTable()` で位置情報も削除
  - **成果物**: `app/stores/query-builder.ts` 拡張
  - **完了条件**: テーブル削除時に位置情報も削除される

- [ ] 6B.2.5 - 単体テスト実装
  - テーブル位置の更新テスト
  - 自動配置のテスト
  - 保存・復元のテスト
  - **成果物**: `*.test.ts` ファイル
  - **完了条件**: テストがすべてパスする

---

## 6B.3 リレーション線描画機能

**目的**: JOIN関係を視覚的に表現する線を描画する

### サブタスク

- [ ] 6B.3.1 - リレーション線の計算ロジック実装
  - `relationLines` computed の実装
  - テーブル位置からJOIN線の座標を計算
  - JOIN種別に応じたスタイル（実線・破線・点線）
  - **成果物**: TableCanvas.vue に `relationLines` computed 追加
  - **完了条件**: JOIN関係から線の座標が計算される

- [ ] 6B.3.2 - SVG線の描画
  - `<line>` 要素でJOIN関係を描画
  - ホバー時のスタイル変更
  - 線の中央にJOIN種別を表示（テキスト）
  - **成果物**: TableCanvas.vue のテンプレート拡張
  - **完了条件**: JOIN関係が線で表示される

- [ ] 6B.3.3 - 線クリックイベント実装
  - 線クリックで `edit-join` イベント発火
  - **成果物**: TableCanvas.vue に `handleLineClick` 実装
  - **完了条件**: 線をクリックするとイベントが発火する

- [ ] 6B.3.4 - 単体テスト実装
  - 線の計算ロジックのテスト
  - 線クリックイベントのテスト
  - **成果物**: `*.test.ts` ファイル
  - **完了条件**: テストがすべてパスする

---

## 6B.4 キャンバス操作UI（ズーム・パン）

**目的**: ズーム・パン操作でキャンバスを快適に操作できるようにする

### サブタスク

- [ ] 6B.4.1 - ズーム機能実装
  - マウスホイールでズームイン・アウト
  - ズーム範囲: 50% ～ 200%
  - ズーム中心: マウスカーソル位置
  - **成果物**: TableCanvas.vue に `handleWheel` 実装
  - **完了条件**: マウスホイールでズームできる

- [ ] 6B.4.2 - パン機能実装
  - 中ボタンドラッグでキャンバス移動
  - `handlePanStart` / `handlePanMove` / `handlePanEnd` 実装
  - **成果物**: TableCanvas.vue にパンロジック追加
  - **完了条件**: 中ボタンドラッグでキャンバスを移動できる

- [ ] 6B.4.3 - SVG transform 適用
  - `svgTransform` computed でズーム・パン位置を反映
  - **成果物**: TableCanvas.vue の `svgTransform` computed
  - **完了条件**: ズーム・パンが視覚的に反映される

- [ ] 6B.4.4 - ツールバーUI実装
  - ズームイン・アウトボタン
  - ズーム倍率表示・リセットボタン
  - レイアウトリセットボタン
  - **成果物**: TableCanvas.vue のツールバー部分
  - **完了条件**: ツールバーからズーム・リセット操作ができる

- [ ] 6B.4.5 - パフォーマンス最適化
  - `requestAnimationFrame` でドラッグ操作を最適化
  - **成果物**: TableCanvas.vue の最適化
  - **完了条件**: ドラッグ操作が滑らか（60fps）

- [ ] 6B.4.6 - 単体テスト実装
  - ズーム操作のテスト
  - パン操作のテスト
  - **成果物**: `*.test.ts` ファイル
  - **完了条件**: テストがすべてパスする

---

## 6B.5 JoinConfigDialogとの連携

**目的**: キャンバスからJOIN編集ダイアログを開けるようにする

### サブタスク

- [ ] 6B.5.1 - JoinPanel.vue にタブ切り替え機能追加
  - [リスト表示] / [キャンバス表示] のタブ切り替え
  - `UTabs` コンポーネントで実装
  - **成果物**: `app/components/query-builder/JoinPanel.vue` 拡張
  - **完了条件**: タブ切り替えでリスト/キャンバスが表示される

- [ ] 6B.5.2 - キャンバスからのJOIN編集フロー統合
  - TableCanvas から `edit-join` イベントを受け取る
  - JoinConfigDialog を開く
  - **成果物**: JoinPanel.vue に `handleEditJoinFromCanvas` 実装
  - **完了条件**: 線クリックでJOIN編集ダイアログが開く

- [ ] 6B.5.3 - ダイアログでの編集内容をキャンバスに反映
  - JoinConfigDialog から保存された内容を受け取る
  - query-builderストアを更新
  - TableCanvas が自動的に更新される
  - **成果物**: 既存のJoinConfigDialog連携ロジックを確認
  - **完了条件**: ダイアログでの編集がキャンバスに反映される

- [ ] 6B.5.4 - E2Eテスト実装
  - タブ切り替えのテスト
  - キャンバスでのJOIN編集フローのテスト
  - **成果物**: `*.test.ts` ファイル
  - **完了条件**: テストがすべてパスする

---

## 総合テスト

- [ ] T1 - 10テーブル、20JOINでのパフォーマンステスト
  - 60fps以上で動作することを確認
  - ドラッグ操作が滑らかであることを確認
  - **完了条件**: パフォーマンス要件を満たす

- [ ] T2 - クエリ保存・復元のテスト
  - テーブル位置を変更後、クエリを保存
  - クエリを読み込んでテーブル位置が復元されることを確認
  - **完了条件**: 位置情報が正しく保存・復元される

- [ ] T3 - キーボード操作のテスト
  - 矢印キーでテーブル位置を調整できることを確認
  - **完了条件**: アクセシビリティ要件を満たす

- [ ] T4 - ブラウザ互換性テスト
  - Chrome, Firefox, Safariで動作確認
  - **完了条件**: 主要ブラウザで動作する

---

## 完了条件チェックリスト

- [ ] キャンバス上でテーブルをドラッグ配置できる
- [ ] JOIN関係が線で可視化される
- [ ] 線をクリックしてJOIN設定を編集できる
- [ ] テーブル位置が保存される
- [ ] ズーム・パン操作が可能
- [ ] 10テーブル、20JOINでもスムーズに動作する（60fps）

---

## 進捗管理

| タスクID | 開始日 | 終了日 | 備考 |
|---------|--------|--------|------|
| 6B.1.1 | - | - | - |
| 6B.1.2 | - | - | - |
| 6B.1.3 | - | - | - |
| 6B.1.4 | - | - | - |
| 6B.2.1 | - | - | - |
| 6B.2.2 | - | - | - |
| 6B.2.3 | - | - | - |
| 6B.2.4 | - | - | - |
| 6B.2.5 | - | - | - |
| 6B.3.1 | - | - | - |
| 6B.3.2 | - | - | - |
| 6B.3.3 | - | - | - |
| 6B.3.4 | - | - | - |
| 6B.4.1 | - | - | - |
| 6B.4.2 | - | - | - |
| 6B.4.3 | - | - | - |
| 6B.4.4 | - | - | - |
| 6B.4.5 | - | - | - |
| 6B.4.6 | - | - | - |
| 6B.5.1 | - | - | - |
| 6B.5.2 | - | - | - |
| 6B.5.3 | - | - | - |
| 6B.5.4 | - | - | - |

---

## リスク管理

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 | 状態 |
|---------|-----------|--------|---------|------|------|
| R1 | SVGパフォーマンスが低下 | 中 | 中 | 要素数制限、Canvas移行準備 | 監視中 |
| R2 | ドラッグ操作がぎこちない | 高 | 低 | requestAnimationFrame使用 | - |
| R3 | テーブル位置の保存がQueryModelを肥大化 | 低 | 低 | オプショナルプロパティ | - |
| R4 | 線が複雑に絡み合う | 中 | 中 | Phase 6Cで自動ルーティング検討 | - |

---

## 次のアクション

1. 6B.1.1から順次実装を開始
2. 各タスク完了後に進捗を更新
3. 問題が発生した場合はリスク管理セクションを更新
