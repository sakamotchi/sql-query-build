# Phase 6B: JOIN設定UI拡張（ビジュアル表現） - 要件定義書

**作成日**: 2025-12-31
**フェーズ**: 6B
**優先度**: 中
**依存関係**: Phase 6A（基本的なJOIN機能）

---

## 1. 概要

Phase 6Aで実装した基本的なJOIN機能をベースに、テーブル間の関係を視覚的に表現するキャンバス機能を追加します。これにより、複雑なJOIN関係を直感的に把握・操作できるようになります。

---

## 2. 目的

- テーブル間のJOIN関係を視覚的に把握できるようにする
- キャンバス上でテーブルをドラッグして配置できるようにする
- JOIN関係を線で表現し、クリックして編集できるようにする
- テーブル位置を保存・復元できるようにする
- ズーム・パン操作で大規模なスキーマを扱いやすくする

---

## 3. スコープ

### 3.1 含まれるもの

- TableRelationArea.vue の拡張（既存コンポーネント）
- RelationLine.vue（SVG線描画コンポーネント）
- テーブル位置の記憶機能（既存のtablePositionsを活用）
- ズーム・パン・リセット操作
- JoinConfigDialogとの連携（線クリックで編集）
- JOINツールバー（浮遊UI）

### 3.2 含まれないもの（後続フェーズ・対象外）

- 外部キーベースの自動提案（Phase 6C）
- ドラッグ&ドロップによる新規JOIN作成（Phase 6C）
- リレーション線の自動ルーティング（複雑なアルゴリズムは今回対象外）
- JOINタブ（中央パネルに直接実装するため不要）
- リスト表示モード（Phase 6Aで実装済みのJoinPanelは別途存在）

---

## 4. 機能要件

### 4.1 キャンバス機能

#### 4.1.1 テーブルカード表示

- 選択済みテーブルをキャンバス上にカード形式で表示
- カード表示内容：
  - テーブル名とエイリアス
  - 主要カラム一覧（最大10件、それ以上は省略）
  - 主キー（PK）・外部キー（FK）のアイコン表示
- カードのサイズ：固定（幅200px、高さ自動）

#### 4.1.2 ドラッグ&ドロップ

- テーブルカードをドラッグして自由に配置できる
- ドラッグ中は視覚的なフィードバック（半透明化等）
- ドロップ位置を記憶し、次回表示時に復元

#### 4.1.3 自動配置

- 新規にテーブルを追加した場合、既存テーブルと重ならないように自動配置
- 配置アルゴリズム：
  - 初回: 左上から開始
  - 2つ目以降: 前のテーブルの右側に配置（横幅＋マージン）
  - 画面幅を超える場合は次の行に折り返し

### 4.2 リレーション線描画

#### 4.2.1 線の表示

- JOIN設定されているテーブル間を線で結ぶ
- 線の種類：
  - INNER JOIN: 実線（太さ2px）
  - LEFT JOIN: 破線（左側テーブルが実線、右側が破線）
  - RIGHT JOIN: 破線（右側テーブルが実線、左側が破線）
  - FULL OUTER JOIN: 破線（両側破線）
  - CROSS JOIN: 点線（灰色）

#### 4.2.2 線の色

- 環境色に準拠（開発=緑、本番=赤など）
- ホバー時は明るく表示
- 選択時は太く表示

#### 4.2.3 線の接続点

- テーブルカードの中央から接続
- 将来的には特定のカラムから接続する形式も検討（Phase 6C）

### 4.3 キャンバス操作

#### 4.3.1 ズーム機能

- マウスホイールでズームイン・ズームアウト
- ズーム範囲: 50% ～ 200%
- ズーム中心: マウスカーソル位置

#### 4.3.2 パン機能

- 中ボタンドラッグまたはスペース+ドラッグでキャンバス移動
- パン位置の記憶・復元

#### 4.3.3 リセット機能

- ツールバーに「リセット」ボタンを配置
- ズーム・パン位置を初期状態に戻す
- テーブル位置は初期化しない（「レイアウトをリセット」は別ボタン）

### 4.4 インタラクション

#### 4.4.1 線クリック

- リレーション線をクリックすると、対応するJOINの編集ダイアログを表示
- JoinConfigDialogが開き、既存のJOIN設定が表示される

#### 4.4.2 テーブルカードクリック

- テーブルカードをクリックすると、そのテーブルに関連するJOINを強調表示
- 強調表示: 関連する線を太く表示、他の線を半透明に

### 4.5 データ永続化

#### 4.5.1 テーブル位置の保存

- クエリ保存時にテーブル位置も含める
- QueryModel型に `tablePositions` プロパティを追加：
  ```typescript
  tablePositions?: {
    [tableAlias: string]: { x: number; y: number }
  }
  ```

#### 4.5.2 キャンバス状態の保存

- ズーム・パン位置も保存（オプション）
- ローカルストレージに保存し、アプリケーション全体で共有

---

## 5. 非機能要件

### 5.1 パフォーマンス

- 10テーブル、20JOINまではスムーズに動作（60fps）
- リレーション線の再描画は300ms以内
- ドラッグ操作は遅延なく反応

### 5.2 ユーザビリティ

- 直感的な操作感（一般的なドローイングツールと同様）
- マウスホイールズームは標準的な挙動
- タッチパッド操作にも対応

### 5.3 アクセシビリティ

- キーボード操作でテーブル位置を調整可能（矢印キー）
- スクリーンリーダーには代替テキストを提供

---

## 6. 制約事項

- キャンバスサイズ: 最大5000x5000px（パフォーマンス考慮）
- リレーション線の自動ルーティングは実装しない（直線接続のみ）
- テーブルカード間の自動整列機能は今回対象外

---

## 7. 成功基準

- ✅ キャンバス上でテーブルをドラッグ配置できる
- ✅ JOIN関係が線で可視化される
- ✅ 線をクリックしてJOIN設定を編集できる
- ✅ テーブル位置が保存される
- ✅ ズーム・パン操作が可能
- ✅ 10テーブル、20JOINでもスムーズに動作する

---

## 8. UI設計方針

### 8.1 実装場所

**中央パネル（TableRelationArea）に直接実装する**

Phase 6Aのようなタブ方式ではなく、既存の中央パネル（テーブル選択エリア）に以下を追加：
- SVGレイヤー（JOIN関係を線で表示）
- JOINツールバー（右上に浮遊）
- JoinConfigDialog（モーダル）

**理由**:
- 既存のテーブルカード表示・ドラッグ機能を活用
- テーブル選択→JOIN設定が同じ場所で完結（UX向上）
- タブ管理が不要でシンプル
- 画面スペースを有効活用

### 8.2 ツールバー配置

中央パネル右上に浮遊表示：

```
┌─────────────────────────────────────────────┐
│                    [+ JOIN追加] [ズーム] [リセット] │
│                                             │
│  (テーブルカード & JOIN線)                  │
└─────────────────────────────────────────────┘
```

### 8.3 レイアウト例（中央パネル内）

```
┌─────────────────────────────────────────────────┐
│ TableRelationArea (中央パネル)                  │
├─────────────────────────────────────────────────┤
│                    [+ JOIN追加] [🔍] [↻]       │
│                                                 │
│  ┌─────────────┐                               │
│  │ orders (o)  │──────┐                        │
│  │ ─────────── │      │                        │
│  │ • id (PK)   │      │ INNER JOIN            │
│  │ • user_id   │      ↓                        │
│  │ • product_id│   ┌─────────────┐            │
│  └─────────────┘   │ users (u)   │            │
│                     │ ─────────── │            │
│                     │ • id (PK)   │            │
│  ┌─────────────┐   │ • name      │            │
│  │ products (p)│   └─────────────┘            │
│  │ ─────────── │                               │
│  │ • id (PK)   │←─── LEFT JOIN ────┘          │
│  │ • name      │                               │
│  └─────────────┘                               │
└─────────────────────────────────────────────────┘
```

**既存のQueryBuilderLayout構成**:
```
┌───────────────────────────────────────────┐
│ ツールバー (QueryBuilderToolbar)          │
├───────┬───────────────────┬───────────────┤
│ 左    │ 中央パネル        │ 右パネル      │
│ パネル│ TableRelationArea │ (SQL Preview) │
│ (DB   │ ← ここに実装 ★   │               │
│ Tree) │                   │               │
└───────┴───────────────────┴───────────────┘
```

---

## 9. データモデル

### 9.1 QueryModel拡張（TypeScript）

```typescript
export interface QueryModel {
  // ... 既存のプロパティ ...

  /**
   * テーブル位置（キャンバス表示用）
   */
  tablePositions?: {
    [tableAlias: string]: {
      x: number
      y: number
    }
  }
}
```

### 9.2 CanvasState（ローカルストレージ）

```typescript
export interface CanvasState {
  zoom: number       // 50 ~ 200
  panX: number       // パン位置X
  panY: number       // パン位置Y
  gridVisible: boolean  // グリッド表示（将来拡張）
}
```

---

## 10. 技術スタック

### 10.1 キャンバス描画

**候補1: SVG（推奨）**
- メリット: スケーラブル、DOM操作が容易、アクセシビリティ良好
- デメリット: 大量の要素でパフォーマンス低下

**候補2: HTML Canvas API**
- メリット: 高パフォーマンス
- デメリット: DOM操作不可、アクセシビリティ対応が困難

→ **SVGを採用**（要素数が少ない想定、UX重視）

### 10.2 ドラッグ&ドロップ

**候補1: VueUse `useDraggable`**
- メリット: Vue統合が容易、型安全
- デメリット: SVGには対応していない可能性

**候補2: 自前実装（Mouse Events）**
- メリット: 完全なコントロール
- デメリット: 実装コストが高い

→ **自前実装を採用**（SVGとの統合を考慮）

### 10.3 線の描画

**ライブラリ: なし（SVG `<line>` または `<path>` を使用）**

---

## 11. 参考資料

- WBS: [docs/sql_editor_wbs_v3.md](../sql_editor_wbs_v3.md) - Phase 6B
- Phase 6A設計書: [docs/working/20251230_join-basic-features/design.md](../20251230_join-basic-features/design.md)
- SVG仕様: https://developer.mozilla.org/en-US/docs/Web/SVG
- Vue3でのSVG操作: https://vuejs.org/guide/extras/web-components.html

---

## 12. リスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 |
|---------|-----------|--------|---------|------|
| R1 | SVGパフォーマンスが低下 | 中 | 中 | 要素数が多い場合はCanvasに移行する準備 |
| R2 | ドラッグ操作がぎこちない | 高 | 低 | requestAnimationFrameで滑らかに |
| R3 | テーブル位置の保存がQueryModelを肥大化 | 低 | 低 | オプショナルプロパティとして実装 |
| R4 | 線が複雑に絡み合う | 中 | 中 | Phase 6Cで自動ルーティングを検討 |

---

## 13. 次のアクション

1. design.mdで詳細設計を行う
2. tasklist.mdでタスクを洗い出す
3. 実装開始
