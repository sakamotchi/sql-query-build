# 要件定義書 - 保存クエリの接続非依存化

**作成日**: 2026-02-01
**要件名**: saved-query-connection-independence
**作業タイプ**: 新規機能開発（既存機能の改善）

---

## 概要

保存クエリ（SavedQuery）を接続ID（connectionId）に依存しない形に変更し、すべての接続で保存クエリを共有できるようにする。これにより、フォルダ管理機能との一貫性を保ち、クエリの再利用性を向上させる。

---

## 背景・目的

### 現状の問題点

1. **フォルダとクエリの設計不整合**
   - フォルダは全接続で共有されている
   - 保存クエリは接続ごとに分離されている
   - この不整合により、ユーザー体験が直感的でない

2. **データモデルとバリデーションの矛盾**
   - データモデルでは `connectionId` は nullable（`Option<String>`）
   - バリデーションでは `connectionId` が必須として扱われている
   - 実装意図が不明瞭になっている

3. **実用的なユースケースへの対応不足**
   - 開発環境で作成したクエリを本番環境で使いたい
   - 同じスキーマの異なる環境間でクエリを再利用したい
   - 現状ではこれらのニーズに対応できていない

### 目的

- **設計の一貫性確保**: フォルダとクエリを同じ設計方針（全接続で共有）に統一
- **再利用性の向上**: 環境間でクエリを再利用可能にする
- **シンプルな概念**: 「すべてのクエリを管理」という単純で分かりやすい設計
- **フォルダ管理との統合**: フォルダで整理することで、接続フィルタがなくても管理可能

---

## 要件一覧

### 機能要件

#### F-1: 保存クエリの接続非依存化

- **説明**: 保存クエリを接続IDに紐づけず、全接続で共有できるようにする
- **受け入れ条件**:
  - [x] `connectionId` をオプショナルフィールドとして扱う
  - [x] 保存クエリ一覧の取得時に接続IDでフィルタしない
  - [x] 任意の接続で任意の保存クエリを実行できる
  - [x] フォルダ管理と保存クエリの設計が一貫している

#### F-2: バリデーションの修正

- **説明**: `connectionId` の必須バリデーションを削除し、オプショナルとして扱う
- **受け入れ条件**:
  - [x] Rustバックエンドのバリデーション関数で `connectionId` の必須チェックを削除
  - [x] フロントエンドの型定義が `connectionId: string | null` のまま維持される

#### F-3: クエリ保存ダイアログの修正

- **説明**: クエリ保存時に接続を選択する必要をなくす
- **受け入れ条件**:
  - [x] 保存ダイアログから接続選択UIを削除（SQLエディタ側）
  - [x] クエリビルダー側は接続IDなしで保存できるよう修正
  - [x] 保存時に `connectionId: null` を設定

#### F-4: クエリ一覧表示の修正

- **説明**: すべての保存クエリを接続に関係なく一覧表示する
- **受け入れ条件**:
  - [x] SQLエディタの保存クエリパネルで全クエリを表示
  - [x] クエリビルダーの保存クエリスライドオーバーで全クエリを表示
  - [x] フォルダで整理された状態で表示される

### 非機能要件

- **下位互換性**: 既存の保存クエリは引き続き動作する（`connectionId` が設定されているものも表示される）
- **パフォーマンス**: クエリ一覧取得時のパフォーマンスに悪影響を与えない
- **保守性**: データモデルとバリデーションの一貫性を保つ

---

## スコープ

### 対象

- SQLエディタの保存クエリ管理機能
- クエリビルダーの保存クエリ管理機能
- Rustバックエンドのバリデーション処理
- フロントエンドのクエリ保存・読み込みロジック

### 対象外

- クエリ履歴機能（履歴は接続ごとに管理することが妥当）
- フォルダ管理機能の変更（既に接続非依存のため対象外）
- データベース構造取得機能

---

## 実装対象ファイル（予定）

### バックエンド（Rust）

- `src-tauri/src/commands/sql_editor.rs` - バリデーション関数の修正
- `src-tauri/src/commands/query_storage_commands.rs` - クエリビルダー側のコマンド

### フロントエンド（TypeScript/Vue）

- `app/stores/sql-editor.ts` - SQLエディタストアの修正
- `app/stores/saved-query.ts` - クエリビルダーストアの修正
- `app/components/sql-editor/dialogs/SaveQueryDialog.vue` - 保存ダイアログ（SQLエディタ）
- `app/components/query-builder/dialog/SaveQueryDialog.vue` - 保存ダイアログ（クエリビルダー）

### その他

- `docs/steering/features/query-builder.md` - 機能詳細仕様の更新
- `docs/steering/06_ubiquitous_language.md` - 用語定義の確認・更新

---

## 依存関係

- フォルダ管理機能（既に実装済み、接続非依存）
- 保存クエリのデータモデル（既存の `SavedQuery` 型を使用）

---

## 既知の制約

### 接続ごとにDB構造が異なる場合

- クエリが動作しない可能性がある
- **対応方針**: 実行時のエラーメッセージで対処（ユーザーの責任範囲）
- **補完策**: フォルダで環境ごとに整理することを推奨

### 大量のクエリが一覧に表示される

- 接続フィルタがないと管理が大変になる可能性がある
- **対応方針**:
  - フォルダで整理することで対応
  - 検索・フィルタ機能（タグ、キーワード）で対応
  - 将来的には「最近使用したクエリ」等のスマートフィルタを追加検討

---

## ユースケース例

### ユースケース1: 環境間でのクエリ再利用

1. 開発環境の接続で「ユーザー一覧取得」クエリを作成・保存
2. フォルダ「/共通クエリ/ユーザー管理」に保存
3. 本番環境の接続を開く
4. 保存クエリパネルから「ユーザー一覧取得」を選択
5. 本番環境で同じクエリを実行

### ユースケース2: 接続に依存しない汎用クエリの管理

1. 「SELECT * FROM users WHERE id = ?」のようなテンプレートクエリを作成
2. フォルダ「/テンプレート」に保存
3. どの接続でも使用可能なクエリとして管理

---

## 参考資料

- [docs/working/20260125_SQLエディタ用保存クエリ管理/design.md](../20260125_SQLエディタ用保存クエリ管理/design.md) - フォルダ管理機能の設計書
- [docs/steering/features/query-builder.md](../../steering/features/query-builder.md) - クエリビルダー機能詳細仕様
- [docs/steering/06_ubiquitous_language.md](../../steering/06_ubiquitous_language.md) - ユビキタス言語定義書
- [app/types/saved-query.ts](../../../app/types/saved-query.ts) - 現在のデータモデル定義
- [src-tauri/src/models/saved_query.rs](../../../src-tauri/src/models/saved_query.rs) - Rustのデータモデル定義
