# タスクリスト - 保存クエリの接続非依存化

**作成日**: 2026-02-01
**要件名**: saved-query-connection-independence
**親ドキュメント**: [requirements.md](./requirements.md) | [design.md](./design.md)

---

## 進捗サマリー

| 状態 | 件数 |
|------|------|
| 完了 | 0 |
| 進行中 | 0 |
| 未着手 | 11 |

**更新日**: 2026-02-01

---

## タスク一覧

### T-1: 要件定義・設計

**関連要件**: 全体

- [x] 要件定義書の作成
- [x] 設計書の作成
- [ ] レビュー完了

**担当**: -
**期日**: -
**状態**: 進行中

---

### T-2: バックエンド修正（SQLエディタ側）

**関連要件**: F-1, F-2

**実装内容**:
- `src-tauri/src/commands/sql_editor.rs` のバリデーション関数修正
- `list_sql_queries` コマンドの接続IDフィルタ削除

**サブタスク**:
- [ ] `validate_save_request()` から `connectionId` の必須チェックを削除
- [ ] `list_sql_queries()` から接続IDでのフィルタリング処理を削除
- [ ] Rustのユニットテスト作成（バリデーション）
- [ ] 動作確認

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-3: バックエンド修正（クエリビルダー側）

**関連要件**: F-1, F-2

**実装内容**:
- `src-tauri/src/commands/query_storage_commands.rs` のバリデーション関数修正

**サブタスク**:
- [ ] `validate_save_request()` から `connectionId` の必須チェックを削除（確認）
- [ ] 既存のテストが通ることを確認
- [ ] 動作確認

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-4: フロントエンド修正（SQLエディタストア）

**関連要件**: F-1, F-4

**実装内容**:
- `app/stores/sql-editor.ts` の修正
- `app/api/sql-editor.ts` の修正

**サブタスク**:
- [ ] `loadSavedQueries()` アクションの修正（接続IDチェック削除）
- [ ] `saveQuery()` アクションの修正（`connectionId: null` 設定）
- [ ] `sqlEditorApi.listQueries()` のシグネチャ修正（`connectionId` をオプショナルに）
- [ ] TypeScriptのユニットテスト作成
- [ ] 動作確認

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-5: フロントエンド修正（クエリビルダーストア）

**関連要件**: F-1, F-4

**実装内容**:
- `app/stores/saved-query.ts` の修正

**サブタスク**:
- [ ] `fetchQueries()` アクションの修正（`connectionId` フィールド削除）
- [ ] `saveCurrentQuery()` の動作確認（`connectionId: null` で保存されるか）
- [ ] TypeScriptのユニットテスト確認・修正
- [ ] 動作確認

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-6: UI修正（SQLエディタ保存ダイアログ）

**関連要件**: F-3

**実装内容**:
- `app/components/sql-editor/dialogs/SaveQueryDialog.vue` の修正

**サブタスク**:
- [ ] 接続選択フィールド（UFormField + USelect）を削除
- [ ] 保存ロジックで `connectionId: null` を設定
- [ ] フォームバリデーションの確認
- [ ] UIの動作確認（保存ダイアログが正しく表示されるか）

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-7: UI確認（クエリビルダー保存ダイアログ）

**関連要件**: F-3

**実装内容**:
- `app/components/query-builder/dialog/SaveQueryDialog.vue` の確認

**サブタスク**:
- [ ] 既に接続選択UIがないことを確認
- [ ] 保存ロジックで `connectionId: null` が設定されているか確認
- [ ] 動作確認（正しく保存されるか）

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-8: 統合テスト（SQLエディタ）

**関連要件**: F-1, F-4

**実装内容**:
- SQLエディタでの保存クエリ機能の統合テスト

**テスト観点**:
- [ ] 既存の保存クエリ（`connectionId` が設定されているもの）が表示されるか
- [ ] 新規にクエリを保存すると `connectionId: null` で保存されるか
- [ ] 保存クエリ一覧に全接続のクエリが表示されるか
- [ ] 異なる接続で同じクエリを読み込んで実行できるか
- [ ] フォルダで整理されたクエリが正しく表示されるか

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-9: 統合テスト（クエリビルダー）

**関連要件**: F-1, F-4

**実装内容**:
- クエリビルダーでの保存クエリ機能の統合テスト

**テスト観点**:
- [ ] 既存の保存クエリが表示されるか
- [ ] 新規にクエリを保存すると `connectionId: null` で保存されるか
- [ ] 保存クエリ一覧に全接続のクエリが表示されるか
- [ ] フォルダで整理されたクエリが正しく表示されるか

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-10: 下位互換性テスト

**関連要件**: 非機能要件（下位互換性）

**実装内容**:
- 既存の保存クエリとの互換性確認

**テスト観点**:
- [ ] `connectionId` が設定されている既存クエリが正しく表示されるか
- [ ] 既存クエリを読み込んで実行できるか
- [ ] 既存クエリを編集して再保存できるか
- [ ] データマイグレーションが不要であることを確認

**担当**: -
**期日**: -
**状態**: 未着手

---

### T-11: ドキュメント更新

**関連要件**: 全体

**実装内容**:
- 永続化ドキュメントの更新

**サブタスク**:
- [ ] `docs/steering/features/query-builder.md` の更新
  - クエリ保存機能の説明を接続非依存に修正
  - APIドキュメントの更新
- [ ] `docs/steering/06_ubiquitous_language.md` の確認
  - 用語定義が正しいか確認（必要に応じて更新）
- [ ] コードレビュー

**担当**: -
**期日**: -
**状態**: 未着手

---

## 完了条件

- [ ] 全タスク（T-1 〜 T-11）が完了
- [ ] すべてのユニットテストがパス
- [ ] 統合テストがパス
- [ ] 下位互換性が確認済み
- [ ] 永続化ドキュメントが更新済み
- [ ] コードレビュー完了

---

## 依存関係

```
T-1 (要件定義・設計)
  ├─→ T-2 (バックエンド: SQLエディタ)
  ├─→ T-3 (バックエンド: クエリビルダー)
  ├─→ T-4 (フロントエンド: SQLエディタストア)
  ├─→ T-5 (フロントエンド: クエリビルダーストア)
  └─→ T-6 (UI: SQLエディタダイアログ)
       └─→ T-7 (UI: クエリビルダーダイアログ確認)

T-2, T-3, T-4, T-5, T-6, T-7
  ├─→ T-8 (統合テスト: SQLエディタ)
  ├─→ T-9 (統合テスト: クエリビルダー)
  └─→ T-10 (下位互換性テスト)

T-8, T-9, T-10
  └─→ T-11 (ドキュメント更新)
```

---

## リスク・懸念事項

| リスク | 影響度 | 対応策 |
|--------|--------|--------|
| 既存の保存クエリがある環境での動作不良 | 高 | T-10で十分なテストを実施 |
| 大量のクエリがある場合のパフォーマンス低下 | 中 | パフォーマンステストを実施（100件以上） |
| ユーザーが接続フィルタを期待している可能性 | 低 | フォルダ・検索機能で代替可能 |

---

## メモ・備考

### 実装の優先順位

1. **Phase 1**: バックエンド修正（T-2, T-3）
   - バリデーション修正は影響範囲が小さく、安全に実施可能

2. **Phase 2**: フロントエンド修正（T-4, T-5, T-6, T-7）
   - ストアとUIの修正を並行して実施可能

3. **Phase 3**: テスト（T-8, T-9, T-10）
   - 統合テストで全体の動作を確認

4. **Phase 4**: ドキュメント更新（T-11）
   - 最後にドキュメントを更新

### 推奨される実装順序

```
T-1 → T-2 → T-3 → T-4 → T-6 → T-5 → T-7 → T-8 → T-9 → T-10 → T-11
```

または、バックエンドとフロントエンドを並行して進める場合:

```
T-1 → (T-2, T-3) → (T-4, T-6) → (T-5, T-7) → (T-8, T-9) → T-10 → T-11
```
