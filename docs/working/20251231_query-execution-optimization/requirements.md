# 要件定義書 - クエリ実行の最適化

## 概要

クエリ実行時の復号化処理がボトルネックとなっているため、復号化済みパスワードのセッションキャッシュを実装し、クエリ実行のパフォーマンスを改善する。

## 背景・目的

### 現状の問題

- クエリ実行のたびに接続情報の復号化が行われている（`commands/query.rs:80-83`）
- 接続プールは適切にキャッシュされているが、復号化は毎回実行される
- 例: 同じ接続で100個のクエリを実行する場合、復号化が100回実行される

### 目的

- クエリ実行時の復号化処理を削減し、レスポンスタイムを改善する
- セキュリティを維持しながら、パフォーマンスを向上させる
- ユーザーの操作体験を向上させる

## 要件一覧

### 機能要件

#### F-1: 復号化済みパスワードのキャッシュ機構

- **説明**: 復号化済みパスワードをメモリ上にキャッシュし、同一接続での再利用を可能にする
- **受け入れ条件**:
  - [ ] 接続IDをキーとして復号化済みパスワードをキャッシュできる
  - [ ] キャッシュヒット時は復号化処理をスキップできる
  - [ ] キャッシュミス時は通常通り復号化を実行し、結果をキャッシュする

#### F-2: セッション有効期限の設定

- **説明**: セキュリティを考慮し、キャッシュに有効期限を設定する
- **受け入れ条件**:
  - [ ] キャッシュエントリに有効期限（24時間）を設定できる
  - [ ] 有効期限切れのエントリは自動的に削除される
  - [ ] 有効期限切れ後は再度復号化が実行される

#### F-3: ConnectionServiceとの統合

- **説明**: `ConnectionService::get_by_id()` でキャッシュを利用するよう変更する
- **受け入れ条件**:
  - [ ] `get_by_id()` 呼び出し時にキャッシュをチェックする
  - [ ] キャッシュヒット時は復号化をスキップする
  - [ ] キャッシュミス時は復号化後にキャッシュに保存する

#### F-4: キャッシュ無効化処理

- **説明**: 接続情報更新時やアプリ終了時に適切にキャッシュをクリアする
- **受け入れ条件**:
  - [ ] 接続情報更新時、該当接続のキャッシュをクリアできる
  - [ ] 接続情報削除時、該当接続のキャッシュをクリアできる
  - [ ] アプリ終了時、すべてのキャッシュをクリアできる
  - [ ] マスターパスワード変更時、すべてのキャッシュをクリアできる

### 非機能要件

- **パフォーマンス**:
  - キャッシュヒット時、復号化処理時間（数十ms〜数百ms）を削減できること
  - 同一接続で連続してクエリを実行する場合、体感的な速度向上があること
- **セキュリティ**:
  - メモリに平文パスワードを保持する期間を最小限にすること（有効期限: 24時間）
  - アプリ終了時、メモリ上のパスワードを確実にクリアすること
  - 接続情報更新時、古いパスワードのキャッシュを確実にクリアすること
- **保守性**:
  - キャッシュ機構は独立したモジュールとして実装すること
  - 既存のコードへの影響を最小限にすること

## スコープ

### 対象

- `src-tauri/src/crypto/` 配下に新規キャッシュモジュールを追加
- `src-tauri/src/connection/service.rs` の `get_by_id()` メソッドを変更
- キャッシュ無効化処理の実装（接続更新時、削除時、アプリ終了時）

### 対象外

- クエリ実行以外のパフォーマンス改善
- フロントエンド側の変更（Rustバックエンドのみ）
- データベース構造取得の最適化（Phase 7.1で対応済み）

## 実装対象ファイル（予定）

### 新規作成

- `src-tauri/src/crypto/password_cache.rs` - DecryptedPasswordCache実装

### 変更

- `src-tauri/src/connection/service.rs` - get_by_id()でキャッシュを利用
- `src-tauri/src/connection/mod.rs` - password_cacheモジュールをexport
- `src-tauri/src/main.rs` - アプリ終了時のキャッシュクリア処理
- `src-tauri/src/commands/connection.rs` - 接続更新・削除時のキャッシュクリア

## 依存関係

- Phase 2（クエリ実行・結果表示）が完了していること
- 現在の暗号化システム（CredentialStorage）が正常に動作していること

## 既知の制約

- セキュリティとパフォーマンスのトレードオフ：キャッシュ有効期限を長くするほどパフォーマンスは向上するが、セキュリティリスクが増加する
- メモリ使用量：接続数が多い場合、キャッシュによるメモリ使用量が増加する（ただし、実用上問題になるレベルではない）

## 参考資料

- WBS Phase 7.2: クエリ実行の最適化
- 既存実装:
  - `src-tauri/src/commands/query.rs` - execute_query()の復号化処理
  - `src-tauri/src/connection/service.rs` - ConnectionService::get_by_id()
  - `src-tauri/src/crypto/security_provider/credential_storage.rs` - 復号化処理
  - `src-tauri/src/services/query_executor.rs` - 接続プール管理
