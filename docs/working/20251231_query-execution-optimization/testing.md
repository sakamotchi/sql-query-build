# テスト手順書 - クエリ実行の最適化

## 概要

このドキュメントでは、クエリ実行の最適化（復号化キャッシュ実装）のテスト手順を記載します。
パフォーマンス改善が目的のため、Before/After のパフォーマンス測定を中心に行います。

## 前提条件

- `npm run tauri:dev` でアプリが起動していること
- テスト用のデータベース接続が設定されていること（PostgreSQL/MySQL/SQLite いずれか）
- マスターパスワードまたはその他のセキュリティプロバイダーが設定されていること

## パフォーマンステスト

### ケース 1: キャッシュヒット時のパフォーマンス改善確認

**目的**: 同一接続で複数回クエリを実行した際、2回目以降の復号化処理がスキップされることを確認する

**手順:**

1. アプリを起動し、接続設定を作成する
2. クエリビルダーを開く
3. **1回目のクエリ実行**:
   - 適当なテーブルを選択し、`SELECT` クエリを実行
   - ターミナルログで復号化処理が実行されたことを確認（ログ出力があれば）
   - 実行時間を記録（T1）
4. **2回目のクエリ実行**（5分以内）:
   - 同じ接続で別のクエリを実行
   - ターミナルログで復号化処理がスキップされたことを確認
   - 実行時間を記録（T2）
5. T1 と T2 を比較し、T2 の方が高速であることを確認

**期待結果:**

- 1回目: 復号化処理が実行される
- 2回目: 復号化処理がスキップされる（キャッシュヒット）
- 2回目の実行時間が1回目より短い（復号化処理時間分の改善）

**確認結果:**

- [ ] OK / NG
- Before（1回目）: ____ ms
- After（2回目）: ____ ms
- 改善率: _____%

---

### ケース 2: 連続100回クエリ実行のパフォーマンス計測

**目的**: ベンチマークスクリプトで連続クエリ実行時のパフォーマンスを計測する

**手順:**

1. ベンチマークスクリプトを作成（Rustテストまたは手動スクリプト）
2. 同一接続で100回クエリを実行
3. 各回の実行時間を記録
4. 1回目（キャッシュミス）と2-100回目（キャッシュヒット）の平均実行時間を比較

**期待結果:**

- 1回目: 復号化あり（遅い）
- 2-100回目: 復号化なし（速い）
- 平均実行時間が改善される

**確認結果:**

- [ ] OK / NG
- 1回目（キャッシュミス）: ____ ms
- 2-100回目平均（キャッシュヒット）: ____ ms
- 改善率: _____%

---

## セキュリティテスト

### ケース 3: TTL（24時間）による自動期限切れ

**目的**: キャッシュが24時間後に自動的に期限切れになることを確認する

**手順:**

1. アプリを起動し、クエリを1回実行（キャッシュに保存）
2. 24時間待機（または、テスト用に短いTTLを設定）
3. 再度クエリを実行
4. ターミナルログで復号化処理が再度実行されたことを確認

**期待結果:**

- 24時間後のクエリ実行時、復号化処理が再度実行される
- キャッシュが期限切れで削除されている

**確認結果:**

- [ ] OK / NG
- メモ:

---

### ケース 4: 接続情報更新時のキャッシュクリア

**目的**: 接続情報を更新した際、キャッシュがクリアされることを確認する

**手順:**

1. アプリを起動し、クエリを1回実行（キャッシュに保存）
2. 接続設定画面を開く
3. 接続情報を更新（例: ホスト名を変更）
4. クエリビルダーに戻り、再度クエリを実行
5. ターミナルログで復号化処理が実行されたことを確認（キャッシュクリアされた証拠）

**期待結果:**

- 接続情報更新後のクエリ実行時、復号化処理が実行される
- キャッシュがクリアされている

**確認結果:**

- [ ] OK / NG
- メモ:

---

### ケース 5: 接続情報削除時のキャッシュクリア

**目的**: 接続情報を削除した際、キャッシュがクリアされることを確認する

**手順:**

1. アプリを起動し、クエリを1回実行（キャッシュに保存）
2. 接続設定画面を開く
3. 接続情報を削除
4. （削除後は検証できないため、ログまたはデバッガで確認）

**期待結果:**

- 接続情報削除時、該当接続のキャッシュがクリアされる

**確認結果:**

- [ ] OK / NG
- メモ:

---

### ケース 6: アプリ終了時のキャッシュクリア

**目的**: アプリ終了時、すべてのキャッシュがクリアされることを確認する

**手順:**

1. アプリを起動し、クエリを1回実行（キャッシュに保存）
2. アプリを終了
3. （メモリダンプまたはログで確認、またはコードレビューで確認）

**期待結果:**

- アプリ終了時、すべてのキャッシュがクリアされる

**確認結果:**

- [ ] OK / NG
- メモ:

---

### ケース 7: マスターパスワード変更時のキャッシュクリア

**目的**: マスターパスワード変更時、すべてのキャッシュがクリアされることを確認する

**手順:**

1. アプリを起動し、クエリを1回実行（キャッシュに保存）
2. 設定画面を開く
3. セキュリティプロバイダーを変更（例: MasterPassword → Simple）
4. クエリビルダーに戻り、再度クエリを実行
5. ターミナルログで復号化処理が実行されたことを確認

**期待結果:**

- プロバイダー変更後のクエリ実行時、復号化処理が実行される
- すべてのキャッシュがクリアされている

**確認結果:**

- [ ] OK / NG
- メモ:

---

## 自動テスト（ユニットテスト）

### Rustテスト

```bash
cd src-tauri && cargo test password_cache
```

**テスト項目**:
- `test_cache_hit` - キャッシュヒットのテスト
- `test_cache_miss` - キャッシュミスのテスト
- `test_cache_expiration` - 有効期限切れのテスト
- `test_invalidate` - 特定接続のキャッシュクリア
- `test_clear` - 全キャッシュクリア
- `test_thread_safety` - スレッドセーフティのテスト

**確認結果:**

- [ ] すべてのテストがパス

---

## 統合テスト

### ケース 8: 複数接続での並行クエリ実行

**目的**: 複数の接続で並行してクエリを実行した際、キャッシュが正しく動作することを確認する

**手順:**

1. アプリを起動し、2つの接続を作成（接続A、接続B）
2. 接続Aでクエリを実行（キャッシュに保存）
3. 接続Bでクエリを実行（キャッシュに保存）
4. 再度、接続Aでクエリを実行（接続Aのキャッシュヒット）
5. 再度、接続Bでクエリを実行（接続Bのキャッシュヒット）

**期待結果:**

- 各接続のキャッシュが独立して管理されている
- 接続Aのキャッシュクリアが接続Bに影響しない

**確認結果:**

- [ ] OK / NG
- メモ:

---

### ケース 9: スレッドセーフティの確認

**目的**: マルチスレッド環境でキャッシュが安全に動作することを確認する

**手順:**

1. Rustテストで `test_thread_safety` を実行
2. デッドロックが発生しないことを確認

**期待結果:**

- テストがパスする
- デッドロックが発生しない

**確認結果:**

- [ ] OK / NG

---

## エッジケース

| ケース | 期待動作 | 確認結果 |
|--------|---------|---------|
| パスワードなしの接続（SQLite） | キャッシュを使用しない | [ ] OK / NG |
| 有効期限ちょうど24時間後 | キャッシュが期限切れで削除される | [ ] OK / NG |
| キャッシュヒット中に接続情報更新 | 更新後はキャッシュミス | [ ] OK / NG |
| キャッシュサイズが大きい場合（100接続） | メモリ使用量が許容範囲内 | [ ] OK / NG |

---

## 回帰テスト

既存機能への影響がないことを確認します。

- [ ] 既存の接続機能が正常に動作する
  - [ ] 接続の追加
  - [ ] 接続の編集
  - [ ] 接続の削除
  - [ ] 接続のテスト
- [ ] 既存のクエリビルダーが正常に動作する
  - [ ] クエリ作成
  - [ ] クエリ実行
  - [ ] 結果表示
- [ ] 既存のクエリ保存・履歴機能が正常に動作する
  - [ ] クエリ保存
  - [ ] クエリ読み込み
  - [ ] クエリ履歴
- [ ] 設定画面が正常に動作する
  - [ ] セキュリティプロバイダー変更
  - [ ] テーマ設定

---

## パフォーマンス改善レポート

### Before（キャッシュなし）

- クエリ実行100回の平均時間: ____ ms
- 復号化処理時間（推定）: ____ ms

### After（キャッシュあり）

- 1回目（キャッシュミス）: ____ ms
- 2-100回目平均（キャッシュヒット）: ____ ms
- 改善率: _____%

### まとめ

- キャッシュ導入により、連続クエリ実行時のパフォーマンスが ____% 改善された
- 復号化処理（PBKDF2 + AES-GCM）がボトルネックであることが確認された
- キャッシュによりユーザー体験が向上した

---

## テスト完了基準

- [ ] すべての手動テストケースがパス
- [ ] すべての自動テストがパス
- [ ] パフォーマンス改善が確認できた（改善率 > 10%）
- [ ] セキュリティテストがすべてパス
- [ ] 回帰テストがすべてパス
- [ ] エッジケースがすべて確認済み
