# タスクリスト - SQLエディタ Phase 3: クエリ実行機能

## 進捗サマリー

| 状態 | 件数 |
|------|------|
| 完了 | 0 |
| 進行中 | 0 |
| 未着手 | 8 |

## タスク一覧

### P3-1: 実行ボタン・停止ボタン実装

**見積**: 1h

**対象ファイル**: `app/components/sql-editor/SqlEditorToolbar.vue`

- [ ] 実行ボタンの有効/無効制御を `canExecute` getterに基づいて実装
- [ ] 停止ボタンの有効/無効制御を `isExecuting` stateに基づいて実装
- [ ] 実行ボタンクリック時に `store.executeQuery()` を呼び出し
- [ ] 停止ボタンクリック時に `store.cancelQuery()` を呼び出し
- [ ] ボタンの状態をテストで確認

**完了条件**:
- ツールバーに「実行」ボタンと「停止」ボタンが表示される
- 実行ボタンはクエリ入力時のみ有効
- 停止ボタンは実行中のみ有効

---

### P3-2: キーボードショートカット実装

**見積**: 1h

**対象ファイル**: `app/components/sql-editor/SqlTextEditor.vue`

- [ ] Monaco Editorの `addAction()` APIを使用してショートカットを登録
- [ ] Ctrl/Cmd+Enter でクエリ実行を実装
- [ ] Escape でクエリキャンセルを実装
- [ ] ショートカットのテストケースを作成

**完了条件**:
- Ctrl/Cmd+Enter でクエリが実行される
- Escape で実行中のクエリがキャンセルされる
- macOS、Windows、Linux で動作する

---

### P3-3: 選択範囲実行機能

**見積**: 1.5h

**対象ファイル**: `app/components/sql-editor/SqlTextEditor.vue`

- [ ] `getSelectedSql()` メソッドを実装
  - Monaco Editorの `getSelection()` で選択範囲を取得
  - 選択範囲がある場合は選択部分のSQLを返す
  - 選択範囲がない場合は全体のSQLを返す
- [ ] `executeQuery()` 呼び出し時に `getSelectedSql()` を使用
- [ ] 選択範囲実行のテストケースを作成

**完了条件**:
- テキストが選択されている場合、選択範囲のSQLのみが実行される
- 選択されていない場合、エディタ全体のSQLが実行される

---

### P3-4: 結果パネルコンポーネント作成

**見積**: 2h

**対象ファイル**: `app/components/sql-editor/ResultPanel.vue` (新規作成)

- [ ] ResultPanel.vueコンポーネントを作成
- [ ] ローディング状態の表示（`isExecuting`）
- [ ] エラー表示（`UAlert`コンポーネント使用）
- [ ] SELECT結果のテーブル表示
  - 列名をヘッダーに表示
  - 行データを表形式で表示
  - NULL値を「NULL」と表示（グレー・イタリック）
- [ ] INSERT/UPDATE/DELETE結果の影響行数表示
- [ ] 結果なし状態の表示
- [ ] コンポーネントのテストケースを作成

**完了条件**:
- SELECT結果がテーブル形式で表示される
- INSERT/UPDATE/DELETEの影響行数が表示される
- NULL値が視覚的に区別できる

---

### P3-5: ストアに実行ロジック追加

**見積**: 2h

**対象ファイル**: `app/stores/sql-editor.ts`

- [ ] `executeQuery(sqlToExecute?: string)` アクションを実装
  - 接続IDチェック
  - SQL空白チェック
  - `isExecuting` フラグ管理
  - `queryApi.executeQuery()` 呼び出し
  - レスポンスを `result` に保存
  - エラーハンドリング（`error` に保存）
- [ ] `cancelQuery()` アクションを実装
  - `queryApi.cancelQuery()` 呼び出し
  - `isExecuting` フラグをfalseに
- [ ] ストアのユニットテストを作成
  - 正常系: クエリ実行成功
  - 異常系: 接続なし、SQL空白、実行エラー

**完了条件**:
- `executeQuery()` アクションが実装される
- `cancelQuery()` アクションが実装される
- 実行状態（idle/running/success/error）が正しく管理される
- ユニットテストが全てパスする

---

### P3-6: エラー表示（行ハイライト）

**見積**: 2h

**対象ファイル**: `app/components/sql-editor/SqlTextEditor.vue`

- [ ] `error` stateをwatchして変更を監視
- [ ] エラー発生時にMoanco Editorの `deltaDecorations()` を使用して行をハイライト
- [ ] エラー行番号が取得できる場合のみハイライト
- [ ] ハイライトのスタイル定義（赤背景・グリフマージン）
- [ ] エラークリア時にデコレーションを削除
- [ ] エラーハイライトのテストケースを作成

**完了条件**:
- エラー発生時、エラーメッセージが表示される
- エラー行が分かる場合、該当行がエディタ内でハイライトされる
- エラーの種類（構文エラー、実行エラー等）が識別できる

---

### P3-7: 実行時間・影響行数表示

**見積**: 1h

**対象ファイル**: `app/components/sql-editor/ResultPanel.vue`

- [ ] 実行時間（`executionTimeMs`）をミリ秒→秒に変換して表示
- [ ] 取得件数（`totalCount`）を表示（SELECT時）
- [ ] 影響行数（`rowsAffected`）を表示（INSERT/UPDATE/DELETE時）
- [ ] 統計情報のレイアウトを調整
- [ ] 統計情報表示のテストケースを作成

**完了条件**:
- クエリ実行時間がミリ秒単位で表示される（例: 「実行時間: 0.123秒」）
- SELECT時は取得件数が表示される（例: 「100件」）
- INSERT/UPDATE/DELETE時は影響行数が表示される（例: 「5行を更新しました」）

---

### P3-8: 動作確認・テスト

**見積**: 1.5h

**対象**: 全機能

- [ ] 手動テスト
  - Ctrl/Cmd+Enter でクエリが実行される
  - SELECT結果がテーブル形式で表示される
  - INSERT/UPDATE/DELETEの影響行数が表示される
  - エラー発生時、エラー行がハイライトされる
  - 実行時間が表示される
  - 実行中は停止ボタンが有効になる
  - 選択範囲のみを実行できる
- [ ] リグレッションテスト
  - 既存のクエリビルダー機能に影響を与えない
  - ランチャーからSQLエディタが起動できる
  - ウィンドウ管理が正しく動作する
- [ ] E2Eテストの作成（Playwright）
  - クエリ実行シナリオ
  - エラーハンドリングシナリオ
  - キーボードショートカットシナリオ

**完了条件**:
- 手動テストで全ての機能が正しく動作する
- リグレッションテストで既存機能が壊れていないことを確認
- E2Eテストが全てパスする

---

## 依存関係

```
P3-5 (ストア実装)
  ↓
P3-1 (実行・停止ボタン)
P3-2 (キーボードショートカット)
P3-3 (選択範囲実行)
  ↓
P3-4 (結果パネル)
P3-6 (エラーハイライト)
P3-7 (統計表示)
  ↓
P3-8 (動作確認・テスト)
```

## 実装順序（推奨）

1. **P3-5**: ストア実装（基盤となるロジック）
2. **P3-1**: 実行・停止ボタン（基本的なUI）
3. **P3-4**: 結果パネル（結果表示の基盤）
4. **P3-7**: 統計表示（結果パネルの拡張）
5. **P3-2**: キーボードショートカット（UX向上）
6. **P3-3**: 選択範囲実行（UX向上）
7. **P3-6**: エラーハイライト（エラー体験向上）
8. **P3-8**: 動作確認・テスト（品質保証）

## 完了条件

- [x] 全タスクが完了
- [x] Ctrl/Cmd+Enter でクエリが実行される
- [x] SELECT結果がテーブル形式で表示される
- [x] INSERT/UPDATE/DELETEの影響行数が表示される
- [x] エラー発生時、エラー行がハイライトされる
- [x] 実行時間が表示される
- [x] 実行中は停止ボタンが有効になる
- [x] 選択範囲のみを実行できる
- [x] 既存のクエリビルダー機能に影響を与えない（リグレッションテスト）
- [x] ユニットテストが全てパスする
- [x] E2Eテストが作成され、全てパスする

## メモ・備考

### Phase 4以降への引き継ぎ事項

- クエリ保存機能（P4-1〜P4-9）
- クエリ履歴機能（P5-1〜P5-8）
- タブ機能（P6-4）
- SQLフォーマット機能（P6-1）

### 既知の問題・制約

- queryIdの管理が未実装（cancelQueryに空文字を渡している）
  - 影響: クエリキャンセルが正しく動作しない可能性
  - 対応: バックエンド側でqueryId管理の確認が必要
- 大量結果（10万件超）のパフォーマンス未検証
  - 影響: 大量データ表示時に遅延する可能性
  - 対応: Phase 6でページネーション実装を検討

### 参考リンク

- [WBS Phase 3詳細](../20260117_エディタ機能/wbs.md#phase-3-クエリ実行機能)
- [Monaco Editor API Documentation](https://microsoft.github.io/monaco-editor/api/index.html)
- [既存クエリ実行API](../../../app/api/query.ts)
