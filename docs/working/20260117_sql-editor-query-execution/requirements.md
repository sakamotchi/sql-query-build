# 要件定義書 - SQLエディタ Phase 3: クエリ実行機能

## 概要

SQLエディタに入力したSQLを実行し、結果を表示する機能を実装します。Phase 1（ウィンドウ基盤）、Phase 2（エディタUI基本）に続く第3フェーズとして、SQLエディタを実際に使える状態にします。

## 背景・目的

### 現在の状態（Phase 2完了時点）

- ✅ SQLエディタウィンドウが起動可能
- ✅ Monaco Editorによるテキストエディタが表示される
- ✅ SQLキーワードの構文ハイライトが動作
- ✅ 行番号表示、基本的なテキスト編集（入力、削除、コピペ、Undo/Redo）

### 課題

1. **実行機能の不在**: エディタにSQLを入力できるが、実行する手段がない
2. **結果確認不可**: クエリを実行しても結果を見る場所がない
3. **エラーフィードバック不足**: 構文エラーや実行エラーが分からない
4. **実行状態の管理**: 長時間クエリの停止、実行中の状態表示が必要

### 目的

エディタに入力したSQLを実行し、結果を表形式で表示できるようにする。これにより、SQLエディタが実用可能な最小機能（MVP）として完成する。

## 要件一覧

### 機能要件

#### F-1: 実行ボタン・停止ボタン

- **説明**: ツールバーに実行ボタンと停止ボタンを配置し、クエリ実行と中断を可能にする
- **受け入れ条件**:
  - [x] ツールバーに「実行」ボタンが表示される
  - [x] 実行ボタンクリックでエディタ内のSQLが実行される
  - [x] 実行中は「停止」ボタンが有効になる
  - [x] 停止ボタンクリックでクエリ実行が中断される
  - [x] 実行中は実行ボタンが無効化される

#### F-2: キーボードショートカット

- **説明**: キーボード操作でクエリを実行できるようにする
- **受け入れ条件**:
  - [x] Ctrl+Enter（Windows/Linux）またはCmd+Enter（macOS）でクエリが実行される
  - [x] Escapeキーで実行中のクエリが中断される
  - [x] ショートカットはエディタフォーカス時に動作する

#### F-3: 選択範囲実行機能

- **説明**: エディタ内で選択したSQL部分のみを実行できるようにする
- **受け入れ条件**:
  - [x] テキストが選択されている場合、選択範囲のSQLのみが実行される
  - [x] 選択されていない場合、エディタ全体のSQLが実行される
  - [x] 選択範囲が空の場合、エラーメッセージを表示する

#### F-4: 結果パネルコンポーネント

- **説明**: クエリ実行結果を表示するパネルを作成する
- **受け入れ条件**:
  - [x] SELECT結果がテーブル形式で表示される
  - [x] INSERT/UPDATE/DELETEの影響行数が表示される
  - [x] 列名がヘッダーに表示される
  - [x] 列幅を調整できる
  - [x] NULL値が視覚的に区別できる（「NULL」と表示）
  - [x] 既存の `ResultPanel.vue` または新規コンポーネントで実装

#### F-5: ストアに実行ロジック追加

- **説明**: sql-editorストアにクエリ実行・結果管理のロジックを追加する
- **受け入れ条件**:
  - [x] `executeQuery()` アクションが実装される
  - [x] `cancelQuery()` アクションが実装される
  - [x] 実行状態（idle/running/success/error）を管理する
  - [x] 実行結果（rows, columns, affected_rows）を保持する
  - [x] エラー情報を保持する
  - [x] 既存の `app/api/query.ts` の `executeQuery()` を流用する

#### F-6: エラー表示（行ハイライト）

- **説明**: SQL実行時のエラーを分かりやすく表示する
- **受け入れ条件**:
  - [x] エラー発生時、エラーメッセージが表示される
  - [x] エラー行が分かる場合、該当行がエディタ内でハイライトされる
  - [x] エラーの種類（構文エラー、実行エラー等）が識別できる
  - [x] エラーメッセージは日本語で分かりやすく表示される

#### F-7: 実行時間・影響行数表示

- **説明**: クエリ実行のパフォーマンスと結果情報を表示する
- **受け入れ条件**:
  - [x] クエリ実行時間がミリ秒単位で表示される（例: 「実行時間: 0.123秒」）
  - [x] SELECT時は取得件数が表示される（例: 「100件」）
  - [x] INSERT/UPDATE/DELETE時は影響行数が表示される（例: 「5行を更新しました」）
  - [x] 結果パネル上部に表示される

### 非機能要件

#### NFR-1: パフォーマンス

- **実行開始までの応答時間**: ボタンクリックから実行開始まで500ms以内
- **結果表示**: 1万件までの結果を1秒以内に表示
- **UI応答性**: 実行中もエディタ入力は可能（非ブロッキング）

#### NFR-2: ユーザビリティ

- **実行状態の可視性**: 実行中はローディングインジケーターを表示
- **エラーの分かりやすさ**: エラーメッセージは日本語で、対処方法を示唆する
- **キーボード操作**: マウスなしでも基本操作が可能

#### NFR-3: 保守性

- **既存資産の再利用**: クエリ実行API（`app/api/query.ts`）、結果表示コンポーネントを流用
- **コード品質**: TypeScript型安全性を保つ
- **テスト可能性**: ユニットテストとE2Eテストが書ける構造

## スコープ

### 対象

- クエリ実行ボタン・停止ボタンの実装
- キーボードショートカット（Ctrl/Cmd+Enter、Escape）
- 選択範囲実行機能
- 結果パネルの実装（または既存ResultPanelの統合）
- エラー表示・行ハイライト
- 実行時間・影響行数の表示
- 実行状態管理（idle/running/success/error）

### 対象外（後続フェーズで実装）

- クエリ保存機能（Phase 4）
- クエリ履歴機能（Phase 5）
- 複数タブ機能（Phase 6）
- SQLフォーマット機能（Phase 6）
- オートコンプリート・IntelliSense（将来）
- 複数クエリの順次実行（将来）

## 実装対象ファイル（予定）

### 新規作成

- `app/components/sql-editor/ResultPanel.vue` - 結果パネルコンポーネント（または既存を流用）

### 既存ファイルの更新

- `app/components/sql-editor/SqlEditorToolbar.vue` - 実行・停止ボタンの追加
- `app/components/sql-editor/SqlTextEditor.vue` - キーボードショートカット、選択範囲取得、エラー行ハイライト
- `app/components/sql-editor/SqlEditorLayout.vue` - 結果パネルの配置
- `app/stores/sql-editor.ts` - 実行ロジック、状態管理の追加
- `app/pages/sql-editor.vue` - 結果パネルの統合

### 既存資産の流用

- `app/api/query.ts` - `executeQuery()` をそのまま使用
- `app/components/query-builder/ResultPanel.vue` - 結果表示のベースまたは参考
- `src-tauri/src/commands/query.rs` - バックエンド処理は既存を使用

## 依存関係

### 必須

- Phase 1（ウィンドウ基盤）完了
- Phase 2（エディタUI基本）完了
- 既存のクエリ実行API（`app/api/query.ts`）

### 任意

- なし

## 既知の制約

### 技術的制約

- Monaco Editorの選択範囲API仕様に依存
- クエリ実行はRustバックエンド経由（非同期処理）
- 大量結果（10万件超）はパフォーマンス劣化の可能性

### ビジネス制約

- Phase 3完了後がMVP（最小機能セット）として位置付け
- Phase 4（保存機能）以降は優先度が相対的に低い

### セキュリティ制約

- 既存の環境別安全設定（Phase 3の本番環境確認ダイアログ）を尊重
- 危険なクエリ（UPDATE/DELETE）は確認ダイアログ表示（既存機能）

## 参考資料

### WBS

- [docs/local/20260117_エディタ機能/wbs.md](../wbs.md) - Phase 3の詳細タスク

### 既存ドキュメント

- [docs/steering/01_product_requirements.md](../../steering/01_product_requirements.md) - プロダクト全体要件
- [docs/steering/02_functional_design.md](../../steering/02_functional_design.md) - 機能設計書
- [docs/steering/03_architecture_specifications.md](../../steering/03_architecture_specifications.md) - 技術仕様書
- [docs/steering/features/query-builder.md](../../steering/features/query-builder.md) - クエリビルダー機能仕様

### 関連する既存コンポーネント

- `app/api/query.ts` - クエリ実行API
- `app/components/query-builder/ResultPanel.vue` - 結果表示コンポーネント
- `app/stores/query-builder.ts` - クエリビルダーストア（参考）

## 受け入れ基準

Phase 3完了の定義：

- [x] Ctrl+Enter でクエリが実行される
- [x] SELECT結果がテーブル形式で表示される
- [x] INSERT/UPDATE/DELETEの影響行数が表示される
- [x] エラー発生時、エラー行がハイライトされる
- [x] 実行時間が表示される
- [x] 実行中は停止ボタンが有効になる
- [x] 選択範囲のみを実行できる
- [x] 既存のクエリビルダー機能に影響を与えない（リグレッションテスト）
