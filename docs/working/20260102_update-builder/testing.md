# テスト手順書 - UPDATEビルダー

## 概要

UPDATEビルダーの動作確認手順を記載します。可能な限り手動操作で確認し、操作で確認できない項目のみテストコードで検証します。

## テスト環境

### 前提条件

- アプリケーションが起動している（`npm run tauri:dev`）
- テスト用データベースに接続済み（PostgreSQL/MySQL/SQLiteのいずれか）
- テスト用テーブルが存在する（例: `users`テーブル）

### テストデータ

以下のテーブルとデータを用意してください。

```sql
-- PostgreSQL/MySQL/SQLite共通
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO users (id, name, email, is_active) VALUES
    (1, 'Alice', 'alice@example.com', true),
    (2, 'Bob', 'bob@example.com', true),
    (3, 'Charlie', 'charlie@example.com', false);
```

## 手動テスト

### T-1: 基本UI表示

**目的**: UpdatePanelが正しく表示されることを確認

**手順**:
1. `/mutation-builder` ページに移動
2. 「UPDATE」タブをクリック

**期待結果**:
- [ ] テーブルセレクトボックスが表示される
- [ ] 「SET」「WHERE」タブが表示される
- [ ] 初期状態で「SET」タブが選択されている
- [ ] 下部にSQLプレビューパネルが表示される

---

### T-2: テーブル選択

**目的**: テーブルを選択できることを確認

**手順**:
1. テーブルセレクトボックスをクリック
2. `users`テーブルを選択

**期待結果**:
- [ ] テーブル一覧がドロップダウンで表示される
- [ ] `users`テーブルを選択できる
- [ ] 選択後、テーブル名が表示される

---

### T-3: SET句設定（基本）

**目的**: SET句でカラムと値を設定できることを確認

**手順**:
1. `users`テーブルを選択
2. 「+ カラムを追加」ボタンをクリック
3. `name`カラムを選択
4. 値に「Updated Name」を入力

**期待結果**:
- [ ] カラン追加ドロップダウンが表示される
- [ ] `name`カラムを選択できる
- [ ] `name (VARCHAR)`とカラム情報が表示される
- [ ] テキスト入力フィールドが表示される
- [ ] 「Updated Name」と入力できる
- [ ] SQLプレビューに `UPDATE users SET name = 'Updated Name'` が表示される

---

### T-4: SET句設定（複数カラム）

**目的**: 複数カラムを更新できることを確認

**手順**:
1. T-3の状態から継続
2. 「+ カラムを追加」ボタンをクリック
3. `email`カラムを選択
4. 値に「updated@example.com」を入力

**期待結果**:
- [ ] 2つ目のカラムフィールドが追加される
- [ ] `email (VARCHAR)`とカラム情報が表示される
- [ ] 「updated@example.com」と入力できる
- [ ] SQLプレビューに `UPDATE users SET name = 'Updated Name', email = 'updated@example.com'` が表示される

---

### T-5: SET句設定（NULL値）

**目的**: NULL値を設定できることを確認

**手順**:
1. T-4の状態から継続
2. `email`カラムの「NULL」チェックボックスをチェック

**期待結果**:
- [ ] 入力フィールドが無効化される
- [ ] SQLプレビューに `email = NULL` が表示される

---

### T-6: SET句設定（カラム削除）

**目的**: 追加したカラムを削除できることを確認

**手順**:
1. T-5の状態から継続
2. `email`カラムの削除ボタン（ゴミ箱アイコン）をクリック

**期待結果**:
- [ ] `email`カラムのフィールドが削除される
- [ ] SQLプレビューから `email = NULL` が消える
- [ ] `UPDATE users SET name = 'Updated Name'` のみが表示される

---

### T-7: SET句設定（型に応じた入力コンポーネント）

**目的**: カラムの型に応じた適切な入力コンポーネントが表示されることを確認

**手順**:
1. 「+ カラムを追加」ボタンをクリック
2. `is_active`カラム（BOOLEAN型）を選択

**期待結果**:
- [ ] チェックボックスが表示される
- [ ] 「有効」というラベルが表示される
- [ ] チェック状態を切り替えられる
- [ ] SQLプレビューに `is_active = true` または `is_active = false` が表示される

---

### T-8: WHERE条件設定（基本）

**目的**: WHERE条件を設定できることを確認

**手順**:
1. 「WHERE」タブをクリック
2. 条件を追加: `id` = `1`

**期待結果**:
- [ ] WhereTabが表示される
- [ ] カラムドロップダウンで`id`を選択できる
- [ ] 演算子ドロップダウンで`=`を選択できる
- [ ] 値入力欄に`1`を入力できる
- [ ] SQLプレビューに `WHERE id = 1` が追加される

---

### T-9: WHERE条件設定（複数条件）

**目的**: 複数のWHERE条件を設定できることを確認

**手順**:
1. T-8の状態から継続
2. 「+ 条件を追加」ボタンをクリック
3. `is_active` = `true` を追加
4. 論理演算子を`AND`に設定

**期待結果**:
- [ ] 2つ目の条件フィールドが追加される
- [ ] 論理演算子（AND/OR）を選択できる
- [ ] SQLプレビューに `WHERE id = 1 AND is_active = true` が表示される

---

### T-10: WHERE句なし警告

**目的**: WHERE句がない場合に警告が表示されることを確認

**手順**:
1. 「WHERE」タブで全条件を削除
2. 「SET」タブに戻る

**期待結果**:
- [ ] SQLプレビューパネルに警告バナーが表示される
- [ ] 「⚠️ 警告: WHERE句がありません。全行が更新されます」というメッセージが表示される
- [ ] 警告バナーが赤色またはオレンジ色で目立つ

---

### T-11: SQLプレビュー（リアルタイム更新）

**目的**: SET句やWHERE句の変更がリアルタイムでSQLプレビューに反映されることを確認

**手順**:
1. SET句で`name`の値を「Test1」に変更
2. 値を「Test2」に変更
3. WHERE句で条件を追加・削除

**期待結果**:
- [ ] 入力するたびにSQLプレビューが更新される
- [ ] SET句の変更が即座に反映される
- [ ] WHERE句の変更が即座に反映される

---

### T-12: UPDATE実行（WHERE句あり）

**目的**: WHERE句ありのUPDATE文を実行できることを確認

**手順**:
1. SET句: `name` = `'Updated Alice'`
2. WHERE句: `id` = `1`
3. 「実行」ボタンをクリック

**期待結果**:
- [ ] UPDATE文が実行される
- [ ] 影響行数「1行が更新されました」が表示される
- [ ] エラーが発生しない
- [ ] データベースで確認すると、`id=1`の行の`name`が`'Updated Alice'`に更新されている

---

### T-13: UPDATE実行（WHERE句なし確認ダイアログ）

**目的**: WHERE句なしの場合に確認ダイアログが表示されることを確認

**手順**:
1. SET句: `is_active` = `false`
2. WHERE句: すべて削除
3. 「実行」ボタンをクリック

**期待結果**:
- [ ] DangerousQueryDialogが表示される
- [ ] 「全行が更新されます」という警告メッセージが表示される
- [ ] 「キャンセル」ボタンで実行を中止できる
- [ ] 「実行」ボタンで実行を続行できる

---

### T-14: UPDATE実行（WHERE句なし実行）

**目的**: WHERE句なしのUPDATE文を実行できることを確認

**手順**:
1. T-13の確認ダイアログで「実行」をクリック

**期待結果**:
- [ ] UPDATE文が実行される
- [ ] 影響行数「3行が更新されました」（全行数）が表示される
- [ ] データベースで確認すると、全行の`is_active`が`false`に更新されている

---

### T-15: エラーハンドリング（SQL構文エラー）

**目的**: 不正なSQL文でエラーが表示されることを確認

**備考**: この手順は通常発生しないが、将来的な拡張で手動SQL編集が可能になった場合を想定

**手順**:
1. （手動でSQLを編集できる場合）不正なSQL文を入力
2. 「実行」ボタンをクリック

**期待結果**:
- [ ] エラーメッセージが表示される
- [ ] エラー内容が明確に表示される

---

### T-16: クエリ保存

**目的**: UPDATE文を保存できることを確認

**手順**:
1. SET句とWHERE句を設定
2. 「保存」ボタンをクリック
3. クエリ名「ユーザー更新」を入力
4. 保存

**期待結果**:
- [ ] SaveQueryDialogが表示される
- [ ] クエリ名を入力できる
- [ ] 保存に成功する
- [ ] 保存済みクエリ一覧に「ユーザー更新」が表示される

---

### T-17: クエリ履歴

**目的**: UPDATE実行時に履歴が記録されることを確認

**手順**:
1. UPDATE文を実行（T-12またはT-14）
2. 「履歴」ボタンをクリック

**期待結果**:
- [ ] QueryHistorySlideoverが表示される
- [ ] 実行したUPDATE文が履歴に記録されている
- [ ] 実行時刻、影響行数が表示される

---

### T-18: 保存済みクエリ読み込み

**目的**: 保存済みUPDATE文を読み込んで再編集できることを確認

**手順**:
1. 保存済みクエリ一覧から「ユーザー更新」を選択
2. 読み込み

**期待結果**:
- [ ] SET句とWHERE句が復元される
- [ ] SQLプレビューに保存時のSQL文が表示される
- [ ] 値を編集して再実行できる

---

### T-19: データベース方言対応（PostgreSQL）

**目的**: PostgreSQLで正しいSQL文が生成されることを確認

**手順**:
1. PostgreSQLデータベースに接続
2. UPDATE文を構築・実行

**期待結果**:
- [ ] 識別子がダブルクォート `"users"` でエスケープされる
- [ ] UPDATE文が正しく実行される

---

### T-20: データベース方言対応（MySQL）

**目的**: MySQLで正しいSQL文が生成されることを確認

**手順**:
1. MySQLデータベースに接続
2. UPDATE文を構築・実行

**期待結果**:
- [ ] 識別子がバッククォート `` `users` `` でエスケープされる
- [ ] UPDATE文が正しく実行される

---

### T-21: データベース方言対応（SQLite）

**目的**: SQLiteで正しいSQL文が生成されることを確認

**手順**:
1. SQLiteデータベースに接続
2. UPDATE文を構築・実行

**期待結果**:
- [ ] UPDATE文が正しく実行される

---

## 自動テスト（テストコード）

操作で確認できない項目のみテストコードで検証します。

### T-A1: generate_update_sql関数（Rust）

**目的**: UPDATE SQL生成ロジックが正しく動作することを確認

**テストコード**: `src-tauri/src/query/mutation.rs`

```rust
#[test]
fn test_generate_update_sql_with_where() { /* 実装済み */ }

#[test]
fn test_generate_update_sql_without_where() { /* 実装済み */ }

#[test]
fn test_generate_update_sql_with_null() { /* 実装済み */ }

#[test]
fn test_generate_update_sql_multiple_conditions() { /* 実装済み */ }
```

---

### T-A2: UpdatePanel.vueコンポーネント（TypeScript）

**目的**: UpdatePanelコンポーネントが正しくレンダリングされることを確認

**テストコード**: `tests/components/mutation-builder/UpdatePanel.spec.ts`

```typescript
it('初期状態でSETタブとWHEREタブが表示される', () => { /* 実装済み */ })

it('SETタブが初期表示される', () => { /* 実装済み */ })
```

---

### T-A3: SetTab.vueコンポーネント（TypeScript）

**目的**: SetTabコンポーネントが正しく動作することを確認

**テストコード**: `tests/components/mutation-builder/SetTab.spec.ts`

```typescript
it('カラム追加ボタンが表示される', () => { /* 実装済み */ })

it('カラムが未選択の場合、警告が表示される', () => { /* 実装済み */ })
```

---

## テスト結果記録

| テストID | 実施日 | 結果 | 備考 |
|---------|--------|------|------|
| T-1 | - | 未実施 | - |
| T-2 | - | 未実施 | - |
| T-3 | - | 未実施 | - |
| T-4 | - | 未実施 | - |
| T-5 | - | 未実施 | - |
| T-6 | - | 未実施 | - |
| T-7 | - | 未実施 | - |
| T-8 | - | 未実施 | - |
| T-9 | - | 未実施 | - |
| T-10 | - | 未実施 | - |
| T-11 | - | 未実施 | - |
| T-12 | - | 未実施 | - |
| T-13 | - | 未実施 | - |
| T-14 | - | 未実施 | - |
| T-15 | - | 未実施 | - |
| T-16 | - | 未実施 | - |
| T-17 | - | 未実施 | - |
| T-18 | - | 未実施 | - |
| T-19 | - | 未実施 | - |
| T-20 | - | 未実施 | - |
| T-21 | - | 未実施 | - |
| T-A1 | - | 未実施 | - |
| T-A2 | - | 未実施 | - |
| T-A3 | - | 未実施 | - |

## バグ・課題管理

テスト中に発見されたバグや課題を記録します。

| ID | 発見日 | 内容 | 優先度 | 状態 | 対応内容 |
|----|--------|------|--------|------|---------|
| - | - | - | - | - | - |

## 参考

- [要件定義書](./requirements.md)
- [設計書](./design.md)
- [タスクリスト](./tasklist.md)
