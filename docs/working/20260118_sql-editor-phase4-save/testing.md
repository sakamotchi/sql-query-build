# テスト手順書 - SQLエディタ Phase 4: クエリ保存機能

## 概要

このドキュメントでは、SQLエディタのクエリ保存機能のテスト手順を記載します。
可能な限り手動操作で確認し、操作で確認できない項目のみ自動テストを記載します。

## 前提条件

- `npm run tauri:dev` でアプリが起動していること
- テスト用のデータベース接続が設定されていること（例: SQLite test.db）
- SQLエディタウィンドウが起動できること（Phase 1-3 完了済み）

## 手動テスト

### ケース 1: クエリの保存（F-1）

**目的**: クエリを名前・説明・タグとともに保存できることを確認

**手順**:

1. アプリを起動し、ランチャーからテスト用接続の「エディタ」ボタンをクリック
2. SQLエディタウィンドウが開く
3. エディタに以下のSQLを入力:
   ```sql
   SELECT * FROM users WHERE status = 'active';
   ```
4. ツールバーの「保存」ボタン（💾アイコン）をクリック
   - または Ctrl/Cmd+S を押下
5. 保存ダイアログが表示される
6. 以下を入力:
   - クエリ名: `アクティブユーザー一覧`
   - 説明: `ステータスがアクティブなユーザーを取得`
   - タグ: `ユーザー, レポート`（カンマ区切り）
7. 「保存」ボタンをクリック

**期待結果**:

- [ ] 保存ダイアログが正しく表示される
- [ ] 保存成功のトースト通知が表示される（「クエリを保存しました」）
- [ ] ダイアログが閉じる
- [ ] 左側のサイドパネルに保存したクエリが即座に表示される
- [ ] サイドパネルのクエリアイテムに以下が表示される:
  - クエリ名: `アクティブユーザー一覧`
  - タグ: `ユーザー`, `レポート`
  - 更新日時（相対表示: 「たった今」など）

**確認結果**:

- [ ] OK / NG

---

### ケース 2: クエリ保存時のバリデーション（F-1）

**目的**: クエリ名が空の場合にバリデーションエラーが表示されることを確認

**手順**:

1. SQLエディタでクエリを入力
2. 保存ボタンをクリック
3. 保存ダイアログでクエリ名を**空のまま**にする
4. 「保存」ボタンをクリック

**期待結果**:

- [ ] クエリ名フィールドにバリデーションエラーが表示される
- [ ] ダイアログは閉じない
- [ ] クエリは保存されない

**確認結果**:

- [ ] OK / NG

---

### ケース 3: 保存クエリの一覧表示（F-2）

**目的**: 保存済みクエリが一覧表示されることを確認

**手順**:

1. ケース1で保存したクエリがある状態で、さらに2つクエリを保存:
   - クエリ2: `月次売上レポート` (タグ: `売上, レポート`)
   - クエリ3: `在庫確認` (タグ: `在庫`)
2. 左側のサイドパネル（SavedQueryPanel）を確認

**期待結果**:

- [ ] サイドパネルに3件のクエリが表示される
- [ ] 一覧は更新日時の降順（新しい順）で表示される
- [ ] 各クエリには以下が表示される:
  - クエリ名
  - タグ（複数ある場合はすべて表示）
  - 更新日時
- [ ] クエリ名が長い場合は省略表示される（text-overflow: ellipsis）

**確認結果**:

- [ ] OK / NG

---

### ケース 4: 保存クエリの検索（F-3）

**目的**: 検索ボックスでクエリを絞り込めることを確認

**手順**:

1. ケース3で3件のクエリが保存されている状態
2. サイドパネル上部の検索ボックスに `売上` と入力

**期待結果**:

- [ ] リアルタイムで一覧が絞り込まれる
- [ ] 「月次売上レポート」のみが表示される
- [ ] 他の2件は表示されない

**追加確認**:

3. 検索ボックスを空にする

**期待結果**:

- [ ] 全件表示に戻る（3件すべて表示される）

**確認結果**:

- [ ] OK / NG

---

### ケース 5: タグでのフィルタリング（F-3）

**目的**: タグをクリックしてフィルタリングできることを確認

**手順**:

1. ケース3で3件のクエリが保存されている状態
2. いずれかのクエリの「レポート」タグをクリック

**期待結果**:

- [ ] 「レポート」タグを持つクエリのみが表示される
  - 「アクティブユーザー一覧」
  - 「月次売上レポート」
- [ ] 「在庫確認」は表示されない

**確認結果**:

- [ ] OK / NG

---

### ケース 6: 保存クエリの読み込み（F-4）

**目的**: 保存済みクエリをクリックしてエディタに読み込めることを確認

**手順**:

1. サイドパネルで「月次売上レポート」をクリック

**期待結果**:

- [ ] エディタに保存されたSQLが読み込まれる
- [ ] ツールバーまたはエディタ上部に読み込んだクエリの情報が表示される:
  - クエリ名: `月次売上レポート`
  - タグ: `売上`, `レポート`
- [ ] `isDirty` フラグがfalseになる（未編集状態）

**確認結果**:

- [ ] OK / NG

---

### ケース 7: 未保存変更がある場合の警告（F-4）

**目的**: エディタに未保存の変更がある状態で別のクエリを読み込もうとすると警告が表示されることを確認

**手順**:

1. エディタに新しいSQLを入力（例: `SELECT * FROM orders;`）
2. まだ保存せずに、サイドパネルで別のクエリ（例: `在庫確認`）をクリック

**期待結果**:

- [ ] 警告ダイアログが表示される
- [ ] ダイアログには「未保存の変更があります。破棄しますか?」のようなメッセージが表示される
- [ ] 「破棄」ボタンと「キャンセル」ボタンがある

**追加確認**:

3. 「破棄」をクリック

**期待結果**:

- [ ] エディタに「在庫確認」のSQLが読み込まれる

4. 再度、未保存変更を作成し、別のクエリをクリック
5. 今度は「キャンセル」をクリック

**期待結果**:

- [ ] エディタの内容は変更されない（未保存の変更が維持される）

**確認結果**:

- [ ] OK / NG

---

### ケース 8: 保存クエリの編集（F-5）

**目的**: 保存済みクエリの名前・説明・タグを編集できることを確認

**手順**:

1. サイドパネルで「アクティブユーザー一覧」にマウスホバー
2. 「編集」ボタン（鉛筆アイコン）が表示される
3. 「編集」ボタンをクリック
4. 編集ダイアログが表示される
5. 以下を変更:
   - 説明: `アクティブなユーザーの一覧を取得するクエリ`（説明を詳細化）
   - タグ: `ユーザー, レポート, 管理者`（「管理者」を追加）
6. 「保存」ボタンをクリック

**期待結果**:

- [ ] 編集ダイアログが正しく表示される
- [ ] SQL本文は表示されているが、編集不可（読み取り専用またはグレーアウト）
- [ ] 更新成功のトースト通知が表示される（「クエリを更新しました」）
- [ ] ダイアログが閉じる
- [ ] サイドパネルで「アクティブユーザー一覧」のタグが更新される（「管理者」タグが追加）

**確認結果**:

- [ ] OK / NG

---

### ケース 9: 保存クエリの削除（F-6）

**目的**: 保存済みクエリを削除できることを確認

**手順**:

1. サイドパネルで「在庫確認」にマウスホバー
2. 「削除」ボタン（ゴミ箱アイコン、赤色）が表示される
3. 「削除」ボタンをクリック
4. 確認ダイアログが表示される
5. ダイアログには削除対象のクエリ名（「在庫確認」）が表示される
6. 「削除」ボタンをクリック

**期待結果**:

- [ ] 確認ダイアログが表示される
- [ ] ダイアログには「このクエリを削除しますか？この操作は取り消せません」のような警告メッセージが表示される
- [ ] 削除成功のトースト通知が表示される（「クエリを削除しました」）
- [ ] サイドパネルから「在庫確認」が即座に削除される
- [ ] 一覧には残り2件のクエリが表示される

**追加確認**:

7. 別のクエリで削除操作を開始し、確認ダイアログで「キャンセル」をクリック

**期待結果**:

- [ ] クエリは削除されない

**確認結果**:

- [ ] OK / NG

---

### ケース 10: 保存クエリの直接実行（F-7）

**目的**: 保存済みクエリを読み込まずに直接実行できることを確認

**手順**:

1. エディタに現在のSQLがある状態（例: `SELECT * FROM products;`）
2. サイドパネルで「月次売上レポート」にマウスホバー
3. 「実行」ボタン（再生アイコン）が表示される
4. 「実行」ボタンをクリック

**期待結果**:

- [ ] エディタの内容は変更されない（`SELECT * FROM products;` のまま）
- [ ] 「月次売上レポート」のSQLが実行される
- [ ] 結果パネルに実行結果が表示される
- [ ] 実行時間と件数が表示される

**確認結果**:

- [ ] OK / NG

---

### ケース 11: アプリ再起動後の永続化確認（NFR-2）

**目的**: アプリを再起動しても保存クエリが残ることを確認

**手順**:

1. 現在保存されているクエリを確認（例: 2件）
2. アプリを終了する（SQLエディタウィンドウを閉じる）
3. アプリを再起動し、同じ接続でSQLエディタを開く
4. サイドパネルを確認

**期待結果**:

- [ ] 再起動前に保存したクエリがすべて表示される
- [ ] クエリ名、タグ、更新日時が正しく復元されている
- [ ] クエリをクリックしてエディタに読み込み、SQL本文が正しいことを確認

**確認結果**:

- [ ] OK / NG

---

### ケース 12: 複数接続のクエリ管理（NFR-2）

**目的**: 接続ごとに保存クエリが分離されることを確認

**手順**:

1. 接続A（例: test.db）で SQLエディタを開き、クエリを保存
2. 接続B（例: production.db）で SQLエディタを開く
3. サイドパネルを確認

**期待結果**:

- [ ] 接続Bのサイドパネルには接続Aで保存したクエリは表示されない
- [ ] 接続Bで新しくクエリを保存
- [ ] 接続Aに戻ると、接続Aのクエリのみが表示される

**確認結果**:

- [ ] OK / NG

---

### ケース 13: 検索対象の確認（F-3）

**目的**: 検索がクエリ名、説明、タグ、SQL本文すべてを対象にすることを確認

**手順**:

1. 以下のクエリを保存:
   - クエリ名: `Test1`、説明: `これは特殊なクエリです`、SQL: `SELECT * FROM users`
   - クエリ名: `Test2`、説明: `通常クエリ`、SQL: `SELECT * FROM orders WHERE status = '特殊'`
2. 検索ボックスに `特殊` と入力

**期待結果**:

- [ ] 2件とも表示される（説明に「特殊」が含まれるTest1、SQL本文に「特殊」が含まれるTest2）

**確認結果**:

- [ ] OK / NG

---

## 自動テスト

### ユニットテスト（フロントエンド）

```bash
npm run test:run
```

**確認項目**:

- [ ] `app/stores/sql-editor.ts` のユニットテストがすべてパス
  - [ ] `loadSavedQueries()` テスト
  - [ ] `saveCurrentQuery()` テスト
  - [ ] `loadSavedQuery()` テスト
  - [ ] `deleteSavedQuery()` テスト

### Rustテスト（バックエンド）

```bash
cd src-tauri && cargo test
```

**確認項目**:

- [ ] `src-tauri/src/services/query_storage.rs` のテストがすべてパス
  - [ ] `test_save_and_load_query` - 保存と読み込み
  - [ ] `test_list_queries` - 一覧取得
  - [ ] `test_delete_query` - 削除
  - [ ] `test_search_queries` - 検索

### 型チェック

```bash
npm run typecheck
```

**確認項目**:

- [ ] TypeScriptの型エラーがないこと

---

## エッジケース

| ケース | 期待動作 | 確認結果 |
|--------|---------|---------|
| クエリ名が100文字を超える | 入力が100文字で制限される | [ ] OK / NG |
| 説明が500文字を超える | 入力が500文字で制限される | [ ] OK / NG |
| タグに特殊文字が含まれる（例: `#レポート`） | 正常に保存・表示される | [ ] OK / NG |
| タグが空の配列 | 正常に保存され、タグなしで表示される | [ ] OK / NG |
| SQL本文が空 | 保存できる（バリデーションなし） | [ ] OK / NG |
| 検索ボックスに日本語を入力 | 正常に絞り込まれる | [ ] OK / NG |
| 保存クエリが0件の場合 | 「保存されたクエリがありません」と表示される | [ ] OK / NG |
| 保存クエリが100件の場合 | パフォーマンス低下なく一覧表示される（1秒以内） | [ ] OK / NG |
| 同じ名前のクエリを複数保存 | 許容される（Phase 4ではユニーク制約なし） | [ ] OK / NG |
| ファイルストレージのパーミッション | 保存ファイルが0600（所有者のみR/W）になる | [ ] OK / NG |

---

## パフォーマンステスト

### NFR-1: パフォーマンス要件

| 項目 | 目標値 | 測定方法 | 測定結果 |
|------|--------|---------|---------|
| 保存クエリの一覧表示 | 100件まで1秒以内 | 100件のクエリを保存し、一覧表示時間を測定 | [ ] OK / NG: ___ms |
| 検索レスポンス | 入力後200ms以内に絞り込み | 検索ボックスに入力し、絞り込み完了までの時間を測定 | [ ] OK / NG: ___ms |
| 保存/更新/削除操作 | 500ms以内に完了 | 保存ボタンクリックからトースト表示までの時間を測定 | [ ] OK / NG: ___ms |

---

## 回帰テスト

既存機能への影響がないことを確認します。

### 既存機能の動作確認

- [ ] ランチャーからSQLエディタが起動できる（Phase 1）
- [ ] SQLエディタでクエリを入力・編集できる（Phase 2）
- [ ] Ctrl+Enter でクエリを実行できる（Phase 3）
- [ ] 実行結果がテーブル形式で表示される（Phase 3）
- [ ] エラー発生時、エラー行がハイライトされる（Phase 3）
- [ ] 他の接続（クエリビルダー、ミューテーションビルダー等）が正常に動作する
- [ ] 設定画面が正常に動作する

---

## テスト完了チェックリスト

- [ ] すべての手動テストケース（ケース1〜13）が OK
- [ ] すべてのエッジケースが OK
- [ ] パフォーマンステストが目標値を満たしている
- [ ] 自動テスト（ユニットテスト、Rustテスト）がすべてパス
- [ ] 型チェックがパス
- [ ] 回帰テストがすべてパス
- [ ] 要件定義書の受け入れ条件（F-1〜F-7）がすべて満たされている

---

## 備考

### テスト環境

- OS: macOS / Windows / Linux
- Nuxt: 4.2.2
- Tauri: 2.x
- データベース: SQLite test.db（テスト用）

### テストデータ

テスト用のSQLiteデータベース（test.db）に以下のテーブルを作成しておくこと:

```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY,
  name TEXT,
  email TEXT,
  status TEXT
);

CREATE TABLE orders (
  id INTEGER PRIMARY KEY,
  user_id INTEGER,
  amount REAL,
  status TEXT
);

CREATE TABLE products (
  id INTEGER PRIMARY KEY,
  name TEXT,
  price REAL,
  stock INTEGER
);

-- サンプルデータ
INSERT INTO users (name, email, status) VALUES
  ('Alice', 'alice@example.com', 'active'),
  ('Bob', 'bob@example.com', 'inactive');

INSERT INTO orders (user_id, amount, status) VALUES
  (1, 1000, '完了'),
  (2, 2000, '特殊');

INSERT INTO products (name, price, stock) VALUES
  ('Product A', 100, 50),
  ('Product B', 200, 30);
```

### 既知の問題・制約

- Phase 4では保存クエリ数の上限は設けない（パフォーマンステストで100件程度を確認）
- クエリ名の重複チェックは実装しない（将来のPhaseで対応）
- 削除したクエリの復元機能はない（ゴミ箱機能は将来対応）
