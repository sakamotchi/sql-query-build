# 要件定義書 - SQLエディタ Phase 4: クエリ保存機能

## 概要

SQLエディタで作成したクエリを名前をつけて保存し、後から再利用できるようにする。よく使うクエリの管理・検索・実行を効率化することで、日常的なデータベース作業の生産性を向上させる。

## 背景・目的

### 現在の状態（Phase 3完了時点）

- SQLエディタでクエリを記述・実行できる
- 実行結果がテーブル形式で表示される
- 構文ハイライトと行番号が利用可能

### 課題

1. **再利用性の欠如**: 一度作成したクエリを再利用するには、手動でコピペまたは再入力が必要
2. **管理の困難さ**: よく使うクエリを効率的に管理する手段がない
3. **検索不能**: 過去に作成したクエリを見つける方法がない
4. **チーム共有への布石**: 将来的なクエリ共有機能の基盤が必要

### 目的

- クエリに名前・説明・タグをつけて永続化する
- 保存済みクエリを一覧・検索できるようにする
- ワンクリックで保存済みクエリをエディタに読み込み・実行できるようにする
- アプリケーション再起動後も保存クエリが維持される

## 要件一覧

### 機能要件

#### F-1: クエリの保存

- **説明**: 現在エディタに入力されているSQLクエリを名前・説明・タグとともに保存する
- **受け入れ条件**:
  - [ ] ツールバーの「保存」ボタンまたはCtrl/Cmd+Sで保存ダイアログが開く
  - [ ] 保存ダイアログで以下を入力できる:
    - [ ] クエリ名（必須、最大100文字）
    - [ ] 説明（任意、最大500文字）
    - [ ] タグ（任意、複数選択可能、カンマ区切り入力）
  - [ ] 保存時にバリデーションエラーがあれば分かりやすく表示される
  - [ ] 保存成功時にトースト通知が表示される
  - [ ] 保存されたクエリが即座にサイドパネルの一覧に反映される

#### F-2: 保存クエリの一覧表示

- **説明**: 保存済みクエリをサイドパネルに一覧表示する
- **受け入れ条件**:
  - [ ] SQLエディタの左側にサイドパネルが表示される
  - [ ] サイドパネルには現在の接続に紐づく保存済みクエリが一覧表示される
  - [ ] 各クエリには以下が表示される:
    - [ ] クエリ名
    - [ ] タグ（あれば）
    - [ ] 更新日時
  - [ ] クエリ名が長い場合は省略表示される
  - [ ] 一覧は更新日時の降順（新しい順）で表示される

#### F-3: 保存クエリの検索・フィルタリング

- **説明**: 保存済みクエリを名前・タグ・SQL本文で検索する
- **受け入れ条件**:
  - [ ] サイドパネルの上部に検索ボックスが表示される
  - [ ] 検索ボックスに入力すると、リアルタイムで一覧が絞り込まれる
  - [ ] 検索対象はクエリ名・説明・タグ・SQL本文（部分一致）
  - [ ] 検索ワードをクリアすると全件表示に戻る
  - [ ] タグでのフィルタリングも可能（タグをクリックでフィルタ）

#### F-4: 保存クエリの読み込み

- **説明**: 保存済みクエリをクリックしてエディタに読み込む
- **受け入れ条件**:
  - [ ] 一覧のクエリをクリックすると、エディタにSQLが読み込まれる
  - [ ] 現在エディタに未保存の変更がある場合、警告ダイアログが表示される
  - [ ] 読み込み後、保存クエリの情報（名前・説明・タグ）が表示される
  - [ ] 読み込んだクエリを編集しても、元の保存クエリは変更されない（新規保存が必要）

#### F-5: 保存クエリの編集

- **説明**: 保存済みクエリの名前・説明・タグを変更する
- **受け入れ条件**:
  - [ ] 一覧のクエリにホバーすると「編集」ボタンが表示される
  - [ ] 編集ボタンをクリックすると編集ダイアログが開く
  - [ ] 編集ダイアログでは名前・説明・タグを変更できる（SQL本文は変更不可）
  - [ ] 保存ボタンで変更を確定する
  - [ ] キャンセルボタンで変更を破棄する
  - [ ] 更新成功時にトースト通知が表示される

#### F-6: 保存クエリの削除

- **説明**: 保存済みクエリを削除する
- **受け入れ条件**:
  - [ ] 一覧のクエリにホバーすると「削除」ボタンが表示される
  - [ ] 削除ボタンをクリックすると確認ダイアログが表示される
  - [ ] 確認ダイアログには削除対象のクエリ名が表示される
  - [ ] 確定すると即座に一覧から削除される
  - [ ] 削除成功時にトースト通知が表示される
  - [ ] 削除は取り消し不可（確認ダイアログで注意喚起）

#### F-7: 保存クエリの直接実行（推奨機能）

- **説明**: 保存済みクエリを読み込まずに直接実行する
- **受け入れ条件**:
  - [ ] 一覧のクエリにホバーすると「実行」ボタンが表示される
  - [ ] 実行ボタンをクリックすると、エディタの内容を変更せずにクエリが実行される
  - [ ] 実行結果は結果パネルに表示される
  - [ ] 実行履歴にも記録される

### 非機能要件

#### NFR-1: パフォーマンス

- 保存クエリの一覧表示: 100件まで1秒以内
- 検索レスポンス: 入力後200ms以内に絞り込み結果を表示
- 保存/更新/削除操作: 500ms以内に完了

#### NFR-2: データ永続化

- 保存場所: `{data_dir}/queries/saved_editor/`
  - クエリビルダー用（`saved_builder/`）とは別ディレクトリに分離
  - 各クエリごとに2ファイルで保存:
    - `{query_id}.json` - メタデータ（名前、説明、タグ、日時等）
    - `{query_id}.sql` - SQL本文（純粋なSQLファイル）
- フォーマット:
  - JSON: pretty-print（人間が読める形式）
  - SQL: プレーンテキスト（改行そのまま、シンタックスハイライト可能）
- アプリケーション再起動後も保存クエリが維持される
- メリット:
  - SQLが外部エディタで直接編集可能
  - Gitで差分が見やすい
  - SQLフォーマッターやリンターが使える

#### NFR-3: セキュリティ

- 保存クエリファイルのパーミッション: 0600（所有者のみ読み書き可能）
- SQLインジェクション対策: 既存のクエリ実行機能と同等のエスケープ処理

#### NFR-4: 保守性

- 既存のストレージパターン（接続情報保存）と統一されたディレクトリ構造
- TypeScript型定義を厳密に定義
- RustとTypeScriptで同一のデータモデルを共有

## スコープ

### 対象

- クエリの保存・読み込み・編集・削除
- クエリの検索・フィルタリング
- 接続ごとのクエリ管理
- ファイルシステムへの永続化

### 対象外（将来検討）

- フォルダ・カテゴリによる階層管理（Phase 4ではタグのみ）
- クエリのエクスポート・インポート機能（JSON一括出力/入力）
- チーム間でのクエリ共有機能
- クエリのバージョン管理（変更履歴）
- クエリのお気に入り機能
- クエリの実行回数・最終実行日時の記録

## 実装対象ファイル（予定）

### バックエンド（Rust）

- `src-tauri/src/models/saved_query.rs` - 保存クエリモデル定義
- `src-tauri/src/services/saved_query.rs` - 保存クエリ管理サービス（CRUD操作）
- `src-tauri/src/commands/sql_editor.rs` - Tauriコマンド（`save_query`, `get_queries`, `update_query`, `delete_query`）
- `src-tauri/src/lib.rs` - コマンド登録

### フロントエンド（Vue/Nuxt）

- `app/api/sql-editor.ts` - SQLエディタAPI（Tauriコマンドのラッパー）
- `app/types/sql-editor.ts` - 型定義（`SavedQuery`インターフェース）
- `app/stores/sql-editor.ts` - SQLエディタストア（保存クエリ管理ロジック）
- `app/components/sql-editor/SavedQueryPanel.vue` - 保存クエリパネル（サイドパネル）
- `app/components/sql-editor/SaveQueryDialog.vue` - 保存ダイアログ
- `app/components/sql-editor/SqlEditorToolbar.vue` - ツールバー更新（保存ボタン追加）
- `app/components/sql-editor/SqlEditorLayout.vue` - レイアウト更新（サイドパネル追加）

### テスト

- `app/tests/stores/sql-editor.test.ts` - ストアのユニットテスト
- `src-tauri/src/services/saved_query.rs` 内のテスト関数

## 依存関係

### 前提条件

- Phase 3（クエリ実行機能）が完了していること
- SQLエディタウィンドウが起動できること
- 既存のクエリ実行APIが動作していること

### 既存コンポーネントの利用

- `app/api/query.ts` - クエリ実行APIは既存を流用（保存クエリの直接実行に使用）
- `app/components/query-builder/ResultPanel.vue` - 結果表示は既存を流用
- 既存のストレージパターン（`~/.sql-query-builder/` 配下にJSON保存）

### 外部ライブラリ

- Rust側:
  - `serde_json` - JSON シリアライズ/デシリアライズ
  - `chrono` - 日時処理（createdAt, updatedAt）
  - `uuid` - クエリIDの生成
- フロントエンド側:
  - Nuxt UI v4コンポーネント（UButton, UFormField, UInput, UTextarea, UDialog等）

## データモデル

### SavedQuery

```typescript
interface SavedQuery {
  id: string                 // UUID
  connectionId: string       // 接続ID
  name: string              // クエリ名（必須、最大100文字）
  description?: string      // 説明（任意、最大500文字）
  sql: string               // SQL本文
  tags: string[]            // タグ（配列）
  createdAt: string         // 作成日時（ISO 8601形式）
  updatedAt: string         // 更新日時（ISO 8601形式）
}
```

### Rust側の型定義

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SavedQuery {
    pub id: String,
    pub connection_id: String,
    pub name: String,
    pub description: Option<String>,
    pub sql: String,
    pub tags: Vec<String>,
    pub created_at: String,
    pub updated_at: String,
}
```

## 既知の制約

- Phase 4では単一接続に対する保存クエリのみを扱う（複数接続間でのクエリ共有は対象外）
- タグは自由入力（プリセットなし）
- 保存クエリ数の上限は設けない（ただし、パフォーマンスを考慮して100件程度を推奨）
- 検索はクライアントサイドで実施（サーバーサイド検索は対象外）

## 参考資料

- [WBS全体](../../local/20260117_エディタ機能/wbs.md) - Phase 4の位置づけと依存関係
- [全体要件定義書](../../local/20260117_エディタ機能/requirements.md) - FR-4章（クエリ保存・管理機能）
- [技術仕様書](../../steering/03_architecture_specifications.md) - Tauri/Rust/Nuxt技術スタック
- [リポジトリ構造定義書](../../steering/04_repository_structure.md) - ファイル配置規則
- [開発ガイドライン](../../steering/05_development_guidelines.md) - コーディング規約
- [ユビキタス言語定義書](../../steering/06_ubiquitous_language.md) - プロジェクト用語
