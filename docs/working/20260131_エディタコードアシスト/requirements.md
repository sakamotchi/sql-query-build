# 要件定義書：SQLエディタコードアシスト機能

## 1. 概要

SQLエディタにコードアシスト（オートコンプリート/IntelliSense）機能を実装し、SQL構文の入力支援とデータベーススキーマ情報に基づく補完を提供する。

## 2. 目的

- SQL入力の効率化と正確性向上
- テーブル名・カラム名の入力ミス削減
- データベーススキーマの参照を容易にする
- 開発者体験（DX）の向上

## 3. 要件

### 3.1 機能要件

#### FR-1: SQL構文の補完
- **優先度**: 高
- **内容**: SQLキーワードの自動補完
  - SELECT, FROM, WHERE, JOIN, GROUP BY, ORDER BY等の予約語
  - INSERT, UPDATE, DELETE, CREATE等のDML/DDL
  - リアルタイムで入力中にサジェスト表示

#### FR-2: SQL関数の補完
- **優先度**: 高
- **内容**: SQL標準関数とDBMS固有関数の補完
  - 集約関数: COUNT, SUM, AVG, MAX, MIN
  - 文字列関数: CONCAT, SUBSTRING, UPPER, LOWER
  - 日付関数: NOW, DATE, TIMESTAMP
  - 数値関数: ROUND, FLOOR, CEIL
  - PostgreSQL固有: array_agg, jsonb_agg等

#### FR-3: テーブル名の補完
- **優先度**: 高
- **内容**: 接続中のデータベースのテーブル名を補完
  - スキーマ名を含む完全修飾名に対応（例: `public.users`）
  - テーブルのコメント情報を表示（存在する場合）
  - システムテーブルは表示するが優先度を下げる

#### FR-4: カラム名の補完
- **優先度**: 高
- **内容**: テーブルのカラム名を補完
  - コンテキストに応じたカラム候補の表示
  - カラムの型情報を表示（例: `user_id (integer)`）
  - カラムのコメント情報を表示（存在する場合）
  - PRIMARY KEY, FOREIGN KEYなどの制約情報を表示

#### FR-5: スキーマ情報のキャッシュ
- **優先度**: 高
- **内容**: 接続時に一度取得したスキーマ情報をキャッシュ
  - 既存の`database-structure` storeを活用
  - 接続切り替え時に対応するキャッシュを使用
  - 手動リフレッシュ機能でキャッシュ更新

#### FR-6: リアルタイム表示
- **優先度**: 高
- **内容**: 入力中に自動でサジェストを表示
  - 文字入力に応じてリアルタイムでフィルタリング
  - Ctrl+Space（Windows/Linux）、Cmd+Space（Mac）で手動トリガーも可能
  - Escapeキーでサジェストを閉じる

### 3.2 非機能要件

#### NFR-1: パフォーマンス
- サジェスト表示のレスポンス時間: 100ms以内
- 大規模スキーマ（1000テーブル以上）でも快適に動作
- 入力のもたつきがないこと

#### NFR-2: ユーザビリティ
- VSCodeと同様の操作感
- キーボードのみで補完候補の選択・確定が可能
- サジェストウィンドウの視認性が高い

#### NFR-3: 拡張性
- 将来的なカスタムスニペット追加に対応可能な設計
- DBMS別の関数リスト追加が容易
- ユーザー定義関数の補完にも対応可能

### 3.3 制約事項

#### C-1: 既存機能への影響
- 既存のエディタ機能（SQL整形、クエリ実行等）に影響を与えない
- 既存のキーバインド（Ctrl+Enter, Ctrl+S等）と競合しない

#### C-2: 技術的制約
- Monaco Editor v0.45.0の機能範囲内で実装
- 既存のスキーマキャッシュ機構を活用
- フロントエンドのみで完結（バックエンド変更は最小限）

#### C-3: 対応範囲
- 初期バージョンではPostgreSQL/MySQL/SQLiteの共通機能のみ
- 複雑なSQL（サブクエリ、CTE等）のコンテキスト解析は将来対応

## 4. ユースケース

### UC-1: テーブル名の補完
**前提条件**: データベースに接続済み、スキーマ情報がキャッシュ済み
**トリガー**: ユーザーがSQLエディタで "FROM u" と入力
**フロー**:
1. ユーザーが "FROM u" と入力
2. システムが "u" で始まるテーブル名をサジェスト表示
3. ユーザーが候補から "users" を選択
4. "users" がエディタに挿入される

### UC-2: カラム名の補完
**前提条件**: データベースに接続済み、スキーマ情報がキャッシュ済み
**トリガー**: ユーザーがSQLエディタで "SELECT user_" と入力
**フロー**:
1. ユーザーが "SELECT user_" と入力
2. システムが "user_" で始まるカラム名をサジェスト表示
3. サジェストに型情報も表示（例: `user_id (integer, PK)`）
4. ユーザーが候補から "user_id" を選択
5. "user_id" がエディタに挿入される

### UC-3: SQL関数の補完
**前提条件**: SQLエディタが開いている
**トリガー**: ユーザーがSQLエディタで "SELECT COU" と入力
**フロー**:
1. ユーザーが "SELECT COU" と入力
2. システムが "COU" で始まるSQL関数をサジェスト表示（COUNT等）
3. ユーザーが候補から "COUNT" を選択
4. "COUNT()" がエディタに挿入され、カーソルが括弧内に移動

### UC-4: 接続切り替え時のスキーマ更新
**前提条件**: 複数のデータベース接続が登録済み
**トリガー**: ユーザーが別の接続に切り替え
**フロー**:
1. ユーザーが接続Aから接続Bに切り替え
2. システムが接続Bのスキーマキャッシュを確認
3. キャッシュがあれば即座に使用、なければバックグラウンドで取得
4. 補完候補が新しい接続のスキーマ情報に更新される

## 5. 成功基準

### 定量的基準
- サジェスト表示レスポンス時間: 100ms以内（95パーセンタイル）
- テーブル数1000件のスキーマで快適に動作
- キーワード補完候補数: 100個以上

### 定性的基準
- ユーザーテストでの満足度: 80%以上
- 既存機能への影響なし（回帰テストクリア）
- VSCodeユーザーが違和感なく使える操作感

## 6. 除外事項

以下は今回の実装範囲外とする：

- カスタムスニペット機能（将来対応予定）
- SQL文法チェック・Linter機能
- サブクエリ・CTE内部のコンテキスト解析
- テーブル結合時の高度なカラム推論
- ユーザー定義関数の自動検出
- クエリ履歴からの補完候補生成

## 7. 関連ドキュメント

- [設計書](./design.md)
- [タスクリスト](./tasklist.md)
- [テスト手順書](./testing.md)
- [機能設計書](../../steering/02_functional_design.md)
- [技術仕様書](../../steering/03_architecture_specifications.md)
