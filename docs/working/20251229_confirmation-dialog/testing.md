# テスト手順書: 確認ダイアログ

**作成日**: 2025年12月29日
**WBS参照**: Phase 3.2 確認ダイアログ

---

## 1. テスト環境

- **アプリ起動**: `npm run tauri:dev`
- **データベース接続**: PostgreSQL/MySQL/SQLite いずれかに接続

---

## 2. 手動テスト手順

### 2.1 Dangerレベル（WHERE句なしDELETE）

**前提条件**: クエリビルダーでテーブルを選択し、SELECT文を構築済み

**手順**:
1. SQLプレビューパネルで「DELETE FROM テーブル名」と手入力（または将来的にDELETE用UIがあれば使用）
2. 実行ボタンをクリック

**期待結果**:
- [ ] 確認ダイアログが表示される
- [ ] 「危険」バッジが赤色で表示される
- [ ] 「WHERE句がありません」の警告メッセージが表示される
- [ ] 影響テーブル名が表示される
- [ ] 実行ボタンに「(3秒待機)」が表示される
- [ ] 3秒後に実行ボタンが有効化される
- [ ] 「この操作は取り消せません」の警告が表示される

---

### 2.2 Warningレベル（WHERE句ありUPDATE）

**手順**:
1. SQLプレビューパネルで「UPDATE テーブル名 SET カラム = 値 WHERE 条件」と入力
2. 実行ボタンをクリック

**期待結果**:
- [ ] 確認ダイアログが表示される
- [ ] 「警告」バッジが黄色で表示される
- [ ] 「条件に一致するデータが更新されます」の警告メッセージが表示される
- [ ] 実行ボタンが即座に有効（カウントダウンなし）

---

### 2.3 Safeレベル（SELECT）

**手順**:
1. クエリビルダーで通常のSELECT文を構築
2. 実行ボタンをクリック

**期待結果**:
- [ ] 確認ダイアログは表示されない
- [ ] 直接クエリが実行される

---

### 2.4 キャンセル動作

**手順**:
1. Dangerレベルのクエリで確認ダイアログを表示
2. 「キャンセル」ボタンをクリック

**期待結果**:
- [ ] ダイアログが閉じる
- [ ] クエリは実行されない

---

### 2.5 Escapeキー動作

**手順**:
1. Warningレベルのクエリで確認ダイアログを表示
2. Escapeキーを押す

**期待結果**:
- [ ] ダイアログが閉じる
- [ ] クエリは実行されない

---

### 2.6 カウントダウンリセット

**手順**:
1. Dangerレベルのクエリで確認ダイアログを表示（カウントダウン開始）
2. カウントダウン途中でキャンセル
3. 再度実行ボタンをクリック

**期待結果**:
- [ ] カウントダウンが3秒からリスタートする

---

### 2.7 確認後の実行

**手順**:
1. Warningレベルのクエリで確認ダイアログを表示
2. 「実行する」ボタンをクリック

**期待結果**:
- [ ] ダイアログが閉じる
- [ ] クエリが実行される
- [ ] 結果パネルに結果/エラーが表示される

---

## 3. 自動テスト

### 3.1 テスト実行コマンド

```bash
npm run test:run -- app/components/query-builder/dialog/__tests__/DangerousQueryDialog.spec.ts
```

### 3.2 テストケース一覧

| テストID | テスト内容 | 期待結果 |
|---------|-----------|---------|
| T-01 | Dangerレベルで3秒カウントダウン | カウントダウンが表示され、0で有効化 |
| T-02 | Warningレベルで即時有効 | カウントダウンなし、即座にボタン有効 |
| T-03 | 危険度バッジ表示 | riskLevelに応じた色・ラベル |
| T-04 | 影響テーブル表示 | affectedTablesの内容が表示 |
| T-05 | confirmイベント発火 | 確認ボタンでemit |
| T-06 | cancelイベント発火 | キャンセルボタンでemit |

---

## 4. 境界条件テスト

### 4.1 analysisResultがnullの場合

**手順**:
1. クエリ解析前（テーブル未選択）に実行ボタンをクリック

**期待結果**:
- [ ] ダイアログは表示されない（そもそも実行ボタンが無効）

---

### 4.2 riskFactorsが空の場合

**手順**:
1. riskFactorsが空のWarningクエリを実行

**期待結果**:
- [ ] 警告メッセージ欄が空または非表示

---

### 4.3 affectedTablesが複数の場合

**手順**:
1. 複数テーブルに影響するクエリを実行

**期待結果**:
- [ ] 全テーブル名がバッジとして表示される

---

## 5. チェックリスト（最終確認）

| 項目 | 確認者 | 確認日 |
|------|--------|--------|
| Dangerレベルで3秒カウントダウンが動作する | | |
| Warningレベルで即座に実行できる | | |
| Safeレベルでダイアログが表示されない | | |
| キャンセルでクエリが実行されない | | |
| Escapeキーでダイアログが閉じる | | |
| 全自動テストがパスする | | |

---

## 6. 備考

- クエリビルダーは現在SELECTのみ対応のため、手動テストでは直接SQLを入力する必要がある
- 将来的にUPDATE/DELETEのUI対応後は、GUIからのテストに移行
