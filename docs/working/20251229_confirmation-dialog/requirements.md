# 要件定義書: 確認ダイアログ

**作成日**: 2025年12月29日
**WBS参照**: Phase 3.2 確認ダイアログ
**依存**: Phase 3.1 クエリ種別検出（完了）

---

## 1. 背景・目的

本番環境でのデータ破壊的なクエリ（UPDATE/DELETE/DROP/TRUNCATE）の誤実行を防止するため、危険なクエリ実行前に確認ダイアログを表示する。

### 1.1 解決したい課題

- 誤ってDELETE文を実行してデータを失う
- WHERE句のないUPDATEで全レコードを更新してしまう
- 本番環境でのDROP TABLEの誤実行

### 1.2 期待する効果

- ユーザーが危険なクエリを実行する前に一度立ち止まって確認できる
- 遅延実行により、衝動的な誤実行を防止できる
- 影響範囲を事前に確認できる

---

## 2. 機能要件

### 2.1 確認ダイアログ表示

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-01 | 危険度がWarning/Dangerのクエリ実行時に確認ダイアログを表示する | 必須 |
| REQ-02 | ダイアログにクエリの危険度レベルを表示する | 必須 |
| REQ-03 | ダイアログに危険度の理由（RiskFactor）を表示する | 必須 |
| REQ-04 | ダイアログに影響を受けるテーブル名を表示する | 必須 |
| REQ-05 | ダイアログに実行予定のSQLを表示する | 必須 |

### 2.2 遅延実行ボタン

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-06 | Dangerレベルの場合、実行ボタンを3秒間無効化する | 必須 |
| REQ-07 | 遅延中はカウントダウンを表示する | 必須 |
| REQ-08 | Warningレベルの場合は即座に実行可能 | 必須 |

### 2.3 影響行数表示（オプション）

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-09 | EXPLAIN結果から影響行数の見積もりを取得・表示する | 任意 |

### 2.4 キャンセル機能

| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-10 | ダイアログからキャンセルして実行を中止できる | 必須 |
| REQ-11 | Escapeキーでダイアログを閉じられる | 必須 |

---

## 3. 非機能要件

### 3.1 ユーザビリティ

- ダイアログは画面中央にモーダル表示
- 危険度レベルに応じた色分け（Warning: 黄色系、Danger: 赤系）
- アイコンで視覚的に危険度を伝える

### 3.2 アクセシビリティ

- キーボードフォーカス管理
- スクリーンリーダー対応（aria-labelなど）

---

## 4. 画面仕様

### 4.1 ダイアログ構成

```
┌─────────────────────────────────────────────────────┐
│ [!] 危険なクエリの実行確認                            │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [危険度バッジ: DANGER / WARNING]                    │
│                                                     │
│  警告メッセージ:                                      │
│  ・WHERE句がありません。テーブル内の全データが削除されます │
│                                                     │
│  影響を受けるテーブル:                                 │
│  ・users                                            │
│                                                     │
│  実行予定のSQL:                                       │
│  ┌───────────────────────────────────────────────┐ │
│  │ DELETE FROM users                             │ │
│  └───────────────────────────────────────────────┘ │
│                                                     │
├─────────────────────────────────────────────────────┤
│                    [キャンセル]  [実行する (3秒待機)]  │
└─────────────────────────────────────────────────────┘
```

### 4.2 状態遷移

```
[クエリ実行ボタン押下]
        │
        ▼
[analysisResult.riskLevel確認]
        │
    ┌───┴───┐
    ▼       ▼
 [Safe]  [Warning/Danger]
    │       │
    │       ▼
    │   [確認ダイアログ表示]
    │       │
    │   ┌───┴───┐
    │   ▼       ▼
    │ [キャンセル] [実行確認]
    │   │       │
    │   ▼       ├──[Danger]──→[3秒待機]→[実行]
    │ [中止]    │
    │           └──[Warning]──→[即実行]
    │                           │
    └───────────────────────────┘
                │
                ▼
           [クエリ実行]
```

---

## 5. 受け入れ条件

1. Dangerレベルのクエリ実行時に確認ダイアログが表示される
2. Warningレベルのクエリ実行時に確認ダイアログが表示される
3. Safeレベルのクエリ実行時は確認ダイアログなしで実行される
4. Dangerレベルでは実行ボタンが3秒間無効化される
5. カウントダウンが正しく表示される
6. キャンセルボタンでダイアログが閉じ、実行が中止される
7. Escapeキーでダイアログが閉じる

---

## 6. 関連ドキュメント

- [WBS v3.0](../../sql_editor_wbs_v3.md) - Phase 3.2
- [3.1 クエリ種別検出 設計書](../20251229_query-type-detection/design.md)
