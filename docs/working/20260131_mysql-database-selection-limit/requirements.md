# 要件定義書 - MySQLデータベース選択機能の制限対応

## 概要

SQLエディタ画面のツールバーに追加したデータベース選択機能について、MySQLの技術的制約（sqlxライブラリがUSEステートメントをサポートしない）により、現状では正しく動作しないことが判明しました。

この開発作業では、MySQLの場合は接続設定で指定したデフォルトデータベースのみを表示し、PostgreSQLの場合は従来通りスキーマ選択可能とする仕様に変更します。

## 背景・目的

### 背景

1. **元々の実装意図**
   - SQLエディタでデータベース名を省略してクエリを実行するとエラーになる問題を解消するため、ツールバーにデータベースセレクターを追加
   - 選択されたデータベースに対して`USE database_name;`を自動的に実行する想定

2. **技術的制約の発見**
   - sqlxライブラリでは`USE`ステートメントがプリペアドステートメントプロトコルでサポートされていない
   - エラー: `"This command is not supported in the prepared statement protocol yet"`
   - 生のSQL実行（`conn.execute()`）も同じエラーが発生

3. **MySQLの接続の仕組み**
   - MySQL接続は作成時にデフォルトデータベースを指定：`mysql://user:pass@host:port/database_name`
   - 接続プール内の各接続は特定のデータベースに紐づいている
   - テーブル名を完全修飾しない場合（例：`SELECT * FROM carts`）、デフォルトデータベースが自動的に使われる

### 目的

- MySQLの技術的制約を考慮した、適切なUI/UX設計への変更
- ユーザーに誤解を与えない明確な仕様の提供
- PostgreSQLとMySQLの違いに対応した柔軟な実装

## 要件一覧

### 機能要件

#### F-1: MySQLの場合はデフォルトデータベース名を読み取り専用で表示

- **説明**: MySQLの場合、ツールバーに接続設定で指定したデフォルトデータベース名を表示する。選択変更は不可とする。
- **受け入れ条件**:
  - [ ] MySQLに接続している場合、デフォルトデータベース名が表示される
  - [ ] データベース名の部分はクリックできない（読み取り専用）
  - [ ] 他のデータベースにアクセスしたい場合は、ユーザーが手動で完全修飾名（`database.table`）を書く必要がある旨をUI上で示す（ツールチップなど）

#### F-2: PostgreSQLの場合はスキーマ選択可能

- **説明**: PostgreSQLの場合、従来通りスキーマをドロップダウンで選択可能とする。
- **受け入れ条件**:
  - [ ] PostgreSQLに接続している場合、利用可能なスキーマ一覧がドロップダウンで選択できる
  - [ ] スキーマを選択すると、`SET search_path TO schema_name;`が実行される
  - [ ] 選択されたスキーマに対してクエリが実行される

#### F-3: SQLiteの場合は何も表示しない

- **説明**: SQLiteはデータベース切り替えの概念がないため、データベースセレクターを非表示にする。
- **受け入れ条件**:
  - [ ] SQLiteに接続している場合、データベースセレクターが非表示になる

#### F-4: USE文生成ロジックの削除

- **説明**: MySQLの`USE`文生成ロジックおよびRust側の分割実行ロジックを削除する。
- **受け入れ条件**:
  - [ ] `generateContextSql()`メソッドからMySQL用のUSE文生成ロジックを削除
  - [ ] PostgreSQL用の`SET search_path`ロジックは残す
  - [ ] Rust側の`mysql_executor.rs`からUSE文の分割実行ロジックを削除
  - [ ] デバッグログをすべて削除

#### F-5: 初期値の設定

- **説明**: SQLエディタ画面を開いた時、接続設定の`database`フィールドを`selectedDatabase`に自動設定する。
- **受け入れ条件**:
  - [ ] MySQLの場合、`connection.database`の値が`selectedDatabase`に設定される
  - [ ] PostgreSQLの場合、デフォルトスキーマ（通常は`public`）が設定される
  - [ ] タブごとに選択されたデータベース/スキーマが保持される

### 非機能要件

- **保守性**: 将来的に完全修飾テーブル名への自動書き換え機能を追加する余地を残す
- **UI/UX**: MySQLとPostgreSQLで異なる動作をする場合、ユーザーが混乱しないよう明確に区別する

## スコープ

### 対象

- SQLエディタのツールバーのデータベースセレクター
- `SqlEditorToolbar.vue`コンポーネント
- `sql-editor.ts`ストア
- `mysql_executor.rs`の不要なロジック削除
- `postgresql_executor.rs`の`SET search_path`ロジック（維持）

### 対象外

- 完全修飾テーブル名への自動書き換え機能（将来的な拡張として検討）
- 他のデータベースにアクセスするための接続を複数作成する機能（既存機能として利用可能）

## 実装対象ファイル（予定）

### フロントエンド

- `app/components/sql-editor/SqlEditorToolbar.vue` - UI表示ロジックの変更
- `app/stores/sql-editor.ts` - `generateContextSql()`メソッドの修正、初期値設定ロジック
- `app/types/sql-editor.ts` - 型定義（必要に応じて）

### バックエンド

- `src-tauri/src/database/mysql_executor.rs` - USE文分割実行ロジックの削除、デバッグログ削除
- `src-tauri/src/database/postgresql_executor.rs` - `SET search_path`ロジックの維持確認
- `src-tauri/src/commands/query.rs` - デバッグログ削除

## 依存関係

- なし（既存の接続管理機能、データベース構造取得機能を使用）

## 既知の制約

### sqlxライブラリの制約

- MySQLの`USE`ステートメントがプリペアドステートメントプロトコルでサポートされていない
- 生のSQL実行（`conn.execute()`）でも同じエラーが発生
- この制約は回避不可能（sqlxライブラリのアーキテクチャ上の制限）

### MySQL接続の仕組み

- 接続作成時にデフォルトデータベースが決定される（`mysql://user:pass@host:port/database`）
- 接続プール内の接続はそのデータベースに紐づいている
- 動的にデフォルトデータベースを切り替えるには`USE`文が必要だが、上記の制約により不可能

### 代替手段

- ユーザーが手動で完全修飾テーブル名（`database.table`）を書く
- 他のデータベースにアクセスする場合は、別の接続を作成する

## 参考資料

- sqlx GitHub Issues: プリペアドステートメントプロトコルの制限について
- MySQL公式ドキュメント: `USE`ステートメント
- PostgreSQL公式ドキュメント: `SET search_path`
- 会話履歴: MySQLデータベース選択機能の調査結果
