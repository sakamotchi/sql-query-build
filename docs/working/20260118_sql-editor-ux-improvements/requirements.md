# 要件定義書 - SQLエディタ Phase 6: UX改善・仕上げ

## 概要

SQLエディタの基本機能（Phase 1-5）が完成した後、使い勝手を向上させ、プロダクション品質に仕上げる。SQLフォーマット、検索・置換、タブ機能、エクスポート連携など、開発者体験を向上させる機能を追加する。

## 背景・目的

### 現在の状態（Phase 5完了時点）

- ✅ SQLエディタウィンドウの起動（Phase 1）
- ✅ テキストエディタでのSQL編集・構文ハイライト（Phase 2）
- ✅ クエリ実行・結果表示（Phase 3）
- ✅ クエリの保存・管理機能（Phase 4）
- ✅ 実行履歴機能（Phase 5）

### 課題

1. **コードの可読性**: 長いSQLや複雑なクエリが読みづらい → フォーマット機能が必要
2. **編集効率**: 検索・置換機能がない → テキスト編集が非効率
3. **括弧の対応確認**: ネストした括弧の対応が分かりにくい → ミスを誘発
4. **複数クエリの同時編集**: 1つのクエリしか開けない → タブ機能が欲しい
5. **未保存の変更**: ウィンドウを閉じる際に警告がない → データ損失のリスク
6. **結果のエクスポート**: 既存のエクスポート機能と連携していない
7. **パネルのサイズ調整**: エディタと結果パネルのサイズが固定 → 柔軟性がない
8. **ダークモード対応**: 確認不足 → 見た目の不具合がある可能性

### 目的

上記の課題を解決し、VSCodeやDataGripなどの一般的なSQLエディタと同等の使い勝手を提供する。プロダクション品質のSQLエディタとして、ユーザーに自信を持って提供できるレベルに仕上げる。

## 要件一覧

### 機能要件

#### F-1: SQLフォーマット機能

- **説明**: エディタ内のSQLを整形し、可読性を向上させる
- **受け入れ条件**:
  - [ ] ツールバーに「整形」ボタンがある
  - [ ] Ctrl/Cmd+Shift+F でSQLがフォーマットされる
  - [ ] SELECT, INSERT, UPDATE, DELETE文が適切にインデントされる
  - [ ] キーワードが大文字に統一される（またはユーザー設定に従う）
  - [ ] 括弧のネストが正しくインデントされる
  - [ ] フォーマット後もUndoで元に戻せる

#### F-2: 括弧の対応表示

- **説明**: カーソルが括弧の上にある時、対応する括弧をハイライト表示する
- **受け入れ条件**:
  - [ ] `(` または `)` にカーソルを置くと、対応する括弧がハイライトされる
  - [ ] ネストした括弧の対応も正しく表示される
  - [ ] 対応する括弧がない場合、エラー色でハイライトされる（オプション）

#### F-3: 検索・置換機能

- **説明**: エディタ内のテキストを検索・置換する
- **受け入れ条件**:
  - [ ] Ctrl/Cmd+F で検索ダイアログが表示される
  - [ ] Ctrl/Cmd+H で置換ダイアログが表示される
  - [ ] 大文字小文字を区別するオプションがある
  - [ ] 正規表現検索に対応している（オプション）
  - [ ] 検索結果がハイライトされる
  - [ ] 「次を検索」「前を検索」「すべて置換」が動作する

#### F-4: タブ機能（複数クエリの同時編集）

- **説明**: 同一ウィンドウ内で複数のクエリをタブで切り替えながら編集できる
- **受け入れ条件**:
  - [ ] 「新規タブ」ボタンでタブが追加される
  - [ ] Ctrl/Cmd+N でも新規タブが追加される
  - [ ] タブをクリックして切り替えられる
  - [ ] タブの「×」ボタンで閉じられる
  - [ ] 各タブのSQL、カーソル位置、実行結果が独立している
  - [ ] タブに名前をつけられる（保存時の名前、または「Untitled 1」など）
  - [ ] 未保存のタブには「*」マークが表示される

#### F-5: 未保存警告

- **説明**: 未保存の変更がある状態でウィンドウまたはタブを閉じようとすると警告を表示する
- **受け入れ条件**:
  - [ ] 未保存の変更がある状態でウィンドウを閉じようとすると確認ダイアログが表示される
  - [ ] 未保存の変更がある状態でタブを閉じようとすると確認ダイアログが表示される
  - [ ] ダイアログで「保存」「破棄」「キャンセル」を選択できる
  - [ ] 「保存」を選択すると保存ダイアログが表示される（未保存クエリの場合）

#### F-6: エクスポート連携

- **説明**: クエリ実行結果を既存のエクスポート機能を使ってCSV/JSON/Excelに出力できる
- **受け入れ条件**:
  - [ ] 結果パネルに「エクスポート」ボタンがある
  - [ ] ボタンをクリックすると既存の ExportDialog が表示される
  - [ ] CSV/JSON/Excel形式でエクスポートできる
  - [ ] エクスポート機能は既存のクエリビルダーと同じ動作をする

#### F-7: パネルのリサイズ対応

- **説明**: エディタパネルと結果パネルの境界をドラッグしてサイズを調整できる
- **受け入れ条件**:
  - [ ] エディタパネルと結果パネルの間にリサイズハンドルがある
  - [ ] ハンドルをドラッグすると境界が移動する
  - [ ] 最小サイズ以下には縮小できない
  - [ ] リサイズ後のサイズが保存される（セッション内またはローカルストレージ）

#### F-8: ダークモード対応確認

- **説明**: ライトモード/ダークモードの両方で正しく表示されることを確認する
- **受け入れ条件**:
  - [ ] ライトモードで全てのUI要素が正しく表示される
  - [ ] ダークモードで全てのUI要素が正しく表示される
  - [ ] Monaco Editorのテーマがシステムテーマに追従する
  - [ ] 構文ハイライトの色がダークモードで読みやすい

### 非機能要件

#### NFR-1: パフォーマンス

- **SQLフォーマット**: 10,000文字のSQLを1秒以内にフォーマット
- **検索**: 10,000文字のSQL内の検索が100ms以内
- **タブ切り替え**: 100ms以内

#### NFR-2: ユーザビリティ

- **キーボードショートカット**: 主要な操作がキーボードで完結する
- **Monaco Editor標準機能**: Monaco Editorの標準的な検索・置換UIを活用する
- **一貫性**: 既存のクエリビルダーやミューテーションビルダーと同じExportDialogを使用

#### NFR-3: 保守性

- **既存コンポーネントの再利用**: ExportDialog, ResizablePanel（存在する場合）など
- **Monaco Editorの標準機能活用**: 検索・置換、括弧の対応表示はMonaco Editorの組み込み機能を優先

## スコープ

### 対象

- SQLフォーマット機能
- 括弧の対応表示
- 検索・置換機能（Monaco Editorの標準機能を活用）
- タブ機能（複数クエリの同時編集）
- 未保存警告
- エクスポート連携（既存のExportDialog流用）
- パネルのリサイズ対応
- ダークモード対応確認・修正

### 対象外（将来検討）

- SQLオートコンプリート（IntelliSense）
- クエリの比較機能
- タブ状態の永続化（ウィンドウ再起動時の復元）
- SQLシンタックスチェック（リアルタイムエラー検出）
- 実行計画の視覚化

## 実装対象ファイル（予定）

### フロントエンド

| ファイル | 変更内容 |
|---------|---------|
| `app/components/sql-editor/SqlEditorToolbar.vue` | フォーマットボタン追加 |
| `app/components/sql-editor/SqlTextEditor.vue` | Monaco Editor設定拡張（括弧対応、検索・置換） |
| `app/components/sql-editor/SqlEditorLayout.vue` | タブ機能追加、リサイズハンドル追加 |
| `app/components/sql-editor/ResultPanel.vue` | エクスポートボタン追加 |
| `app/components/sql-editor/EditorTabs.vue` | **新規**: タブUI |
| `app/stores/sql-editor.ts` | タブ管理、未保存状態管理、フォーマット処理 |
| `app/pages/sql-editor.vue` | beforeunload イベントハンドラー追加 |

### バックエンド

| ファイル | 変更内容 |
|---------|---------|
| `src-tauri/src/commands/sql_editor.rs` | SQLフォーマットコマンド追加（オプション） |

**注**: SQLフォーマットはフロントエンド側でJavaScriptライブラリ（`sql-formatter`など）を使用する方針とする。Rustでの実装は将来的な性能改善として検討。

### 依存パッケージ

| パッケージ | 用途 |
|---------|------|
| `sql-formatter` | SQLフォーマット |
| `monaco-editor` | 既存（検索・置換、括弧対応表示機能を活用） |

## 依存関係

- **Phase 5完了**: クエリ履歴機能が実装済みであること
- **既存のExportDialog**: クエリビルダーで使用している ExportDialog コンポーネントが存在すること
- **Monaco Editor**: Phase 2で導入済み

## 既知の制約

- Monaco Editorのバンドルサイズが大きい（すでにPhase 2で導入済み、追加影響なし）
- タブ機能の実装により、状態管理が複雑化する可能性
- SQLフォーマットライブラリの選定が必要（`sql-formatter`, `prettier-plugin-sql` など）

## 参考資料

### 内部ドキュメント

- [SQLエディタ機能要件定義](../../local/20260117_エディタ機能/requirements.md)
- [SQLエディタ WBS](../../local/20260117_エディタ機能/wbs.md)
- [技術仕様書](../../steering/03_architecture_specifications.md)
- [リポジトリ構造定義書](../../steering/04_repository_structure.md)

### 外部ドキュメント

- [Monaco Editor API](https://microsoft.github.io/monaco-editor/api/index.html)
- [sql-formatter](https://github.com/sql-formatter-org/sql-formatter)
- [Nuxt UI Components](https://ui.nuxt.com/)

## 成功指標

### 定量的指標

- [ ] SQLフォーマットの実行時間が1秒以内（10,000文字のSQL）
- [ ] 検索機能の応答時間が100ms以内
- [ ] タブ切り替えの応答時間が100ms以内
- [ ] ダークモード/ライトモード両方で視覚的な不具合がゼロ

### 定性的指標

- [ ] ユーザーが「VSCodeのようなエディタ体験」と感じられる
- [ ] 複数クエリの同時編集がスムーズに行える
- [ ] 未保存データの損失が防止される
- [ ] エクスポート機能がクエリビルダーと同等の使い勝手

## 備考

- Phase 6完了後、Phase 7（テスト安定化）に進む
- Phase 6はMVP（Phase 1-3）とv1.0（Phase 1-5）の完成後の「仕上げ」フェーズとして位置づけられる
- 各機能は独立性が高いため、優先度をつけて段階的に実装可能
