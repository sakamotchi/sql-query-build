# テスト手順書 - SQLエディタ Phase 6: UX改善・仕上げ

## 概要

このドキュメントでは、SQLエディタ Phase 6（UX改善・仕上げ）機能のテスト手順を記載します。
可能な限り手動操作で確認し、操作で確認できない項目のみ自動テストを記載します。

## 前提条件

- `npm run tauri:dev` でアプリが起動していること
- 少なくとも1つのデータベース接続が登録されていること
- SQLエディタ Phase 1-5 が完了していること（基本的なエディタ機能が動作すること）

## 手動テスト

### F-1: SQLフォーマット機能

#### ケース 1-1: ツールバーの整形ボタンでフォーマット

**手順:**

1. ランチャーから接続を選択し、「エディタ」ボタンをクリック
2. エディタに以下のSQL（フォーマットされていない）を入力:
   ```sql
   select id,name,email from users where age>20 and status='active'
   ```
3. ツールバーの「整形」ボタンをクリック

**期待結果:**

- SQLが整形される（キーワードが大文字、改行・インデントが適用される）
- 例:
  ```sql
  SELECT
    id,
    name,
    email
  FROM
    users
  WHERE
    age > 20
    AND status = 'active'
  ```
- Undoで元に戻せる

**確認結果:**

- [ ] OK / NG

---

#### ケース 1-2: Ctrl/Cmd+Shift+F でフォーマット

**手順:**

1. エディタに以下のSQL（フォーマットされていない）を入力:
   ```sql
   insert into products(name,price,stock) values('Product A',1000,50)
   ```
2. Ctrl/Cmd+Shift+F を押下

**期待結果:**

- SQLが整形される
- 例:
  ```sql
  INSERT INTO
    products (name, price, stock)
  VALUES
    ('Product A', 1000, 50)
  ```

**確認結果:**

- [ ] OK / NG

---

#### ケース 1-3: 空のSQLをフォーマット

**手順:**

1. エディタに何も入力しない（空の状態）
2. 「整形」ボタンをクリック

**期待結果:**

- 何も起こらない（エラーが表示されない）
- 整形ボタンが無効になっている

**確認結果:**

- [ ] OK / NG

---

### F-2: 括弧の対応表示

#### ケース 2-1: 括弧の対応がハイライトされる

**手順:**

1. エディタに以下のSQLを入力:
   ```sql
   SELECT COUNT(*) FROM (SELECT id FROM users WHERE age > (20 + 5))
   ```
2. カーソルを `(SELECT` の `(` に置く

**期待結果:**

- 対応する閉じ括弧 `)` がハイライトされる

**確認結果:**

- [ ] OK / NG

---

#### ケース 2-2: ネストした括弧の対応表示

**手順:**

1. エディタに以下のSQLを入力:
   ```sql
   SELECT * FROM users WHERE (age > 20 AND (status = 'active' OR status = 'pending'))
   ```
2. 各括弧にカーソルを置いて、対応する括弧がハイライトされることを確認

**期待結果:**

- 各括弧について、正しく対応する括弧がハイライトされる

**確認結果:**

- [ ] OK / NG

---

### F-3: 検索・置換機能

#### ケース 3-1: Ctrl/Cmd+F で検索

**手順:**

1. エディタに以下のSQLを入力:
   ```sql
   SELECT id, name, email FROM users WHERE status = 'active'
   SELECT id, name FROM orders WHERE user_id = 1
   ```
2. Ctrl/Cmd+F を押下
3. 検索ボックスに「SELECT」と入力

**期待結果:**

- 検索ダイアログが表示される
- 「SELECT」がハイライトされる（2箇所）
- 「次を検索」「前を検索」ボタンで移動できる

**確認結果:**

- [ ] OK / NG

---

#### ケース 3-2: Ctrl/Cmd+H で置換

**手順:**

1. エディタに以下のSQLを入力:
   ```sql
   SELECT * FROM users WHERE status = 'active'
   SELECT * FROM orders WHERE status = 'active'
   ```
2. Ctrl/Cmd+H を押下
3. 検索ボックスに「active」、置換ボックスに「pending」と入力
4. 「すべて置換」をクリック

**期待結果:**

- 置換ダイアログが表示される
- 「active」が「pending」に置き換わる（2箇所）

**確認結果:**

- [ ] OK / NG

---

#### ケース 3-3: 大文字小文字を区別する検索

**手順:**

1. エディタに以下のSQLを入力:
   ```sql
   SELECT id, Name, EMAIL from users
   ```
2. Ctrl/Cmd+F を押下
3. 検索ボックスに「name」と入力
4. 「大文字小文字を区別」オプションを有効にする

**期待結果:**

- 「Name」はヒットしない（大文字小文字が異なるため）

**確認結果:**

- [ ] OK / NG

---

### F-4: タブ機能（複数クエリの同時編集）

#### ケース 4-1: 新規タブを追加

**手順:**

1. SQLエディタを開く
2. 「新規」ボタンをクリック

**期待結果:**

- 新しいタブが追加される
- タブ名は「Untitled 1」などの連番になる
- 新しいタブがアクティブになる

**確認結果:**

- [ ] OK / NG

---

#### ケース 4-2: タブを切り替える

**手順:**

1. タブ1に「SELECT * FROM users」と入力
2. 新規タブを追加（タブ2）
3. タブ2に「SELECT * FROM orders」と入力
4. タブ1をクリック

**期待結果:**

- タブ1に戻り、エディタに「SELECT * FROM users」が表示される
- タブ2をクリックすると「SELECT * FROM orders」が表示される

**確認結果:**

- [ ] OK / NG

---

#### ケース 4-3: タブを閉じる

**手順:**

1. 複数のタブを開く
2. タブの「×」ボタンをクリック

**期待結果:**

- タブが閉じられる
- アクティブなタブが隣のタブに移動する

**確認結果:**

- [ ] OK / NG

---

#### ケース 4-4: 未保存タブに「*」マークが表示される

**手順:**

1. 新規タブを追加
2. エディタに「SELECT * FROM users」と入力（保存しない）

**期待結果:**

- タブ名の前に「* 」マークが表示される（例: 「* Untitled 1」）

**確認結果:**

- [ ] OK / NG

---

#### ケース 4-5: Ctrl/Cmd+N で新規タブを追加

**手順:**

1. SQLエディタを開く
2. Ctrl/Cmd+N を押下

**期待結果:**

- 新しいタブが追加される

**確認結果:**

- [ ] OK / NG

---

### F-5: 未保存警告

#### ケース 5-1: 未保存タブを閉じる際の警告

**手順:**

1. 新規タブを追加
2. エディタに「SELECT * FROM users」と入力（保存しない）
3. タブの「×」ボタンをクリック

**期待結果:**

- 確認ダイアログが表示される
- 「保存」「破棄」「キャンセル」ボタンが表示される
- 「キャンセル」をクリックするとタブが閉じない
- 「破棄」をクリックするとタブが閉じられる

**確認結果:**

- [ ] OK / NG

---

#### ケース 5-2: ウィンドウを閉じる際の警告

**手順:**

1. 新規タブを追加
2. エディタに「SELECT * FROM users」と入力（保存しない）
3. ウィンドウの閉じるボタンをクリック

**期待結果:**

- ブラウザの `beforeunload` 警告が表示される
- 「このページを離れますか？」のような確認メッセージが表示される

**確認結果:**

- [ ] OK / NG

---

### F-6: エクスポート連携

#### ケース 6-1: 実行結果をCSVにエクスポート

**手順:**

1. エディタに「SELECT * FROM users LIMIT 10」と入力
2. Ctrl/Cmd+Enter でクエリを実行
3. 結果パネルの「エクスポート」ボタンをクリック
4. CSV形式を選択してエクスポート

**期待結果:**

- ExportDialog が表示される
- CSV形式でエクスポートできる
- エクスポートされたファイルを開くと、正しいデータが入っている

**確認結果:**

- [ ] OK / NG

---

#### ケース 6-2: 実行結果をJSONにエクスポート

**手順:**

1. エディタに「SELECT id, name FROM users LIMIT 5」と入力
2. クエリを実行
3. 結果パネルの「エクスポート」ボタンをクリック
4. JSON形式を選択してエクスポート

**期待結果:**

- JSON形式でエクスポートできる
- エクスポートされたファイルを開くと、正しいJSON配列が入っている

**確認結果:**

- [ ] OK / NG

---

#### ケース 6-3: 結果がない場合、エクスポートボタンが無効

**手順:**

1. SQLエディタを開く（クエリ実行前）
2. 結果パネルの「エクスポート」ボタンを確認

**期待結果:**

- エクスポートボタンが無効（disabled）になっている

**確認結果:**

- [ ] OK / NG

---

### F-7: パネルのリサイズ対応

#### ケース 7-1: エディタパネルと結果パネルの境界をリサイズ

**手順:**

1. エディタに「SELECT * FROM users」と入力し、実行
2. エディタパネルと結果パネルの境界（リサイズハンドル）をドラッグ

**期待結果:**

- ドラッグに応じてパネルのサイズが変更される
- リサイズハンドルの上にマウスを置くと、カーソルが変わる（`cursor: row-resize`）

**確認結果:**

- [ ] OK / NG

---

#### ケース 7-2: リサイズの最小・最大制限

**手順:**

1. リサイズハンドルを上端まで（または下端まで）ドラッグ

**期待結果:**

- エディタパネルは20%以下にならない
- エディタパネルは80%以上にならない

**確認結果:**

- [ ] OK / NG

---

#### ケース 7-3: リサイズ後のサイズが保存される

**手順:**

1. リサイズハンドルをドラッグしてパネルサイズを変更
2. SQLエディタウィンドウを閉じる
3. 再度SQLエディタウィンドウを開く

**期待結果:**

- リサイズ後のサイズが復元される（ローカルストレージに保存されている）

**確認結果:**

- [ ] OK / NG

---

### F-8: ダークモード対応確認

#### ケース 8-1: ライトモードでの表示確認

**手順:**

1. システム設定をライトモードに変更
2. SQLエディタを開く
3. 全てのUI要素を確認（ツールバー、タブ、エディタ、結果パネル、サイドパネル）

**期待結果:**

- 全てのUI要素がライトモードで正しく表示される
- Monaco Editorのテーマが「vs」になっている
- 構文ハイライトの色が読みやすい

**確認結果:**

- [ ] OK / NG

---

#### ケース 8-2: ダークモードでの表示確認

**手順:**

1. システム設定をダークモードに変更
2. SQLエディタを開く
3. 全てのUI要素を確認（ツールバー、タブ、エディタ、結果パネル、サイドパネル）

**期待結果:**

- 全てのUI要素がダークモードで正しく表示される
- Monaco Editorのテーマが「vs-dark」になっている
- 構文ハイライトの色が読みやすい

**確認結果:**

- [ ] OK / NG

---

#### ケース 8-3: ダークモード切り替え時の動作

**手順:**

1. ライトモードでSQLエディタを開く
2. システム設定をダークモードに変更
3. SQLエディタの表示を確認

**期待結果:**

- Monaco Editorのテーマが自動的に「vs-dark」に変更される
- 再起動なしで即座に反映される

**確認結果:**

- [ ] OK / NG

---

## 自動テスト

### ユニットテスト

```bash
npm run test:run
```

**対象テスト:**

- `tests/stores/sql-editor.spec.ts` - SQLフォーマット機能、タブ管理機能
- `tests/components/sql-editor/EditorTabs.spec.ts` - タブUIコンポーネント
- `tests/components/sql-editor/SqlEditorResultPanel.spec.ts` - エクスポート機能

**期待結果:**

- [ ] 全てのテストがパスする

---

### 型チェック

```bash
npm run typecheck
```

**期待結果:**

- [ ] TypeScriptの型エラーがゼロ

---

### Rustテスト

```bash
cd src-tauri && cargo test
```

**期待結果:**

- [ ] 全てのRustテストがパスする（Phase 6ではRust側の変更はないため、既存テストのみ）

---

## 非機能要件テスト

### パフォーマンステスト

#### ケース P-1: SQLフォーマットの実行時間

**手順:**

1. 10,000文字以上のSQLを準備（複雑なCTE、複数のJOINを含む）
2. エディタに貼り付け
3. 「整形」ボタンをクリック
4. 実行時間を計測（ブラウザのDevToolsのPerformanceタブなど）

**期待結果:**

- フォーマット実行が1秒以内に完了する

**確認結果:**

- [ ] OK / NG (計測時間: _____ ms)

---

#### ケース P-2: 検索の応答時間

**手順:**

1. 10,000文字以上のSQLを準備
2. エディタに貼り付け
3. Ctrl/Cmd+F で検索
4. 検索ボックスに「SELECT」と入力
5. 検索結果がハイライトされるまでの時間を計測

**期待結果:**

- 検索が100ms以内に完了する

**確認結果:**

- [ ] OK / NG (計測時間: _____ ms)

---

#### ケース P-3: タブ切り替えの応答時間

**手順:**

1. 10個のタブを開く
2. 各タブに異なるSQLを入力
3. タブを切り替える（タブ1→タブ10→タブ5）
4. 切り替えにかかる時間を計測

**期待結果:**

- タブ切り替えが100ms以内に完了する

**確認結果:**

- [ ] OK / NG (計測時間: _____ ms)

---

## エッジケース

| ケース | 期待動作 | 確認結果 |
|--------|---------|---------|
| 空のSQLをフォーマット | 何も起こらない、エラーなし | [ ] OK / NG |
| 文法エラーのSQLをフォーマット | エラーを無視してフォーマット、または元のまま | [ ] OK / NG |
| 巨大なSQL（100,000文字）をフォーマット | 1秒以内、またはタイムアウトメッセージ | [ ] OK / NG |
| タブを100個開く | 制限メッセージ、または最大10タブまで | [ ] OK / NG |
| リサイズハンドルを高速にドラッグ | スムーズに追従する | [ ] OK / NG |
| ダークモードとライトモードを連続切り替え | テーマが正しく切り替わる | [ ] OK / NG |
| 未保存タブが10個ある状態でウィンドウを閉じる | beforeunload警告が表示される | [ ] OK / NG |
| エクスポート中にウィンドウを閉じる | エクスポート完了まで待機、または中断確認 | [ ] OK / NG |

---

## 回帰テスト

既存機能への影響がないことを確認します。

### Phase 1-5の機能

- [ ] エディタウィンドウが正常に起動する（Phase 1）
- [ ] SQLテキスト編集・構文ハイライトが動作する（Phase 2）
- [ ] クエリ実行・結果表示が動作する（Phase 3）
- [ ] クエリの保存・読み込みが動作する（Phase 4）
- [ ] クエリ履歴機能が動作する（Phase 5）

### その他の既存機能

- [ ] 接続カードからエディタボタンでウィンドウが開く
- [ ] クエリビルダーが正常に動作する
- [ ] ミューテーションビルダーが正常に動作する
- [ ] 設定画面が正常に動作する

---

## テスト結果サマリー

| カテゴリ | 総数 | 成功 | 失敗 | スキップ |
|---------|------|------|------|---------|
| 手動テスト（機能） | 25 | 0 | 0 | 0 |
| 手動テスト（非機能） | 3 | 0 | 0 | 0 |
| エッジケース | 8 | 0 | 0 | 0 |
| 回帰テスト | 9 | 0 | 0 | 0 |
| 自動テスト | 3 | 0 | 0 | 0 |
| **合計** | **48** | **0** | **0** | **0** |

---

## バグ・課題管理

テスト中に発見されたバグや課題を記録します。

| ID | カテゴリ | 概要 | 優先度 | 状態 |
|----|---------|------|--------|------|
| | | | | |

---

## テスト完了条件

- [ ] 全ての手動テストがパスしている
- [ ] 全ての自動テストがパスしている
- [ ] 非機能要件（パフォーマンス）を満たしている
- [ ] エッジケースで致命的なバグがない
- [ ] 回帰テストで既存機能に影響がない
- [ ] バグ・課題がすべて解決または受け入れられている

---

## 補足

### テスト環境

- OS: macOS / Windows / Linux
- ブラウザ: WebView（Tauri）
- データベース: PostgreSQL 14+, MySQL 8+, SQLite 3+

### テストデータ

- サンプルデータベース: Northwind, Sakila, Chinook など
- 最低10,000行のテーブルを用意（パフォーマンステスト用）

### テスト時の注意事項

- ダークモード/ライトモードの両方でテストすること
- 異なるデータベース（PostgreSQL, MySQL, SQLite）でテストすること
- タブ機能は未保存状態のテストを必ず含めること
- パフォーマンステストは複数回実行して平均値を取ること
