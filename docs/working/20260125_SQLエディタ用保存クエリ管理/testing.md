# テスト手順書：SQLエディタ用保存クエリのフォルダ管理機能

**作成日**: 2026-01-25
**バージョン**: 1.0
**ステータス**: 📝 計画中

---

## 1. テスト環境

### 1.1 前提条件
- Tauriアプリが起動している（`npm run tauri:dev`）
- データベース接続が設定されている
- 既存の保存クエリが存在する（テストデータ）

### 1.2 テストデータの準備

#### 既存クエリ（フォルダなし）
1. SQLエディタで適当なクエリを3件作成
2. それぞれ異なるタグを付与
   - Query A: タグ「開発」
   - Query B: タグ「本番」
   - Query C: タグ「開発」「テスト」

---

## 2. 手動テスト

### 2.1 フォルダ作成テスト

#### TC-001: ルート直下にフォルダを作成
**操作手順**:
1. SQLエディタ画面を開く
2. 保存クエリパネルを開く
3. ツールバーの「新規フォルダ」ボタン（📁+）をクリック
4. フォルダ名「開発環境」を入力
5. 「作成」ボタンをクリック

**期待結果**:
- ✅ フォルダ「開発環境」がツリーに表示される
- ✅ フォルダアイコンが表示される
- ✅ Toast通知「フォルダを作成しました」が表示される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-002: サブフォルダを作成
**操作手順**:
1. フォルダ「開発環境」を右クリック
2. コンテキストメニューから「新規フォルダ」を選択
3. フォルダ名「ユーザー管理」を入力
4. 「作成」ボタンをクリック

**期待結果**:
- ✅ フォルダ「開発環境/ユーザー管理」がツリーに表示される
- ✅ 階層構造が正しく表示される（インデント）

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-003: フォルダ名の禁止文字チェック
**操作手順**:
1. 「新規フォルダ」ボタンをクリック
2. フォルダ名に禁止文字を含める（例: `テスト/フォルダ`）
3. 「作成」ボタンをクリック

**期待結果**:
- ✅ バリデーションエラーが表示される
- ✅ 「フォルダ名に使用できない文字が含まれています」などのメッセージ
- ✅ フォルダは作成されない

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.2 クエリ移動テスト

#### TC-004: ドラッグ&ドロップでクエリを移動
**操作手順**:
1. ルート直下のクエリ「Query A」をドラッグ
2. フォルダ「開発環境」にドロップ

**期待結果**:
- ✅ クエリ「Query A」がフォルダ「開発環境」配下に移動
- ✅ Toast通知「クエリを移動しました」が表示される
- ✅ フォルダのクエリ数バッジが更新される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-005: コンテキストメニューからクエリを移動
**操作手順**:
1. クエリ「Query B」を右クリック
2. コンテキストメニューから「移動」を選択
3. 移動先フォルダ選択ダイアログで「開発環境/ユーザー管理」を選択
4. 「移動」ボタンをクリック

**期待結果**:
- ✅ クエリ「Query B」がフォルダ「開発環境/ユーザー管理」配下に移動
- ✅ Toast通知が表示される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-006: 同じフォルダにドロップした場合
**操作手順**:
1. フォルダ「開発環境」内のクエリ「Query A」をドラッグ
2. 同じフォルダ「開発環境」にドロップ

**期待結果**:
- ✅ 何も起こらない（移動しない）
- ✅ Toast通知は表示されない

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.3 フォルダ名変更テスト

#### TC-007: フォルダ名を変更
**操作手順**:
1. フォルダ「開発環境」を右クリック
2. コンテキストメニューから「名前変更」を選択
3. 新しいフォルダ名「開発」を入力
4. 「変更」ボタンをクリック

**期待結果**:
- ✅ フォルダ名が「開発」に変更される
- ✅ サブフォルダのパスも更新される（「開発/ユーザー管理」）
- ✅ フォルダ内のクエリの `folderPath` も更新される
- ✅ Toast通知「フォルダ名を変更しました」が表示される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-008: 重複するフォルダ名に変更しようとする
**操作手順**:
1. 新しいフォルダ「本番環境」を作成
2. フォルダ「開発」を右クリックして「名前変更」
3. 新しいフォルダ名「本番環境」を入力
4. 「変更」ボタンをクリック

**期待結果**:
- ✅ Toast通知「フォルダ名が重複しています」が表示される
- ✅ フォルダ名は変更されない

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.4 フォルダ削除テスト

#### TC-009: 空のフォルダを削除
**操作手順**:
1. 空のフォルダ「本番環境」を作成
2. フォルダ「本番環境」を右クリック
3. コンテキストメニューから「削除」を選択
4. 確認ダイアログで「削除」をクリック

**期待結果**:
- ✅ フォルダ「本番環境」がツリーから削除される
- ✅ Toast通知「フォルダを削除しました」が表示される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-010: クエリが含まれるフォルダを削除しようとする
**操作手順**:
1. フォルダ「開発」（クエリが含まれている）を右クリック
2. コンテキストメニューから「削除」を選択

**期待結果**:
- ✅ Toast通知「フォルダを削除できません。フォルダ内に○件のクエリが含まれています」が表示される
- ✅ フォルダは削除されない

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.5 展開/折りたたみテスト

#### TC-011: フォルダを展開/折りたたみ
**操作手順**:
1. フォルダ「開発」をクリックして展開
2. サブフォルダとクエリが表示されることを確認
3. もう一度フォルダ「開発」をクリックして折りたたみ

**期待結果**:
- ✅ 展開時：サブフォルダとクエリが表示される
- ✅ 展開時：フォルダアイコンが「📂」に変わる
- ✅ 折りたたみ時：サブフォルダとクエリが非表示になる
- ✅ 折りたたみ時：フォルダアイコンが「📁」に変わる
- ✅ 展開/折りたたみの反応が100ms以内

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-012: 展開状態の永続化
**操作手順**:
1. フォルダ「開発」を展開
2. ブラウザをリロードまたはアプリを再起動
3. 保存クエリパネルを開く

**期待結果**:
- ✅ フォルダ「開発」が展開された状態で表示される
- ✅ LocalStorage（`sqlEditorExpandedFolders`）に保存されている

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.6 検索・フィルタテスト

#### TC-013: クエリ名で検索
**操作手順**:
1. 検索ボックスに「Query A」と入力

**期待結果**:
- ✅ クエリ「Query A」を含むノードのみ表示される
- ✅ 親フォルダが自動的に展開される
- ✅ フォルダ階層は維持される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-014: タグでフィルタ
**操作手順**:
1. クエリのタグ「開発」をクリックしてフィルタ

**期待結果**:
- ✅ タグ「開発」を持つクエリのみ表示される
- ✅ フォルダ階層は維持される
- ✅ 空のフォルダは表示されない（オプション）

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-015: 検索とフィルタのクリア
**操作手順**:
1. 検索ボックスに「Query」と入力
2. タグ「開発」でフィルタ
3. 「×」ボタンをクリックしてクリア

**期待結果**:
- ✅ 全てのクエリが表示される
- ✅ フィルタが解除される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.7 既存機能の回帰テスト

#### TC-016: クエリの保存
**操作手順**:
1. SQLエディタでクエリを入力
2. 「保存」ボタンをクリック
3. クエリ名「新規クエリ」を入力
4. 「保存」ボタンをクリック

**期待結果**:
- ✅ クエリが保存される
- ✅ ルート直下に表示される（`folderPath: null`）
- ✅ Toast通知が表示される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-017: クエリの読み込み
**操作手順**:
1. 保存クエリパネルでクエリ「Query A」をクリック

**期待結果**:
- ✅ クエリがエディタに読み込まれる
- ✅ 読み込み中のクエリとして上部に表示される
- ✅ Toast通知「クエリを読み込みました」が表示される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-018: クエリの実行
**操作手順**:
1. クエリ「Query A」の実行ボタン（▶）をクリック

**期待結果**:
- ✅ クエリが実行される
- ✅ 結果パネルに結果が表示される
- ✅ 実行履歴に追加される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-019: クエリの削除
**操作手順**:
1. クエリ「Query C」の削除ボタン（🗑）をクリック
2. 確認ダイアログで「削除」をクリック

**期待結果**:
- ✅ クエリが削除される
- ✅ ツリーから消える
- ✅ Toast通知「クエリを削除しました」が表示される

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.8 クエリビルダーとの連携テスト

#### TC-020: クエリビルダーで作成したフォルダがSQLエディタで表示される
**操作手順**:
1. クエリビルダー画面を開く
2. 保存クエリのフォルダ「テスト環境」を作成
3. SQLエディタ画面に戻る
4. 保存クエリパネルを開く

**期待結果**:
- ✅ フォルダ「テスト環境」がSQLエディタのツリーに表示される
- ✅ データが共有されている

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-021: SQLエディタで作成したフォルダがクエリビルダーで表示される
**操作手順**:
1. SQLエディタでフォルダ「統合テスト」を作成
2. クエリビルダー画面を開く
3. 保存クエリパネルを開く

**期待結果**:
- ✅ フォルダ「統合テスト」がクエリビルダーのツリーに表示される（UIが実装されていれば）
- ✅ データが共有されている

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

### 2.9 パフォーマンステスト

#### TC-022: 大量のクエリでのパフォーマンス
**操作手順**:
1. 1000件のテストクエリを作成（スクリプトで自動生成）
2. 保存クエリパネルを開く
3. ツリー表示の速度を計測

**期待結果**:
- ✅ 初回ロードが1秒以内
- ✅ UIが固まらない
- ✅ スクロールが滑らか

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

#### TC-023: フォルダ展開のパフォーマンス
**操作手順**:
1. 100個のクエリを含むフォルダを作成
2. フォルダをクリックして展開
3. 反応時間を計測

**期待結果**:
- ✅ 展開が100ms以内
- ✅ UIが固まらない

**実際の結果**:
- [ ] 合格 / [ ] 不合格

---

## 3. 自動テスト（ユニットテスト）

### 3.1 ストアのテスト

**ファイル**: `tests/stores/sql-editor.spec.ts`

#### UT-001: queryTree Getter
```typescript
describe('queryTree Getter', () => {
  it('フォルダとクエリを正しくツリー構造に変換する', () => {
    // テストコード
  })

  it('展開状態が正しく設定される', () => {
    // テストコード
  })

  it('フォルダ内のクエリ数をカウントする', () => {
    // テストコード
  })

  it('ソート順が正しい（フォルダ優先、アルファベット順）', () => {
    // テストコード
  })
})
```

#### UT-002: フォルダ操作アクション
```typescript
describe('フォルダ操作', () => {
  it('fetchFolders でフォルダ一覧を取得できる', async () => {
    // テストコード
  })

  it('moveSavedQuery でクエリを移動できる', async () => {
    // テストコード
  })

  it('renameFolder でフォルダ名を変更できる', async () => {
    // テストコード
  })

  it('renameFolder で重複チェックが動作する', async () => {
    // テストコード
  })

  it('deleteFolder で空のフォルダを削除できる', async () => {
    // テストコード
  })

  it('deleteFolder で空でないフォルダは削除できない', async () => {
    // テストコード
  })
})
```

#### UT-003: 展開状態管理
```typescript
describe('展開状態管理', () => {
  it('toggleFolderExpansion で展開状態を切り替えられる', () => {
    // テストコード
  })

  it('saveExpandedFolders で LocalStorage に保存される', () => {
    // テストコード
  })

  it('loadExpandedFolders で LocalStorage から復元される', () => {
    // テストコード
  })
})
```

---

## 4. テスト結果サマリ

### 手動テスト結果
| テストID | テスト項目 | 結果 | 備考 |
|---------|----------|------|------|
| TC-001  | フォルダ作成 | - | |
| TC-002  | サブフォルダ作成 | - | |
| TC-003  | 禁止文字チェック | - | |
| TC-004  | D&Dでクエリ移動 | - | |
| TC-005  | メニューからクエリ移動 | - | |
| TC-006  | 同じフォルダにドロップ | - | |
| TC-007  | フォルダ名変更 | - | |
| TC-008  | 重複フォルダ名チェック | - | |
| TC-009  | 空フォルダ削除 | - | |
| TC-010  | 非空フォルダ削除 | - | |
| TC-011  | 展開/折りたたみ | - | |
| TC-012  | 展開状態永続化 | - | |
| TC-013  | クエリ名検索 | - | |
| TC-014  | タグフィルタ | - | |
| TC-015  | フィルタクリア | - | |
| TC-016  | クエリ保存 | - | |
| TC-017  | クエリ読み込み | - | |
| TC-018  | クエリ実行 | - | |
| TC-019  | クエリ削除 | - | |
| TC-020  | QB→SQLエディタ連携 | - | |
| TC-021  | SQLエディタ→QB連携 | - | |
| TC-022  | 大量データパフォーマンス | - | |
| TC-023  | フォルダ展開パフォーマンス | - | |

### 自動テスト結果
| テストID | テスト項目 | 結果 | 備考 |
|---------|----------|------|------|
| UT-001  | queryTree Getter | - | |
| UT-002  | フォルダ操作アクション | - | |
| UT-003  | 展開状態管理 | - | |

---

## 5. バグ報告テンプレート

### バグID: BUG-XXX
**テストケース**: TC-XXX
**概要**: （バグの概要）
**再現手順**:
1. 手順1
2. 手順2
3. 手順3

**期待結果**: （期待される動作）
**実際の結果**: （実際に起きた動作）
**スクリーンショット**: （該当する場合）
**優先度**: 高 / 中 / 低
**発見日**: YYYY-MM-DD

---

## 付録: テストデータ生成スクリプト

大量のテストデータを生成するためのスクリプト例：

```typescript
// scripts/generate-test-queries.ts
import { queryStorageApi } from '@/api/query-storage'

async function generateTestQueries(count: number) {
  for (let i = 0; i < count; i++) {
    await queryStorageApi.saveQuery({
      name: `Test Query ${i}`,
      description: `This is test query ${i}`,
      tags: [`tag${i % 10}`],
      connectionId: 'test-connection-id',
      query: {
        selectedTables: [],
        selectedColumns: [],
        // ... 他のフィールド
      },
    })
  }
}

// 実行: generateTestQueries(1000)
```
