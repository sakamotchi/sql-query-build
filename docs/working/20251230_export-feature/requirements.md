# フェーズ5: エクスポート機能 - 要件定義書

**作成日**: 2025-12-30
**作業ディレクトリ**: `docs/working/20251230_export-feature/`
**WBS参照**: `docs/sql_editor_wbs_v3.md` Phase 5

## 1. 概要

クエリ実行結果をCSV/Excel/JSON形式でエクスポートする機能を実装します。

## 2. 目的

- クエリ実行結果を外部ファイルとして保存可能にする
- 複数のファイル形式に対応し、用途に応じた選択を可能にする
- 大量データのエクスポート時にも快適な操作体験を提供する

## 3. 前提条件

- **依存フェーズ**: Phase 2（クエリ実行・結果表示）完了済み
- **前提システム**:
  - Tauri 2.x環境
  - `tauri-plugin-dialog`でファイル保存ダイアログ使用可能
  - Rustでのファイル書き込み処理が実装可能

## 4. 機能要件

### 4.1 サポートするファイル形式

| 形式 | 拡張子 | 用途 |
|------|-------|------|
| CSV | `.csv` | 汎用的なデータ交換、Excelでの読み込み |
| Excel | `.xlsx` | Excelネイティブ形式、書式設定可能 |
| JSON | `.json` | プログラムでの処理、API連携 |

### 4.2 エクスポート機能仕様

#### 4.2.1 CSV出力
- UTF-8 BOM付き（Excelでの文字化け防止）
- カンマ区切り、ダブルクォート囲み
- ヘッダー行にカラム名を出力
- NULL値は空文字列として出力
- 改行を含む値は適切にエスケープ

#### 4.2.2 Excel出力
- `.xlsx`形式（OpenXML）
- 先頭行にカラム名（太字）
- カラム幅の自動調整
- 日付・数値型の自動判定
- NULL値は空セルとして出力

#### 4.2.3 JSON出力
- オブジェクト配列形式: `[{"col1": "value1", ...}, ...]`
- Pretty-print（インデント2スペース）
- NULL値は`null`として出力
- UTF-8エンコーディング

### 4.3 UI要件

#### 4.3.1 エクスポートボタン
- **配置**: ResultPanel内の右上
- **表示条件**: クエリ実行結果が存在する場合のみ表示
- **アイコン**: ダウンロードアイコン
- **ラベル**: "Export"

#### 4.3.2 ExportDialog
- **トリガー**: Exportボタンクリック時に表示
- **内容**:
  - ファイル形式選択（CSV/Excel/JSON）
  - エクスポート対象行数の表示
  - オプション設定（将来拡張用）
  - Export/Cancelボタン

#### 4.3.3 ファイル保存ダイアログ
- **タイミング**: ExportDialogでExportボタンクリック後
- **機能**: `tauri-plugin-dialog`の`save()`を使用
- **デフォルトファイル名**: `query_result_{timestamp}.{ext}`
- **フィルタ**: 選択された形式のみ表示

#### 4.3.4 進捗表示（大量データ時）
- **表示条件**: 10,000行以上のデータをエクスポート時
- **内容**: プログレスバー + パーセンテージ表示
- **キャンセル**: キャンセルボタンで処理中断可能

### 4.4 非機能要件

#### 4.4.1 パフォーマンス
- 1,000行程度: 1秒以内
- 10,000行程度: 5秒以内
- 100,000行以上: 進捗表示 + ストリーミング書き込み

#### 4.4.2 メモリ効率
- ストリーミング書き込みでメモリ使用量を抑制
- 大量データでもメモリ不足にならない設計

#### 4.4.3 エラーハンドリング
- ファイル書き込み失敗時のエラーメッセージ表示
- ディスク容量不足時の適切なエラー通知
- エクスポート中のキャンセル処理

## 5. ユースケース

### 5.1 基本的なエクスポート

1. ユーザーがクエリを実行し、結果が表示される
2. ResultPanel右上の"Export"ボタンをクリック
3. ExportDialogが開く
4. ファイル形式を選択（CSV/Excel/JSON）
5. "Export"ボタンをクリック
6. ファイル保存ダイアログが開く
7. 保存先とファイル名を指定
8. エクスポート実行、完了通知が表示される

### 5.2 大量データのエクスポート

1. 10,000行以上の結果に対してエクスポート実行
2. プログレスバーが表示される
3. バックグラウンドで書き込み処理が進行
4. 完了通知が表示される

### 5.3 エクスポートのキャンセル

1. 大量データのエクスポート中
2. ユーザーが"Cancel"ボタンをクリック
3. 処理が中断され、一部書き込まれたファイルは削除される
4. キャンセル通知が表示される

## 6. 技術要件

### 6.1 Rust側（バックエンド）

- **クレート**:
  - `csv` - CSV書き込み
  - `rust_xlsxwriter` - Excel書き込み
  - `serde_json` - JSON書き込み
- **実装場所**:
  - `src-tauri/src/services/exporter.rs` - エクスポートサービス
  - `src-tauri/src/commands/export_commands.rs` - Tauriコマンド

### 6.2 フロントエンド側

- **コンポーネント**:
  - `app/components/query-builder/dialog/ExportDialog.vue` - エクスポート設定ダイアログ
  - `app/components/query-builder/ExportProgressDialog.vue` - 進捗表示（大量データ時）
- **API**:
  - `app/api/export.ts` - エクスポートAPI
- **ストア**: 既存の`query-builder.ts`を拡張

## 7. 制約事項

- エクスポート中は他の操作をブロックしない（バックグラウンド実行）
- 同時に複数のエクスポート処理は実行しない（キューイング）
- 最大10MB程度のファイルサイズを想定（それ以上はストリーミング必須）

## 8. 将来拡張

- TSV形式対応
- カスタムCSVフォーマット（区切り文字変更）
- HTMLテーブル形式
- Markdown形式
- エクスポート設定のプリセット保存
- エクスポート履歴の記録

## 9. 参考資料

- WBS: `docs/sql_editor_wbs_v3.md` Phase 5
- 技術仕様書: `docs/03_architecture_specifications.md`
- 既存の結果表示実装: `app/components/query-builder/ResultPanel.vue`
