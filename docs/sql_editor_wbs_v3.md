# SQLエディタ開発 WBS v3.0

**プロジェクト開始日**: 2025年10月
**作成日**: 2025年12月28日
**前提**: フェーズ1.6 クエリビルダー基盤まで完了

---

## 進捗サマリー

### 完了済みフェーズ

| フェーズ | 完了日 | 主な成果物 |
|---------|--------|-----------|
| **1.1** プロジェクト環境構築 | 完了 | Nuxt 4 + Tauri 2 + Rust環境 |
| **1.2** データ永続化層実装 | 完了 | FileStorage, PathManager |
| **1.3** 接続管理機能 | 完了 | ConnectionService, CRUD API |
| **1.4** 環境別テーマシステム | 完了 | 4環境カラー、ダークモード |
| **1.5** マルチウィンドウ機能 | 完了 | WindowManager, ウィンドウ状態保存 |
| **1.5a** セキュリティ情報格納方式変更 | 完了 | SecurityProvider（Simple/MasterPassword/Keychain） |
| **1.5b** Nuxt + Nuxt UI v4 フレッシュスタート | 完了 | 全コンポーネントをNuxt UIに移行 |
| **1.6** クエリビルダー基盤 | 完了 | SQL生成エンジン、DB方言対応 |
| **2** クエリ実行・結果表示 | 完了 | QueryExecutor、ResultTable UI |
| **3** 本番環境安全機能 | 完了 | QueryAnalyzer、DangerousQueryDialog |
| **4.1-4.2** クエリ保存・管理UI | 2025-12-30 | QueryStorage、SaveQueryDialog、SavedQuerySlideover |

### 1.6 詳細実装状況

| 機能 | 状態 | 実装内容 |
|------|------|---------|
| クエリビルダーレイアウト | ✅ | 3カラムレイアウト、リサイズ可能パネル |
| データベース構造取得API | ✅ | PostgreSQL/MySQL/SQLite対応 |
| データベースツリー | ✅ | スキーマ/テーブル/カラム階層表示 |
| テーブル選択機能 | ✅ | ドラッグ&ドロップ、TableCard |
| カラム選択UI | ✅ | チェックボックス選択、順序変更 |
| WHERE条件設定UI | ✅ | 条件行/グループ/ネスト対応 |
| GROUP BY設定UI | ✅ | カラム選択、複数カラム対応 |
| ORDER BY設定UI | ✅ | ASC/DESC、複数カラム対応 |
| LIMIT設定UI | ✅ | 件数制限、OFFSET対応 |
| クエリオブジェクトモデル | ✅ | QueryModel型定義 |
| SQL生成エンジン | ✅ | SELECT/FROM/JOIN/WHERE/GROUP BY/HAVING/ORDER BY/LIMIT |
| DB方言対応 | ✅ | PostgresDialect/MysqlDialect/SqliteDialect |

---

## 今後のフェーズ

| Phase | 名称 | 優先度 | 依存 | 状態 |
|-------|------|--------|------|------|
| **2** | クエリ実行・結果表示 | 最高 | 1.6 | ✅ 完了 |
| **3** | 本番環境安全機能 | 高 | 2, 8 | ✅ 完了 |
| **4.1-4.2** | クエリ保存・管理UI | 中 | 2 | ✅ 完了 |
| **4.3** | クエリ履歴機能 | 中 | 4.1-4.2 | 📝 次のフェーズ |
| **5** | エクスポート機能 | 中 | 2 | 📝 待機中 |
| **6** | JOIN設定UI拡張 | 中 | 2 | 📝 待機中 |
| **7** | 監査ログ・UX改善 | 低 | 3 | 📝 待機中 |
| **8** | データ変更クエリビルダー | 低 | 7 | 📝 待機中 |

---

## フェーズ2: クエリ実行・結果表示

**目的**: 生成されたSQLを実際に実行し、結果を表示する

### 2.1 クエリ実行基盤（Rust）

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 2.1.1 | QueryExecutor トレイト定義 | - | 各DB共通のクエリ実行インターフェース定義 |
| 2.1.2 | PostgreSQL QueryExecutor実装 | 2.1.1 | PostgreSQLでSELECT実行可能 |
| 2.1.3 | MySQL QueryExecutor実装 | 2.1.1 | MySQLでSELECT実行可能 |
| 2.1.4 | SQLite QueryExecutor実装 | 2.1.1 | SQLiteでSELECT実行可能 |
| 2.1.5 | execute_query Tauriコマンド | 2.1.2-4 | フロントエンドからクエリ実行可能 |
| 2.1.6 | 接続プール管理 | 2.1.5 | 接続の効率的な再利用 |
| 2.1.7 | タイムアウト・キャンセル機能 | 2.1.6 | 長時間クエリのキャンセル可能 |

**参照ファイル**:
- `src-tauri/src/services/database_inspector.rs` - パターン参考
- `src-tauri/src/database/postgresql_inspector.rs` - sqlx接続パターン

### 2.2 結果表示UI

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 2.2.1 | QueryResult型定義（フロントエンド） | 2.1.5 | TypeScript型定義完了 |
| 2.2.2 | queryApi.executeQuery実装 | 2.1.5 | Tauri IPCラッパー |
| 2.2.3 | ResultTable.vue コンポーネント | 2.2.1 | 結果データを表形式で表示 |
| 2.2.4 | ResultColumnHeader.vue | 2.2.3 | カラムヘッダー表示（型情報含む） |
| 2.2.5 | ResultRow.vue | 2.2.3 | 行データ表示、NULL表示対応 |
| 2.2.6 | Pagination.vue | 2.2.3 | ページネーションUI |
| 2.2.7 | ResultPanel.vue拡張 | 2.2.3-6 | 既存パネルに結果表示統合 |
| 2.2.8 | query-builderストア executeQuery実装 | 2.2.7 | TODOコメント部分の実装 |

**参照ファイル**:
- `app/components/query-builder/ResultPanel.vue` - 拡張対象
- `app/stores/query-builder.ts` - executeQuery実装（L481-498のTODO）

### 2.3 エラーハンドリング

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 2.3.1 | QueryError型定義 | 2.2.1 | エラー種別の分類 |
| 2.3.2 | エラー表示UI | 2.3.1 | わかりやすいエラーメッセージ表示 |
| 2.3.3 | 構文エラーハイライト | 2.3.2 | エラー位置を視覚化 |

**成果物**:
- QueryExecutorトレイトと各DB実装
- execute_query Tauriコマンド
- ResultTable/Pagination UIコンポーネント
- エラー表示UI

**完了条件**:
- ✅ PostgreSQL/MySQL/SQLiteでSELECT実行可能
- ✅ 結果が表形式で表示される
- ✅ ページネーションが動作する
- ✅ エラーメッセージが適切に表示される

---

## フェーズ3: 本番環境安全機能

**目的**: 本番環境での誤操作を防止する

### 3.1 クエリ種別検出

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 3.1.1 | QueryAnalyzer実装（Rust） | Phase 2 | UPDATE/DELETE/DROP/TRUNCATEを検出 |
| 3.1.2 | analyze_queryコマンド | 3.1.1 | クエリの危険度を判定 |
| 3.1.3 | 危険度レベル定義 | 3.1.2 | Safe/Warning/Danger |

### 3.2 確認ダイアログ

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 3.2.1 | DangerousQueryDialog.vue | 3.1.3 | 2段階確認ダイアログ |
| 3.2.2 | 遅延実行ボタン | 3.2.1 | 3秒待機後に有効化 |
| 3.2.3 | 影響行数表示 | 3.2.1 | EXPLAIN結果の表示 |

### 3.3 環境別安全設定

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 3.3.1 | SafetySettings型定義 | 3.2.3 | 環境別設定データ構造 |
| 3.3.2 | SafetySettingsPanel.vue | 3.3.1 | 設定UI |
| 3.3.3 | 安全機能統合テスト | 3.3.2 | 誤操作防止を確認 |

**成果物**:
- QueryAnalyzerと危険度判定
- DangerousQueryDialog
- 環境別安全設定UI

**完了条件**:
- ✅ UPDATE/DELETE/DROPが検出される
- ✅ 本番環境で確認ダイアログが表示される
- ✅ 実行ボタンが3秒間無効化される

---

## フェーズ4: クエリ保存・履歴

**目的**: クエリの保存・再利用と履歴管理

### 4.1 クエリ保存機能 ✅

| タスクID | タスク名 | 依存関係 | 完了条件 | 状態 |
|---------|---------|---------|---------|------|
| 4.1.1 | SavedQuery型定義（Rust） | Phase 2 | JSON構造確定 | ✅ |
| 4.1.2 | QueryStorage実装 | 4.1.1 | ファイルへの保存/読み込み | ✅ |
| 4.1.3 | save_query/load_queryコマンド | 4.1.2 | Tauriコマンド | ✅ |

**実装ファイル**:
- `src-tauri/src/models/saved_query.rs` - SavedQuery型定義
- `src-tauri/src/services/query_storage.rs` - QueryStorageサービス
- `src-tauri/src/commands/query_storage_commands.rs` - Tauriコマンド

### 4.2 クエリ管理UI ✅

| タスクID | タスク名 | 依存関係 | 完了条件 | 状態 |
|---------|---------|---------|---------|------|
| 4.2.1 | SaveQueryDialog.vue | 4.1.3 | 名前/説明/タグ入力UI | ✅ |
| 4.2.2 | SavedQuerySlideover.vue | 4.1.3 | 保存済みクエリ一覧 | ✅ |
| 4.2.3 | 検索・フィルタ機能 | 4.2.2 | 名前/タグで検索 | ✅ (4.2.2に統合) |
| 4.2.4 | ToolbarにSave/Loadボタン統合 | 4.2.1-3 | 既存TODOの解消 | ✅ |

**実装ファイル**:
- `app/components/query-builder/dialog/SaveQueryDialog.vue` - 保存ダイアログ
- `app/components/query-builder/SavedQuerySlideover.vue` - 一覧・検索（統合型）
- `app/components/query-builder/QueryBuilderToolbar.vue` - 保存/読み込みボタン
- `app/stores/saved-query.ts` - Piniaストア
- `app/api/query-storage.ts` - API実装
- `app/types/saved-query.ts` - 型定義

**実装メモ**:
- 4.2.3の検索機能は`SavedQuerySlideover.vue`内に統合実装（独立コンポーネントは不要と判断）

### 4.3 履歴機能

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 4.3.1 | QueryHistory型定義 | 4.1.1 | 履歴データ構造 |
| 4.3.2 | 自動履歴記録 | 4.3.1 | 実行時に自動記録 |
| 4.3.3 | HistoryPanel.vue | 4.3.2 | 履歴一覧表示 |
| 4.3.4 | 履歴からの復元 | 4.3.3 | クリックで復元 |
| 4.3.5 | ToolbarにHistoryボタン統合 | 4.3.4 | 既存TODOの解消 |

**参照ファイル**:
- `app/components/query-builder/QueryBuilderToolbar.vue` - L46のTODO

**成果物**:
- QueryStorageとTauriコマンド
- SaveQueryDialog/SavedQueryList UI
- HistoryPanel UI

**完了条件**:
- ✅ クエリを名前付きで保存できる
- ✅ 保存済みクエリを一覧表示・検索できる
- ✅ 実行履歴が自動記録される
- ✅ 履歴からクエリを復元できる

---

## フェーズ5: エクスポート機能

**目的**: 結果データのエクスポート

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 5.1 | CSVエクスポート実装（Rust） | Phase 2 | CSV出力可能 |
| 5.2 | Excelエクスポート実装（Rust） | 5.1 | XLSX出力可能 |
| 5.3 | JSONエクスポート実装 | 5.1 | JSON出力可能 |
| 5.4 | ExportDialog.vue | 5.1-3 | 形式選択UI |
| 5.5 | ファイル保存ダイアログ連携 | 5.4 | tauri-plugin-dialog使用 |
| 5.6 | 大量データ時の進捗表示 | 5.5 | プログレスバー |

**成果物**:
- CSV/Excel/JSONエクスポート機能
- ExportDialog UI
- 進捗表示

**完了条件**:
- ✅ 結果をCSV/Excel/JSONで出力できる
- ✅ ファイル保存先を選択できる
- ✅ 大量データ時に進捗が表示される

---

## フェーズ6: JOIN設定UI拡張

**目的**: JOIN設定のビジュアル編集機能

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 6.1 | TableCanvas.vue | Phase 2 | ドラッグ可能なキャンバス |
| 6.2 | テーブル位置管理 | 6.1 | 位置記憶、自動配置 |
| 6.3 | リレーション線描画 | 6.2 | JOIN関係を線で表示 |
| 6.4 | JoinConfigDialog.vue | 6.3 | JOIN種別/条件設定 |
| 6.5 | JoinConditionRow.vue | 6.4 | ON条件の設定行 |
| 6.6 | 自動JOIN提案 | 6.5 | 外部キーベースの提案 |

**参照ファイル**:
- `app/stores/query-builder.ts` - L373のTODO

**成果物**:
- TableCanvas/リレーション線描画
- JoinConfigDialog UI
- 自動JOIN提案

**完了条件**:
- ✅ キャンバス上でテーブルをドラッグ配置できる
- ✅ JOIN関係が線で可視化される
- ✅ JOIN設定ダイアログでINNER/LEFT/RIGHT/FULLを選択できる
- ✅ 外部キーからJOIN条件が自動提案される

---

## フェーズ7: 監査ログ・UX改善

**目的**: 監査機能と操作性改善

### 7.1 監査ログ

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 7.1.1 | AuditLog型定義 | Phase 3 | ログデータ構造 |
| 7.1.2 | 監査ログ記録 | 7.1.1 | 全操作を記録 |
| 7.1.3 | LogViewer.vue | 7.1.2 | ログ一覧表示 |
| 7.1.4 | ログエクスポート | 7.1.3 | CSV出力 |

### 7.2 パフォーマンス最適化

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 7.2.1 | 起動時間最適化 | - | 3秒以内に起動 |
| 7.2.2 | 仮想スクロール実装 | Phase 2 | 大量データ表示最適化 |
| 7.2.3 | バンドルサイズ最適化 | - | アプリサイズ削減 |

### 7.3 UX改善

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 7.3.1 | キーボードショートカット | - | 主要操作がショートカット可能 |
| 7.3.2 | ツールチップ追加 | - | 全機能に説明追加 |
| 7.3.3 | 初心者向けガイド | 7.3.2 | ウォークスルー表示 |
| 7.3.4 | アクセシビリティ対応 | 7.3.3 | WCAG 2.1準拠 |

**成果物**:
- 監査ログシステム
- パフォーマンス最適化
- UX改善（ショートカット、ツールチップ等）

**完了条件**:
- ✅ 全操作が監査ログに記録される
- ✅ 起動が3秒以内
- ✅ キーボードショートカットが動作する
- ✅ WCAG 2.1準拠

---

## フェーズ8: データ変更クエリビルダー

**目的**: INSERT/UPDATE/DELETEクエリをGUIで構築する機能を追加

**前提**:
- SELECTビルダー（Phase 1.6）とは別のUIとして設計
- 本番環境安全機能（Phase 3）と連携して危険なクエリの確認ダイアログを表示

### 8.1 共通基盤

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 8.1.1 | クエリ種別選択UI | Phase 7 | SELECT/INSERT/UPDATE/DELETEの切り替えUI |
| 8.1.2 | MutationQueryModel型定義 | 8.1.1 | INSERT/UPDATE/DELETE共通のデータ構造 |
| 8.1.3 | mutation-query-builderストア | 8.1.2 | データ変更クエリ用の状態管理 |

### 8.2 INSERTビルダー

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 8.2.1 | InsertBuilderPanel.vue | 8.1.3 | INSERTビルダーUI |
| 8.2.2 | テーブル選択（単一） | 8.2.1 | 挿入先テーブル選択 |
| 8.2.3 | カラム・値入力UI | 8.2.2 | カラムごとの値入力 |
| 8.2.4 | 複数行INSERT対応 | 8.2.3 | VALUES句の複数行対応 |
| 8.2.5 | INSERT SQL生成（Rust） | 8.2.4 | INSERT文生成エンジン |

### 8.3 UPDATEビルダー

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 8.3.1 | UpdateBuilderPanel.vue | 8.1.3 | UPDATEビルダーUI |
| 8.3.2 | SET句設定UI | 8.3.1 | カラム=値のペア設定 |
| 8.3.3 | WHERE条件設定（既存流用） | 8.3.2 | WHERE句設定（SELECTと共通化） |
| 8.3.4 | UPDATE SQL生成（Rust） | 8.3.3 | UPDATE文生成エンジン |

### 8.4 DELETEビルダー

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 8.4.1 | DeleteBuilderPanel.vue | 8.1.3 | DELETEビルダーUI |
| 8.4.2 | テーブル選択（単一） | 8.4.1 | 削除対象テーブル選択 |
| 8.4.3 | WHERE条件設定（既存流用） | 8.4.2 | WHERE句設定（SELECTと共通化） |
| 8.4.4 | DELETE SQL生成（Rust） | 8.4.3 | DELETE文生成エンジン |

### 8.5 安全機能統合

| タスクID | タスク名 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| 8.5.1 | Phase 3確認ダイアログ統合 | 8.2-8.4 | 危険なクエリ実行時に確認ダイアログ表示 |
| 8.5.2 | 影響行数プレビュー | 8.5.1 | EXPLAIN結果で影響行数を事前表示 |
| 8.5.3 | 統合テスト | 8.5.2 | 全機能の動作確認 |

**成果物**:
- クエリ種別選択UI
- InsertBuilderPanel/UpdateBuilderPanel/DeleteBuilderPanel
- INSERT/UPDATE/DELETE SQL生成エンジン（Rust）
- Phase 3安全機能との統合

**完了条件**:
- ✅ GUIでINSERT文を構築・実行できる
- ✅ GUIでUPDATE文を構築・実行できる
- ✅ GUIでDELETE文を構築・実行できる
- ✅ 危険なクエリ実行時に確認ダイアログが表示される
- ✅ WHERE句のないUPDATE/DELETEは特に強い警告が表示される

---

## マイルストーン

| マイルストーン | フェーズ | 成果物 |
|---------------|---------|--------|
| M1: クエリ実行可能 | Phase 2完了 | SQL実行と結果表示 |
| M2: 安全機能完備 | Phase 3完了 | 本番環境での誤操作防止 |
| M3: クエリ保存可能 | Phase 4完了 | クエリの保存・再利用 |
| M4: エクスポート可能 | Phase 5完了 | CSV/Excel/JSON出力 |
| M5: JOIN設定強化 | Phase 6完了 | ビジュアルJOIN設定 |
| M6: v1.0リリース候補 | Phase 7完了 | 製品版準備完了 |
| M7: データ変更対応 | Phase 8完了 | INSERT/UPDATE/DELETEビルダー |

---

## リスク管理

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 |
|---------|-----------|--------|---------|------|
| R1 | 大量データ表示時のパフォーマンス問題 | 高 | 中 | 仮想スクロールを早期実装（Phase 2.2で考慮） |
| R2 | 接続プール管理の複雑性 | 中 | 中 | sqlxの既存パターンを参照 |
| R3 | クエリキャンセル時のリソースリーク | 中 | 低 | Tokioのabort機構を使用 |
| R4 | 本番環境でのDROPクエリ誤実行 | 高 | 低 | Phase 3を優先度高に設定 |
| R5 | Excelエクスポートのクレート互換性 | 低 | 中 | rust_xlsxwriter等の安定版を使用 |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 承認者 |
|------|----------|---------|--------|
| 2025-10-05 | 1.0 | 初版作成 | - |
| 2025-11-24 | 1.1 | 1.5aフェーズ追加 | - |
| 2025-12-06 | 1.2 | 1.5bフェーズ追加 | - |
| 2025-12-07 | 2.0 | 1.5bフェーズ再設計（フレッシュスタート方式） | - |
| 2025-12-28 | **3.0** | **実装状況反映・フェーズ再構成** | - |
| 2025-12-29 | **3.1** | **Phase 8（データ変更クエリビルダー）追加** | - |
| 2025-12-30 | **3.2** | **Phase 4.1-4.2完了状態を反映** | - |

### v3.2 主な変更点

1. **Phase 4.1-4.2完了**: クエリ保存機能とクエリ管理UI実装完了を反映
2. **実装ファイル一覧追加**: 4.1と4.2セクションに実装ファイルリスト追加
3. **次フェーズ明確化**: Phase 4.3（履歴機能）が次のフェーズと明示
4. **完了済みフェーズ更新**: Phase 2, 3, 4.1-4.2を完了済みに追加

### v3.1 主な変更点

1. **Phase 8追加**: INSERT/UPDATE/DELETEビルダーを新フェーズとして追加
2. **Phase 3依存関係更新**: 確認ダイアログ機能はPhase 8のUIがあって初めて活用可能
3. **マイルストーンM7追加**: データ変更対応マイルストーン

### v3.0 主な変更点

1. **完了済みタスクの整理**: フェーズ1.1〜1.6を進捗サマリーに移動
2. **フェーズ再番号付け**: Phase 2から開始
3. **タスク統合**: 重複していたSQL実行関連タスクを統合
4. **優先度明確化**: クエリ実行→安全機能→保存/履歴の順に整理
5. **依存関係整理**: 各タスクの前後関係を明確化

---

**次のアクション**: Phase 4.3.1 QueryHistory型定義の開始
