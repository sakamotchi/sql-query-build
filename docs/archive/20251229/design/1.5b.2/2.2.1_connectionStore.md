# タスク1.5b.2.2.1: connectionストア移行

**サブフェーズ**: 2.2 Piniaストア移行
**工数**: 3時間
**優先度**: 高
**依存関係**: 2.1.2 (useTauri), 2.1.3 (型定義)

---

## 目的

接続情報の管理ストアを実装

---

## 実装内容

### ファイル作成: `app/stores/connection.ts`

```typescript
import { defineStore } from 'pinia'
import type { Connection } from '~/types'

export const useConnectionStore = defineStore('connection', {
  state: () => ({
    connections: [] as Connection[],
    activeConnection: null as Connection | null,
    loading: false,
    error: null as string | null
  }),

  getters: {
    /**
     * 環境別の接続リストを取得
     */
    connectionsByEnvironment: (state) => (env: string) => {
      return state.connections.filter(c => c.environment === env)
    },

    /**
     * IDで接続を取得
     */
    getConnectionById: (state) => (id: string) => {
      return state.connections.find(c => c.id === id)
    }
  },

  actions: {
    /**
     * 接続リストをロード
     */
    async loadConnections() {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        this.connections = await invokeCommand<Connection[]>('get_connections')
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Unknown error'
        console.error('Failed to load connections:', error)
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続を作成
     */
    async createConnection(connection: Omit<Connection, 'id' | 'createdAt' | 'updatedAt'>) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        const newConnection = await invokeCommand<Connection>('create_connection', { connection })
        this.connections.push(newConnection)
        return newConnection
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to create connection'
        console.error('Failed to create connection:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続を更新
     */
    async updateConnection(id: string, updates: Partial<Connection>) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        const updated = await invokeCommand<Connection>('update_connection', { id, updates })

        const index = this.connections.findIndex(c => c.id === id)
        if (index !== -1) {
          this.connections[index] = updated
        }

        return updated
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to update connection'
        console.error('Failed to update connection:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続を削除
     */
    async deleteConnection(id: string) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        await invokeCommand('delete_connection', { id })
        this.connections = this.connections.filter(c => c.id !== id)

        if (this.activeConnection?.id === id) {
          this.activeConnection = null
        }
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to delete connection'
        console.error('Failed to delete connection:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * 接続をテスト
     */
    async testConnection(connection: Connection | Omit<Connection, 'id' | 'createdAt' | 'updatedAt'>) {
      try {
        const { invokeCommand } = useTauri()
        return await invokeCommand('test_connection', { connection })
      } catch (error) {
        console.error('Connection test failed:', error)
        throw error
      }
    },

    /**
     * アクティブな接続を設定
     */
    setActiveConnection(connection: Connection | null) {
      this.activeConnection = connection
    }
  }
})
```

---

## 確認事項

- [ ] ファイルが作成されたか
- [ ] CRUD操作が実装されているか
- [ ] Tauri IPCと連携しているか
- [ ] エラーハンドリングが適切か
- [ ] loadingとerror状態が管理されているか

---

## 成果物

- `app/stores/connection.ts`

---

## ストア構成

### State
- `connections`: 接続リスト
- `activeConnection`: アクティブな接続
- `loading`: ローディング状態
- `error`: エラーメッセージ

### Getters
- `connectionsByEnvironment(env)`: 環境でフィルタリング
- `getConnectionById(id)`: IDで接続を取得

### Actions
- `loadConnections()`: 接続リストをロード
- `createConnection()`: 新規接続を作成
- `updateConnection()`: 接続を更新
- `deleteConnection()`: 接続を削除
- `testConnection()`: 接続テスト
- `setActiveConnection()`: アクティブ接続を設定

---

## Tauri IPCコマンド一覧

| コマンド名 | 引数 | 戻り値 |
|-----------|------|--------|
| `get_connections` | なし | `Connection[]` |
| `create_connection` | `{ connection }` | `Connection` |
| `update_connection` | `{ id, updates }` | `Connection` |
| `delete_connection` | `{ id }` | `void` |
| `test_connection` | `{ connection }` | `ConnectionTestResult` |

---

## 次のタスク

→ [2.2.2: themeストア移行](2.2.2_themeStore.md)
