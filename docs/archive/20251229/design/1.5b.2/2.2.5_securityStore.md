# タスク1.5b.2.2.5: securityストア移行

**サブフェーズ**: 2.2 Piniaストア移行
**工数**: 2時間
**優先度**: 高
**依存関係**: 2.1.3 (型定義)

---

## 目的

セキュリティプロバイダーの管理を実装

---

## 実装内容

### ファイル作成: `app/stores/security.ts`

```typescript
import { defineStore } from 'pinia'
import type { SecuritySettings, SecurityProvider, SecurityLevel } from '~/types'

export const useSecurityStore = defineStore('security', {
  state: () => ({
    settings: {
      provider: 'system',
      level: 'medium',
      masterPasswordSet: false
    } as SecuritySettings,
    loading: false,
    error: null as string | null
  }),

  getters: {
    /**
     * 現在のセキュリティ設定
     */
    currentSettings: (state) => state.settings,

    /**
     * セキュリティプロバイダー
     */
    currentProvider: (state) => state.settings.provider,

    /**
     * セキュリティレベル
     */
    currentLevel: (state) => state.settings.level,

    /**
     * マスターパスワードが設定されているか
     */
    isMasterPasswordSet: (state) => state.settings.masterPasswordSet
  },

  actions: {
    /**
     * セキュリティ設定をロード
     */
    async loadSettings() {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        const settings = await invokeCommand<SecuritySettings>('get_security_settings')
        if (settings) {
          this.settings = settings
        }
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to load security settings'
        console.error('Failed to load security settings:', error)
      } finally {
        this.loading = false
      }
    },

    /**
     * セキュリティプロバイダーを設定
     */
    async setProvider(provider: SecurityProvider) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        await invokeCommand('set_security_provider', { provider })
        this.settings.provider = provider
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to set security provider'
        console.error('Failed to set security provider:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * セキュリティレベルを設定
     */
    async setLevel(level: SecurityLevel) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        await invokeCommand('set_security_level', { level })
        this.settings.level = level
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to set security level'
        console.error('Failed to set security level:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * マスターパスワードを設定
     */
    async setMasterPassword(password: string) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        await invokeCommand('set_master_password', { password })
        this.settings.masterPasswordSet = true
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to set master password'
        console.error('Failed to set master password:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * マスターパスワードを検証
     */
    async verifyMasterPassword(password: string): Promise<boolean> {
      try {
        const { invokeCommand } = useTauri()
        return await invokeCommand<boolean>('verify_master_password', { password })
      } catch (error) {
        console.error('Failed to verify master password:', error)
        return false
      }
    }
  }
})
```

---

## 確認事項

- [ ] ファイルが作成されたか
- [ ] セキュリティ設定の管理が実装されているか
- [ ] Tauri IPCと連携しているか
- [ ] SecuritySettings型が正しく使用されているか
- [ ] パスワード関連の処理が安全に実装されているか

---

## 成果物

- `app/stores/security.ts`

---

## ストア構成

### State
- `settings`: セキュリティ設定
  - `provider`: セキュリティプロバイダー(system/master-password)
  - `level`: セキュリティレベル(low/medium/high)
  - `masterPasswordSet`: マスターパスワードが設定されているか
- `loading`: ローディング状態
- `error`: エラーメッセージ

### Getters
- `currentSettings`: 現在のセキュリティ設定
- `currentProvider`: 現在のプロバイダー
- `currentLevel`: 現在のセキュリティレベル
- `isMasterPasswordSet`: マスターパスワードが設定されているか

### Actions
- `loadSettings()`: セキュリティ設定をロード
- `setProvider(provider)`: プロバイダーを設定
- `setLevel(level)`: セキュリティレベルを設定
- `setMasterPassword(password)`: マスターパスワードを設定
- `verifyMasterPassword(password)`: マスターパスワードを検証

---

## Tauri IPCコマンド一覧

| コマンド名 | 引数 | 戻り値 |
|-----------|------|--------|
| `get_security_settings` | なし | `SecuritySettings` |
| `set_security_provider` | `{ provider }` | `void` |
| `set_security_level` | `{ level }` | `void` |
| `set_master_password` | `{ password }` | `void` |
| `verify_master_password` | `{ password }` | `boolean` |

---

## セキュリティ考慮事項

- パスワードは平文で保存しない
- Tauri IPCを通じてRustバックエンドで暗号化
- マスターパスワードの検証はバックエンドで実施
- セキュリティレベルに応じた暗号化強度の調整

---

## 次のタスク

→ [2.3.1: EnvironmentHeader.vue作成](2.3.1_EnvironmentHeader.md)
