# タスク1.5b.2.2.3: windowストア移行

**サブフェーズ**: 2.2 Piniaストア移行
**工数**: 1.5時間
**優先度**: 中
**依存関係**: 2.1.3 (型定義)

---

## 目的

ウィンドウ状態の管理を実装

---

## 実装内容

### ファイル作成: `app/stores/window.ts`

```typescript
import { defineStore } from 'pinia'
import type { WindowState } from '~/types'

export const useWindowStore = defineStore('window', {
  state: () => ({
    windows: [] as WindowState[],
    loading: false,
    error: null as string | null
  }),

  getters: {
    /**
     * 接続IDでウィンドウを取得
     */
    getWindowByConnectionId: (state) => (connectionId: string) => {
      return state.windows.find(w => w.connectionId === connectionId)
    },

    /**
     * すべてのウィンドウ
     */
    allWindows: (state) => state.windows
  },

  actions: {
    /**
     * ウィンドウ状態をロード
     */
    async loadWindows() {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        this.windows = await invokeCommand<WindowState[]>('get_windows')
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to load windows'
        console.error('Failed to load windows:', error)
      } finally {
        this.loading = false
      }
    },

    /**
     * ウィンドウ状態を保存
     */
    async saveWindowState(windowState: Omit<WindowState, 'id' | 'createdAt'>) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        const saved = await invokeCommand<WindowState>('save_window_state', { windowState })

        const index = this.windows.findIndex(w => w.connectionId === windowState.connectionId)
        if (index !== -1) {
          this.windows[index] = saved
        } else {
          this.windows.push(saved)
        }

        return saved
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to save window state'
        console.error('Failed to save window state:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    /**
     * ウィンドウを復元
     */
    async restoreWindows() {
      try {
        const { invokeCommand } = useTauri()
        await invokeCommand('restore_windows')
      } catch (error) {
        console.error('Failed to restore windows:', error)
        throw error
      }
    },

    /**
     * ウィンドウを削除
     */
    async deleteWindow(id: string) {
      this.loading = true
      this.error = null

      try {
        const { invokeCommand } = useTauri()
        await invokeCommand('delete_window', { id })
        this.windows = this.windows.filter(w => w.id !== id)
      } catch (error) {
        this.error = error instanceof Error ? error.message : 'Failed to delete window'
        console.error('Failed to delete window:', error)
        throw error
      } finally {
        this.loading = false
      }
    }
  }
})
```

---

## 確認事項

- [ ] ファイルが作成されたか
- [ ] ウィンドウ状態の管理が実装されているか
- [ ] Tauri IPCと連携しているか
- [ ] WindowState型が正しく使用されているか

---

## 成果物

- `app/stores/window.ts`

---

## ストア構成

### State
- `windows`: ウィンドウ状態のリスト
- `loading`: ローディング状態
- `error`: エラーメッセージ

### Getters
- `getWindowByConnectionId(connectionId)`: 接続IDでウィンドウを取得
- `allWindows`: すべてのウィンドウ

### Actions
- `loadWindows()`: ウィンドウ状態をロード
- `saveWindowState(windowState)`: ウィンドウ状態を保存
- `restoreWindows()`: ウィンドウを復元
- `deleteWindow(id)`: ウィンドウを削除

---

## Tauri IPCコマンド一覧

| コマンド名 | 引数 | 戻り値 |
|-----------|------|--------|
| `get_windows` | なし | `WindowState[]` |
| `save_window_state` | `{ windowState }` | `WindowState` |
| `restore_windows` | なし | `void` |
| `delete_window` | `{ id }` | `void` |

---

## 次のタスク

→ [2.2.4: settingsストア移行](2.2.4_settingsStore.md)
