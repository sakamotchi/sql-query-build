# タスク1.4.2: テーマ切り替え機能実装 設計書

## 概要

**タスクID**: 1.4.2
**タスク名**: テーマ切り替え機能実装
**工数**: 1日
**依存関係**: 1.4.1 (Vuetifyテーマ定義作成)
**完了条件**: 動的にテーマ変更が可能

---

## 目的

接続先のデータベース環境に応じて、動的にVuetifyのテーマを切り替える機能を実装する。これにより、ユーザーは現在操作している環境を視覚的に識別できる。

---

## 機能要件

### 主要機能

1. **テーマの動的切り替え**
   - 接続選択時に環境に応じたテーマを自動適用
   - ウィンドウごとに独立したテーマ設定

2. **テーマの永続化**
   - 現在のテーマをウィンドウラベルに記録
   - アプリケーション再起動時にテーマを復元

3. **テーマAPI**
   - プログラムからテーマ切り替え可能なAPI
   - 現在のテーマ取得API

---

## アーキテクチャ

### コンポーザブル設計

```
src/composables/
└── useTheme.ts       # テーマ切り替え用コンポーザブル
```

---

## 実装設計

### useTheme.ts

**ファイル**: `src/composables/useTheme.ts`

```typescript
import { computed } from 'vue';
import { useTheme as useVuetifyTheme } from 'vuetify';
import type { ThemeType } from '@/types/theme';
import { THEME_COLORS } from '@/types/theme';

/**
 * テーマ切り替えコンポーザブル
 */
export function useTheme() {
  const vuetifyTheme = useVuetifyTheme();

  /**
   * 現在のテーマ名
   */
  const currentTheme = computed<ThemeType>({
    get: () => vuetifyTheme.global.name.value as ThemeType,
    set: (themeName: ThemeType) => {
      vuetifyTheme.global.name.value = themeName;
    },
  });

  /**
   * 現在のテーマカラー情報
   */
  const currentThemeInfo = computed(() => {
    return THEME_COLORS[currentTheme.value];
  });

  /**
   * 現在のプライマリーカラー
   */
  const primaryColor = computed(() => {
    return vuetifyTheme.current.value.colors.primary;
  });

  /**
   * 現在のバックグラウンドカラー
   */
  const backgroundColor = computed(() => {
    return vuetifyTheme.current.value.colors.background;
  });

  /**
   * 環境に応じてテーマを切り替え
   * @param environment 環境タイプ
   */
  const setThemeByEnvironment = (environment: ThemeType) => {
    vuetifyTheme.global.name.value = environment;
  };

  /**
   * テーマをデフォルト(開発環境)に戻す
   */
  const resetTheme = () => {
    vuetifyTheme.global.name.value = 'development';
  };

  /**
   * 利用可能なテーマ一覧を取得
   */
  const availableThemes = computed(() => {
    return Object.keys(THEME_COLORS) as ThemeType[];
  });

  /**
   * 指定されたテーマのカラー情報を取得
   * @param themeName テーマ名
   */
  const getThemeInfo = (themeName: ThemeType) => {
    return THEME_COLORS[themeName];
  };

  /**
   * テーマがプロダクション環境かどうか
   */
  const isProductionTheme = computed(() => {
    return currentTheme.value === 'production';
  });

  /**
   * テーマがステージング環境かどうか
   */
  const isStagingTheme = computed(() => {
    return currentTheme.value === 'staging';
  });

  /**
   * 警告が必要な環境かどうか (ステージング or 本番)
   */
  const needsWarning = computed(() => {
    return isProductionTheme.value || isStagingTheme.value;
  });

  return {
    // 状態
    currentTheme,
    currentThemeInfo,
    primaryColor,
    backgroundColor,
    availableThemes,

    // フラグ
    isProductionTheme,
    isStagingTheme,
    needsWarning,

    // アクション
    setThemeByEnvironment,
    resetTheme,
    getThemeInfo,
  };
}
```

---

## Tauri連携 (ウィンドウラベルによるテーマ管理)

### ウィンドウラベルの設計

各ウィンドウは接続IDと環境情報を含むラベルを持つ:

```
window-{connectionId}-{environment}
例: window-a1b2c3d4-production
```

### Tauriコマンド

**ファイル**: `src-tauri/src/commands/window.rs`

```rust
use tauri::{Manager, Window};
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct WindowConfig {
    pub connection_id: String,
    pub environment: String,
    pub connection_name: String,
}

/// ウィンドウのラベルから環境情報を取得
#[tauri::command]
pub fn get_window_environment(window: Window) -> Result<String, String> {
    let label = window.label();

    // ラベルのフォーマット: "window-{connectionId}-{environment}"
    let parts: Vec<&str> = label.split('-').collect();

    if parts.len() >= 3 {
        Ok(parts[2].to_string())
    } else {
        Err("Invalid window label format".to_string())
    }
}

/// 新しいクエリビルダーウィンドウを起動
#[tauri::command]
pub async fn open_query_builder_window(
    app: tauri::AppHandle,
    config: WindowConfig,
) -> Result<(), String> {
    let label = format!("window-{}-{}", config.connection_id, config.environment);

    // ウィンドウが既に存在する場合はフォーカス
    if let Some(existing_window) = app.get_window(&label) {
        existing_window.set_focus().map_err(|e| e.to_string())?;
        return Ok(());
    }

    // 新規ウィンドウ作成
    tauri::WindowBuilder::new(
        &app,
        label,
        tauri::WindowUrl::App(format!(
            "query-builder?connectionId={}&environment={}",
            config.connection_id,
            config.environment
        ).into()),
    )
    .title(&format!("{} - SQLエディタ", config.connection_name))
    .inner_size(1280.0, 800.0)
    .min_inner_size(800.0, 600.0)
    .build()
    .map_err(|e| e.to_string())?;

    Ok(())
}
```

---

## フロントエンド統合

### クエリビルダー画面での使用

**ファイル**: `src/pages/query-builder.vue`

```vue
<script setup lang="ts">
import { onMounted, computed } from 'vue';
import { useRoute } from 'vue-router';
import { useTheme } from '@/composables/useTheme';
import { invoke } from '@tauri-apps/api/core';
import type { ThemeType } from '@/types/theme';

const route = useRoute();
const { setThemeByEnvironment, currentThemeInfo, needsWarning } = useTheme();

// クエリパラメータから環境を取得
const environment = computed(() => {
  return route.query.environment as ThemeType || 'development';
});

const connectionId = computed(() => {
  return route.query.connectionId as string;
});

// マウント時にテーマを設定
onMounted(async () => {
  // 環境に応じてテーマを切り替え
  setThemeByEnvironment(environment.value);

  // Tauriウィンドウから環境情報を取得して検証
  try {
    const windowEnv = await invoke<string>('get_window_environment');
    if (windowEnv !== environment.value) {
      console.warn('Environment mismatch:', windowEnv, environment.value);
    }
  } catch (error) {
    console.error('Failed to get window environment:', error);
  }
});
</script>

<template>
  <v-app>
    <!-- 環境識別ヘッダー (1.4.4で実装) -->
    <EnvironmentHeader
      :environment="environment"
      :connection-id="connectionId"
      :show-warning="needsWarning"
    />

    <!-- メインコンテンツ -->
    <v-main :style="{ backgroundColor: currentThemeInfo.background }">
      <QueryBuilderContent />
    </v-main>
  </v-app>
</template>
```

### ランチャー画面からの起動

**ファイル**: `src/pages/launcher.vue`

```vue
<script setup lang="ts">
import { invoke } from '@tauri-apps/api/core';
import type { Connection } from '@/stores/types';

interface WindowConfig {
  connection_id: string;
  environment: string;
  connection_name: string;
}

const handleSelectConnection = async (connection: Connection) => {
  try {
    // 接続を使用済みとしてマーク
    await connectionStore.markConnectionAsUsed(connection.id);

    // ウィンドウ設定を準備
    const config: WindowConfig = {
      connection_id: connection.id,
      environment: connection.environment,
      connection_name: connection.name,
    };

    // 新しいウィンドウを起動
    await invoke('open_query_builder_window', { config });
  } catch (error) {
    console.error('Failed to open query builder:', error);
    // エラートースト表示
  }
};
</script>
```

---

## テーマ切り替えのトランジション

### スムーズな切り替えアニメーション

**ファイル**: `src/assets/styles/theme-transition.scss`

```scss
// テーマ切り替え時のトランジション
.v-application {
  transition: background-color 0.3s ease-in-out;
}

.v-app-bar,
.v-card,
.v-btn {
  transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
}
```

### グローバルスタイルの登録

**ファイル**: `nuxt.config.ts`

```typescript
export default defineNuxtConfig({
  css: [
    'vuetify/styles',
    '@mdi/font/css/materialdesignicons.css',
    '@/assets/styles/theme-transition.scss',
  ],
});
```

---

## エラーハンドリング

### テーマ切り替え失敗時の処理

```typescript
export function useTheme() {
  // ... 前述のコード

  /**
   * 安全にテーマを切り替え (エラーハンドリング付き)
   */
  const safeSetTheme = (environment: ThemeType) => {
    try {
      if (!availableThemes.value.includes(environment)) {
        console.warn(`Unknown theme: ${environment}, falling back to development`);
        setThemeByEnvironment('development');
        return false;
      }

      setThemeByEnvironment(environment);
      return true;
    } catch (error) {
      console.error('Failed to set theme:', error);
      resetTheme();
      return false;
    }
  };

  return {
    // ... 既存のreturn
    safeSetTheme,
  };
}
```

---

## テスト設計

### ユニットテスト

**ファイル**: `tests/composables/useTheme.spec.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { useTheme } from '@/composables/useTheme';
import { createVuetify } from 'vuetify';
import { mount } from '@vue/test-utils';

describe('useTheme', () => {
  beforeEach(() => {
    // Vuetifyインスタンスをセットアップ
  });

  it('should switch theme by environment', () => {
    const { setThemeByEnvironment, currentTheme } = useTheme();

    setThemeByEnvironment('production');
    expect(currentTheme.value).toBe('production');

    setThemeByEnvironment('development');
    expect(currentTheme.value).toBe('development');
  });

  it('should return correct theme info', () => {
    const { setThemeByEnvironment, currentThemeInfo } = useTheme();

    setThemeByEnvironment('production');
    expect(currentThemeInfo.value.label).toBe('本番環境');
    expect(currentThemeInfo.value.primary).toBe('#F44336');
  });

  it('should detect production theme', () => {
    const { setThemeByEnvironment, isProductionTheme } = useTheme();

    setThemeByEnvironment('production');
    expect(isProductionTheme.value).toBe(true);

    setThemeByEnvironment('development');
    expect(isProductionTheme.value).toBe(false);
  });

  it('should detect warning environments', () => {
    const { setThemeByEnvironment, needsWarning } = useTheme();

    setThemeByEnvironment('production');
    expect(needsWarning.value).toBe(true);

    setThemeByEnvironment('staging');
    expect(needsWarning.value).toBe(true);

    setThemeByEnvironment('development');
    expect(needsWarning.value).toBe(false);
  });
});
```

### E2Eテスト

**ファイル**: `e2e/theme-switching.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('Theme Switching', () => {
  test('should apply development theme by default', async ({ page }) => {
    await page.goto('/launcher');

    const appBar = page.locator('.v-app-bar');
    const bgColor = await appBar.evaluate((el) =>
      window.getComputedStyle(el).backgroundColor
    );

    // 開発環境テーマの緑色が適用されているか
    expect(bgColor).toContain('76, 175, 80'); // RGB値
  });

  test('should switch to production theme when opening production connection', async ({ page }) => {
    await page.goto('/launcher');

    // 本番環境の接続カードをクリック
    await page.click('[data-environment="production"]');

    // 新しいウィンドウが開く
    const [newPage] = await Promise.all([
      page.waitForEvent('popup'),
    ]);

    // 本番環境テーマの赤色が適用されているか
    const appBar = newPage.locator('.v-app-bar');
    const bgColor = await appBar.evaluate((el) =>
      window.getComputedStyle(el).backgroundColor
    );

    expect(bgColor).toContain('244, 67, 54'); // RGB値
  });
});
```

---

## パフォーマンス考慮事項

### テーマ切り替えの最適化

1. **CSS変数の活用**
   - JavaScriptでの再計算を最小限に
   - ブラウザのネイティブなCSS変数機能を使用

2. **トランジションの最適化**
   - `will-change` プロパティの活用
   - GPU加速の利用

```scss
.v-application {
  will-change: background-color;
  transition: background-color 0.3s ease-in-out;
}
```

3. **リアクティビティの最適化**
   - `computed` でメモ化
   - 不要な再計算を防ぐ

---

## アクセシビリティ

### テーマ変更の通知

```vue
<template>
  <v-app>
    <!-- スクリーンリーダー向けの通知 -->
    <div
      role="status"
      aria-live="polite"
      class="sr-only"
    >
      {{ currentThemeInfo.label }}に切り替えました
    </div>
  </v-app>
</template>

<style scoped>
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
</style>
```

---

## 実装チェックリスト

- [ ] `src/composables/useTheme.ts` の作成
- [ ] Tauriウィンドウコマンドの実装
- [ ] クエリビルダー画面へのテーマ適用
- [ ] ランチャー画面からの起動処理
- [ ] テーマトランジションCSSの実装
- [ ] エラーハンドリングの実装
- [ ] ユニットテストの作成
- [ ] E2Eテストの作成
- [ ] アクセシビリティ対応

---

## デバッグ方法

### 開発者ツールでのテーマ確認

```javascript
// ブラウザコンソールで現在のテーマを確認
const theme = document.documentElement.style.getPropertyValue('--v-theme-primary');
console.log('Current primary color:', theme);

// 全てのテーマ変数を表示
const styles = getComputedStyle(document.documentElement);
const themeVars = Array.from(styles)
  .filter(prop => prop.startsWith('--v-theme-'));
console.table(themeVars);
```

---

## 参考資料

- [Vuetify Theme Configuration](https://vuetifyjs.com/en/features/theme/)
- [Tauri Window Management](https://tauri.app/v1/guides/features/window/)
- [Vue Composables Pattern](https://vuejs.org/guide/reusability/composables.html)
