# タスク1.4.6: テーマプレビュー機能 設計書

## 概要

**タスクID**: 1.4.6
**タスク名**: テーマプレビュー機能
**工数**: 0.5日
**依存関係**: 1.4.3 (環境色設定UI実装)
**完了条件**: 設定画面でプレビュー可能

---

## 目的

接続設定画面で環境タイプを選択する際、その環境のテーマがどのように表示されるかをリアルタイムでプレビューできる機能を実装する。ユーザーが環境選択の影響を視覚的に確認できるようにする。

---

## 機能要件

### 主要機能

1. **リアルタイムプレビュー**
   - 環境タイプ選択時に即座にプレビュー更新
   - アニメーション付きの切り替え

2. **UIコンポーネントのプレビュー**
   - ボタン、カード、アラートなどの主要コンポーネント
   - ヘッダーのプレビュー

3. **インタラクティブプレビュー**
   - プレビュー内でコンポーネントの状態を確認
   - ホバー・フォーカス状態の確認

4. **カラーパレット表示**
   - プライマリー、セカンダリー、バックグラウンドカラー
   - カラーコードの表示

---

## 画面設計

### プレビューレイアウト

```
┌─────────────────────────────────────────────────┐
│ テーマプレビュー                                 │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ ヘッダープレビュー                           │ │
│ │ [環境アイコン] 開発環境 - サンプル接続       │ │
│ │                              [●接続中][設定] │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ コンポーネントプレビュー                     │ │
│ │                                             │ │
│ │ [プライマリーボタン] [セカンダリーボタン]    │ │
│ │                                             │ │
│ │ ┌─────────┐                                 │ │
│ │ │カード    │                                 │ │
│ │ │サンプル  │                                 │ │
│ │ └─────────┘                                 │ │
│ │                                             │ │
│ │ ⓘ 情報メッセージ                            │ │
│ │ ✓ 成功メッセージ                            │ │
│ │ ⚠ 警告メッセージ                            │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ カラーパレット                               │ │
│ │ ■ #4CAF50 プライマリー                      │ │
│ │ ■ #66BB6A セカンダリー                      │ │
│ │ ■ #F1F8E9 バックグラウンド                  │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

---

## コンポーネント設計

### 1. ThemePreview.vue

**配置場所**: `src/components/connection/ThemePreview.vue`

#### 責務
- テーマのリアルタイムプレビュー
- UIコンポーネントのサンプル表示
- カラーパレットの表示

#### Props
```typescript
interface ThemePreviewProps {
  environment: Environment;     // プレビューする環境
  connectionName?: string;      // 接続名（プレビュー用）
  interactive?: boolean;        // インタラクティブモード
}
```

#### コンポーネント実装

```vue
<script setup lang="ts">
import { computed } from 'vue';
import type { Environment } from '@/stores/types';
import { THEME_COLORS } from '@/types/theme';

const props = withDefaults(
  defineProps<ThemePreviewProps>(),
  {
    connectionName: 'サンプル接続',
    interactive: true,
  }
);

// テーマカラー情報
const themeInfo = computed(() => THEME_COLORS[props.environment]);

// 環境アイコン
const environmentIcon = computed(() => {
  const icons: Record<Environment, string> = {
    development: 'mdi-code-tags',
    test: 'mdi-test-tube',
    staging: 'mdi-server-network',
    production: 'mdi-database-alert',
  };
  return icons[props.environment];
});

// 警告バナー表示フラグ
const showWarning = computed(() => {
  return props.environment === 'production' || props.environment === 'staging';
});

// 警告メッセージ
const warningMessage = computed(() => {
  if (props.environment === 'production') {
    return '⚠️ 本番環境 - UPDATE/DELETE操作には十分注意してください';
  } else if (props.environment === 'staging') {
    return '⚠️ ステージング環境 - 本番前の環境です';
  }
  return '';
});
</script>

<template>
  <div class="theme-preview">
    <!-- プレビュータイトル -->
    <div class="text-subtitle-2 mb-3 d-flex align-center">
      <v-icon size="small" class="mr-2">mdi-eye</v-icon>
      テーマプレビュー
    </div>

    <v-card variant="outlined" class="preview-container">
      <!-- 警告バナープレビュー -->
      <v-alert
        v-if="showWarning"
        :color="environment === 'production' ? 'error' : 'warning'"
        variant="flat"
        density="compact"
        class="preview-warning-banner"
      >
        <template #prepend>
          <v-icon>mdi-alert</v-icon>
        </template>
        <strong>{{ warningMessage }}</strong>
      </v-alert>

      <!-- ヘッダープレビュー -->
      <div
        class="preview-header"
        :style="{ backgroundColor: themeInfo.primary, color: 'white' }"
      >
        <div class="d-flex align-center pa-3">
          <v-icon :color="'white'" class="mr-2">
            {{ environmentIcon }}
          </v-icon>
          <div class="flex-grow-1">
            <div class="font-weight-medium">
              <v-chip
                :color="themeInfo.secondary"
                size="x-small"
                variant="elevated"
                class="mr-2"
              >
                {{ themeInfo.label }}
              </v-chip>
              {{ connectionName }}
            </div>
            <div class="text-caption opacity-90">
              localhost:5432 / sample_db
            </div>
          </div>
          <v-chip
            color="success"
            size="x-small"
            variant="elevated"
          >
            接続中
          </v-chip>
        </div>
      </div>

      <!-- コンテンツプレビュー -->
      <div
        class="preview-content pa-4"
        :style="{ backgroundColor: themeInfo.background }"
      >
        <!-- ボタンプレビュー -->
        <div class="mb-4">
          <div class="text-caption text-grey-darken-1 mb-2">ボタン</div>
          <div class="d-flex gap-2 flex-wrap">
            <v-btn
              :color="themeInfo.primary"
              size="small"
              variant="elevated"
            >
              プライマリー
            </v-btn>
            <v-btn
              :color="themeInfo.secondary"
              size="small"
              variant="elevated"
            >
              セカンダリー
            </v-btn>
            <v-btn
              size="small"
              variant="outlined"
              :style="{ borderColor: themeInfo.primary, color: themeInfo.primary }"
            >
              アウトライン
            </v-btn>
            <v-btn
              size="small"
              variant="text"
              :style="{ color: themeInfo.primary }"
            >
              テキスト
            </v-btn>
          </div>
        </div>

        <!-- カードプレビュー -->
        <div class="mb-4">
          <div class="text-caption text-grey-darken-1 mb-2">カード</div>
          <v-card
            max-width="300"
            variant="outlined"
          >
            <v-card-title>サンプルカード</v-card-title>
            <v-card-text>
              このカードは{{ themeInfo.label }}のテーマプレビューです。
            </v-card-text>
            <v-card-actions>
              <v-btn
                :color="themeInfo.primary"
                size="small"
                variant="text"
              >
                アクション
              </v-btn>
            </v-card-actions>
          </v-card>
        </div>

        <!-- アラートプレビュー -->
        <div class="mb-4">
          <div class="text-caption text-grey-darken-1 mb-2">アラート</div>
          <div class="d-flex flex-column gap-2">
            <v-alert
              type="info"
              variant="tonal"
              density="compact"
            >
              情報メッセージの表示例
            </v-alert>
            <v-alert
              type="success"
              variant="tonal"
              density="compact"
            >
              成功メッセージの表示例
            </v-alert>
            <v-alert
              type="warning"
              variant="tonal"
              density="compact"
            >
              警告メッセージの表示例
            </v-alert>
            <v-alert
              type="error"
              variant="tonal"
              density="compact"
            >
              エラーメッセージの表示例
            </v-alert>
          </div>
        </div>

        <!-- カラーパレット -->
        <div>
          <div class="text-caption text-grey-darken-1 mb-2">カラーパレット</div>
          <div class="color-palette">
            <div class="color-item">
              <div
                class="color-swatch"
                :style="{ backgroundColor: themeInfo.primary }"
              ></div>
              <div class="color-info">
                <div class="text-caption font-weight-medium">プライマリー</div>
                <div class="text-caption text-grey">{{ themeInfo.primary }}</div>
              </div>
            </div>

            <div class="color-item">
              <div
                class="color-swatch"
                :style="{ backgroundColor: themeInfo.secondary }"
              ></div>
              <div class="color-info">
                <div class="text-caption font-weight-medium">セカンダリー</div>
                <div class="text-caption text-grey">{{ themeInfo.secondary }}</div>
              </div>
            </div>

            <div class="color-item">
              <div
                class="color-swatch"
                :style="{ backgroundColor: themeInfo.background }"
              ></div>
              <div class="color-info">
                <div class="text-caption font-weight-medium">バックグラウンド</div>
                <div class="text-caption text-grey">{{ themeInfo.background }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </v-card>
  </div>
</template>

<style scoped>
.theme-preview {
  max-width: 600px;
}

.preview-container {
  overflow: hidden;
  transition: all 0.3s ease-in-out;
}

.preview-warning-banner {
  border-radius: 0;
  margin: 0;
}

.preview-header {
  transition: background-color 0.3s ease-in-out;
}

.preview-content {
  min-height: 400px;
  transition: background-color 0.3s ease-in-out;
}

.color-palette {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.color-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.color-swatch {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.12);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  flex-shrink: 0;
}

.color-info {
  display: flex;
  flex-direction: column;
}

/* アニメーション */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.preview-container {
  animation: fadeIn 0.3s ease-out;
}
</style>
```

---

### 2. ThemeComparisonView.vue (オプション)

複数のテーマを並べて比較表示するコンポーネント:

```vue
<script setup lang="ts">
import { ref } from 'vue';
import type { Environment } from '@/stores/types';
import ThemePreview from './ThemePreview.vue';

const environments: Environment[] = ['development', 'test', 'staging', 'production'];
</script>

<template>
  <div class="theme-comparison">
    <v-row>
      <v-col
        v-for="env in environments"
        :key="env"
        cols="12"
        md="6"
        lg="3"
      >
        <ThemePreview
          :environment="env"
          :interactive="false"
        />
      </v-col>
    </v-row>
  </div>
</template>

<style scoped>
.theme-comparison {
  /* スタイル定義 */
}
</style>
```

---

## 使用例

### ConnectionForm.vueへの統合

```vue
<script setup lang="ts">
import { ref } from 'vue';
import EnvironmentSelector from './EnvironmentSelector.vue';
import ThemePreview from './ThemePreview.vue';

const formData = ref({
  name: '',
  environment: 'development' as Environment,
  // ... その他のフィールド
});
</script>

<template>
  <v-form>
    <v-row>
      <!-- 左側: フォーム入力 -->
      <v-col cols="12" md="6">
        <v-text-field
          v-model="formData.name"
          label="接続名"
          required
        ></v-text-field>

        <EnvironmentSelector
          v-model="formData.environment"
        />

        <!-- ... その他のフィールド -->
      </v-col>

      <!-- 右側: プレビュー -->
      <v-col cols="12" md="6">
        <ThemePreview
          :environment="formData.environment"
          :connection-name="formData.name || 'サンプル接続'"
        />
      </v-col>
    </v-row>
  </v-form>
</template>
```

---

## インタラクティブ機能

### ホバー・フォーカス状態のプレビュー

```vue
<template>
  <div class="interactive-preview">
    <!-- ホバー状態のヒント -->
    <v-tooltip text="ボタンにカーソルを合わせて、ホバー状態を確認できます">
      <template #activator="{ props }">
        <v-btn
          v-bind="props"
          :color="themeInfo.primary"
          size="small"
        >
          ホバーしてみる
        </v-btn>
      </template>
    </v-tooltip>
  </div>
</template>
```

---

## アニメーション効果

### テーマ切り替えトランジション

```vue
<template>
  <transition
    name="theme-fade"
    mode="out-in"
  >
    <div :key="environment" class="preview-content">
      <!-- プレビュー内容 -->
    </div>
  </transition>
</template>

<style scoped>
.theme-fade-enter-active,
.theme-fade-leave-active {
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.theme-fade-enter-from {
  opacity: 0;
  transform: translateY(10px);
}

.theme-fade-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}
</style>
```

---

## テスト設計

### ユニットテスト

```typescript
import { describe, it, expect } from 'vitest';
import { mount } from '@vue/test-utils';
import ThemePreview from '@/components/connection/ThemePreview.vue';
import { createVuetify } from 'vuetify';

describe('ThemePreview', () => {
  const vuetify = createVuetify();

  it('should render preview with correct theme colors', () => {
    const wrapper = mount(ThemePreview, {
      global: {
        plugins: [vuetify],
      },
      props: {
        environment: 'production',
      },
    });

    // 本番環境の赤色が適用されているか
    const header = wrapper.find('.preview-header');
    expect(header.attributes('style')).toContain('#F44336');
  });

  it('should show warning banner for production environment', () => {
    const wrapper = mount(ThemePreview, {
      global: {
        plugins: [vuetify],
      },
      props: {
        environment: 'production',
      },
    });

    expect(wrapper.find('.preview-warning-banner').exists()).toBe(true);
  });

  it('should not show warning banner for development environment', () => {
    const wrapper = mount(ThemePreview, {
      global: {
        plugins: [vuetify],
      },
      props: {
        environment: 'development',
      },
    });

    expect(wrapper.find('.preview-warning-banner').exists()).toBe(false);
  });

  it('should display color palette', () => {
    const wrapper = mount(ThemePreview, {
      global: {
        plugins: [vuetify],
      },
      props: {
        environment: 'development',
      },
    });

    const swatches = wrapper.findAll('.color-swatch');
    expect(swatches.length).toBeGreaterThanOrEqual(3);
  });
});
```

### ビジュアルリグレッションテスト

```typescript
import { test, expect } from '@playwright/test';

test.describe('Theme Preview Visual Tests', () => {
  test('should render all environment previews correctly', async ({ page }) => {
    await page.goto('/connections/new');

    const environments = ['development', 'test', 'staging', 'production'];

    for (const env of environments) {
      // 環境を選択
      await page.click(`text=${env === 'development' ? '開発環境' : env}`);

      // プレビューのスクリーンショット
      const preview = page.locator('.theme-preview');
      await expect(preview).toHaveScreenshot(`preview-${env}.png`);
    }
  });
});
```

---

## アクセシビリティ

### スクリーンリーダー対応

```vue
<template>
  <div
    class="theme-preview"
    role="region"
    aria-label="テーマプレビュー"
  >
    <div
      class="sr-only"
      aria-live="polite"
    >
      {{ themeInfo.label }}のプレビューを表示中
    </div>

    <!-- プレビュー内容 -->
  </div>
</template>

<style scoped>
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
</style>
```

---

## レスポンシブデザイン

### モバイル対応

```vue
<template>
  <v-row>
    <!-- モバイル: プレビューを下に配置 -->
    <v-col
      cols="12"
      md="6"
      :order="$vuetify.display.smAndDown ? 2 : 1"
    >
      <!-- フォーム -->
    </v-col>

    <v-col
      cols="12"
      md="6"
      :order="$vuetify.display.smAndDown ? 1 : 2"
    >
      <ThemePreview :environment="formData.environment" />
    </v-col>
  </v-row>
</template>

<style scoped>
@media (max-width: 600px) {
  .preview-content {
    min-height: 300px;
  }

  .color-palette {
    flex-direction: row;
    flex-wrap: wrap;
  }

  .color-item {
    flex: 1 1 45%;
  }
}
</style>
```

---

## 実装チェックリスト

- [ ] `ThemePreview.vue` の作成
- [ ] `ThemeComparisonView.vue` の作成 (オプション)
- [ ] `ConnectionForm.vue` への統合
- [ ] アニメーション効果の実装
- [ ] レスポンシブデザインの実装
- [ ] アクセシビリティ対応
- [ ] ユニットテストの作成
- [ ] ビジュアルテストの作成

---

## パフォーマンス考慮事項

### プレビューの最適化

- プレビューコンポーネントの遅延ロード
- 不要な再レンダリングを防ぐ

```vue
<script setup lang="ts">
import { defineAsyncComponent } from 'vue';

const ThemePreview = defineAsyncComponent(
  () => import('@/components/connection/ThemePreview.vue')
);
</script>
```

---

## 将来拡張

### カスタムテーマエディター

ユーザーが独自のカラーパレットを作成できる機能:

```vue
<template>
  <div class="custom-theme-editor">
    <v-color-picker
      v-model="customPrimary"
      label="プライマリーカラー"
    ></v-color-picker>

    <ThemePreview
      :environment="environment"
      :custom-colors="{
        primary: customPrimary,
        secondary: customSecondary,
        background: customBackground,
      }"
    />
  </div>
</template>
```

---

## 参考資料

- [Vuetify Color Picker](https://vuetifyjs.com/en/components/color-pickers/)
- [Vue Transitions](https://vuejs.org/guide/built-ins/transition.html)
- [Material Design Color System](https://m3.material.io/styles/color/overview)
