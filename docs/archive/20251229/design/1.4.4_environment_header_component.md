# タスク1.4.4: 環境識別ヘッダーコンポーネント 設計書

## 概要

**タスクID**: 1.4.4
**タスク名**: 環境識別ヘッダーコンポーネント
**工数**: 1日
**依存関係**: 1.4.1 (Vuetifyテーマ定義作成)
**完了条件**: ヘッダーに環境色が表示

---

## 目的

クエリビルダー画面のヘッダーに、接続先の環境を明確に識別できる視覚的なコンポーネントを実装する。特に本番環境では強い警告表示を行い、誤操作を防止する。

---

## 機能要件

### 主要機能

1. **環境情報の表示**
   - 環境タイプ（開発・テスト・ステージング・本番）
   - 接続名
   - データベース種別

2. **環境色の適用**
   - ヘッダー全体に環境色を適用
   - アイコンと環境ラベルを表示

3. **本番環境の警告表示**
   - 赤色の警告バナー
   - 警告アイコン
   - 警告メッセージ

4. **接続情報の表示**
   - ホスト名とデータベース名
   - 接続ステータスインジケーター

---

## 画面設計

### レイアウト構成

#### 通常環境（開発・テスト）
```
┌─────────────────────────────────────────────────────────┐
│ [開発環境アイコン] 開発環境 - MyApp Dev DB              │
│ localhost:5432 / myapp_dev                              │
│                                        [●接続中] [設定] │
└─────────────────────────────────────────────────────────┘
```

#### 警告環境（ステージング・本番）
```
┌─────────────────────────────────────────────────────────┐
│ ⚠️ 本番環境 - 慎重に操作してください                     │
├─────────────────────────────────────────────────────────┤
│ [本番アイコン] 本番環境 - Production DB                  │
│ prod.example.com:5432 / myapp_production                │
│                                        [●接続中] [設定] │
└─────────────────────────────────────────────────────────┘
```

---

## コンポーネント設計

### 1. EnvironmentHeader.vue

**配置場所**: `src/components/common/EnvironmentHeader.vue`

#### 責務
- 環境情報の表示
- 環境色の適用
- 警告バナーの表示（本番・ステージング環境）
- 接続ステータスの表示

#### Props
```typescript
interface EnvironmentHeaderProps {
  environment: Environment;      // 環境タイプ
  connectionId: string;          // 接続ID
  connectionName: string;        // 接続名
  dbType: DatabaseType;          // データベース種別
  host: string;                  // ホスト名
  database: string;              // データベース名
  connected: boolean;            // 接続状態
  showWarning?: boolean;         // 警告バナー表示フラグ
}
```

#### Emits
```typescript
interface EnvironmentHeaderEmits {
  (e: 'settings'): void;         // 設定ボタンクリック
  (e: 'disconnect'): void;       // 切断ボタンクリック
}
```

#### コンポーネント実装

```vue
<script setup lang="ts">
import { computed } from 'vue';
import { useTheme } from '@/composables/useTheme';
import type { Environment, DatabaseType } from '@/stores/types';

const props = withDefaults(
  defineProps<EnvironmentHeaderProps>(),
  {
    showWarning: false,
    connected: true,
  }
);

const emit = defineEmits<EnvironmentHeaderEmits>();

const { currentThemeInfo, isProductionTheme, isStagingTheme } = useTheme();

// 環境アイコン
const environmentIcon = computed(() => {
  const icons: Record<Environment, string> = {
    development: 'mdi-code-tags',
    test: 'mdi-test-tube',
    staging: 'mdi-server-network',
    production: 'mdi-database-alert',
  };
  return icons[props.environment];
});

// DBアイコン
const dbIcon = computed(() => {
  const icons: Record<DatabaseType, string> = {
    postgresql: 'mdi-elephant',
    mysql: 'mdi-dolphin',
    sqlite: 'mdi-database',
  };
  return icons[props.dbType];
});

// 警告バナー表示フラグ
const shouldShowWarning = computed(() => {
  return props.showWarning && (isProductionTheme.value || isStagingTheme.value);
});

// 警告メッセージ
const warningMessage = computed(() => {
  if (isProductionTheme.value) {
    return '⚠️ 本番環境 - UPDATE/DELETE操作には十分注意してください';
  } else if (isStagingTheme.value) {
    return '⚠️ ステージング環境 - 本番前の環境です';
  }
  return '';
});

// 接続ステータス
const connectionStatus = computed(() => {
  return props.connected ? '接続中' : '切断';
});

const connectionStatusColor = computed(() => {
  return props.connected ? 'success' : 'error';
});
</script>

<template>
  <div class="environment-header">
    <!-- 警告バナー -->
    <v-alert
      v-if="shouldShowWarning"
      :color="isProductionTheme ? 'error' : 'warning'"
      variant="flat"
      density="compact"
      class="warning-banner"
    >
      <template #prepend>
        <v-icon>mdi-alert</v-icon>
      </template>
      <strong>{{ warningMessage }}</strong>
    </v-alert>

    <!-- メインヘッダー -->
    <v-app-bar
      :color="currentThemeInfo.primary"
      dark
      elevation="2"
      height="64"
      class="environment-app-bar"
    >
      <!-- 左側: 環境情報 -->
      <div class="d-flex align-center flex-grow-1">
        <!-- 環境アイコン -->
        <v-icon
          size="32"
          class="ml-4 mr-3"
        >
          {{ environmentIcon }}
        </v-icon>

        <!-- 環境名と接続名 -->
        <div class="environment-info">
          <div class="environment-title">
            <v-chip
              :color="currentThemeInfo.secondary"
              size="small"
              variant="elevated"
              class="mr-2"
            >
              {{ currentThemeInfo.label }}
            </v-chip>
            <span class="connection-name">{{ connectionName }}</span>
          </div>

          <!-- 接続先情報 -->
          <div class="connection-details text-caption">
            <v-icon size="small" class="mr-1">{{ dbIcon }}</v-icon>
            <span>{{ host }} / {{ database }}</span>
          </div>
        </div>
      </div>

      <!-- 右側: ステータスとアクション -->
      <div class="d-flex align-center mr-2">
        <!-- 接続ステータス -->
        <v-chip
          :color="connectionStatusColor"
          size="small"
          variant="elevated"
          class="mr-3"
        >
          <v-icon
            start
            size="small"
          >
            {{ connected ? 'mdi-circle' : 'mdi-circle-outline' }}
          </v-icon>
          {{ connectionStatus }}
        </v-chip>

        <!-- 設定ボタン -->
        <v-btn
          icon="mdi-cog"
          variant="text"
          @click="emit('settings')"
        ></v-btn>
      </div>
    </v-app-bar>
  </div>
</template>

<style scoped>
.environment-header {
  position: sticky;
  top: 0;
  z-index: 100;
}

.warning-banner {
  border-radius: 0;
  margin-bottom: 0;
}

.environment-app-bar {
  /* ヘッダーが固定されるようにする */
}

.environment-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.environment-title {
  display: flex;
  align-items: center;
  font-size: 16px;
  font-weight: 500;
}

.connection-name {
  font-weight: 600;
}

.connection-details {
  opacity: 0.9;
  display: flex;
  align-items: center;
}
</style>
```

---

### 2. EnvironmentBadge.vue (補助コンポーネント)

**配置場所**: `src/components/common/EnvironmentBadge.vue`

小さな環境バッジ表示用（カードなどで使用）:

```vue
<script setup lang="ts">
import { computed } from 'vue';
import type { Environment } from '@/stores/types';
import { THEME_COLORS } from '@/types/theme';

const props = defineProps<{
  environment: Environment;
  size?: 'small' | 'default' | 'large';
}>();

const themeInfo = computed(() => THEME_COLORS[props.environment]);

const iconSize = computed(() => {
  const sizes = {
    small: 'x-small',
    default: 'small',
    large: 'default',
  };
  return sizes[props.size || 'default'];
});
</script>

<template>
  <v-chip
    :color="themeInfo.primary"
    :size="size || 'default'"
    variant="elevated"
  >
    {{ themeInfo.label }}
  </v-chip>
</template>
```

---

## 使用例

### クエリビルダー画面での使用

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import { useConnectionStore } from '@/stores/connection';
import { useTheme } from '@/composables/useTheme';
import EnvironmentHeader from '@/components/common/EnvironmentHeader.vue';

const route = useRoute();
const connectionStore = useConnectionStore();
const { setThemeByEnvironment } = useTheme();

const connectionId = ref(route.query.connectionId as string);
const connection = computed(() =>
  connectionStore.getConnectionById(connectionId.value)
);

const isConnected = ref(true);

onMounted(() => {
  if (connection.value) {
    setThemeByEnvironment(connection.value.environment);
  }
});

const handleSettings = () => {
  // 設定ダイアログを開く
};

const handleDisconnect = async () => {
  // 接続を切断
  isConnected.value = false;
};
</script>

<template>
  <v-app v-if="connection">
    <EnvironmentHeader
      :environment="connection.environment"
      :connection-id="connection.id"
      :connection-name="connection.name"
      :db-type="connection.dbType"
      :host="connection.host"
      :database="connection.database"
      :connected="isConnected"
      :show-warning="true"
      @settings="handleSettings"
      @disconnect="handleDisconnect"
    />

    <v-main>
      <!-- クエリビルダーのコンテンツ -->
    </v-main>
  </v-app>
</template>
```

---

## アニメーション効果

### 警告バナーの強調表示

本番環境の警告バナーに注意を引くアニメーションを追加:

```vue
<style scoped>
@keyframes pulse-warning {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.8;
  }
}

.warning-banner.production-warning {
  animation: pulse-warning 2s ease-in-out infinite;
}
</style>
```

### ヘッダーのフェードイン

```vue
<style scoped>
@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.environment-header {
  animation: fadeInDown 0.3s ease-out;
}
</style>
```

---

## レスポンシブデザイン

### モバイル対応

```vue
<template>
  <v-app-bar
    :color="currentThemeInfo.primary"
    dark
  >
    <!-- モバイル: 縦積み表示 -->
    <div class="d-flex flex-column flex-md-row align-start align-md-center flex-grow-1">
      <!-- ... -->
    </div>
  </v-app-bar>
</template>

<style scoped>
@media (max-width: 600px) {
  .environment-title {
    font-size: 14px;
  }

  .connection-details {
    font-size: 11px;
  }

  .environment-app-bar {
    height: auto !important;
    padding: 8px 0;
  }
}
</style>
```

---

## アクセシビリティ

### ARIA属性

```vue
<template>
  <v-app-bar
    role="banner"
    :aria-label="`${currentThemeInfo.label} - ${connectionName}`"
  >
    <!-- 警告バナー -->
    <v-alert
      v-if="shouldShowWarning"
      role="alert"
      aria-live="polite"
    >
      {{ warningMessage }}
    </v-alert>
  </v-app-bar>
</template>
```

### スクリーンリーダー対応

```vue
<template>
  <div class="sr-only" aria-live="polite">
    現在{{ currentThemeInfo.label }}に接続しています。
    接続先: {{ connectionName }}
  </div>
</template>

<style scoped>
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
</style>
```

---

## テスト設計

### ユニットテスト

```typescript
import { describe, it, expect } from 'vitest';
import { mount } from '@vue/test-utils';
import EnvironmentHeader from '@/components/common/EnvironmentHeader.vue';
import { createVuetify } from 'vuetify';

describe('EnvironmentHeader', () => {
  const vuetify = createVuetify();

  const defaultProps = {
    environment: 'development' as const,
    connectionId: 'test-id',
    connectionName: 'Test DB',
    dbType: 'postgresql' as const,
    host: 'localhost',
    database: 'testdb',
    connected: true,
  };

  it('should render environment information', () => {
    const wrapper = mount(EnvironmentHeader, {
      global: {
        plugins: [vuetify],
      },
      props: defaultProps,
    });

    expect(wrapper.text()).toContain('開発環境');
    expect(wrapper.text()).toContain('Test DB');
    expect(wrapper.text()).toContain('localhost / testdb');
  });

  it('should show warning banner for production environment', () => {
    const wrapper = mount(EnvironmentHeader, {
      global: {
        plugins: [vuetify],
      },
      props: {
        ...defaultProps,
        environment: 'production',
        showWarning: true,
      },
    });

    expect(wrapper.find('.warning-banner').exists()).toBe(true);
    expect(wrapper.text()).toContain('本番環境');
  });

  it('should emit settings event when settings button is clicked', async () => {
    const wrapper = mount(EnvironmentHeader, {
      global: {
        plugins: [vuetify],
      },
      props: defaultProps,
    });

    await wrapper.find('[icon="mdi-cog"]').trigger('click');
    expect(wrapper.emitted('settings')).toBeTruthy();
  });

  it('should display connection status', () => {
    const wrapper = mount(EnvironmentHeader, {
      global: {
        plugins: [vuetify],
      },
      props: {
        ...defaultProps,
        connected: true,
      },
    });

    expect(wrapper.text()).toContain('接続中');

    wrapper.setProps({ connected: false });
    expect(wrapper.text()).toContain('切断');
  });
});
```

### ビジュアルリグレッションテスト

```typescript
import { test, expect } from '@playwright/test';

test.describe('EnvironmentHeader Visual Tests', () => {
  test('should match development theme snapshot', async ({ page }) => {
    await page.goto('/query-builder?connectionId=dev-conn&environment=development');

    const header = page.locator('.environment-header');
    await expect(header).toHaveScreenshot('dev-header.png');
  });

  test('should match production theme with warning', async ({ page }) => {
    await page.goto('/query-builder?connectionId=prod-conn&environment=production');

    const header = page.locator('.environment-header');
    await expect(header).toHaveScreenshot('prod-header.png');
  });
});
```

---

## セキュリティ考慮事項

### 接続情報の表示

- パスワードは絶対に表示しない
- ホスト名とデータベース名のみ表示
- 必要に応じてマスキング機能を追加

### XSS対策

```vue
<template>
  <!-- Vue.jsの自動エスケープに依存 -->
  <div>{{ connectionName }}</div>

  <!-- v-htmlは使用しない -->
</template>
```

---

## 実装チェックリスト

- [ ] `EnvironmentHeader.vue` の作成
- [ ] `EnvironmentBadge.vue` の作成
- [ ] 環境別のテーマカラー適用
- [ ] 警告バナーの実装
- [ ] 接続ステータス表示の実装
- [ ] アニメーション効果の追加
- [ ] レスポンシブ対応
- [ ] アクセシビリティ対応
- [ ] ユニットテストの作成
- [ ] ビジュアルテストの作成

---

## パフォーマンス考慮事項

### 固定ヘッダーの最適化

```scss
.environment-header {
  position: sticky;
  top: 0;
  z-index: 100;

  // GPU加速
  will-change: transform;
  transform: translateZ(0);
}
```

### リアクティビティの最適化

- `computed` でメモ化
- 不要な再計算を防ぐ

---

## 参考資料

- [Vuetify App Bar](https://vuetifyjs.com/en/components/app-bars/)
- [Vuetify Alert](https://vuetifyjs.com/en/components/alerts/)
- [Material Design Top App Bar](https://m3.material.io/components/top-app-bar/overview)
- [WCAG 2.1 ARIA Landmarks](https://www.w3.org/WAI/WCAG21/Understanding/info-and-relationships.html)
