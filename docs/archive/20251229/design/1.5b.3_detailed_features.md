# 1.5b.3 詳細機能実装 - 詳細設計書

**作成日**: 2025-12-12
**バージョン**: 1.1
**ステータス**: 設計中（Nuxt 4対応版）
**フェーズ**: 1.5b Phase 3
**担当**: FE
**工数**: 約56時間（1週間）

---

## 目次

1. [概要](#1-概要)
2. [目的とゴール](#2-目的とゴール)
3. [サブフェーズ詳細設計](#3-サブフェーズ詳細設計)
4. [技術仕様](#4-技術仕様)
5. [依存関係とリスク](#5-依存関係とリスク)
6. [成果物チェックリスト](#6-成果物チェックリスト)

---

## 1. 概要

### 1.1 Phase 3の位置づけ

Phase 3では、設定ページ、セキュリティコンポーネント、クエリビルダーの基本構造、その他の詳細機能を実装します。アプリケーションの主要機能を完成させ、Phase 4のテストに向けた準備を行います。

### 1.2 期間

- **総工数**: 約56時間
- **期間**: 1週間
- **サブフェーズ**: 4つ（3.1 〜 3.4）

### 1.3 前提条件

- ✅ Phase 2（コア機能実装）が完了していること
- ✅ Composables、Piniaストアが正常動作すること
- ✅ ランチャーページ、接続フォームページが動作すること

---

## 2. 目的とゴール

### 2.1 主要目的

1. **設定ページの実装**
   - 一般設定、セキュリティ設定、Aboutセクション
   - ウィンドウ復元設定

2. **セキュリティコンポーネントの実装**
   - マスターパスワード設定ダイアログ
   - アンロックダイアログ
   - パスワード強度メーター
   - パスワード要件表示

3. **クエリビルダー基本構造の実装**
   - 3カラムレイアウト（左:DB構造、中央:キャンバス、右:SQL/条件）
   - リサイズ可能なパネル
   - ツールバー

4. **その他コンポーネントの実装**
   - ウィンドウ復元ダイアログ
   - アクティブフィルター表示
   - SQLプレビュー
   - クエリ情報表示

### 2.2 成功基準

| 項目 | 基準 |
|------|------|
| **設定ページ** | 一般・セキュリティ・Aboutの各タブが表示され、設定変更が可能 |
| **セキュリティ** | マスターパスワード設定・アンロックが動作する |
| **クエリビルダー** | 3カラムレイアウトが表示され、リサイズが可能 |
| **その他機能** | 各コンポーネントが正常に表示・動作する |

---

## 3. サブフェーズ詳細設計

### 3.1 サブフェーズ3.1: 設定ページ（2日）

#### 3.1.1 pages/settings.vue

**目的**: アプリケーション設定画面の実装

**実装内容**:

**`app/pages/settings.vue`**:

```vue
<script setup lang="ts">
const settingsStore = useSettingsStore()
const { currentEnvironment } = useEnvironment()

const tabs = [
  { key: 'general', label: '一般設定', icon: 'i-heroicons-cog-6-tooth' },
  { key: 'security', label: 'セキュリティ', icon: 'i-heroicons-lock-closed' },
  { key: 'about', label: 'について', icon: 'i-heroicons-information-circle' }
]

const selectedTab = ref('general')
</script>

<template>
  <div>
    <EnvironmentHeader :environment="currentEnvironment" :show-toggle="true" />

    <div class="container mx-auto p-8 max-w-5xl">
      <h2 class="text-3xl font-bold mb-6">設定</h2>

      <UTabs v-model="selectedTab" :items="tabs">
        <template #item="{ item }">
          <div class="py-6">
            <GeneralSettings v-if="item.key === 'general'" />
            <SecuritySettings v-if="item.key === 'security'" />
            <AboutSection v-if="item.key === 'about'" />
          </div>
        </template>
      </UTabs>
    </div>
  </div>
</template>
```

**成果物**: `app/pages/settings.vue`

---

#### 3.1.2 GeneralSettings.vue

**目的**: 一般設定（テーマ、言語、自動保存など）のUI

**実装内容**:

**`app/components/settings/GeneralSettings.vue`**:

```vue
<script setup lang="ts">
const settingsStore = useSettingsStore()
const { colorMode, setColorMode } = useTheme()

const settings = reactive({
  theme: settingsStore.appSettings.theme,
  language: settingsStore.appSettings.language,
  autoSave: settingsStore.appSettings.autoSave,
  windowRestore: settingsStore.appSettings.windowRestore
})

const saveSettings = async () => {
  await settingsStore.updateSettings(settings)
}

watch(() => settings.theme, (newTheme) => {
  setColorMode(newTheme)
})
</script>

<template>
  <UCard>
    <template #header>
      <h3 class="text-xl font-semibold">一般設定</h3>
    </template>

    <div class="space-y-6">
      <UFormGroup label="テーマ">
        <USelect
          v-model="settings.theme"
          :options="[
            { label: 'ライト', value: 'light' },
            { label: 'ダーク', value: 'dark' },
            { label: '自動', value: 'auto' }
          ]"
        />
      </UFormGroup>

      <UFormGroup label="言語">
        <USelect
          v-model="settings.language"
          :options="[
            { label: '日本語', value: 'ja' },
            { label: 'English', value: 'en' }
          ]"
        />
      </UFormGroup>

      <UFormGroup label="自動保存">
        <UToggle v-model="settings.autoSave" />
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          クエリを自動的に保存します
        </p>
      </UFormGroup>

      <UFormGroup label="ウィンドウ復元">
        <UToggle v-model="settings.windowRestore" />
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          アプリ起動時に前回のウィンドウを復元します
        </p>
      </UFormGroup>
    </div>

    <template #footer>
      <UButton @click="saveSettings">
        設定を保存
      </UButton>
    </template>
  </UCard>
</template>
```

**成果物**: `app/components/settings/GeneralSettings.vue`

---

#### 3.1.3 SecuritySettings.vue

**目的**: セキュリティ設定（プロバイダー選択、レベル設定）のUI

**実装内容**:

**`app/components/settings/SecuritySettings.vue`**:

```vue
<script setup lang="ts">
const securityStore = useSecurityStore()

const showMasterPasswordDialog = ref(false)
const showProviderChangeDialog = ref(false)

const openProviderChangeDialog = () => {
  showProviderChangeDialog.value = true
}

const openMasterPasswordDialog = () => {
  showMasterPasswordDialog.value = true
}
</script>

<template>
  <div class="space-y-6">
    <UCard>
      <template #header>
        <h3 class="text-xl font-semibold">セキュリティプロバイダー</h3>
      </template>

      <SecurityProviderCard
        :provider="securityStore.provider"
        :level="securityStore.level"
        @change-provider="openProviderChangeDialog"
      />
    </UCard>

    <UCard v-if="securityStore.provider === 'master-password'">
      <template #header>
        <h3 class="text-xl font-semibold">マスターパスワード</h3>
      </template>

      <div class="space-y-4">
        <SecurityLevelIndicator :level="securityStore.level" />

        <UButton
          v-if="!securityStore.masterPasswordSet"
          @click="openMasterPasswordDialog"
        >
          マスターパスワードを設定
        </UButton>

        <UButton
          v-else
          variant="outline"
          @click="openMasterPasswordDialog"
        >
          マスターパスワードを変更
        </UButton>
      </div>
    </UCard>

    <MasterPasswordSetupDialog v-model="showMasterPasswordDialog" />
    <ProviderChangeDialog v-model="showProviderChangeDialog" />
  </div>
</template>
```

**成果物**: `app/components/settings/SecuritySettings.vue`

---

### 3.2 サブフェーズ3.2: セキュリティコンポーネント（1.5日）

#### 3.2.1 MasterPasswordSetupDialog.vue

**目的**: マスターパスワード設定・変更ダイアログ

**実装内容**:

**`app/components/security/MasterPasswordSetupDialog.vue`**:

```vue
<script setup lang="ts">
const isOpen = defineModel<boolean>()

const password = ref('')
const confirmPassword = ref('')
const strength = ref(0)
const showPassword = ref(false)

const securityStore = useSecurityStore()

const passwordsMatch = computed(() => {
  if (!confirmPassword.value) return true
  return password.value === confirmPassword.value
})

const canSubmit = computed(() => {
  return password.value.length >= 8 &&
         passwordsMatch.value &&
         strength.value >= 3
})

watch(password, (newPassword) => {
  // パスワード強度を計算
  let strengthValue = 0
  if (newPassword.length >= 8) strengthValue++
  if (/[a-z]/.test(newPassword)) strengthValue++
  if (/[A-Z]/.test(newPassword)) strengthValue++
  if (/[0-9]/.test(newPassword)) strengthValue++
  if (/[^a-zA-Z0-9]/.test(newPassword)) strengthValue++
  strength.value = strengthValue
})

const setupPassword = async () => {
  try {
    await securityStore.setMasterPassword(password.value)
    isOpen.value = false
    password.value = ''
    confirmPassword.value = ''
  } catch (error) {
    console.error('Failed to set master password:', error)
  }
}
</script>

<template>
  <UModal v-model="isOpen" :prevent-close="true">
    <UCard>
      <template #header>
        <h3 class="text-xl font-semibold">マスターパスワード設定</h3>
      </template>

      <div class="space-y-4">
        <p class="text-sm text-gray-600 dark:text-gray-300">
          データベース接続情報を保護するマスターパスワードを設定します。
          このパスワードは忘れると復元できませんのでご注意ください。
        </p>

        <UFormGroup label="パスワード">
          <UInput
            v-model="password"
            :type="showPassword ? 'text' : 'password'"
            placeholder="8文字以上"
          />
        </UFormGroup>

        <PasswordStrengthMeter :password="password" :strength="strength" />

        <UFormGroup label="パスワード確認">
          <UInput
            v-model="confirmPassword"
            :type="showPassword ? 'text' : 'password'"
            placeholder="もう一度入力"
          />
          <p v-if="!passwordsMatch" class="text-sm text-red-600 mt-1">
            パスワードが一致しません
          </p>
        </UFormGroup>

        <UToggle v-model="showPassword">
          パスワードを表示
        </UToggle>

        <PasswordRequirements :password="password" />
      </div>

      <template #footer>
        <div class="flex gap-2 justify-end">
          <UButton variant="outline" @click="isOpen = false">
            キャンセル
          </UButton>
          <UButton :disabled="!canSubmit" @click="setupPassword">
            設定
          </UButton>
        </div>
      </template>
    </UCard>
  </UModal>
</template>
```

**成果物**: `app/components/security/MasterPasswordSetupDialog.vue`

---

### 3.3 サブフェーズ3.3: クエリビルダー基本構造（2.5日）

#### 3.3.1 pages/query-builder.vue

**目的**: クエリビルダーのメインページ

**実装内容**:

**`app/pages/query-builder.vue`**:

```vue
<script setup lang="ts">
const route = useRoute()
const connectionStore = useConnectionStore()

const connectionId = computed(() => route.query.connectionId as string)
const connection = computed(() =>
  connectionStore.getConnectionById(connectionId.value)
)

onMounted(() => {
  if (connection.value) {
    connectionStore.setActiveConnection(connection.value)
  }
})
</script>

<template>
  <div v-if="connection">
    <EnvironmentHeader :environment="connection.environment" />

    <div class="h-[calc(100vh-64px)] flex flex-col">
      <QueryBuilderToolbar :connection="connection" />

      <div class="flex-1 overflow-hidden">
        <QueryBuilderLayout />
      </div>
    </div>
  </div>

  <div v-else class="flex items-center justify-center h-screen">
    <p class="text-xl text-gray-600 dark:text-gray-300">
      接続が見つかりません
    </p>
  </div>
</template>
```

**成果物**: `app/pages/query-builder.vue`

---

#### 3.3.2 QueryBuilderLayout.vue

**目的**: 3カラムレイアウト（リサイズ可能）

**実装内容**:

**`app/components/query-builder/QueryBuilderLayout.vue`**:

```vue
<script setup lang="ts">
const leftPanelWidth = ref(250)
const rightPanelWidth = ref(350)
</script>

<template>
  <div class="flex h-full">
    <!-- 左パネル: DB構造 -->
    <ResizablePanel
      v-model:width="leftPanelWidth"
      :min-width="200"
      :max-width="400"
      direction="right"
    >
      <LeftPanel />
    </ResizablePanel>

    <!-- 中央パネル: キャンバス -->
    <div class="flex-1 bg-gray-50 dark:bg-gray-800">
      <CenterPanel />
    </div>

    <!-- 右パネル: SQL/条件 -->
    <ResizablePanel
      v-model:width="rightPanelWidth"
      :min-width="300"
      :max-width="600"
      direction="left"
    >
      <RightPanel />
    </ResizablePanel>
  </div>
</template>
```

**成果物**: `app/components/query-builder/QueryBuilderLayout.vue`

---

### 3.4 サブフェーズ3.4: その他コンポーネント（1日）

その他の補助的なコンポーネントを実装します：

- `RestoreWindowsDialog.vue` - ウィンドウ復元ダイアログ
- `ActiveFilters.vue` - アクティブフィルター表示
- `SqlPreview.vue` - SQLプレビュー
- `QueryInfo.vue` - クエリ情報表示

**成果物**:
- `app/components/window/RestoreWindowsDialog.vue`
- `app/components/query-builder/ActiveFilters.vue`
- `app/components/query-builder/SqlPreview.vue`
- `app/components/query-builder/QueryInfo.vue`

---

## 4. 技術仕様

### 4.1 コンポーネント構成

| カテゴリ | コンポーネント数 | 主要コンポーネント |
|---------|---------------|------------------|
| 設定 | 4 | GeneralSettings, SecuritySettings |
| セキュリティ | 4 | MasterPasswordSetupDialog, UnlockDialog |
| クエリビルダー | 7 | QueryBuilderLayout, LeftPanel, CenterPanel, RightPanel |
| その他 | 4 | RestoreWindowsDialog, SqlPreview |

### 4.2 レイアウト仕様

**クエリビルダーレイアウト**:
- 左パネル幅: 200px 〜 400px（デフォルト250px）
- 右パネル幅: 300px 〜 600px（デフォルト350px）
- 中央パネル: 残り全幅（最低400px推奨）

---

## 5. 依存関係とリスク

### 5.1 サブフェーズ依存関係

```
3.1 (設定ページ)
  ↓
3.2 (セキュリティコンポーネント)
  ↓
3.3 (クエリビルダー基本構造)
  ↓
3.4 (その他コンポーネント)
```

### 5.2 リスク管理

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| リサイズ機能の実装難易度 | 中 | 中 | 既存のリサイズライブラリを活用 |
| マスターパスワードの安全性 | 高 | 低 | Tauri側で暗号化処理を実装 |
| クエリビルダーの複雑性 | 高 | 中 | Phase 3では基本構造のみ実装、詳細はPhase 2以降 |

---

## 6. 成果物チェックリスト

### 6.1 設定ページ

- [ ] `app/pages/settings.vue`
- [ ] `app/components/settings/GeneralSettings.vue`
- [ ] `app/components/settings/SecuritySettings.vue`
- [ ] `app/components/settings/SecurityProviderCard.vue`
- [ ] `app/components/settings/SecurityLevelIndicator.vue`
- [ ] `app/components/settings/ProviderChangeDialog.vue`
- [ ] `app/components/settings/AboutSection.vue`
- [ ] `app/components/settings/WindowRestoreSettings.vue`

### 6.2 セキュリティコンポーネント

- [ ] `app/components/security/MasterPasswordSetupDialog.vue`
- [ ] `app/components/security/UnlockDialog.vue`
- [ ] `app/components/security/PasswordStrengthMeter.vue`
- [ ] `app/components/security/PasswordRequirements.vue`

### 6.3 クエリビルダー

- [ ] `app/pages/query-builder.vue`
- [ ] `app/components/query-builder/QueryBuilderLayout.vue`
- [ ] `app/components/query-builder/QueryBuilderToolbar.vue`
- [ ] `app/components/query-builder/LeftPanel.vue`
- [ ] `app/components/query-builder/CenterPanel.vue`
- [ ] `app/components/query-builder/RightPanel.vue`
- [ ] `app/components/query-builder/ResizablePanel.vue`

### 6.4 その他コンポーネント

- [ ] `app/components/window/RestoreWindowsDialog.vue`
- [ ] `app/components/query-builder/ActiveFilters.vue`
- [ ] `app/components/query-builder/SqlPreview.vue`
- [ ] `app/components/query-builder/QueryInfo.vue`

### 6.5 動作確認

- [ ] 設定ページの各タブが表示される
- [ ] 設定変更が保存される
- [ ] セキュリティプロバイダーの変更が可能
- [ ] マスターパスワードの設定・変更が可能
- [ ] クエリビルダーのレイアウトが表示される
- [ ] パネルのリサイズが正常に動作する

---

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|-------|------|
| プロジェクトマネージャー | | | |
| 技術リード | | | |
| フロントエンド担当 | | | |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|--------|
| 1.0 | 2025-12-12 | 初版作成 | Claude |
| 1.1 | 2025-12-12 | Nuxt 4.2.2 + Nuxt UI v4.2.1対応 | Claude |

---

**次のアクション**:
1. 本設計書のレビュー・承認
2. サブフェーズ3.1から順次実装開始
3. 完了後、Phase 4の設計書作成へ進む
