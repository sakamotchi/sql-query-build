# タスク1.3.8: 検索・フィルター機能実装 設計書

## 概要

**タスクID**: 1.3.8
**タスク名**: 検索・フィルター機能実装
**工数**: 1日
**依存関係**: 1.3.2 (接続カードコンポーネント作成)
**完了条件**: 接続の検索が可能

---

## 目的

ランチャー画面で接続を効率的に検索・フィルタリングする機能を実装する。テキスト検索、環境別フィルター、データベース種別フィルター、ソート機能を提供する。

---

## 機能要件

### 検索機能
- **テキスト検索**: 接続名、ホスト名、データベース名で検索
- **リアルタイム検索**: 入力に応じて即座に結果を更新
- **大文字小文字を区別しない**: 柔軟な検索

### フィルター機能
- **環境別フィルター**: 開発/テスト/ステージング/本番
- **データベース種別フィルター**: PostgreSQL/MySQL/SQLite
- **複数条件の組み合わせ**: 検索 + 環境 + DB種別

### ソート機能
- **接続名順**: アルファベット順
- **最終使用日時順**: 最近使用したものを上位表示
- **環境順**: 開発→テスト→ステージング→本番
- **作成日時順**: 新しいものを上位表示

---

## データ構造

### フィルター状態

**ファイル**: `src/stores/types.ts` (既存)

```typescript
export interface ConnectionFilter {
  searchQuery: string;
  environment: Environment | 'all';
  dbType: DatabaseType | 'all';
}

export type ConnectionSort = 'name' | 'lastUsed' | 'environment' | 'createdAt';
```

---

## フィルタリングロジック

### Piniaストア実装 (既存)

**ファイル**: `src/stores/connection.ts`

```typescript
getters: {
  /**
   * フィルタリング済みの接続リスト
   */
  filteredConnections(state): Connection[] {
    let filtered = [...state.connections];

    // 1. テキスト検索
    if (state.filter.searchQuery) {
      filtered = this.searchConnections(filtered, state.filter.searchQuery);
    }

    // 2. 環境フィルター
    if (state.filter.environment && state.filter.environment !== 'all') {
      filtered = filtered.filter(
        (conn) => conn.environment === state.filter.environment
      );
    }

    // 3. データベース種別フィルター
    if (state.filter.dbType && state.filter.dbType !== 'all') {
      filtered = filtered.filter((conn) => conn.dbType === state.filter.dbType);
    }

    // 4. ソート
    return this.sortConnections(filtered, state.sort);
  },
},

actions: {
  /**
   * 接続を検索
   */
  searchConnections(connections: Connection[], query: string): Connection[] {
    const lowerQuery = query.toLowerCase().trim();

    if (!lowerQuery) {
      return connections;
    }

    return connections.filter((conn) => {
      // 接続名で検索
      if (conn.name.toLowerCase().includes(lowerQuery)) {
        return true;
      }

      // ホスト名で検索
      if (conn.host.toLowerCase().includes(lowerQuery)) {
        return true;
      }

      // データベース名で検索
      if (conn.database.toLowerCase().includes(lowerQuery)) {
        return true;
      }

      // ユーザー名で検索
      if (conn.username.toLowerCase().includes(lowerQuery)) {
        return true;
      }

      return false;
    });
  },

  /**
   * 接続をソート
   */
  sortConnections(connections: Connection[], sortBy: ConnectionSort): Connection[] {
    const sorted = [...connections];

    switch (sortBy) {
      case 'name':
        return sorted.sort((a, b) =>
          a.name.localeCompare(b.name, 'ja')
        );

      case 'lastUsed':
        return sorted.sort((a, b) => {
          // 最終使用日時がない場合は最後に
          if (!a.lastUsedAt && !b.lastUsedAt) return 0;
          if (!a.lastUsedAt) return 1;
          if (!b.lastUsedAt) return -1;

          return new Date(b.lastUsedAt).getTime() - new Date(a.lastUsedAt).getTime();
        });

      case 'environment':
        const envOrder: Record<Environment, number> = {
          development: 0,
          test: 1,
          staging: 2,
          production: 3,
        };
        return sorted.sort((a, b) => {
          const orderDiff = envOrder[a.environment] - envOrder[b.environment];
          // 環境が同じ場合は名前順
          return orderDiff !== 0 ? orderDiff : a.name.localeCompare(b.name, 'ja');
        });

      case 'createdAt':
        return sorted.sort((a, b) =>
          new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
        );

      default:
        return sorted;
    }
  },
}
```

---

## UIコンポーネント

### ツールバーコンポーネント (既存の拡張)

**ファイル**: `src/components/connection/LauncherToolbar.vue`

```vue
<template>
  <v-toolbar flat class="mb-4">
    <v-row align="center" no-gutters>
      <!-- 検索バー -->
      <v-col cols="12" sm="6" md="4">
        <v-text-field
          :model-value="search"
          @update:model-value="handleSearchChange"
          prepend-inner-icon="mdi-magnify"
          label="接続名、ホスト名、データベース名で検索"
          single-line
          hide-details
          clearable
          variant="outlined"
          density="compact"
          @click:clear="handleSearchClear"
        >
          <template v-slot:append-inner>
            <v-chip
              v-if="resultCount !== null"
              size="small"
              color="primary"
              variant="tonal"
            >
              {{ resultCount }} 件
            </v-chip>
          </template>
        </v-text-field>
      </v-col>

      <v-spacer></v-spacer>

      <!-- 環境フィルター -->
      <v-col cols="6" sm="auto">
        <v-select
          :model-value="filter"
          @update:model-value="$emit('update:filter', $event)"
          :items="environmentFilterOptions"
          label="環境"
          variant="outlined"
          density="compact"
          hide-details
          style="min-width: 180px"
        >
          <template v-slot:selection="{ item }">
            <div class="d-flex align-center">
              <v-icon
                v-if="item.value !== 'all'"
                :color="item.raw.color"
                size="small"
                class="mr-2"
              >
                {{ item.raw.icon }}
              </v-icon>
              <span>{{ item.title }}</span>
            </div>
          </template>

          <template v-slot:item="{ item, props }">
            <v-list-item v-bind="props">
              <template v-slot:prepend>
                <v-icon
                  v-if="item.value !== 'all'"
                  :color="item.raw.color"
                >
                  {{ item.raw.icon }}
                </v-icon>
              </template>
            </v-list-item>
          </template>
        </v-select>
      </v-col>

      <!-- データベース種別フィルター -->
      <v-col cols="6" sm="auto" class="ml-sm-2">
        <v-select
          :model-value="dbTypeFilter"
          @update:model-value="$emit('update:dbTypeFilter', $event)"
          :items="dbTypeFilterOptions"
          label="データベース"
          variant="outlined"
          density="compact"
          hide-details
          style="min-width: 160px"
        >
          <template v-slot:selection="{ item }">
            <div class="d-flex align-center">
              <v-icon
                v-if="item.value !== 'all'"
                size="small"
                class="mr-2"
              >
                {{ item.raw.icon }}
              </v-icon>
              <span>{{ item.title }}</span>
            </div>
          </template>

          <template v-slot:item="{ item, props }">
            <v-list-item v-bind="props">
              <template v-slot:prepend>
                <v-icon v-if="item.value !== 'all'">
                  {{ item.raw.icon }}
                </v-icon>
              </template>
            </v-list-item>
          </template>
        </v-select>
      </v-col>

      <!-- ソート -->
      <v-col cols="12" sm="auto" class="ml-sm-2">
        <v-select
          :model-value="sort"
          @update:model-value="$emit('update:sort', $event)"
          :items="sortOptions"
          label="並び順"
          variant="outlined"
          density="compact"
          hide-details
          style="min-width: 180px"
        >
          <template v-slot:selection="{ item }">
            <div class="d-flex align-center">
              <v-icon size="small" class="mr-2">{{ item.raw.icon }}</v-icon>
              <span>{{ item.title }}</span>
            </div>
          </template>

          <template v-slot:item="{ item, props }">
            <v-list-item v-bind="props">
              <template v-slot:prepend>
                <v-icon>{{ item.raw.icon }}</v-icon>
              </template>
            </v-list-item>
          </template>
        </v-select>
      </v-col>

      <!-- フィルタークリアボタン -->
      <v-col v-if="hasActiveFilters" cols="auto" class="ml-2">
        <v-btn
          variant="text"
          color="grey-darken-1"
          size="small"
          @click="handleClearFilters"
        >
          <v-icon class="mr-1">mdi-filter-off</v-icon>
          クリア
        </v-btn>
      </v-col>
    </v-row>
  </v-toolbar>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import type { Environment, DatabaseType } from '@/stores/types';

const props = defineProps<{
  search: string;
  filter: Environment | 'all';
  dbTypeFilter: DatabaseType | 'all';
  sort: string;
  resultCount?: number;
}>();

const emit = defineEmits<{
  'update:search': [value: string];
  'update:filter': [value: Environment | 'all'];
  'update:dbTypeFilter': [value: DatabaseType | 'all'];
  'update:sort': [value: string];
  'clear-filters': [];
}>();

// 環境フィルターオプション
const environmentFilterOptions = [
  { title: 'すべての環境', value: 'all' },
  {
    title: '開発環境',
    value: 'development',
    icon: 'mdi-laptop',
    color: '#4CAF50',
  },
  {
    title: 'テスト環境',
    value: 'test',
    icon: 'mdi-flask',
    color: '#2196F3',
  },
  {
    title: 'ステージング環境',
    value: 'staging',
    icon: 'mdi-server',
    color: '#FF9800',
  },
  {
    title: '本番環境',
    value: 'production',
    icon: 'mdi-alert-circle',
    color: '#F44336',
  },
];

// データベース種別フィルターオプション
const dbTypeFilterOptions = [
  { title: 'すべてのDB', value: 'all' },
  { title: 'PostgreSQL', value: 'postgresql', icon: 'mdi-elephant' },
  { title: 'MySQL', value: 'mysql', icon: 'mdi-dolphin' },
  { title: 'SQLite', value: 'sqlite', icon: 'mdi-database' },
];

// ソートオプション
const sortOptions = [
  { title: '最終使用日時順', value: 'lastUsed', icon: 'mdi-clock-outline' },
  { title: '接続名順', value: 'name', icon: 'mdi-sort-alphabetical-ascending' },
  { title: '環境順', value: 'environment', icon: 'mdi-server' },
  { title: '作成日時順', value: 'createdAt', icon: 'mdi-calendar' },
];

// アクティブなフィルターがあるかチェック
const hasActiveFilters = computed(() => {
  return (
    props.search ||
    props.filter !== 'all' ||
    props.dbTypeFilter !== 'all'
  );
});

// 検索変更ハンドラー (デバウンス)
let searchTimeout: number | null = null;
const handleSearchChange = (value: string | null) => {
  if (searchTimeout) {
    clearTimeout(searchTimeout);
  }

  searchTimeout = window.setTimeout(() => {
    emit('update:search', value || '');
  }, 300); // 300ms デバウンス
};

// 検索クリア
const handleSearchClear = () => {
  emit('update:search', '');
};

// フィルタークリア
const handleClearFilters = () => {
  emit('update:search', '');
  emit('update:filter', 'all');
  emit('update:dbTypeFilter', 'all');
  emit('clear-filters');
};
</script>
```

---

## アクティブフィルターインジケーター

### フィルターチップ表示

```vue
<template>
  <div v-if="hasActiveFilters" class="active-filters mb-4">
    <v-chip-group>
      <span class="text-caption text-grey-darken-1 mr-2">フィルター:</span>

      <!-- 検索クエリ -->
      <v-chip
        v-if="filter.searchQuery"
        closable
        size="small"
        color="primary"
        variant="tonal"
        @click:close="clearSearch"
      >
        <v-icon start>mdi-magnify</v-icon>
        "{{ filter.searchQuery }}"
      </v-chip>

      <!-- 環境フィルター -->
      <v-chip
        v-if="filter.environment !== 'all'"
        closable
        size="small"
        :color="getEnvironmentColor(filter.environment)"
        variant="tonal"
        @click:close="clearEnvironment"
      >
        <v-icon start>{{ getEnvironmentIcon(filter.environment) }}</v-icon>
        {{ getEnvironmentLabel(filter.environment) }}
      </v-chip>

      <!-- DB種別フィルター -->
      <v-chip
        v-if="filter.dbType !== 'all'"
        closable
        size="small"
        color="blue-grey"
        variant="tonal"
        @click:close="clearDbType"
      >
        <v-icon start>{{ getDbTypeIcon(filter.dbType) }}</v-icon>
        {{ getDbTypeLabel(filter.dbType) }}
      </v-chip>
    </v-chip-group>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { useConnectionStore } from '@/stores/connection';
import { storeToRefs } from 'pinia';

const connectionStore = useConnectionStore();
const { filter } = storeToRefs(connectionStore);

const hasActiveFilters = computed(() => {
  return (
    filter.value.searchQuery ||
    filter.value.environment !== 'all' ||
    filter.value.dbType !== 'all'
  );
});

const clearSearch = () => {
  connectionStore.setFilter({ searchQuery: '' });
};

const clearEnvironment = () => {
  connectionStore.setFilter({ environment: 'all' });
};

const clearDbType = () => {
  connectionStore.setFilter({ dbType: 'all' });
};
</script>
```

---

## キーボードショートカット

### ショートカット実装

```typescript
// src/composables/useKeyboardShortcuts.ts
import { onMounted, onUnmounted } from 'vue';

export function useSearchShortcut(searchInputRef: Ref<HTMLElement | null>) {
  const handleKeydown = (event: KeyboardEvent) => {
    // Ctrl/Cmd + F で検索にフォーカス
    if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
      event.preventDefault();
      searchInputRef.value?.focus();
    }

    // Esc でフィルタークリア
    if (event.key === 'Escape') {
      // フォーカスが検索バーにある場合のみ
      if (document.activeElement === searchInputRef.value) {
        connectionStore.resetFilter();
      }
    }
  };

  onMounted(() => {
    document.addEventListener('keydown', handleKeydown);
  });

  onUnmounted(() => {
    document.removeEventListener('keydown', handleKeydown);
  });
}
```

---

## パフォーマンス最適化

### デバウンス処理

```typescript
// 検索入力のデバウンス
const debouncedSearch = debounce((query: string) => {
  connectionStore.setFilter({ searchQuery: query });
}, 300);
```

### メモ化

```typescript
// フィルタリング結果のメモ化はPiniaのgetterで自動的に行われる
const filteredConnections = computed(() =>
  connectionStore.filteredConnections
);
```

---

## アクセシビリティ

### ARIA属性

```html
<v-text-field
  role="searchbox"
  aria-label="接続を検索"
  aria-describedby="search-description"
>
</v-text-field>

<div id="search-description" class="sr-only">
  接続名、ホスト名、またはデータベース名で検索できます
</div>
```

### スクリーンリーダー対応

```html
<div role="status" aria-live="polite" class="sr-only">
  {{ filteredConnections.length }} 件の接続が見つかりました
</div>
```

---

## テスト

### ユニットテスト

```typescript
import { describe, it, expect } from 'vitest';
import { setActivePinia, createPinia } from 'pinia';
import { useConnectionStore } from '@/stores/connection';

describe('Connection Search and Filter', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
  });

  it('should filter by search query', () => {
    const store = useConnectionStore();
    store.connections = [
      { id: '1', name: 'Production DB', host: 'prod.example.com' },
      { id: '2', name: 'Dev DB', host: 'dev.example.com' },
    ] as Connection[];

    store.setFilter({ searchQuery: 'prod' });

    expect(store.filteredConnections).toHaveLength(1);
    expect(store.filteredConnections[0].name).toBe('Production DB');
  });

  it('should filter by environment', () => {
    const store = useConnectionStore();
    store.connections = [
      { id: '1', environment: 'production' },
      { id: '2', environment: 'development' },
    ] as Connection[];

    store.setFilter({ environment: 'production' });

    expect(store.filteredConnections).toHaveLength(1);
    expect(store.filteredConnections[0].environment).toBe('production');
  });

  it('should combine multiple filters', () => {
    const store = useConnectionStore();
    store.connections = [
      { id: '1', name: 'Prod PG', environment: 'production', dbType: 'postgresql' },
      { id: '2', name: 'Prod MySQL', environment: 'production', dbType: 'mysql' },
      { id: '3', name: 'Dev PG', environment: 'development', dbType: 'postgresql' },
    ] as Connection[];

    store.setFilter({
      environment: 'production',
      dbType: 'postgresql',
    });

    expect(store.filteredConnections).toHaveLength(1);
    expect(store.filteredConnections[0].name).toBe('Prod PG');
  });

  it('should sort by name', () => {
    const store = useConnectionStore();
    store.connections = [
      { id: '1', name: 'Zebra' },
      { id: '2', name: 'Alpha' },
      { id: '3', name: 'Beta' },
    ] as Connection[];

    store.setSort('name');

    const sorted = store.filteredConnections;
    expect(sorted[0].name).toBe('Alpha');
    expect(sorted[1].name).toBe('Beta');
    expect(sorted[2].name).toBe('Zebra');
  });
});
```

---

## ユーザーエクスペリエンス向上

### 空状態メッセージ

```vue
<template>
  <div v-if="filteredConnections.length === 0 && hasActiveFilters" class="empty-state">
    <v-icon size="64" color="grey-lighten-1">mdi-filter-off-outline</v-icon>
    <div class="text-h6 mt-4 text-grey">検索条件に一致する接続がありません</div>
    <div class="text-body-2 text-grey-darken-1 mt-2">
      別の検索条件を試すか、フィルターをクリアしてください
    </div>
    <v-btn
      color="primary"
      variant="outlined"
      class="mt-4"
      @click="clearAllFilters"
    >
      フィルターをクリア
    </v-btn>
  </div>
</template>
```

### ローディング状態

```vue
<template>
  <v-skeleton-loader
    v-if="loading"
    type="card"
    :loading="true"
  ></v-skeleton-loader>
</template>
```

---

## 実装チェックリスト

- [ ] Piniaストアのフィルタリングロジック実装
- [ ] ツールバーコンポーネントの拡張
- [ ] アクティブフィルターインジケーターの実装
- [ ] デバウンス処理の実装
- [ ] キーボードショートカットの実装
- [ ] 空状態メッセージの実装
- [ ] ユニットテストの作成
- [ ] E2Eテストの作成
- [ ] アクセシビリティのテスト

---

## 将来の拡張

### 高度な検索
- **正規表現検索**: パワーユーザー向け
- **タグ検索**: タグでフィルタリング
- **保存された検索**: よく使う検索条件を保存

### フィルタープリセット
- **よく使うフィルター**: ワンクリックで適用
- **フィルター履歴**: 最近使用したフィルター
