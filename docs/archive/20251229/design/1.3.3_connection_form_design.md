# タスク1.3.3: 接続設定フォームUI実装 設計書

## 概要

**タスクID**: 1.3.3
**タスク名**: 接続設定フォームUI実装
**工数**: 2日
**依存関係**: 1.3.1 (起動画面(ランチャー)UI実装)
**完了条件**: フォームが表示される

---

## 目的

データベース接続情報の登録・編集を行うフォーム画面のUIを実装する。環境設定、認証情報、接続オプションを入力できるようにする。

---

## 画面構成

### レイアウト構造

```
┌─────────────────────────────────────────────────┐
│ [×] 接続設定                                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  基本情報                                        │
│  ┌─────────────────────────────────────────┐   │
│  │ 接続名: [___________________________]  │   │
│  │ 環境:   [開発環境 ▼]                   │   │
│  │ テーマ色: [🟢 緑]                       │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  データベース設定                                │
│  ┌─────────────────────────────────────────┐   │
│  │ データベース種別: [PostgreSQL ▼]       │   │
│  │ ホスト: [_____________________]        │   │
│  │ ポート: [5432]                         │   │
│  │ データベース名: [_________________]    │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  認証情報                                        │
│  ┌─────────────────────────────────────────┐   │
│  │ ユーザー名: [_____________________]    │   │
│  │ パスワード: [*********************]    │   │
│  │ □ パスワードを保存する                  │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  詳細設定                                        │
│  ┌─────────────────────────────────────────┐   │
│  │ ☑ SSL接続を使用                         │   │
│  │ □ SSH トンネル                          │   │
│  │ タイムアウト: [30] 秒                   │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  [接続テスト]                [キャンセル] [保存] │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## コンポーネント設計

### ページコンポーネント: `ConnectionForm.vue`

**配置場所**: `src/pages/connection-form.vue`

---

## Props定義

```typescript
interface ConnectionFormProps {
  connection?: Connection;  // 編集時に既存の接続情報
  mode: 'create' | 'edit' | 'duplicate';
}
```

---

## Emits定義

```typescript
interface ConnectionFormEmits {
  (e: 'save', connection: Connection): void;
  (e: 'cancel'): void;
  (e: 'test-connection', connection: Partial<Connection>): void;
}
```

---

## データ構造

### フォームデータ型

```typescript
interface ConnectionFormData {
  // 基本情報
  name: string;
  environment: Environment;
  themeColor: string;

  // データベース設定
  dbType: DatabaseType;
  host: string;
  port: number;
  database: string;

  // 認証情報
  username: string;
  password: string;
  savePassword: boolean;

  // 詳細設定
  ssl: boolean;
  sshTunnel: boolean;
  sshHost?: string;
  sshPort?: number;
  sshUsername?: string;
  sshPassword?: string;
  timeout: number;
}

type Environment = 'development' | 'test' | 'staging' | 'production';
type DatabaseType = 'postgresql' | 'mysql' | 'sqlite';
```

---

## バリデーションルール

### 基本情報
```typescript
const validationRules = {
  name: [
    (v: string) => !!v || '接続名は必須です',
    (v: string) => v.length <= 100 || '接続名は100文字以内で入力してください',
  ],

  environment: [
    (v: string) => !!v || '環境は必須です',
  ],
};
```

### データベース設定
```typescript
const databaseValidationRules = {
  host: [
    (v: string) => !!v || 'ホスト名は必須です',
    (v: string) => /^[a-zA-Z0-9.-]+$/.test(v) || 'ホスト名の形式が正しくありません',
  ],

  port: [
    (v: number) => !!v || 'ポート番号は必須です',
    (v: number) => v > 0 && v <= 65535 || 'ポート番号は1-65535の範囲で入力してください',
  ],

  database: [
    (v: string) => !!v || 'データベース名は必須です',
    (v: string) => v.length <= 63 || 'データベース名は63文字以内で入力してください',
  ],
};
```

### 認証情報
```typescript
const authValidationRules = {
  username: [
    (v: string) => !!v || 'ユーザー名は必須です',
  ],

  password: [
    (v: string) => {
      if (formData.value.savePassword) {
        return !!v || 'パスワードは必須です';
      }
      return true;
    },
  ],
};
```

---

## コンポーネント実装

### テンプレート構造

```vue
<template>
  <v-card>
    <v-card-title class="d-flex align-center">
      <span class="text-h5">
        {{ mode === 'create' ? '新規接続' : mode === 'edit' ? '接続編集' : '接続複製' }}
      </span>
      <v-spacer></v-spacer>
      <v-btn icon="mdi-close" variant="text" @click="handleCancel"></v-btn>
    </v-card-title>

    <v-divider></v-divider>

    <v-card-text>
      <v-form ref="formRef" v-model="formValid" @submit.prevent="handleSave">
        <!-- 基本情報 -->
        <v-card variant="outlined" class="mb-4">
          <v-card-title class="text-subtitle-1">基本情報</v-card-title>
          <v-card-text>
            <v-text-field
              v-model="formData.name"
              label="接続名"
              :rules="validationRules.name"
              required
              variant="outlined"
              prepend-inner-icon="mdi-label"
            ></v-text-field>

            <v-select
              v-model="formData.environment"
              :items="environmentOptions"
              label="環境"
              :rules="validationRules.environment"
              required
              variant="outlined"
              prepend-inner-icon="mdi-server"
            >
              <template v-slot:item="{ item, props }">
                <v-list-item v-bind="props">
                  <template v-slot:prepend>
                    <v-icon :color="item.raw.color">{{ item.raw.icon }}</v-icon>
                  </template>
                </v-list-item>
              </template>
            </v-select>

            <EnvironmentColorPicker
              v-model="formData.themeColor"
              :environment="formData.environment"
            />
          </v-card-text>
        </v-card>

        <!-- データベース設定 -->
        <v-card variant="outlined" class="mb-4">
          <v-card-title class="text-subtitle-1">データベース設定</v-card-title>
          <v-card-text>
            <v-select
              v-model="formData.dbType"
              :items="databaseTypeOptions"
              label="データベース種別"
              required
              variant="outlined"
              prepend-inner-icon="mdi-database"
              @update:model-value="handleDatabaseTypeChange"
            >
              <template v-slot:item="{ item, props }">
                <v-list-item v-bind="props">
                  <template v-slot:prepend>
                    <v-icon>{{ item.raw.icon }}</v-icon>
                  </template>
                </v-list-item>
              </template>
            </v-select>

            <v-text-field
              v-model="formData.host"
              label="ホスト"
              :rules="databaseValidationRules.host"
              required
              variant="outlined"
              prepend-inner-icon="mdi-server-network"
              placeholder="localhost"
            ></v-text-field>

            <v-text-field
              v-model.number="formData.port"
              label="ポート"
              :rules="databaseValidationRules.port"
              required
              type="number"
              variant="outlined"
              prepend-inner-icon="mdi-numeric"
            ></v-text-field>

            <v-text-field
              v-model="formData.database"
              label="データベース名"
              :rules="databaseValidationRules.database"
              required
              variant="outlined"
              prepend-inner-icon="mdi-database"
            ></v-text-field>
          </v-card-text>
        </v-card>

        <!-- 認証情報 -->
        <v-card variant="outlined" class="mb-4">
          <v-card-title class="text-subtitle-1">認証情報</v-card-title>
          <v-card-text>
            <v-text-field
              v-model="formData.username"
              label="ユーザー名"
              :rules="authValidationRules.username"
              required
              variant="outlined"
              prepend-inner-icon="mdi-account"
              autocomplete="username"
            ></v-text-field>

            <v-text-field
              v-model="formData.password"
              :label="formData.savePassword ? 'パスワード *' : 'パスワード (接続時に入力)'"
              :rules="authValidationRules.password"
              :type="showPassword ? 'text' : 'password'"
              variant="outlined"
              prepend-inner-icon="mdi-lock"
              :append-inner-icon="showPassword ? 'mdi-eye-off' : 'mdi-eye'"
              @click:append-inner="showPassword = !showPassword"
              autocomplete="current-password"
            ></v-text-field>

            <v-checkbox
              v-model="formData.savePassword"
              label="パスワードを保存する"
              hint="パスワードは暗号化して保存されます"
              persistent-hint
            ></v-checkbox>

            <v-alert v-if="!formData.savePassword" type="info" variant="tonal" class="mt-2">
              パスワードを保存しない場合、接続時に毎回入力が必要です
            </v-alert>
          </v-card-text>
        </v-card>

        <!-- 詳細設定 -->
        <v-expansion-panels>
          <v-expansion-panel>
            <v-expansion-panel-title>
              <v-icon class="mr-2">mdi-cog</v-icon>
              詳細設定
            </v-expansion-panel-title>
            <v-expansion-panel-text>
              <v-checkbox
                v-model="formData.ssl"
                label="SSL接続を使用"
                hint="セキュアな接続を使用します"
                persistent-hint
              ></v-checkbox>

              <v-checkbox
                v-model="formData.sshTunnel"
                label="SSHトンネルを使用"
                hint="SSHトンネル経由でデータベースに接続します"
                persistent-hint
                class="mt-4"
              ></v-checkbox>

              <!-- SSH設定 (SSHトンネル有効時のみ表示) -->
              <v-expand-transition>
                <div v-if="formData.sshTunnel" class="mt-4">
                  <v-divider class="mb-4"></v-divider>
                  <div class="text-subtitle-2 mb-2">SSH設定</div>

                  <v-text-field
                    v-model="formData.sshHost"
                    label="SSHホスト"
                    variant="outlined"
                    density="compact"
                  ></v-text-field>

                  <v-text-field
                    v-model.number="formData.sshPort"
                    label="SSHポート"
                    type="number"
                    variant="outlined"
                    density="compact"
                  ></v-text-field>

                  <v-text-field
                    v-model="formData.sshUsername"
                    label="SSHユーザー名"
                    variant="outlined"
                    density="compact"
                  ></v-text-field>
                </div>
              </v-expand-transition>

              <v-text-field
                v-model.number="formData.timeout"
                label="接続タイムアウト (秒)"
                type="number"
                variant="outlined"
                hint="0で無制限"
                persistent-hint
                class="mt-4"
              ></v-text-field>
            </v-expansion-panel-text>
          </v-expansion-panel>
        </v-expansion-panels>
      </v-form>
    </v-card-text>

    <v-divider></v-divider>

    <v-card-actions>
      <v-btn
        color="primary"
        variant="outlined"
        prepend-icon="mdi-connection"
        :loading="testingConnection"
        @click="handleTestConnection"
      >
        接続テスト
      </v-btn>

      <v-spacer></v-spacer>

      <v-btn variant="text" @click="handleCancel">
        キャンセル
      </v-btn>

      <v-btn
        color="primary"
        variant="flat"
        :disabled="!formValid"
        @click="handleSave"
      >
        保存
      </v-btn>
    </v-card-actions>
  </v-card>
</template>
```

---

## スクリプト実装

```typescript
<script setup lang="ts">
import { ref, reactive, computed, watch } from 'vue';
import type { Connection, Environment, DatabaseType } from '@/types/connection';

const props = defineProps<{
  connection?: Connection;
  mode: 'create' | 'edit' | 'duplicate';
}>();

const emit = defineEmits<{
  save: [connection: Connection];
  cancel: [];
  'test-connection': [connection: Partial<Connection>];
}>();

// フォーム状態
const formRef = ref<any>(null);
const formValid = ref(false);
const showPassword = ref(false);
const testingConnection = ref(false);

// フォームデータ
const formData = reactive<ConnectionFormData>({
  name: '',
  environment: 'development',
  themeColor: '#4CAF50',
  dbType: 'postgresql',
  host: 'localhost',
  port: 5432,
  database: '',
  username: '',
  password: '',
  savePassword: true,
  ssl: false,
  sshTunnel: false,
  timeout: 30,
});

// 環境オプション
const environmentOptions = [
  {
    title: '開発環境',
    value: 'development',
    icon: 'mdi-laptop',
    color: '#4CAF50',
  },
  {
    title: 'テスト環境',
    value: 'test',
    icon: 'mdi-flask',
    color: '#2196F3',
  },
  {
    title: 'ステージング環境',
    value: 'staging',
    icon: 'mdi-server',
    color: '#FF9800',
  },
  {
    title: '本番環境',
    value: 'production',
    icon: 'mdi-alert-circle',
    color: '#F44336',
  },
];

// データベース種別オプション
const databaseTypeOptions = [
  {
    title: 'PostgreSQL',
    value: 'postgresql',
    icon: 'mdi-elephant',
    defaultPort: 5432,
  },
  {
    title: 'MySQL',
    value: 'mysql',
    icon: 'mdi-dolphin',
    defaultPort: 3306,
  },
  {
    title: 'SQLite',
    value: 'sqlite',
    icon: 'mdi-database',
    defaultPort: 0,
  },
];

// データベース種別変更時の処理
const handleDatabaseTypeChange = (dbType: DatabaseType) => {
  const option = databaseTypeOptions.find(opt => opt.value === dbType);
  if (option && option.defaultPort > 0) {
    formData.port = option.defaultPort;
  }
};

// 初期化
const initializeForm = () => {
  if (props.connection && (props.mode === 'edit' || props.mode === 'duplicate')) {
    Object.assign(formData, {
      ...props.connection,
      name: props.mode === 'duplicate' ? `${props.connection.name} (コピー)` : props.connection.name,
    });
  }
};

// 保存処理
const handleSave = async () => {
  const valid = await formRef.value?.validate();
  if (!valid) return;

  const connectionData: Connection = {
    id: props.connection?.id || crypto.randomUUID(),
    ...formData,
    createdAt: props.connection?.createdAt || new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };

  emit('save', connectionData);
};

// キャンセル処理
const handleCancel = () => {
  emit('cancel');
};

// 接続テスト
const handleTestConnection = async () => {
  const valid = await formRef.value?.validate();
  if (!valid) return;

  testingConnection.value = true;
  emit('test-connection', formData);
};

// 接続テスト結果を親から受け取る
const finishTestConnection = () => {
  testingConnection.value = false;
};

// 初期化
initializeForm();

// エクスポート (親コンポーネントから呼び出せるメソッド)
defineExpose({
  finishTestConnection,
});
</script>
```

---

## 子コンポーネント

### EnvironmentColorPicker.vue

環境別のテーマカラーを選択するコンポーネント

```vue
<template>
  <div class="environment-color-picker">
    <div class="text-subtitle-2 mb-2">テーマカラー</div>
    <v-item-group v-model="selectedColor" mandatory>
      <v-row>
        <v-col
          v-for="color in colorOptions"
          :key="color.value"
          cols="3"
        >
          <v-item v-slot="{ isSelected, toggle }" :value="color.value">
            <v-card
              :color="color.value"
              :variant="isSelected ? 'elevated' : 'outlined'"
              :elevation="isSelected ? 4 : 0"
              @click="toggle"
              class="color-card"
            >
              <v-card-text class="text-center pa-2">
                <div
                  class="color-preview"
                  :style="{ backgroundColor: color.value }"
                ></div>
                <div class="text-caption mt-1">{{ color.label }}</div>
                <v-icon v-if="isSelected" color="white" size="small">
                  mdi-check-circle
                </v-icon>
              </v-card-text>
            </v-card>
          </v-item>
        </v-col>
      </v-row>
    </v-item-group>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';

const props = defineProps<{
  modelValue: string;
  environment: string;
}>();

const emit = defineEmits<{
  'update:modelValue': [value: string];
}>();

const selectedColor = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value),
});

const colorOptions = computed(() => {
  const baseColors = {
    development: [
      { label: '緑', value: '#4CAF50' },
      { label: '明緑', value: '#81C784' },
      { label: '濃緑', value: '#388E3C' },
    ],
    test: [
      { label: '青', value: '#2196F3' },
      { label: '明青', value: '#64B5F6' },
      { label: '濃青', value: '#1976D2' },
    ],
    staging: [
      { label: 'オレンジ', value: '#FF9800' },
      { label: '明オレンジ', value: '#FFB74D' },
      { label: '濃オレンジ', value: '#F57C00' },
    ],
    production: [
      { label: '赤', value: '#F44336' },
      { label: '明赤', value: '#E57373' },
      { label: '濃赤', value: '#D32F2F' },
    ],
  };

  return baseColors[props.environment as keyof typeof baseColors] || baseColors.development;
});
</script>

<style scoped lang="scss">
.color-card {
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    transform: scale(1.05);
  }
}

.color-preview {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin: 0 auto;
  border: 2px solid rgba(0, 0, 0, 0.1);
}
</style>
```

---

## アクセシビリティ

### フォーカス管理
- 画面表示時に最初の入力フィールド(接続名)にフォーカス

### エラー表示
- バリデーションエラーはフィールド下に赤文字で表示
- 必須フィールドにはアスタリスク(*)を表示

### キーボード操作
- **Enter**: 保存
- **Esc**: キャンセル
- **Tab**: 次のフィールドへ移動

---

## テスト観点

### ユニットテスト
- [ ] バリデーションルールが正しく動作すること
- [ ] データベース種別変更時にデフォルトポートが設定されること
- [ ] 環境変更時にテーマカラーが更新されること

### E2Eテスト
- [ ] フォームが正しく表示されること
- [ ] 新規作成モードで保存できること
- [ ] 編集モードで保存できること
- [ ] 接続テストが実行できること
- [ ] バリデーションエラーが表示されること

---

## 実装チェックリスト

- [ ] `src/pages/connection-form.vue` の作成
- [ ] `src/components/connection/EnvironmentColorPicker.vue` の作成
- [ ] バリデーションルールの実装
- [ ] 接続テスト機能の実装
- [ ] アクセシビリティ対応
- [ ] ユニットテストの作成
- [ ] E2Eテストの作成
