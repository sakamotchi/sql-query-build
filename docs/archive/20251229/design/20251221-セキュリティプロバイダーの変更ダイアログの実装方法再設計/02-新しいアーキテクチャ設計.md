# 新しいアーキテクチャ設計

## 設計方針

### 単一責任の原則
各ダイアログコンポーネントは、**1つの移行フロー**のみを担当する。

### コンポーネント分割戦略

移行フローを以下の2つのカテゴリに分類:

1. **認証が不要なフロー** (Simpleから他プロバイダーへの移行)
2. **認証が必要なフロー** (Master Passwordから他プロバイダーへの移行)

## コンポーネント構成

```
app/components/security/
├── ProviderChangeDialog.vue (削除予定)
├── provider-change/
│   ├── FromSimpleDialog.vue          # Simpleからの移行用
│   ├── FromMasterPasswordDialog.vue  # Master Passwordからの移行用
│   ├── ProviderCard.vue              # プロバイダー情報表示用の共通コンポーネント
│   └── composables/
│       └── useProviderSwitch.ts      # プロバイダー切り替えロジックの共通化
```

## コンポーネント詳細設計

### 1. FromSimpleDialog.vue

**責務:** Simple プロバイダーから Master Password への移行

**対応する移行パターン (初期実装):**
- Simple → Master Password

**将来実装予定:**
- Simple → Keychain

**フェーズ:**
```typescript
type Phase = 'confirm' | 'initialize' | 'switching' | 'complete' | 'error'
```

**フロー:**
1. **confirm**: 移行先プロバイダーの確認
2. **initialize**: 新しいマスターパスワードの設定
3. **switching**: プロバイダー切り替え処理
4. **complete**: 完了
5. **error**: エラー

**Props (初期実装):**
```typescript
interface Props {
  // 初期実装では 'master-password' のみサポート
  // 将来的に 'keychain' を追加予定
  targetProvider: 'master-password'
}
```

**特徴:**
- 認証フェーズなし(Simpleは認証不要)
- 新しいマスターパスワードの設定が必須
- シンプルで直線的なフロー

---

### 2. FromMasterPasswordDialog.vue

**責務:** Master Password プロバイダーから Simple への移行

**対応する移行パターン (初期実装):**
- Master Password → Simple

**将来実装予定:**
- Master Password → Keychain

**フェーズ:**
```typescript
type Phase = 'confirm' | 'authenticate' | 'switching' | 'complete' | 'error'
```

**フロー:**
1. **confirm**: 移行先プロバイダーの確認
2. **authenticate**: 現在のマスターパスワードで認証
3. **switching**: プロバイダー切り替え処理
4. **complete**: 完了
5. **error**: エラー

**Props (初期実装):**
```typescript
interface Props {
  // 初期実装では 'simple' のみサポート
  // 将来的に 'keychain' を追加予定
  targetProvider: 'simple'
}
```

**特徴:**
- 認証フェーズが必須
- 移行先がSimpleなので初期化パラメータ不要
- 認証後は直接switching フェーズへ

---

### 3. ProviderCard.vue

**責務:** プロバイダー情報の視覚的表示

**Props:**
```typescript
interface Props {
  provider: SecurityProvider
  variant: 'current' | 'target'  // 現在のプロバイダーか移行先か
}
```

**表示内容:**
- プロバイダー名
- 説明文
- セキュリティレベル表示
- 現在/移行先の視覚的区別

**使用例:**
```vue
<template>
  <div class="grid grid-cols-2 gap-4">
    <ProviderCard provider="simple" variant="current" />
    <ProviderCard provider="master-password" variant="target" />
  </div>
</template>
```

---

### 4. useProviderSwitch.ts (Composable)

**責務:** プロバイダー切り替えのバックエンド通信ロジック

**提供する機能 (初期実装):**
```typescript
export function useProviderSwitch() {
  const securityStore = useSecurityStore()

  /**
   * SimpleからMaster Passwordへの切り替え
   * 将来的にKeychainもサポート予定
   */
  async function switchFromSimple(params: {
    targetProvider: 'master-password'  // 初期実装では 'master-password' のみ
    newPassword: string  // 必須
    newPasswordConfirm: string
  }): Promise<void>

  /**
   * Master PasswordからSimpleへの切り替え
   * 将来的にKeychainもサポート予定
   */
  async function switchFromMasterPassword(params: {
    targetProvider: 'simple'  // 初期実装では 'simple' のみ
    currentPassword: string
  }): Promise<void>

  return {
    switchFromSimple,
    switchFromMasterPassword
  }
}
```

**利点:**
- バックエンド通信ロジックの一元管理
- 型安全性の向上
- テスタビリティの向上
- 各ダイアログコンポーネントから重複コードを排除

## 親コンポーネントでの使用方法

**変更前 (現在):**
```vue
<ProviderChangeDialog
  v-model:open="isDialogOpen"
  :params="{ from: 'simple', to: 'master-password' }"
/>
```

**変更後:**
```vue
<!-- Simpleからの移行 -->
<FromSimpleDialog
  v-model:open="isDialogOpen"
  :target-provider="targetProvider"
/>

<!-- Master Passwordからの移行 -->
<FromMasterPasswordDialog
  v-model:open="isDialogOpen"
  :target-provider="targetProvider"
/>
```

親コンポーネント側で、現在のプロバイダーに応じて適切なダイアログを選択する必要がある。

## 比較表

| 項目 | 現在の実装 | 新しい設計 |
|------|-----------|-----------|
| コンポーネント数 | 1 | 3 (+ 1 composable) |
| 1コンポーネントの責務 | 全フロー | 1フロー |
| フェーズ数 | 6 | 4-5 (フローによる) |
| `nextPhase`の分岐 | 複雑(from/to依存) | シンプル(線形) |
| テストケース数 | 多い(全組み合わせ) | 少ない(フローごと) |
| 新規プロバイダー追加時の影響 | 全体に影響 | 該当フローのみ |
| コードの可読性 | 低い | 高い |
| 保守性 | 低い | 高い |

## 段階的移行計画

1. **Phase 1: 共通コンポーネント作成**
   - `ProviderCard.vue` 作成
   - `useProviderSwitch.ts` composable 作成

2. **Phase 2: 新ダイアログ作成**
   - `FromSimpleDialog.vue` 作成
   - `FromMasterPasswordDialog.vue` 作成

3. **Phase 3: 親コンポーネント更新**
   - 設定ページで新しいダイアログを使用するように変更

4. **Phase 4: 旧コンポーネント削除**
   - `ProviderChangeDialog.vue` 削除
