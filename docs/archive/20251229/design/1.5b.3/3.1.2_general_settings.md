# 3.1.2 GeneralSettings.vue

**フェーズ**: 1.5b Phase 3 - サブフェーズ3.1
**作成日**: 2025-12-12
**工数**: 0.75日

---

## 目的

一般設定（テーマ、言語、自動保存など）のUI実装

---

## 実装内容

### ファイル構成

**`app/components/settings/GeneralSettings.vue`**

---

### コンポーネント仕様

- 一般設定カードを1枚に集約し、テーマ/言語/自動保存/ウィンドウ復元を編集
- `settingsStore.settings` をフォームにバインドし、保存時に `updateSettings` を呼ぶ
- テーマ変更時に `setColorMode` で即時反映
- 読み込み中・保存中のステータス表示と簡易エラーメッセージを表示

### 実装コード

```vue
<script setup lang="ts">
import { storeToRefs } from 'pinia'
import type { AppSettings } from '~/types'

const settingsStore = useSettingsStore()
const { setColorMode } = useTheme()

const { settings, loading, error } = storeToRefs(settingsStore)

const form = reactive<AppSettings>({
  theme: settings.value.theme,
  language: settings.value.language,
  autoSave: settings.value.autoSave,
  windowRestore: settings.value.windowRestore
})

const saving = ref(false)
const message = ref<string | null>(null)

watch(
  settings,
  (current) => {
    // ストア更新時にフォームへ反映（ページ再訪や外部更新に対応）
    Object.assign(form, current)
  },
  { deep: true }
)

watch(
  () => form.theme,
  (mode) => {
    setColorMode(mode)
  }
)

const saveSettings = async () => {
  saving.value = true
  message.value = null
  try {
    await settingsStore.updateSettings({ ...form })
    message.value = '設定を保存しました'
  } catch (e) {
    message.value = '設定の保存に失敗しました'
  } finally {
    saving.value = false
  }
}
</script>

<template>
  <UCard>
    <template #header>
      <div class="flex items-center justify-between gap-3">
        <h3 class="text-xl font-semibold">一般設定</h3>
        <UBadge v-if="saving" color="primary" variant="soft">保存中</UBadge>
      </div>
    </template>

    <div class="space-y-6">
      <UFormGroup label="テーマ" hint="アプリ全体のカラーモード">
        <USelect
          v-model="form.theme"
          :options="[
            { label: 'ライト', value: 'light' },
            { label: 'ダーク', value: 'dark' },
            { label: '自動', value: 'auto' }
          ]"
        />
      </UFormGroup>

      <UFormGroup label="言語" hint="将来的にi18nで切り替え予定">
        <USelect
          v-model="form.language"
          :options="[
            { label: '日本語', value: 'ja' },
            { label: 'English', value: 'en' }
          ]"
        />
      </UFormGroup>

      <UFormGroup label="自動保存">
        <div class="space-y-1">
          <UToggle v-model="form.autoSave" />
          <p class="text-sm text-gray-600 dark:text-gray-400">
            クエリを一定間隔で自動保存します
          </p>
        </div>
      </UFormGroup>

      <UFormGroup label="ウィンドウ復元">
        <div class="space-y-1">
          <UToggle v-model="form.windowRestore" />
          <p class="text-sm text-gray-600 dark:text-gray-400">
            再起動時に前回のウィンドウ位置とサイズを復元します
          </p>
        </div>
      </UFormGroup>

      <UAlert
        v-if="error || message"
        :color="error ? 'red' : 'green'"
        variant="soft"
        :title="error ? '設定の読み込み/保存でエラーが発生しました' : '完了'"
      >
        {{ error || message }}
      </UAlert>
    </div>

    <template #footer>
      <div class="flex justify-end">
        <UButton
          color="primary"
          :loading="saving || loading"
          :disabled="loading"
          @click="saveSettings"
        >
          設定を保存
        </UButton>
      </div>
    </template>
  </UCard>
</template>
```

---

## 技術仕様

### 設定項目

| 項目 | 型 | デフォルト値 | 説明 |
|------|---|------------|------|
| theme | ColorMode | 'auto' | カラーモード（light/dark/auto） |
| language | Language | 'ja' | UI言語（現状は選択のみ、将来i18nで反映） |
| autoSave | boolean | true | クエリの自動保存 |
| windowRestore | boolean | true | ウィンドウ位置とサイズの復元 |

### 状態管理

- **ストア依存**: `settingsStore.settings` を唯一の真実源とし、ローカルフォームは双方向同期  
- **テーマ反映**: `form.theme` 変更時に `setColorMode` を即時呼び出し  
- **ローディング**: `settingsStore.loading` をフォーム操作の無効化に使用  
- **エラー**: `settingsStore.error` を `UAlert` で表示し、保存完了メッセージも同カード内に表示

### 使用コンポーネント

- `UCard` / `UFormGroup` / `USelect` / `UToggle` / `UButton` / `UBadge` / `UAlert`

### 使用Composable / ストア

- `useSettingsStore()`  
  - `settings`: `AppSettings`  
  - `updateSettings(partial)`：Tauri経由で永続化し、反映後の設定を返却  
  - `loading` / `error`
- `useTheme()`  
  - `setColorMode(mode: ColorMode)`：Nuxt UIのカラーモードを更新

### データフロー

```mermaid
graph LR
    A[settingsStore.settings] --> B[form]
    B --> C[watch(theme)]
    C --> D[setColorMode]
    E[保存ボタン] --> F[settingsStore.updateSettings(form)]
    F --> G[settingsStore.settings]
    G --> B
```

---

## 成果物

- [ ] `app/components/settings/GeneralSettings.vue`

---

## 動作確認項目

- [ ] テーマを変更すると即座にダーク/ライト/自動へ反映される
- [ ] 設定保存が成功し、バッジまたは完了メッセージが表示される
- [ ] 保存失敗時にエラーメッセージが表示される
- [ ] 言語選択・自動保存・ウィンドウ復元の各トグル/セレクトが動作する
- [ ] ページ再表示時にストアから設定が同期される

---

## 依存関係

**前提条件**:
- ✅ `useSettingsStore()` が実装され、`get_settings` / `update_settings` のTauriコマンドが利用可能
- ✅ `useTheme()` が実装されている
- ✅ Nuxt UIコンポーネント（UCard/USelect/UToggle/UAlert等）が利用可能

---

## 今後の拡張

- i18n対応による言語切り替えの実動化
- 自動保存間隔の調整、保存先の指定
- ウィンドウ復元の詳細設定（マルチウィンドウ対応時の動作方針）
- エディタ設定（タブサイズ、ライン番号表示など）
- キーボードショートカットのカスタマイズ

---

## 備考

- 設定はリアクティブに管理される
- テーマ変更は即座に反映（保存不要）
- その他の設定は「設定を保存」ボタンで確定
- Nuxt UIのダークモード機能を活用
