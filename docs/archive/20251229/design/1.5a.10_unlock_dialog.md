# 1.5a.10 起動時マスターパスワード入力ダイアログ

## 概要

| 項目 | 内容 |
|------|------|
| タスクID | 1.5a.10 |
| タスク名 | 起動時マスターパスワード入力ダイアログ |
| 担当 | FE |
| 工数 | 1日 |
| 依存関係 | 1.5a.9 |
| 完了条件 | 起動時認証UI完成 |

## 目的

マスターパスワードプロバイダーが設定されている場合、アプリ起動時にパスワード入力を求めるダイアログを表示する。

## コンポーネント

```
src/components/security/
└── UnlockDialog.vue               # アンロックダイアログ
```

## 画面設計

### UnlockDialog.vue

```vue
<template>
  <v-dialog
    v-model="isOpen"
    max-width="400"
    persistent
    :scrim="true"
    scrim-color="rgba(0,0,0,0.8)"
  >
    <v-card class="unlock-dialog">
      <!-- ロゴ・タイトル -->
      <v-card-item class="text-center pt-8">
        <div class="mb-4">
          <v-avatar size="80" color="primary">
            <v-icon size="48">mdi-database-lock</v-icon>
          </v-avatar>
        </div>
        <v-card-title class="text-h5">SQL Query Builder</v-card-title>
        <v-card-subtitle>マスターパスワードを入力してください</v-card-subtitle>
      </v-card-item>

      <v-card-text class="pt-4">
        <v-form ref="form" v-model="isFormValid" @submit.prevent="onSubmit">
          <v-text-field
            v-model="password"
            :type="showPassword ? 'text' : 'password'"
            label="マスターパスワード"
            :rules="[v => !!v || 'パスワードを入力してください']"
            :error-messages="error ? [error] : []"
            :append-inner-icon="showPassword ? 'mdi-eye-off' : 'mdi-eye'"
            @click:append-inner="showPassword = !showPassword"
            @keyup.enter="onSubmit"
            autofocus
            autocomplete="current-password"
            variant="outlined"
          />

          <!-- 認証失敗カウント -->
          <v-fade-transition>
            <div v-if="failedAttempts > 0" class="text-center mb-4">
              <span class="text-caption text-error">
                認証失敗: {{ failedAttempts }} 回
              </span>
              <span v-if="failedAttempts >= 3" class="text-caption text-grey">
                <br />パスワードを忘れた場合は、設定をリセットする必要があります。
              </span>
            </div>
          </v-fade-transition>

          <v-btn
            color="primary"
            size="large"
            block
            :loading="isLoading"
            :disabled="!isFormValid || isLocked"
            type="submit"
          >
            <v-icon start>mdi-lock-open</v-icon>
            アンロック
          </v-btn>
        </v-form>

        <!-- ロックアウト表示 -->
        <v-fade-transition>
          <v-alert
            v-if="isLocked"
            type="warning"
            variant="tonal"
            class="mt-4"
          >
            複数回の認証失敗により、{{ lockoutRemaining }}秒間ロックされています。
          </v-alert>
        </v-fade-transition>
      </v-card-text>

      <v-card-actions class="justify-center pb-6">
        <v-btn
          variant="text"
          size="small"
          @click="showResetConfirm = true"
        >
          パスワードを忘れた場合
        </v-btn>
      </v-card-actions>
    </v-card>

    <!-- リセット確認ダイアログ -->
    <v-dialog v-model="showResetConfirm" max-width="400">
      <v-card>
        <v-card-title class="text-error">
          <v-icon start color="error">mdi-alert</v-icon>
          設定のリセット
        </v-card-title>
        <v-card-text>
          <p>
            マスターパスワードをリセットすると、
            <strong>保存されているすべてのデータベースパスワードが削除されます。</strong>
          </p>
          <p class="mb-0">
            接続情報は残りますが、パスワードは再入力が必要になります。
          </p>
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn
            variant="text"
            @click="showResetConfirm = false"
          >
            キャンセル
          </v-btn>
          <v-btn
            color="error"
            @click="onReset"
          >
            リセットする
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted } from 'vue';
import { useSecurityStore } from '@/stores/security';

const props = defineProps<{
  modelValue: boolean;
}>();

const emit = defineEmits<{
  'update:modelValue': [value: boolean];
  'unlocked': [];
  'reset': [];
}>();

const securityStore = useSecurityStore();

const isOpen = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value),
});

const form = ref<HTMLFormElement | null>(null);
const password = ref('');
const showPassword = ref(false);
const isFormValid = ref(false);
const isLoading = ref(false);
const error = ref<string | null>(null);
const failedAttempts = ref(0);
const showResetConfirm = ref(false);

// ロックアウト機能
const MAX_ATTEMPTS = 5;
const LOCKOUT_DURATION = 30; // 秒
const isLocked = ref(false);
const lockoutRemaining = ref(0);
let lockoutTimer: ReturnType<typeof setInterval> | null = null;

const onSubmit = async () => {
  if (!isFormValid.value || isLocked.value) return;

  isLoading.value = true;
  error.value = null;

  try {
    await securityStore.unlock(password.value);
    failedAttempts.value = 0;
    emit('unlocked');
    isOpen.value = false;
  } catch (e) {
    failedAttempts.value++;
    error.value = '認証に失敗しました';
    password.value = '';

    // ロックアウト判定
    if (failedAttempts.value >= MAX_ATTEMPTS) {
      startLockout();
    }
  } finally {
    isLoading.value = false;
  }
};

const startLockout = () => {
  isLocked.value = true;
  lockoutRemaining.value = LOCKOUT_DURATION;

  lockoutTimer = setInterval(() => {
    lockoutRemaining.value--;
    if (lockoutRemaining.value <= 0) {
      isLocked.value = false;
      failedAttempts.value = 0;
      if (lockoutTimer) {
        clearInterval(lockoutTimer);
        lockoutTimer = null;
      }
    }
  }, 1000);
};

const onReset = async () => {
  try {
    await securityStore.reset();
    showResetConfirm.value = false;
    emit('reset');
    isOpen.value = false;
  } catch (e) {
    // エラーハンドリング
  }
};

// クリーンアップ
onUnmounted(() => {
  if (lockoutTimer) {
    clearInterval(lockoutTimer);
  }
});

// ダイアログを閉じる際にリセット
watch(isOpen, (value) => {
  if (!value) {
    password.value = '';
    error.value = null;
  }
});
</script>

<style scoped>
.unlock-dialog {
  overflow: hidden;
}
</style>
```

## アプリケーション統合

### App.vue での使用

```vue
<template>
  <v-app>
    <!-- メインコンテンツ -->
    <router-view v-if="isUnlocked" />

    <!-- ローディング -->
    <div v-else-if="isInitializing" class="d-flex align-center justify-center h-100">
      <v-progress-circular indeterminate color="primary" />
    </div>

    <!-- アンロックダイアログ -->
    <UnlockDialog
      v-model="showUnlockDialog"
      @unlocked="onUnlocked"
      @reset="onReset"
    />
  </v-app>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useSecurityStore } from '@/stores/security';
import UnlockDialog from '@/components/security/UnlockDialog.vue';

const securityStore = useSecurityStore();

const isInitializing = ref(true);
const isUnlocked = ref(false);
const showUnlockDialog = ref(false);

onMounted(async () => {
  try {
    await securityStore.initialize();

    if (securityStore.needsUnlock) {
      showUnlockDialog.value = true;
    } else {
      isUnlocked.value = true;
    }
  } finally {
    isInitializing.value = false;
  }
});

const onUnlocked = () => {
  isUnlocked.value = true;
};

const onReset = () => {
  // リセット後の処理（Simpleプロバイダーに戻る）
  isUnlocked.value = true;
};
</script>
```

## セキュリティストア拡張

```typescript
// src/stores/security.ts (追加)
export const useSecurityStore = defineStore('security', () => {
  // ... 既存のコード

  const needsUnlock = computed(() => {
    return config.value?.providerType === 'master_password' &&
           providerState.value === 'locked';
  });

  const initialize = async () => {
    await loadConfig();
    const info = await securityApi.getProviderInfo();
    providerState.value = info.state;
  };

  const unlock = async (password: string) => {
    await securityApi.unlockWithMasterPassword(password);
    providerState.value = 'ready';
  };

  const reset = async () => {
    await securityApi.resetProvider();
    await loadConfig();
    providerState.value = 'ready';
  };

  return {
    // ... 既存の return
    needsUnlock,
    initialize,
    unlock,
    reset,
  };
});
```

## テスト

```typescript
describe('UnlockDialog', () => {
  it('shows dialog when provider needs unlock', async () => {
    const wrapper = mount(UnlockDialog, {
      props: { modelValue: true },
    });

    expect(wrapper.find('.unlock-dialog').exists()).toBe(true);
  });

  it('unlocks with correct password', async () => {
    const wrapper = mount(UnlockDialog, {
      props: { modelValue: true },
    });

    await wrapper.find('input').setValue('correct-password');
    await wrapper.find('form').trigger('submit');

    expect(wrapper.emitted('unlocked')).toBeTruthy();
  });

  it('shows error on wrong password', async () => {
    // 間違ったパスワードでエラー表示
  });

  it('locks out after max attempts', async () => {
    // 複数回失敗でロックアウト
  });
});
```

## 実装チェックリスト

- [ ] `UnlockDialog.vue` 実装
- [ ] ロックアウト機能実装
- [ ] リセット確認ダイアログ実装
- [ ] App.vueへの統合
- [ ] セキュリティストア拡張
- [ ] コンポーネントテスト作成

---

**作成日**: 2025-11-24
**作成者**: Claude Code
