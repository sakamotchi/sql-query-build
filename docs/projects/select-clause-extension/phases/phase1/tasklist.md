# Phase 1 タスクリスト: 式ツリー基盤構築

**フェーズ目標**: ExpressionNode型定義とバックエンドSQL生成ロジックの実装、シンプルな式入力UI

**状態**: 📝 未着手

---

## タスク一覧

### 1. 型定義とデータモデル

| ID | タスク | 状態 | 優先度 | 見積もり |
|----|--------|------|--------|---------|
| T1.1 | ExpressionNode型定義（TypeScript） | ⬜ 未着手 | 必須 | 中 |
| T1.2 | ExpressionNode型定義（Rust） | ⬜ 未着手 | 必須 | 中 |
| T1.3 | SelectColumn型に`expressionTree`フィールド追加 | ⬜ 未着手 | 必須 | 小 |
| T1.4 | 型のシリアライズ/デシリアライズテスト | ⬜ 未着手 | 必須 | 小 |

**依存関係**: なし（最初のタスク）

---

### 2. バックエンド - SQL生成ロジック

| ID | タスク | 状態 | 優先度 | 見積もり |
|----|--------|------|--------|---------|
| T2.1 | ExpressionBuilder実装（式ツリー→SQL変換） | ⬜ 未着手 | 必須 | 大 |
| T2.2 | ColumnReference のSQL生成 | ⬜ 未着手 | 必須 | 小 |
| T2.3 | LiteralValue のSQL生成（エスケープ処理） | ⬜ 未着手 | 必須 | 中 |
| T2.4 | FunctionCall のSQL生成 | ⬜ 未着手 | 必須 | 中 |
| T2.5 | BinaryOperation のSQL生成 | ⬜ 未着手 | 必須 | 小 |
| T2.6 | UnaryOperation のSQL生成 | ⬜ 未着手 | 必須 | 小 |
| T2.7 | Subquery のSQL生成（括弧付き） | ⬜ 未着手 | 必須 | 中 |

**依存関係**: T1系（型定義完了後）

---

### 3. データベース方言対応

| ID | タスク | 状態 | 優先度 | 見積もり |
|----|--------|------|--------|---------|
| T3.1 | 関数名マッピングテーブル作成 | ⬜ 未着手 | 必須 | 中 |
| T3.2 | PostgreSQL方言での関数SQL生成 | ⬜ 未着手 | 必須 | 中 |
| T3.3 | MySQL方言での関数SQL生成 | ⬜ 未着手 | 必須 | 中 |
| T3.4 | SQLite方言での関数SQL生成 | ⬜ 未着手 | 必須 | 中 |
| T3.5 | リテラル値のクォート処理（DB別） | ⬜ 未着手 | 必須 | 小 |

**依存関係**: T2系（SQL生成ロジック完了後）

---

### 4. フロントエンド - 基本UI

| ID | タスク | 状態 | 優先度 | 見積もり |
|----|--------|------|--------|---------|
| T4.1 | SelectTabに「式を追加」ボタン追加 | ⬜ 未着手 | 必須 | 小 |
| T4.2 | ExpressionItem.vueコンポーネント作成 | ⬜ 未着手 | 必須 | 中 |
| T4.3 | 式の入力フィールド実装（テキスト入力） | ⬜ 未着手 | 必須 | 小 |
| T4.4 | エイリアス入力フィールド実装 | ⬜ 未着手 | 必須 | 小 |
| T4.5 | 式のプレビュー表示 | ⬜ 未着手 | 必須 | 小 |
| T4.6 | 式の削除機能 | ⬜ 未着手 | 必須 | 小 |

**依存関係**: T2系（バックエンド完了後、またはモックで並行開発可）

---

### 5. ストアとデータフロー

| ID | タスク | 状態 | 優先度 | 見積もり |
|----|--------|------|--------|---------|
| T5.1 | queryBuilderストアに`addExpression()`追加 | ⬜ 未着手 | 必須 | 小 |
| T5.2 | queryBuilderストアに`updateExpression()`追加 | ⬜ 未着手 | 必須 | 小 |
| T5.3 | queryBuilderストアに`removeExpression()`追加 | ⬜ 未着手 | 必須 | 小 |
| T5.4 | 式追加時のSQL再生成トリガー実装 | ⬜ 未着手 | 必須 | 小 |
| T5.5 | QueryModel変換ロジック更新 | ⬜ 未着手 | 必須 | 中 |

**依存関係**: T1系, T4系（型定義とUI完了後）

---

### 6. テスト

| ID | タスク | 状態 | 優先度 | 見積もり |
|----|--------|------|--------|---------|
| T6.1 | ExpressionNode型のシリアライズテスト | ⬜ 未着手 | 必須 | 小 |
| T6.2 | ExpressionBuilderの単体テスト | ⬜ 未着手 | 必須 | 中 |
| T6.3 | 各データベースでのSQL生成テスト | ⬜ 未着手 | 必須 | 中 |
| T6.4 | フロントエンド単体テスト（コンポーネント） | ⬜ 未着手 | 必須 | 中 |
| T6.5 | E2Eテスト（式入力→SQL生成→実行） | ⬜ 未着手 | 必須 | 大 |
| T6.6 | リグレッションテスト（既存機能） | ⬜ 未着手 | 必須 | 中 |

**依存関係**: 各実装タスク完了後

---

### 7. ドキュメント

| ID | タスク | 状態 | 優先度 | 見積もり |
|----|--------|------|--------|---------|
| T7.1 | 型定義のコメント追加 | ⬜ 未着手 | 高 | 小 |
| T7.2 | 06_ubiquitous_language.md更新 | ⬜ 未着手 | 高 | 小 |
| T7.3 | features/query-builder.md更新 | ⬜ 未着手 | 高 | 小 |
| T7.4 | 使用例のドキュメント作成 | ⬜ 未着手 | 中 | 小 |

**依存関係**: 実装完了後

---

## 進捗サマリー

| カテゴリ | 完了 | 進行中 | 未着手 | 合計 |
|---------|------|--------|--------|------|
| 型定義 | 0 | 0 | 4 | 4 |
| バックエンド | 0 | 0 | 7 | 7 |
| 方言対応 | 0 | 0 | 5 | 5 |
| フロントエンド | 0 | 0 | 6 | 6 |
| ストア | 0 | 0 | 5 | 5 |
| テスト | 0 | 0 | 6 | 6 |
| ドキュメント | 0 | 0 | 4 | 4 |
| **合計** | **0** | **0** | **37** | **37** |

---

## クリティカルパス

```
T1.1/T1.2 → T2.1 → T3.1 → T3.2/T3.3/T3.4 → T6.3 → T6.5
  (型定義)   (SQL生成)  (方言)    (DB対応)      (テスト)
```

---

## 完了条件

- [ ] すべてのタスクが完了している
- [ ] 単体テストが全て合格している
- [ ] E2Eテストが全て合格している
- [ ] リグレッションテストが全て合格している
- [ ] コードレビューが完了している
- [ ] ドキュメントが更新されている
- [ ] testing.mdのテスト手順が全て完了している

---

## 備考

### 技術的注意事項

- ExpressionNodeは再帰的な構造のため、深さ制限（最大10レベル）を実装すること
- リテラル値のエスケープ処理に注意（SQLインジェクション防止）
- 既存のexpression/aggregate型との共存を保つこと

### 開発時の注意

- Nuxt UI v4の記法を使用すること（UFormField + items）
- 既存のWhereClauseの実装を参考にすること
- 各タスク完了後に都度コミットすること
