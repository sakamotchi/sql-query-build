# Phase 2 テスト手順書: 関数ビルダーUI

**テスト対象**: 関数ビルダーUI、関数マスター、式ツリー変換

**前提条件**:
- Phase 2の実装が完了している
- Phase 1のテストが全て合格している
- テストデータベースが準備されている

---

## 1. 関数マスターのテスト

### 1.1 関数定義の検証

**手順**:
```bash
# 関数マスターの単体テスト
npm run test -- database-functions
```

**期待結果**:
- すべての関数が正しく定義されている
- 引数の数、型が正しい
- データベース方言マッピングが正しい

---

## 2. 関数ビルダーUIのテスト

### 2.1 関数ビルダーの起動

**手順**:
1. アプリを起動してクエリビルダーを開く
2. テーブルを選択
3. SELECTタブで「関数を追加」ボタンをクリック

**期待結果**:
- 関数ビルダーダイアログが表示される
- カテゴリ選択が表示される

---

### 2.2 関数カテゴリの選択

**手順**:
1. カテゴリドロップダウンをクリック
2. 各カテゴリ（文字列/日付/数値/条件）を選択

**期待結果**:
- 各カテゴリの関数リストが表示される
- 関数名と説明が表示される

---

### 2.3 シンプルな関数の構築（UPPER）

**手順**:
1. カテゴリ「文字列」を選択
2. 関数「UPPER」を選択
3. 引数1: カラム `u.name` を選択
4. エイリアス `upper_name` を入力
5. 「追加」ボタンをクリック

**期待結果**:
- プレビューに `UPPER(u.name)` が表示される
- 選択済みリストに追加される
- SQLプレビューに `UPPER(u.name) AS upper_name` が表示される

---

### 2.4 複数引数の関数の構築（CONCAT）

**手順**:
1. カテゴリ「文字列」を選択
2. 関数「CONCAT」を選択
3. 引数1: カラム `u.first_name` を選択
4. 引数2: リテラル値 `' '` を入力
5. 引数3: カラム `u.last_name` を選択
6. エイリアス `full_name` を入力
7. 「追加」ボタンをクリック

**期待結果**:
- プレビューに `CONCAT(u.first_name, ' ', u.last_name)` が表示される
- 選択済みリストに追加される

---

### 2.5 ネストした関数の構築

**手順**:
1. カテゴリ「文字列」を選択
2. 関数「UPPER」を選択
3. 引数1: 「関数を追加」をクリック
   - ネストした関数「SUBSTRING」を選択
   - 引数1: カラム `u.name`
   - 引数2: リテラル `1`
   - 引数3: リテラル `3`
4. エイリアス `short_upper_name` を入力
5. 「追加」ボタンをクリック

**期待結果**:
- プレビューに `UPPER(SUBSTRING(u.name, 1, 3))` が表示される
- 選択済みリストに追加される

---

## 3. データベース方言対応のテスト

### 3.1 CONCAT関数の方言変換（SQLite）

**手順**:
1. SQLiteデータベースに接続
2. CONCAT関数を構築（前述と同様）
3. SQLプレビューを確認

**期待結果**:
- SQLプレビューに `u.first_name || ' ' || u.last_name` が表示される（CONCATが||に変換）

---

### 3.2 非対応関数の警告

**手順**:
1. PostgreSQL専用の関数（例: REGEXP_REPLACE）を選択
2. MySQLに接続を切り替える

**期待結果**:
- 警告メッセージが表示される
- または非対応関数がリストに表示されない

---

## 4. 式ツリー変換のテスト

### 4.1 関数から式ツリーへの変換

**手順**:
```bash
# 単体テスト実行
npm run test -- function-to-expression-tree
```

**期待結果**:
- 関数定義が正しく式ツリーに変換される
- ネストした関数も正しく変換される

---

## 5. E2Eテスト

### 5.1 文字列関数のクエリ実行

**手順**:
1. PostgreSQLに接続
2. usersテーブルを選択
3. 以下の関数を関数ビルダーで追加:
   - UPPER(name) AS upper_name
   - LOWER(email) AS lower_email
   - CONCAT(first_name, ' ', last_name) AS full_name
   - SUBSTRING(name, 1, 3) AS name_prefix
4. クエリを実行

**期待されるSQL**:
```sql
SELECT
  UPPER(name) AS upper_name,
  LOWER(email) AS lower_email,
  CONCAT(first_name, ' ', last_name) AS full_name,
  SUBSTRING(name, 1, 3) AS name_prefix
FROM users
```

**期待結果**:
- クエリが正常に実行される
- 各カラムが正しく表示される

---

### 5.2 日付関数のクエリ実行

**手順**:
1. ordersテーブルを選択
2. 以下の関数を追加:
   - NOW() AS current_time
   - DATE_FORMAT(created_at, '%Y-%m-%d') AS date_only
3. クエリを実行

**期待されるSQL（PostgreSQL）**:
```sql
SELECT
  NOW() AS current_time,
  TO_CHAR(created_at, 'YYYY-MM-DD') AS date_only
FROM orders
```

**期待結果**:
- 現在時刻と日付が正しく表示される

---

### 5.3 数値関数のクエリ実行

**手順**:
1. ordersテーブルを選択
2. 以下の関数を追加:
   - ROUND(price * 1.1, 2) AS price_with_tax
   - CEIL(quantity / 10) AS boxes_needed
3. クエリを実行

**期待結果**:
- 計算結果が正しく表示される

---

### 5.4 条件関数のクエリ実行

**手順**:
1. usersテーブルを選択
2. 以下の関数を追加:
   - COALESCE(nickname, name) AS display_name
   - NULLIF(status, 'inactive') AS active_status
3. クエリを実行

**期待結果**:
- NULL値が正しく処理される

---

### 5.5 ネストした関数のクエリ実行

**手順**:
1. usersテーブルを選択
2. 関数ビルダーでネストした関数を構築:
   - UPPER(SUBSTRING(name, 1, 3)) AS short_upper_name
3. クエリを実行

**期待されるSQL**:
```sql
SELECT
  UPPER(SUBSTRING(name, 1, 3)) AS short_upper_name
FROM users
```

**期待結果**:
- ネストした関数が正しく実行される

---

## 6. エラーハンドリングのテスト

### 6.1 必須引数の未入力

**手順**:
1. 関数ビルダーでSUBSTRINGを選択
2. 引数1のみ入力し、引数2, 3を空にする
3. 「追加」ボタンをクリック

**期待結果**:
- バリデーションエラーが表示される
- 追加できない

---

### 6.2 引数の型の不一致

**手順**:
1. 数値関数ROUNDを選択
2. 引数1にリテラル値 `'text'` を入力
3. 「追加」ボタンをクリック

**期待結果**:
- 警告が表示される（または追加はできるが実行時エラー）

---

## 7. リグレッションテスト

### 7.1 Phase 1の式入力機能

**手順**:
1. 「式を追加」（テキスト入力）を使用
2. `UPPER(name)` と直接入力
3. クエリを実行

**期待結果**:
- Phase 1の機能が正常に動作する
- 関数ビルダーと共存できる

---

### 7.2 既存のカラム選択機能

**手順**:
1. 通常のカラム選択
2. 関数ビルダーで追加した関数
3. これらを組み合わせてクエリを実行

**期待結果**:
- すべてが正しく組み合わされる

---

## テスト完了チェックリスト

- [ ] 関数マスターのテストがすべて合格
- [ ] 関数ビルダーUIが正しく動作
- [ ] ネストした関数が構築可能
- [ ] データベース方言対応が正しく動作
- [ ] E2Eテストがすべて合格（20種類以上の関数）
- [ ] エラーハンドリングが適切に動作
- [ ] リグレッションテストがすべて合格
- [ ] 3つのデータベースで動作確認完了

---

## テスト実施記録

| 日付 | テスター | 結果 | 備考 |
|------|---------|------|------|
| | | | |
