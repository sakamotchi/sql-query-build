# プロジェクト計画書: SELECT句拡張（関数・サブクエリ対応）

**プロジェクト名**: SELECT句拡張プロジェクト
**プロジェクトコード**: select-clause-extension
**作成日**: 2026-01-02
**最終更新**: 2026-01-02
**ステータス**: 📝 計画中

---

## 1. プロジェクト概要

### 1.1 プロジェクトの目的

クエリビルダーのSELECT句を拡張し、データベース関数とサブクエリに対応することで、より実用的で柔軟なクエリ構築を可能にする。

現在のSELECT句は単純なカラム選択とエイリアス設定のみに対応しているが、以下の機能を追加する：

1. **データベース関数の適用**
   - 文字列関数（UPPER, LOWER, CONCAT, SUBSTRING等）
   - 日付関数（NOW, DATE_FORMAT, EXTRACT等）
   - 数値関数（ROUND, CEIL, FLOOR等）
   - 条件関数（COALESCE, NULLIF, CASE WHEN等）

2. **スカラーサブクエリのサポート**
   - 関連レコード数の取得
   - 関連データの集計値（MAX, MIN, SUM等）
   - 相関サブクエリ

3. **ネストした式の構築**
   - 関数のネスト（関数の引数として関数を指定）
   - 演算子の組み合わせ
   - 関数とサブクエリの組み合わせ

### 1.2 背景と必要性

#### 現状の課題

- SELECT句で使用できるのは通常のカラム選択のみ
- 文字列の加工や日付のフォーマットができない
- 関連テーブルの集計値を取得できない
- 実用的なクエリの構築に制限がある

#### 解決すべき問題

1. **データ加工の制約**: 生データしか取得できず、フロントエンドでの加工が必要
2. **関連データの制約**: JOINなしで関連データの集計値を取得できない
3. **複雑な式の制約**: 計算カラムや条件分岐を含むクエリが構築できない

#### 期待される効果

- クエリビルダーの実用性が大幅に向上
- フロントエンドでの後処理が不要になる
- より複雑なビジネスロジックをクエリレベルで表現可能
- 他のSQLツールと同等の機能を提供

### 1.3 ゴールと成功基準

#### プロジェクトゴール

1. **Phase 1完了時**: 式ツリー型定義とバックエンドSQL生成が完成し、文字列での式入力が可能
2. **Phase 2完了時**: 関数ビルダーUIが完成し、よく使う関数をGUIで構築可能
3. **Phase 3完了時**: サブクエリビルダーUIが完成し、スカラーサブクエリを含むクエリが構築可能

#### 成功基準

| ID | 基準 | 測定方法 |
|----|------|---------|
| SC-1 | 文字列関数を使用したクエリが正しく生成・実行される | 手動テスト + 単体テスト |
| SC-2 | 日付関数を使用したクエリが正しく生成・実行される | 手動テスト + 単体テスト |
| SC-3 | スカラーサブクエリを使用したクエリが正しく生成・実行される | 手動テスト + 単体テスト |
| SC-4 | ネストした関数が正しく生成される | 単体テスト |
| SC-5 | PostgreSQL、MySQL、SQLiteの3つのDBで正しく動作する | 統合テスト |
| SC-6 | UIで直感的に関数やサブクエリを構築できる | ユーザビリティテスト |
| SC-7 | 既存のクエリビルダー機能が正常に動作する（後方互換性） | リグレッションテスト |

---

## 2. スコープ

### 2.1 対象範囲

#### 機能範囲

1. **式ツリー型定義**
   - `ExpressionNode`型の定義（TypeScript + Rust）
   - ColumnReference, LiteralValue, FunctionCall, Subquery, BinaryOperation, UnaryOperation

2. **バックエンド - SQL生成**
   - 式ツリーからSQL文字列への変換
   - データベース方言ごとの関数名マッピング
   - サブクエリの括弧付きSQL生成

3. **フロントエンド - 式エディタUI**
   - 式の種類選択UI（カラム/関数/サブクエリ/式）
   - 関数ビルダーUI
   - サブクエリビルダーUI
   - プレビュー表示

4. **対応関数**
   - 文字列関数: UPPER, LOWER, CONCAT, SUBSTRING, LENGTH, TRIM
   - 日付関数: NOW, CURRENT_DATE, DATE_FORMAT, EXTRACT
   - 数値関数: ROUND, CEIL, FLOOR, ABS
   - 条件関数: COALESCE, NULLIF, CASE WHEN
   - 集計関数: COUNT, SUM, AVG, MIN, MAX（既存拡張）

5. **対応サブクエリ**
   - スカラーサブクエリ（単一値を返す）
   - 相関サブクエリ（外部クエリのカラムを参照）

### 2.2 対象外範囲

以下は本プロジェクトの対象外とする：

1. **ウィンドウ関数**: ROW_NUMBER, RANK, PARTITION BY等（別プロジェクトで対応）
2. **CTE（WITH句）**: 共通テーブル式（別プロジェクトで対応）
3. **FROM句のサブクエリ**: 派生テーブル（別プロジェクトで対応）
4. **ユーザー定義関数**: UDF、ストアドプロシージャ
5. **正規表現関数**: REGEXP_REPLACE等の高度な関数
6. **JSON/XML関数**: データベース固有の複雑な関数

---

## 3. 前提条件と制約

### 3.1 前提条件

| ID | 前提条件 |
|----|---------|
| P-1 | Phase 1.6のクエリビルダー基盤が完成している |
| P-2 | Phase 2.1のクエリ実行基盤が完成している |
| P-3 | WHERE句のサブクエリ対応が実装済み |
| P-4 | 3つのデータベース（PostgreSQL, MySQL, SQLite）の接続・実行環境がある |
| P-5 | Nuxt UI v4の知識がある |

### 3.2 技術的制約

| ID | 制約 | 理由 |
|----|------|------|
| TC-1 | 式ツリーの深さは最大10レベルまで | 無限再帰防止、パフォーマンス考慮 |
| TC-2 | サブクエリはスカラー値（単一値）のみ | SELECT句の制約、複雑性の制限 |
| TC-3 | 関数の引数は最大10個まで | 実用的な範囲での制限 |
| TC-4 | データベース方言の自動変換は主要関数のみ | すべての関数の変換は非現実的 |

### 3.3 プロジェクト制約

| ID | 制約 | 影響 |
|----|------|------|
| PC-1 | 既存機能との後方互換性を維持 | 既存の`expression`/`aggregate`型を残す必要がある |
| PC-2 | 段階的リリースが必要 | 各フェーズ完了時にリリース可能にする |
| PC-3 | UIのレスポンス時間は1秒以内 | プレビュー更新の性能要件 |

---

## 4. ステークホルダー

| 役割 | 名前/チーム | 責任 |
|-----|-----------|------|
| プロダクトオーナー | - | 要件定義、優先順位決定 |
| 開発者 | Claude | 設計、実装、テスト |
| レビュアー | ユーザー | コードレビュー、受け入れテスト |
| ユーザー | エンドユーザー | フィードバック、受け入れ確認 |

---

## 5. フェーズとマイルストーン

### 5.1 フェーズ概要

| フェーズ | 目標 | 期間目安 | 成果物 |
|---------|------|---------|--------|
| **Phase 1** | 式ツリー基盤構築 | - | ExpressionNode型定義、SQL生成ロジック、シンプルな式入力UI |
| **Phase 2** | 関数ビルダーUI | - | 関数選択UI、引数設定UI、関数プレビュー |
| **Phase 3** | サブクエリビルダーUI | - | サブクエリ構築UI、相関サブクエリ対応 |

### 5.2 マイルストーン

| マイルストーン | 日付 | 内容 |
|-------------|------|------|
| M1: Phase 1完了 | TBD | 式ツリー基盤とバックエンドSQL生成完成 |
| M2: Phase 2完了 | TBD | 関数ビルダーUI完成 |
| M3: Phase 3完了 | TBD | サブクエリビルダーUI完成、プロジェクト完了 |

---

## 6. リスクと課題

### 6.1 技術リスク

| ID | リスク | 影響度 | 対策 |
|----|-------|-------|------|
| TR-1 | 再帰的なデータ構造の実装が複雑 | 高 | 既存のWhereClauseの実装を参考にする |
| TR-2 | データベース方言の違いが大きい | 中 | 主要関数のみサポート、マッピングテーブルを作成 |
| TR-3 | サブクエリのバリデーションが困難 | 中 | 段階的に実装、Phase 3で対応 |
| TR-4 | UIの複雑化によるユーザビリティ低下 | 中 | プロトタイプで検証、シンプルな設計を優先 |

### 6.2 プロジェクトリスク

| ID | リスク | 影響度 | 対策 |
|----|-------|-------|------|
| PR-1 | スコープクリープ（機能追加要望） | 中 | スコープを明確化、Phase 4以降に延期 |
| PR-2 | 後方互換性の破壊 | 高 | 既存型を残す、段階的移行を計画 |
| PR-3 | パフォーマンス劣化 | 中 | 各フェーズでパフォーマンステスト実施 |

---

## 7. 依存関係

### 7.1 先行要件

| 項目 | 状態 | 備考 |
|-----|------|------|
| クエリビルダー基盤（Phase 1.6） | ✅ 完了 | 基本的なSELECT文生成が可能 |
| クエリ実行基盤（Phase 2.1） | ✅ 完了 | SQL実行とエラーハンドリング |
| WHERE句サブクエリ対応 | ✅ 完了 | サブクエリの実装パターンを参考にできる |

### 7.2 並行プロジェクト

| プロジェクト | 影響 | 調整事項 |
|------------|------|---------|
| なし | - | - |

---

## 8. コミュニケーション計画

### 8.1 報告頻度

| 内容 | 頻度 | 方法 |
|-----|------|------|
| 進捗報告 | 各フェーズ完了時 | ドキュメント更新 |
| 設計レビュー | 主要設計完了時 | ドキュメント共有 |
| 受け入れテスト | 各フェーズ完了時 | デモ・動作確認 |

### 8.2 ドキュメント管理

| ドキュメント | 更新タイミング |
|------------|--------------|
| 本計画書 | マイルストーン達成時、リスク変更時 |
| 要件定義書 | 要件変更時 |
| 技術設計書 | 設計変更時 |
| WBS | タスク追加・変更時 |
| 実装計画書 | 計画変更時 |

---

## 9. 品質保証計画

### 9.1 テスト戦略

| テスト種別 | タイミング | 対象 |
|----------|----------|------|
| 単体テスト | コード実装時 | 各関数、メソッド |
| 統合テスト | フェーズ完了時 | バックエンド・フロントエンド連携 |
| E2Eテスト | フェーズ完了時 | ユーザーシナリオ全体 |
| リグレッションテスト | 各フェーズ完了時 | 既存機能の動作確認 |

### 9.2 品質基準

| 項目 | 基準 |
|-----|------|
| 単体テストカバレッジ | 80%以上 |
| コードレビュー | すべてのPRで実施 |
| ドキュメント更新 | コード変更と同時 |

---

## 10. 変更管理

### 10.1 変更プロセス

1. 変更要求の記録
2. 影響度分析
3. 承認/却下判断
4. 計画の更新
5. 関係者への通知

### 10.2 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|----------|---------|--------|
| 2026-01-02 | 1.0 | 初版作成 | Claude |

---

## 関連ドキュメント

- [要件定義書](requirements.md)
- [技術設計書](design.md)
- [WBS](wbs.md)
- [実装計画書](implementation-plan.md)
